define(["jquery","mobile","underscore","backbone","shared/global","shared/service","shared/method","shared/shared","model/base","model/lookupcriteria","collection/base","collection/products","view/20.0.0/products/openingbalance/controls/ob-list","view/20.0.0/products/openingbalance/openingbalance-detail","view/20.0.0/products/openingbalance/lookup/lookup","text!template/20.0.0/products/openingbalance/openingbalance-form.tpl.html","text!template/20.0.0/products/openingbalance/lookup/lookup.tpl.html","text!template/20.0.0/products/controls/generic-layout.tpl.html","js/libs/format.min.js"],function(e,t,i,o,n,s,a,l,c,r,d,h,u,p,m,w,g,f){var L,V={SearchInput:"#txt-search",OpeningBalanceForm:"#opening-balance-form"},C=o.View.extend({_openingBalanceFormTemplate:i.template(w),_genericLayoutTemplate:i.template(f),initialize:function(){L=this,this.UnloadConfirmationMessage=null,this.IsNew=!1},render:function(){return this.$el.html(this._openingBalanceFormTemplate),this.$(V.OpeningBalanceForm).html(this._genericLayoutTemplate),this},Show:function(){this.LoadItems(),this.render()},HasChanges:function(){if(this.IsNew)return this.UnloadConfirmationMessage="Do you want to cancel this new record?",!0},InitializeChildViews:function(){},ProductLookUpLoadSuccess:function(e,t,i){this._products||(this._products=new d),this._products.reset(t.InventoryOpeningBalance),this.ConvertJSONtoDate(),this.DisplayItemList(),l.Products.Overlay.Hide()},ProductLookUpLoadError:function(e,t,i){console.log(e),l.Products.Overlay.Hide(),l.Products.RequestTimeOut()},InitializeProductLookUp:function(){this._productLookUp||(this._productLookUp=new r,this._productLookUp.on("sync",this.ProductLookUpLoadSuccess,this),this._productLookUp.on("error",this.ProductLookUpLoadError,this))},LoadItems:function(e){void 0!==e&&null!==e||(e=null),this.InitializeProductLookUp();var t="100";this._productLookUp.set({StringValue:e}),this._productLookUp.url=n.ServiceUrl+s.PRODUCT+a.OPENINGBALANCELOOKUP+t,this._productLookUp.save(),l.Products.Overlay.Show()},DisplayItemList:function(){this.genericListView?this.genericListView.RefreshList(this._products):(this.genericListView=new u({el:"#left-panel",DisableAdd:this.options.IsReadOnly}),this.genericListView.on("search",this.SearchItem,this),this.genericListView.on("selected",this.SelectedItem,this),this.genericListView.on("add",this.AddMode,this),this.genericListView.collection=this._products,this.genericListView.SetPlaceHolder("Search Products"),this.genericListView.SetDisplayField("ConvertedTransactionDate"),this.genericListView.Show()),this.SelectedItem()},SearchItem:function(){this.genericListView&&this.LoadItems(this.genericListView.GetItemToSearch())},InitializeOpeningBalanceDetailView:function(){this.openingBalanceDetailView=new p({el:"#right-panel"}),this.openingBalanceDetailView.on("cancel",this.CancelNew,this),this.openingBalanceDetailView.on("saved",this.Saved,this),this.openingBalanceDetailView.on("updated",this.Updated,this),this.openingBalanceDetailView.on("deleted",this.Deleted,this),this.openingBalanceDetailView.on("itemLookup",this.triggerItemLookupItem,this)},triggerItemLookupItem:function(){this.productCollection||this.InitializeProductCollection(),this.LoadLookupView()},CancelNew:function(){this.ConfirmCancelChanges("DoCancelNew")},DoCancelNew:function(){this.IsNew=!1,this.openingBalanceDetailView.IsNew=!1,this.SelectedItem()},Saved:function(){this.openingBalanceDetailView.ItemCode;l.Products.ShowNotification("Transaction(s) was successfully created!"),this.IsNew=!1,this.openingBalanceDetailView.IsNew=!1,n.justRefreshCollection=!0,this.LoadItems()},Updated:function(){l.Products.ShowNotification("Changes successfully saved!")},Deleted:function(){var e=this.openingBalanceDetailView.ItemCode;this.SearchItem(),l.Products.ShowNotification("Product '"+e+"' was successfully deleted!")},SelectedItem:function(){if(!this.IsNew&&this.genericListView){if(this.openingBalanceDetailView||this.InitializeOpeningBalanceDetailView(),this.genericListView.GetSelectedModel()||this.genericListView.GetFirstModel()){this.openingBalanceDetailView.model=new c;this.genericListView.GetSelectedModel()||this.genericListView.GetFirstModel();this.openingBalanceDetailView.model.set(this.genericListView.GetSelectedModel().attributes)}else this._products&&(this._products.models.length>0?(this.openingBalanceDetailView.model=new c,this.openingBalanceDetailView.model.set(this._products.at(0))):this.openingBalanceDetailView.model=null);if(n.justRefreshCollection){var e=new c;e=this.openingBalanceDetailView.savedModel,this.openingBalanceDetailView.model=e,this.genericListView.SelectByAttribute("OpeningBalanceCode",e.get("OpeningBalanceCode")),n.justRefreshCollection=!1}this.openingBalanceDetailView.toBeSearched=this.genericListView.GetItemToSearch(),this.openingBalanceDetailView.Show()}},AddMode:function(){this.IsNew||this.openingBalanceDetailView&&(this.IsNew=!0,this.openingBalanceDetailView.AddMode())},InitializeProductCollection:function(){var e="ItemName";this.productCollection=new h,this.productCollection.sortVar=e,this.productCollection.on("selected",this.GetItemSelected,this)},GetItemSelected:function(e){this.ValidateExistingItem(e)||this.GenerateSchemaOnSelectedModel(e.get("ItemCode"))},ValidateExistingItem:function(e){var t=e.get("ItemCode"),i=!1,o=new h;return o.reset(this.openingBalanceDetailView.GetCurrentCollection().models),o.each(function(e){e.get("ItemCode")===t&&(i=!0)}),i&&navigator.notification.alert(t+" already exist!",null,"Duplicate Item","OK"),i},GenerateSchemaOnSelectedModel:function(e){this.HideModal(),this.openingBalanceDetailView.LoadNewOBSchemaByItemCode(e)},LoadLookupView:function(){l.Products.Overlay.Show(),this.itemLookupView||(this.itemLookupView=new m({el:e("#modal-panel-container")}),this.itemLookupView.on("done",this.HideModal,this),this.itemLookupView.productCollection=this.productCollection),this.itemLookupView.Show(),e("#txt-search").attr("disabled","disabled"),e(".data-upc").attr("disabled","disabled"),e(".data-ob-code").attr("disabled","disabled"),this.itemLookupView.RefreshItemList(),e("#modal-panel-container").show()},ConvertJSONtoDate:function(){this._products.each(function(e){var t=e.get("TransactionDate"),i="L",o=moment(t).format(i);e.set({ConvertedTransactionDate:o})})},HideModal:function(){e("#txt-search").removeAttr("disabled","disabled"),e(".data-upc").removeAttr("disabled","disabled"),e(".data-ob-code").removeAttr("disabled","disabled"),e("#modal-panel-container").hide(),l.Products.Overlay.Hide()},ConfirmCancelChanges:function(e,t){this.DoOnCancel=t,this.DoOnConfirm=e,this.HasChanges()?navigator.notification.confirm(this.UnloadConfirmationMessage,I,"Confirmation",["Yes","No"]):this.ConfirmExecute()},ConfirmExecute:function(){this.DoOnConfirm&&this[this.DoOnConfirm]()},CancelExecute:function(){this.DoOnCancel&&this[this.DoOnCancel]()}}),I=function(e){1==e?L.ConfirmExecute():L.CancelExecute()};return C});