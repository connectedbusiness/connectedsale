define(["jquery","mobile","underscore","backbone","shared/global","shared/service","shared/method","shared/shared","model/postal","model/country","model/customerschema","collection/postal","collection/countries","text!template/20.0.0/pos/item/header-info/customer/customerform.tpl.html","view/spinner"],function(t,e,o,i,s,a,n,r,l,c,d,u,m,h,C){var p=null,y="#chkloyalty-points",v=!1,f=i.View.extend({_template:o.template(h),events:{"keypress #editcustomer-PostalCode":"buttonLoadOnTap","blur #editcustomer-PostalCode":"buttonLoadOnFocus","tap #editcustomer-save-btn":"buttonSaveOnTap","tap #editcustomer-cancel-btn":"buttonCancelOnTap","change #editcustomer-City":"SetState","tap #editcustomer-country":"CountryTap","change #editcustomer-country":"CountryChanged","tap #chkloyalty-points":"LoyaltyPointsCheck_Changed"},customerCode:"",classsCode:"",classTemplate:"",paymentTerm:"",paymentTermCode:"",taxCode:"",postal:"",customerName:"",address:"",city:"",state:"",phone:"",email:"",website:"",country:"",initialize:function(){this.render()},render:function(){p=!0,this.InitializeThings(),this.$el.append(this._template({FormTitle:"Edit Customer",Name:"CustomerName"})),t("#editcustomerForm").trigger("create")},InitializePostalModel:function(){this.postalmodel=new l},InitializeCustomerSchemaModel:function(){this.customerschema=new d,this.customerschema.url=s.ServiceUrl+a.CUSTOMER+n.GETNEWCUSTOMERSCHEMA,this.LoadCustomerSchema()},InitializePostal:function(){this.postalCollection=new u},InitializeThings:function(){this.InitializePostalModel(),this.InitializePostal(),this.InitializeCountryModel(),this.InitializeCountry(),this.InitializeCustomerSchemaModel(),t("#editcustomer-name").focus()},InitializeCountryModel:function(){_rows=1e4,this.countryModel=new c,this.countryModel.url=s.ServiceUrl+a.CUSTOMER+n.COUNTRYCODELOOKUP+_rows},InitializeCountry:function(){this.countryCollection=new m,this.LoadCountries()},LoadCountries:function(){var t=this;this.index=0,this.countryModel.set({Criteria:""}),this.countryModel.save(null,{success:function(e,o){s.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.countryCollection.reset(o.Countries),t.DisplayCountries()},error:function(t,e,o){s.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.RequestError(e,"Error Loading Country List")}})},DisplayCountries:function(){0===this.countryCollection.length?(console.log("no countries available."),navigator.notification.alert("No country available.",null,"No Country Found","OK")):(t('#editcustomer-country > option[val !=""]').remove(),this.LoadRetrievedCountry())},LoadRetrievedCountry:function(){this.countryCollection.each(this.SetCountryOptions,this)},SetCountryOptions:function(e){var o=e.get("CountryCode");t("#editcustomer-country").append(new Option(o,o))},SetSelectedCountry:function(e){var o=e.get("CountryCode");t("#editcustomer-country").val(o),t("#editcustomer-country").trigger("change")},LoyaltyPointsCheck_Changed:function(){v=r.CustomCheckBoxChange(y,v)},CountryTap:function(){this.isCountryTapped=!0},ClearPostalInfo:function(){t("#editcustomer-PostalCode").val(""),t("#editcustomer-State").val(""),this.ClearCity()},RemoveInvalidPostals:function(t){var e=t.get("CountryCode");console.log(e),e===this.countrySelected&&this.newCollection.add(t)},DisplayResultOnPostal:function(e,o){p||(this.newCollection=new u,this.postalCollection.each(this.RemoveInvalidPostals,this),this.postalCollection=this.newCollection),0===this.postalCollection.length?(navigator.notification.alert("The Zip Code "+e+" does not exist in the Country selected.",null,"Zip Code Not Found","OK"),t("#editcustomer-PostalCode").val(""),this.ClearCity()):(t('#editcustomer-City > option[val !=""]').remove(),this.LoadRetrievedPostal(),""==o?t("#editcustomer-City").prop("selectedIndex",0):t("#editcustomer-City option[value='"+o+"']").attr("selected","selected"),t("#editcustomer-City").trigger("change"))},CountryChanged:function(e){var o=e.target.id,i=t("#"+o).val(),s=t("#editcustomer-PostalCode").val();this.countrySelected!=i&&(p||s.length>0&&this.ClearPostalInfo()),this.countrySelected=i},AddCustomer:function(t){var e=this;this.postalmodel.url=s.ServiceUrl+a.CUSTOMER+n.UPDATECUSTOMER,this.postalmodel.set(t),this.postalmodel.save(null,{success:function(t,o){s.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.DisplayResult(o)},error:function(t,e,o){s.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.RequestError(e,"Error Updating Customer")}})},buttonCancelOnTap:function(t){t.preventDefault(),this.HideCustomerForm()},buttonLoadOnFocus:function(){this.ResetVariable(),this.postal=t("#editcustomer-PostalCode").val();var e="";this.LoadPostal(this.postal,e)},buttonLoadOnTap:function(e){if(13===e.keyCode){this.ResetVariable(),this.postal=t("#editcustomer-PostalCode").val();var o="";this.LoadPostal(this.postal,o)}},buttonSaveOnTap:function(t){t.stopPropagation(),this.ResetVariable(),this.ValidateFields()},ClearFields:function(){t("#editcustomer-PostalCode").val(""),t("#editcustomer-name").val(""),t("#editcustomer-Address").val(""),t("#editcustomer-State").val(""),t("#editcustomer-Phone").val(""),t("#editcustomer-Email").val(""),t("#editcustomer-Site").val(""),this.ClearCity()},GetCity:function(e){this.ResetVariable(),this.postal=t("#editcustomer-PostalCode").val();var o=e.get("City");this.LoadPostal(this.postal,o)},EditCustomer:function(e){this.ClearCity(),console.log("trackLoyaltyPoints: "+e.get("TrackLoyaltyPoints")),r.IsNullOrWhiteSpace(e.get("TrackLoyaltyPoints"))||this.LoyaltyPointsCheck_Changed(),t("#editcustomer-PostalCode").val(e.get("PostalCode")),this.GetCity(e),t("#editcustomer-name").val(e.get("CustomerName")),t("#editcustomer-Address").val(e.get("Address")),t("#editcustomer-Phone").val(e.get("Telephone")),t("#editcustomer-Email").val(e.get("Email")),t("#editcustomer-Site").val(e.get("Website")),this.customerCode=e.get("CustomerCode"),this.classCode=e.get("ClassCode"),this.country=e.get("Country");var o,i,s;o=e.get("ClassCode"),i=e.get("PaymentTerm"),s=e.get("TaxCode"),this.SetCustomerSchemaFields(o,i,s)},DisplayResult:function(t){t.ErrorMessage?(console.log(t.ErrorMessage),this.HideActivityIndicator()):(s.CurrentCustomer=t,null===t.ShipToName&&null===t.ShipToAddress?this.SetCustomerName(t.CustomerName,t.CustomerCode,t.DefaultShipToName,t.Address):this.SetCustomerName(t.CustomerName,t.CustomerCode,t.ShipToName,t.ShipToAddress),this.HideActivityIndicator())},HideCustomerForm:function(){t("#editcustomer-name").blur(),t("#editcustomerForm").unbind("create"),t("#editcustomerForm").remove(),this.ClearFields(),this.HideActivityIndicator(),t("#main-transaction-blockoverlay").hide(),this.undelegateEvents()},LoadCustomerSchemaDetails:function(){this.customerschema?(console.log(this.customerschema.get("ClassCode")),this.LoadRetrievedCustomerSchema(this.customerschema),this.InitializePostalModel(),this.InitializePostal(),t("#editcustomer-name").focus()):(console.log("else"),this.InitializeThings())},LoadRetrievedCustomerSchema:function(t){this.classCode=t.get("ClassCode"),this.classTemplate=t.get("ClassCode"),this.paymentTerm=t.get("PaymentTerm"),this.taxCode=t.get("TaxCode"),this.SetCustomerSchemaFields(this.classTemplate,this.paymentTerm,this.taxCode)},LoadRetrievedPostal:function(){this.postalCollection.each(this.SetFields,this)},LoadPostal:function(e,o){if(""==e)this.ClearCity();else{var i=this;r.LoadPostalByCode(e,function(t){i.postalCollection.reset(t),i.DisplayResultOnPostal(e,o)},function(e){i.postalCollection.reset(),i.postalCollection.RequestError(e,"Error Loading Postal Code"),t("#customer-PostalCode").val("")})}},LoadCustomerSchema:function(){var t=this;this.customerschema.fetch({success:function(e,o){t.SetCustomerSchema(o),s.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()}})},ResetVariable:function(){this.postal="",this.customerName="",this.address="",this.city="",this.state="",this.phone="",this.email="",this.website="",this.country=""},SetCustomerSchema:function(t){this.classCode=t.ClassCode,this.classTemplate=t.ClassCode,this.paymentTerm=t.PaymentTermCode,this.taxCode=t.TaxCode,this.SetCustomerSchemaFields(this.classTemplate,this.paymentTerm,this.taxCode)},SetCustomerSchemaFields:function(e,o,i){t("#editcustomer-ClassTemplate").val(e),t("#editcustomer-PaymentTerm").val(o),t("#editcustomer-TaxCode").val(i)},SetCustomerDetails:function(){this.postal=t("#editcustomer-PostalCode").val(),this.customerName=t("#editcustomer-name").val(),this.address=t("#editcustomer-Address").val(),this.city=t("#editcustomer-City").val(),this.state=t("#editcustomer-State").val(),this.phone=t("#editcustomer-Phone").val(),this.email=t("#editcustomer-Email").val(),this.website=t("#editcustomer-Site").val(),this.country=t("#editcustomer-country").val();var e={CustomerCode:this.customerCode,CustomerName:this.customerName,Country:this.country,ClassCode:this.classCode,Address:this.address,City:this.city,State:this.state,PostalCode:this.postal,Telephone:this.phone,Website:this.website,PaymentTerm:this.paymentTerm,Email:this.email,DefaultClassTemplate:this.classTemplate,TaxCode:this.taxCode};this.AddCustomer(e)},ClearCity:function(){t('#editcustomer-City > option[val !=""]').remove(),t("#editcustomer-City").append(new Option("City...","")),t("#editcustomer-City").prop("selectedIndex",0),t("#editcustomer-City").trigger("change"),t("#editcustomer-State").val("")},SetState:function(){var e=this,o=t("#editcustomer-City option:selected").val();if(""!=o){var i=this.postalCollection.find(function(t){return o=t.get("City")}),s=i.get("StateCode");t("#editcustomer-State").val(s),p&&setTimeout(function(){e.SetSelectedCountry(i),console.log("isFirstTymLoaded"+p),p=!1},200)}else t("#editcustomer-State").val("")},SetFields:function(e){var o=e.get("City");t("#editcustomer-City").append(new Option(o,o))},SetCustomerName:function(e,o,i,a){s.CustomerName=e,s.CustomerCode=o,t("#label-customername").html(r.TrimCustomerName()),t("#lbl-customerName").html(r.TrimCustomerName()),s.DefaultShipTo=i+",",s.DefaultShipToAddress=a,t("#label-shipto i").html(r.TrimDefaultShipTo()),t("#label-shipto i").append("<br/>"+r.Escapedhtml(s.DefaultShipToAddress))},Show:function(){t("#editcustomerForm").show(),this.InitializeThings(),this.isFirstTymLoaded=!0,t("#editcustomerForm").trigger("create")},ShowSpinner:function(){t("#spin").remove(),t("#main-transaction-blockoverlay").show(),target=document.getElementById("main-transaction-page"),this.ShowActivityIndicator(target),t("<h5>Saving...</h5>").appendTo(t("#spin"))},ShowActivityIndicator:function(e){t("<div id='spin'></div>").appendTo(e);var o=document.getElementById("spin");_spinner=C,_spinner.opts.color="#fff",_spinner.opts.lines=13,_spinner.opts.length=7,_spinner.opts.width=4,_spinner.opts.radius=10,_spinner.opts.top="auto",_spinner.opts.left="auto",_spinner.spin(o)},HideActivityIndicator:function(){_spinner=C,_spinner.stop(),t("#spin").remove()},ValidateFields:function(){var e=t("#editcustomer-PostalCode").val(),o=t("#editcustomer-name").val(),i=t("#editcustomer-Email").val();""===e?navigator.notification.alert("Please input a valid Zip Code.",null,"Zip Code is Required","OK"):""===o?navigator.notification.alert("Please enter a Customer Name.",null,"Customer Name is Required","OK"):null!=i&&""!=i&&this.ValidateEmailFormat(i)?navigator.notification.alert("Email format is invalid.",null,"Invalid Email","OK"):(this.ShowSpinner(),this.SetCustomerDetails(),this.HideCustomerForm())},ValidateEmailFormat:function(t){var e=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i;return t.search(e)==-1}});return f});