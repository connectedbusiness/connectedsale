define(["jquery","mobile","underscore","backbone","shared/global","shared/service","shared/method","shared/enum","shared/shared","model/base","collection/base","text!template/16.0.0/pos/giftcard/recharge.tpl.html","text!template/16.0.0/pos/giftcard/activate.tpl.html","view/spinner"],function(t,e,i,a,s,n,r,o,c,d,h,l,p,u){var f={Recharge:"RechargeGCard",Activate:"ActivateGCard"},g={PIN:"PIN",NewPIN:"New PIN",Activate:"Activate"},v={POS:"POS",SecondaryDisplay:"SecondaryDisplay"},I=null,m=a.View.extend({_RechargeTemplate:i.template(l),_ActivateTemplate:i.template(p),render:function(t){return this.$el.html(""),this.$el.html(t),this},events:{"tap #recharge-btn":"Recharge_tapped","tap #btn-cancel":"Cancel_tapped","keypress #gift-card-input":"GiftCard_keypress","change #gift-card-input":"GiftCard_change","focus #amount-input":"Amount_focused","blur #amount-input":"Amount_blur","keypress #pin-input":"Pin_keypress","keypress #confirm-pin-input":"Pin_keypress","tap #activate-btn":"Activate_tapped","tap #btn-back":"Back_tapped","tap #btn-done":"Done_tapped","tap #ask-pin-btn":"AskPIN_tapped","tap #stop-asking-btn":"StopAsking_tapped"},initialize:function(){this.InitializeGiftCardModel(),I=this},PopulatePINFields:function(e){e||(e=s.PIN),console.log("processPINCaptured"),t("#confirm-pin-input").val(e),t("#pin-input").val(e),this.GetFieldValues(),P(),this.activateFormType==g.PIN&&this.ValidData()&&this.ValidatePIN()},ShowGCardRechargeForm:function(){s.ViewRecipient="Recharge",this.formType=f.Recharge,this.$el.html(""),this.IsActivated||this.gcModel.get("SerialLotNumber")&&this.gcModel.set({CreditAvailableRate:0}),this.render(this._RechargeTemplate(this.gcModel.toJSON())),this.IsActivated?this.ShowHiddenFields():c.Focus("#gift-card-input"),t("#rechargeGCardForm").trigger("create"),this.$el.show()},ShowGCardActivationForm:function(e){switch(this.formType=f.Activate,e||(e=g.Activate),this.render(this._ActivateTemplate),c.Focus("#pin-input"),this.IsSecondaryView()?(t(".popover-left").hide(),t("#activate-btn").text("Submit"),t("#ask-pin-btn").hide()):(t("#activate-btn").addClass("left-btn"),t("#ask-pin-btn").addClass("right-btn")),e){case g.PIN:this.ShowPinOnly();break;case g.NewPIN:this.ShowNewPIN();break;default:this.activateFormType=g.Activate}t("#activateGCardForm").trigger("create"),this.$el.show()},ShowHiddenFields:function(){return t("#balance-container").show(),this.hasItemOnCart?void t("#gc-button-container").hide():(t("#recharge-btn").text("Recharge"),t("#amount-container").show(),t("#gc-button-container").show(),c.Input.NonNegative("#amount-input"),void c.Focus("#amount-input"))},ShowPinOnly:function(){this.activateFormType=g.PIN,this.IsSecondaryView()?(t(".popover-left").hide(),t("#gc-button-container").hide(),t("#btn-done").text("Submit")):(t("#activate-btn").hide(),t(".ask-pin-btn").show(),t("#activate-btn").removeClass("left-btn"),t("#ask-pin-btn").removeClass("right-btn")),t("#activate-title").hide(),t("#pin-title").show(),t("#confirm-pin-container").hide(),t(".popover-right").show()},ShowNewPIN:function(){this.activateFormType=g.NewPIN,t("#activate-title").hide(),t("#new-pin-title").show(),this.IsSecondaryView()?(t(".popover-left").hide(),t("#gc-button-container").hide(),t("#btn-activate").text("Submit")):(t(".ask-pin-btn").show(),t("#btn-activate").text("Submit"))},Cancel_tapped:function(t){t.preventDefault(),c.ShowHideBlockOverlay(),this.$el.hide(),c.FocusToItemScan()},Recharge_tapped:function(e){if(e.preventDefault(),!this.validateLocationBankAccount||this.validateLocationBankAccount()){var i=t("#gift-card-input").val();c.IsNullOrWhiteSpace(i)||(this.IsActivated?this.RechargeGiftCard():this.SearchGCard())}},Activate_tapped:function(t){if(t.preventDefault(),this.IsWaiting())return void navigator.notification.alert("Waiting for the customer to enter pin.",null,"Invalid Action","OK");if(this.ValidData()){if(this.IsSecondaryView())return void this.TriggerPINCaptured();if(this.IsActivated)this.ActivateGiftCard();else{I=this;var e="This gift card will be permanently associated to the current customer. Do you still want to proceed to activation?";navigator.notification.confirm(e,this.ProceedToActivation,"Activate Gift Card")}}},TriggerPINCaptured:function(){this.Hide(),this.trigger("pinCaptured",this.pin)},ProceedToActivation:function(t){1==t&&I.ActivateGiftCard()},Back_tapped:function(t){return t.preventDefault(),this.IsWaiting()?void navigator.notification.alert("Waiting for the customer to enter pin.",null,"Invalid Action","OK"):void this.ShowGCardRechargeForm()},GiftCard_keypress:function(e){if(13==e.keyCode){var i=t("#"+e.target.id).val();if(c.IsNullOrWhiteSpace(i))return;this.SearchGCard()}},Amount_focused:function(e){e.stopPropagation();var i=t("#"+e.target.id).val();i&&(i=parseFloat(i),0==i&&t("#"+e.target.id).val(""))},Amount_blur:function(e){e.stopImmediatePropagation();var i=t("#"+e.target.id).val();i||t("#"+e.target.id).val("0.00")},GiftCard_change:function(t){t.preventDefault(),t.stopImmediatePropagation(),this.IsActivated&&this.SearchGCard()},Pin_keypress:function(t){13==t.keyCode&&this.activateFormType==g.PIN&&"pin-input"==t.target.id&&(this.ValidData()?this.ValidatePIN():this.ValidData()&&console.log("valid"))},Done_tapped:function(t){return t.preventDefault(),this.IsWaiting()?void navigator.notification.alert("Waiting for the customer to enter pin.",null,"Invalid Action","OK"):void(this.ValidData()&&(this.IsSecondaryView()?this.TriggerPINCaptured():this.ValidatePIN()))},AskPIN_tapped:function(e){e.preventDefault(),t(".ask-pin-btn").attr("id","stop-asking-btn"),C(),this.trigger("askToEnterPIN",this.activateFormType,this)},StopAsking_tapped:function(t){t.preventDefault(),console.log("btnCancel_Retrieval"),this.$(".ask-pin-btn").attr("id","ask-pin-btn"),P(),this.trigger("stopAskingPIN","Recharge",this)},RechargeGiftCard:function(){if(this.ValidData()){var e=t("#amount-input").val();e=parseFloat(e),this.gcModel.set({SalesPriceRate:e}),this.trigger("proceedToRecharge",this.gcModel)}},SearchGCard:function(t){if(this.ValidData()){this.IsActivated=!1,t||(t=this.serialNumber);var e=new d;e.on("sync",this.SearchGCardSuccess,this),e.on("error",this.SearchGCardFailed,this),e.url=s.ServiceUrl+n.SOP+r.GETGIFTDETAILBYSERIAL,e.set({SerialLotNumber:t}),e.save()}},ValidatePIN:function(){if(this.IsSecondaryView())return void this.TriggerPINCaptured();var t=new d,e=this.GetCurrentModelAtt();t.on("sync",this.ValidatePINSuccess,this),t.on("error",this.ValidatePINFailed,this),t.url=s.ServiceUrl+n.SOP+r.VALIDATEGIFTPIN,t.set(e),t.set({PIN:this.encryptedPIN}),t.save()},FetchGCardDetails:function(t){t||(t=this.serialNumber);var e=new d;e.on("sync",this.FetchGCardDetailsSuccess,this),e.on("error",this.FetchGCardDetailsFailed,this),e.url=s.ServiceUrl+n.SOP+r.GETGIFTCREDITS,e.set({SerialLotNumber:t,ItemType:o.ItemType.GiftCard}),e.save()},ActivateGiftCard:function(t){t||(t=this.serialNumber);var e=new d;e.set(this.GetCurrentModelAtt()),e.on("sync",this.ActivateGCardSuccess,this),e.on("error",this.ActivateGCardFailed,this);var i=this.creditCode,a=s.CustomerCode;this.activateFormType==g.NewPIN?a=e.get("CustomerCode"):this.gcModel.set({CustomerCode:a}),e.url=s.ServiceUrl+n.SOP+"activategift/",e.set({SetPIN:!0,CustomerCode:a,CreditCode:i,PIN:this.encryptedPIN}),e.save()},SearchGCardSuccess:function(t,e){this.ResponseMsg(),e?e.ErrorMessage?this.AlertMsg(e.ErrorMessage):e.ItemType==o.ItemType.GiftCertificate?this.ReinitializeRechargeForm():this.ProcessGCard(e):this.ReinitializeRechargeForm()},ValidatePINSuccess:function(t,e){this.ResponseMsg(),e.Value?(this.IsActivated=!0,this.ShowGCardRechargeForm()):(this.AddMsg("Invalid PIN Please try Again..."),P())},FetchGCardDetailsSuccess:function(t,e){if(this.ResponseMsg(),e){if(e.ErrorMessage)return void this.AlertMsg(e.ErrorMessage);this.gcModel.set(e),this.gcModel.get("IsActivated")&&!this.gcModel.get("PIN")?this.ProceedToNewPin():this.gcModel.get("IsActivated")?this.ShowGCardActivationForm(g.PIN):this.gcModel.get("IsReturned")?this.AddMsg("Gift card already been returned."):"Kiosk"==s.ApplicationType&&null==s.Kiosk.Customer?this.AlertMsg("This card is not yet activated. Please enter customer code to process activation.",null,"Invalid Action"):this.hasItemOnCart?navigator.notification.alert("This card is not yet activated.",null,"Inactivate Gift Card"):navigator.notification.confirm("This card is not yet activated. Do you want to activate this card?",this.ProceedToActivationForm,"Activate Gift Card")}},ActivateGCardSuccess:function(t,e){this.ResponseMsg(),e&&(e.ErrorMessage?this.AlertMsg(e.ErrorMessage):(this.IsActivated=!0,this.ShowGCardRechargeForm()))},ActivateGCardFailed:function(t,e,i){this.ResponseMsg(!0,"Error activation of gift card","Request Timeout")},FetchGCardDetailsFailed:function(t,e,i){this.ResponseMsg(!0,"Error Retrieving Gift Card Details","Request Timeout")},ValidatePINFailed:function(t,e,i){this.ResponseMsg(!0,"Error Validating PIN","Request Timeout")},SearchGCardFailed:function(t,e,i){this.ResponseMsg(!0,"Error Retrieving Gift Card","Request Timeout")},ProcessGCard:function(t){this.gcModel||this.InitializeGiftCardModel(),this.creditCode=t.CreditCode,this.gcModel.set(t),this.FetchGCardDetails()},ReinitializeRechargeForm:function(){this.IsActivated=!1,this.InitializeGiftCardModel(),this.ShowGCardRechargeForm(),c.Focus("#gift-card-input"),this.AddMsg("Gift card does not exist.")},ProceedToNewPin:function(){this.IsActivated=!0,this.AlertMsg("This card is activated but doesn't have PIN yet.",null,"Set New PIN"),this.ShowGCardActivationForm(g.NewPIN)},ProceedToActivationForm:function(t){1==t?I.ShowGCardActivationForm():I.ShowGCardRechargeForm()},InitializeGiftCardModel:function(){this.gcModel=new d,this.gcModel.set({SerialLotNumber:"",CreditAvailableRate:0})},ValidData:function(){if(this.GetFieldValues(),this.IsSecondaryView())return this.ValidActivationFields();if(this.IsValid(this.serialNumber))if(this.IsRechargeForm()){if(!this.IsActivated||this.hasItemOnCart)return!0;if(this.newGCardSearch)return!0;if(this.IsValid(this.amount)&&this.amount>0)return!0;this.AlertMsg("Please Enter valid Amount",null,"Invalid amount")}else if(this.activateFormType==g.PIN){if(this.IsValid(this.pin))return!0}else if(this.IsValid(this.pin)&&this.IsValid(this.confirmPIN))if(this.pin===this.confirmPIN){if(this.pin.length>3)return!0;this.AddMsg("PIN is too short.",!0)}else this.AddMsg("PINs does not match.",!0);else this.AddMsg("Please fill all fields given.",!0);else this.AlertMsg("Please Enter Gift Card",null,"Invalid gift card");return!1},ValidActivationFields:function(){if(this.activateFormType==g.PIN){if(this.IsValid(this.pin))return!0}else if(this.IsValid(this.pin)&&this.IsValid(this.confirmPIN))if(this.pin===this.confirmPIN){if(this.pin.length>3)return!0;this.AddMsg("PIN is too short.",!0)}else this.AddMsg("PINs does not match.",!0);else this.AddMsg("Please fill all fields given.",!0);return!1},GetCurrentModelAtt:function(){return this.gcModel.attributes},GetFieldValues:function(){this.IsRechargeForm()?(this.serialNumber&&(this.serialNumber!=t("#gift-card-input").val()?this.newGCardSearch=!0:this.newGCardSearch=!1),this.serialNumber=t("#gift-card-input").val(),this.amount=t("#amount-input").val()):(this.pin=t("#pin-input").val(),this.confirmPIN=t("#confirm-pin-input").val(),this.encryptedPIN=this.EncryptPIN(this.pin))},IsRechargeForm:function(){switch(this.formType){case f.Recharge:return!0;case f.Activate:return!1;default:console.log("no form found!")}},EncryptPIN:function(t){return t||(t=this.pin),Base64.encode(t)},ResponseMsg:function(t,e,i){s.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t&&this.AlertMsg(e,null,i)},AlertMsg:function(t,e,i){i||(i="Error"),navigator.notification.alert(t,e,i)},AddMsg:function(e,i){t("#activate-giftcard-body p").remove(),t("#recharge-giftcard-body p").remove(),i?(t("#activate-giftcard-body").prepend('<p style="font-color: red; font-align: left;"><i>*'+e+"</i></p>"),t("#recharge-giftcard-body").prepend('<p style="font-color: red; font-align: left;"><i>*'+e+"</i></p>")):(t("#recharge-giftcard-body").append('<p style="font-color: red; font-align: left;"><i>*'+e+"</i></p>"),t("#activate-giftcard-body").append('<p style="font-color: red; font-align: left;"><i>*'+e+"</i></p>"))},IsWaiting:function(){return t("#pin-input").hasClass("ui-disabled")},IsSecondaryView:function(){return this.viewType==v.SecondaryDisplay},Hide:function(){t("input").blur(),this.$el.hide()},IsValid:function(t){return!c.IsNullOrWhiteSpace(t)},ShowOverlay:function(){}}),C=function(){var e=document.getElementById("stop-asking-btn");_spinner=u,_spinner.opts.left=10,_spinner.opts.radius=3,_spinner.opts.lines=9,_spinner.opts.length=4,_spinner.opts.width=3,_spinner.opts.color="#000",_spinner.spin(e,"Cancel"),t("#stop-asking-btn .ui-btn-text").text("Cancel"),t(".ask-pin-btn").css("text-align","center"),t("#confirm-pin-input").addClass("ui-disabled"),t("#pin-input").addClass("ui-disabled")},A=function(){_spinner=u,_spinner.stop()},P=function(){t(".ask-pin-btn").attr("id","ask-pin-btn"),t(".ask-pin-btn .ui-btn-text").text("Allow User To Enter Pin"),t(".ask-pin-btn").css("text-align","center"),A(),t("#confirm-pin-input").removeClass("ui-disabled"),t("#pin-input").removeClass("ui-disabled")};return m});