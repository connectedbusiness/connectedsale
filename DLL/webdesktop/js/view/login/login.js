define(["jquery","mobile","underscore","backbone","shared/global","shared/method","shared/service","shared/shared","model/lookupcriteria","collection/url","collection/workstations","collection/localpreferences","view/login/connection","view/spinner"],function(e,i,o,t,n,r,s,a,l,c,u,d,p,g){var f,h=!1,w=t.View.extend({events:{"tap #login-btn":"Login","tap #connection-btn":"Connect","tap .websiteLink":"OpenWebsite","keyup #password":"Password_keyup","tap .clearTextBtn":"ClearUserText","focus #password":"ClearPassword","focus #username":"ShowClearBtn","keyup input":"ShowClearBtn","blur #username":"HideClearBtn","blur #password":"HideClearBtn"},initialize:function(){n.IsPatchCompatible=!1,this.InitializeLocalPreference(),this.InitializeUrlCollection(),this.InitializeConnection(),this.initializeDefaultUrl(),this.hasURLparam()&&!n.IsSignOut&&(v(),n.IsSignOut=!1,h=!0,n.Username=a.GetUrlFromParent("u"),n.Password=a.GetUrlFromParent("p"),n.ServiceUrl=a.GetUrlFromParent("s"),this.DoLogin(),this.cleanParentURL()),this.$("#loginForm").trigger("create");try{n.isBrowserMode||navigator.splashscreen.hide()}catch(e){navigator.notification.alert(e.message,null,e.name,"OK")}navigator.notification.overrideAlert(),a.StorePickup.StopChecker()},cleanParentURL:function(){var e=parent.location.protocol+"//"+parent.location.host+parent.location.pathname;parent.history.replaceState({},document.title,e)},hasURLparam:function(){return""!=parent.location.search},initializeDefaultUrl:function(){e("#username").val(""),e("#password").val(""),n.BetaServerUrl.CB==n.ServiceUrl&&(console.log(" Global.BetaServerUrl.CB "+n.BetaServerUrl.CB+"SeviceUrl "+n.ServiceUrl),e("#username").val("posdemo"),e("#password").val("posdemo")),n.isBrowserMode&&this.Focus()},Focus:function(){this.$("#username").focus()},InitializeWorkstation:function(e,i){var o=new l,t=e;o.set("StringValue",i),o.url=n.ServiceUrl+s.POS+r.PREFERENCELOOKUP+t,o.save(o,{success:function(e,o){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.CheckApplicationType(i,o)}.bind(this),error:function(e,i,o){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(i,"Error Retrieving Preference")}.bind(this)})},CheckApplicationType:function(e,i){switch(n.ApplicationType){case"POS":i.Preferences?window.location.hash="dashboard":window.location.hash="settings";break;case"Kiosk":n.POSWorkstationID=e,window.location.hash="kiosk"}},InitializeLocalPreference:function(){this.localpreference=new d,this.localpreference.fetch({isLocalStorage:!0,success:function(e,i){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.CheckDefaultWorkstationID(e)}.bind(this),error:function(e,i,o){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(i,"Error Retrieving Local Preference")}.bind(this)})},InitializeUrlCollection:function(){this.urlcollection=new c,this.urlcollection.fetch({isLocalStorage:!0,success:function(){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.SetDefaultUrl(),this.LoadDefaultUrl()}.bind(this),error:function(e,i,o){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(i,"Error Retrieving URLs")}.bind(this)})},CheckDefaultWorkstationID:function(e){0===e.length?(e.create({WorkstationID:n.DefaultPOSWorkstationID}),console.log(e.toJSON())):(console.log("Exist"),e.each(function(e){e.get("WorkstationID")===n.DefaultPOSWorkstationID&&(n.POSWorkstationID=e.get("WorkstationID"))}))},InitializeConnection:function(){this.connectionview=new p({el:e("#connectionContainer"),collection:this.urlcollection}),this.connectionview.on("Close",this.ConnectionViewClosed,this)},ConnectionViewClosed:function(){n.isBrowserMode&&this.Focus()},LoadDefaultUrl:function(){this.urlcollection.each(this.FindSelectedUrl,this)},FindSelectedUrl:function(e){if(1===this.urlcollection.length){var i=this.urlcollection.last();n.ServiceUrl=i.get("url")}else 1===e.get("isSelected")&&(n.ServiceUrl=e.get("url"),console.log(n.ServiceUrl))},SetDefaultUrl:function(){if(!this.urlcollection||0===this.urlcollection.length){var e=0,i={url:n.BetaServerUrl.CB,isSelected:e};this.urlcollection.create(i)}},ShowClearBtn:function(i){if(i.stopPropagation(),13===i.keyCode)return void this.HideClearBtn();var o=i.target.id,t=e("#"+o).val(),n=t.length,r=e("#"+o).position(),s=e("#"+o).width();n<=0?this.HideClearBtn():null===r&&""===r||(e("#"+o+"ClearTxt").css({top:r.top+8,left:r.left+(s-10)}),e("#"+o+"ClearTxt").fadeIn())},HideClearBtn:function(){e(".clearTextBtn").fadeOut()},ClearPassword:function(){e("#password").val("")},ClearUserText:function(i){var o=i.target.id,t=o.substring(0,o.indexOf("ClearTxt"));e("#"+t).val(""),e("#"+t).focus(),this.HideClearBtn()},Login:function(i){i.preventDefault(),e("#password").blur(),this.ValidateFields()&&(v(),this.DoLogin())},DoLogin:function(e){this.model.url=n.ServiceUrl+s.POS+"signin?isFromAutoSignIn="+h,this.model.save(null,{success:function(e,i){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.ProcessLogin(i)}.bind(this),error:function(i,o,t){return n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e?(m(),void i.RequestError(o,"Login Failed")):void this.DoLogin(!0)}.bind(this)},e),h=!1},RequestError:function(e,i,o){switch(e.statusText){case"timeout":navigator.notification.alert("Request timed out. Check internet settings and try again.",null,i,"OK");break;case"abort":navigator.notification.alert("Unable to process request. Please check your internet settings.",null,i,"OK");break;default:o||(o="The remote server returned an error."),navigator.notification.alert(o,null,i,"OK")}},ProcessLogin:function(i){if(n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),i.ErrorMessage){var o=i.Message||i.ErrorMessage;n.isBrowserMode&&(o=o.replace(/\n/g,"<br />")),navigator.notification.alert(o,null,"Error Logging In","OK"),m()}else{var t=a.GetVersionAttributes(i.AppVersion),r=t.Major+"."+t.Minor;t=t.Major+"."+t.Minor;var s=a.GetVersionAttributes(i.PatchVersion);if(!this.IsVersionCompatible(t)){this.Logout();var l="ConnectedSale and server are not compatible.\n";return l=l+"ConnectedSale Version: "+n.AppVersion+"\n",l=l+"Server Version: "+t,n.isBrowserMode&&(l="ConnectedSale and server are not compatible.<br>",l=l+"ConnectedSale Version: "+n.AppVersion+"<br>",l=l+"Server Version: "+t),navigator.notification.alert(l,null,"Version Incompatibility","OK"),void m()}if(!this.IsPatchCompatible(s,t)){this.Logout();var l="Although Connected Sale supports your backend version, a patch is required before you can continue. <br><br>";return l+="Please contact support for more details.",navigator.notification.alert(l,null,"Version Incompatibility","OK"),void m()}if(n.ServerVersion=t,"Connected Sale"==i.ProductEdition&&!n.IsAllowedUser(i.UserCode)){this.Logout();var l="User is not authorized to log in.";return navigator.notification.alert(l,null,"Access Denied","OK"),void m()}if(i.Message)if(e("#username").blur(),e("#password").blur(),i.Message.indexOf("other location")>0){console.log(i.Message),f=this;var o="You have signed in to other location(s).\n Do you want to sign out from them?";n.isBrowserMode&&(o="You have signed in to other location(s).<br>Do you want to sign out from them?"),navigator.notification.confirm(o,S,"Welcome",["Yes","No"])}else{var o=i.Message;n.isBrowserMode&&(o=i.Message.replace(/\n/g,"<br />")),navigator.notification.alert(o,null,"Welcome","OK")}n.UserInfo=i,n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),r<"18.1"?a.CompareVersions(t,"14.0.0")<2&&(n.IsPatchCompatible=!0):n.IsPatchCompatible=!0,window.location.hash="dashboard",m(),b(),e(".loginFormInput").val("")}},IsVersionCompatible:function(e){var i=a.GetVersionAttributes(e);i=i.Major+"."+i.Minor;var o=0;if(i>="18.1"){if(o=n.isBrowserMode?a.CompareMajorMinorVersions(i,n.MinimumSupportedVersionForDesktop):a.CompareMajorMinorVersions(i,n.MinimumSupportedVersion),o>1){var t=n.AppVersion;if(t!=i)return!1}if(o=a.CompareMajorMinorVersions(i,n.AppVersion),1==o)return!1}else{if(o=n.isBrowserMode?a.CompareVersions(e,n.MinimumSupportedVersionForDesktop):a.CompareVersions(e,n.MinimumSupportedVersion),o>1){var t=n.AppVersion;if(t!=e)return!1}if(o=a.CompareVersions(e,n.AppVersion),1==o)return!1}return!0},IsPatchCompatible:function(e,i){var o=485,t=55,n=e.Interim,r=a.GetVersionAttributes(i);if(r=r.Major+"."+r.Minor,r>="18.1"){if(2==a.CompareMajorMinorVersions(r,"14.0"))return!0;if(i=a.GetVersionAttributes(i),14==i.Major&&0==i.Minor){if(n<o)return!1}else if(14==i.Major&&0==i.Minor&&1==i.Build&&n<t)return!1}else{if(2==a.CompareVersions(i,"14.0.0"))return!0;if(i=a.GetVersionAttributes(i),14==i.Major&&0==i.Minor&&0==i.Build){if(n<o)return!1}else if(14==i.Major&&0==i.Minor&&1==i.Build&&n<t)return!1}return!0},ValidateFields:function(){return n.Username=e("#username").val().trim(),n.Password=e("#password").val(),n.ServiceUrl&&""!==n.ServiceUrl?n.Username?!!n.Password||(navigator.notification.alert("Password is required.",null,"Login Failed","OK"),!1):(navigator.notification.alert("Username is required.",null,"Login Failed","OK"),!1):(this.Connect(),!1)},Connect:function(i){i&&i.preventDefault(),e("#username").blur(),e("#password").blur(),this.connectionview.Show(),e(".loginFormInput").attr("disabled","disabled"),e(".loginFormButton").addClass("ui-disabled"),e("#loginForm").fadeTo("fast",.3)},OpenWebsite:function(e){e.preventDefault(),navigator.notification.confirm("You will be redirected to Connected Business website.",C,"Are you sure you want to Continue?","Yes,No")},Password_keyup:function(i){13===i.keyCode&&(e("#password").blur(),this.HideClearBtn(),this.Login(i))},ForceSignOutOtherLocations:function(){var e=new l;e.url=n.ServiceUrl+s.POS+r.FORCESIGNOUT,e.save(null,{success:function(e,i){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),console.log("Force SignOut - Success")},error:function(e,i,o){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),console.log("Force SignOut - Error")}})},Logout:function(){var e=new l;e.url=n.ServiceUrl+s.POS+r.SIGNOUT,e.save(null,{success:function(){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),console.log("Log-out Success")},error:function(e,i){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),console.log("Log-out Error")}},!0)}}),v=function(){var i=document.getElementById("login-btn");_spinner=g,_spinner.opts.left=10,_spinner.opts.radius=3,_spinner.opts.lines=9,_spinner.opts.length=4,_spinner.opts.width=3,_spinner.opts.color="#000",_spinner.spin(i,"Logging in..."),e("#login-btn .ui-btn-text").text("Logging in..."),e("#login-btn").css("text-align","right"),e("#login-btn").addClass("ui-disabled"),e("#connection-btn").addClass("ui-disabled"),e("#username").addClass("ui-disabled"),e("#password").addClass("ui-disabled")},b=function(){_spinner=g,_spinner.stop()},m=function(){e("#login-btn .ui-btn-text").text("Log in"),e("#login-btn").css("text-align","center"),b(),e("#login-btn").removeClass("ui-disabled"),e("#connection-btn").removeClass("ui-disabled"),e("#username").removeClass("ui-disabled"),e("#password").removeClass("ui-disabled")},C=function(e){1===e&&window.location.replace("http://connectedbusiness.com/pos.html")},S=function(e){1===e&&f.ForceSignOutOtherLocations()};return w});