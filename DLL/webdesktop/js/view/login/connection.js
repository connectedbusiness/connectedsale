define(["jquery","mobile","underscore","backbone","shared/global","shared/shared","shared/service","shared/method","model/base","view/login/url","view/spinner","text!template/login/connection.tpl.html"],function(e,t,i,n,r,o,s,l,c,a,d,u){var h={Show:function(){e("#connection-overlay").show()},Hide:function(){e("#connection-overlay").hide()}},v=n.View.extend({_template:i.template(u),events:{"tap #serviceUrl":"showClear_tap","tap #done-url":"closeForm_tap","blur #serviceUrl":"hideClear_blur","keyup #serviceUrl":"input_keyup","tap #serviceUrlClearBtn":"clearInput_tap","tap #addconnection-btn":"addInput_tap"},LockConnectionScreen:function(t,i){t?(h.Show(),e("#serviceUrl").blur(),target=document.getElementById("connectionForm"),this.ShowActivityIndicator(target),e("<h5>"+i+"</h5>").appendTo(e("#spin"))):(h.Hide(),this.HideActivityIndicator())},ShowActivityIndicator:function(t){t||(t=document.getElementById("connectionForm")),e("<div id='spin'></div>").appendTo(t);var i=document.getElementById("spin");_spinner=d,_spinner.opts.color="#fff",_spinner.opts.lines=13,_spinner.opts.length=7,_spinner.opts.width=4,_spinner.opts.radius=10,_spinner.opts.top="auto",_spinner.opts.left="auto",_spinner.spin(i)},HideActivityIndicator:function(){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),_spinner=d,_spinner.stop(),e("#spin").remove()},initialize:function(){this.$el.html(this._template),this.$el.trigger("create"),this.Hide(),e("body, html").on("tap",this.outsideMenuHandler),this.collection.on("selected",this.SetDefault,this),this.collection.on("removeUrl",this.RemoveUrl,this),this.collection.on("editUrl",this.EditUrl,this)},addInput_tap:function(e){this.ProcessAdd()},clearInput_tap:function(t){var i=t.target.id,n=i.substring(0,i.indexOf("ClearBtn"));e("#"+n).val(""),this.HideClearBtn()},closeForm_tap:function(e){e.preventDefault(),this.CheckCollectionStatus()},hideClear_blur:function(){this.ChangeButton(),e(".clearTextBtn").fadeOut()},input_keyup:function(e){e.preventDefault(),13===e.keyCode?this.ProcessAdd():this.showClear_tap(e)},outsideMenuHandler:function(){e(".deletebtn-overlay").hide()},showClear_tap:function(t){t.stopPropagation();var i=t.target.id,n=e("#"+i).val(),r=n.length,o=e("#"+i).position(),s=e("#"+i).width();r<=0?this.hideClear_blur():null===o&&""===o||(e("#"+i+"ClearBtn").css({top:o.top+15,left:o.left+(s-18)}),e("#"+i+"ClearBtn").show())},AddServiceUrl:function(){r.isBrowserMode||this.CheckIfOnline(),this.ResetSelected(),this.SaveUrl()},ChangeButton:function(t){switch(t){case"Save":e("#done-url").text("Save"),e("#done-url").attr("id","save-url");break;case"Edit":e("#addconnection-btn > i").removeClass("icon-plus"),e("#addconnection-btn > i").addClass("icon-save");break;case"Add":e("#addconnection-btn > i").removeClass("icon-save"),e("#addconnection-btn > i").addClass("icon-plus");break;default:e("#save-url").text("Done"),e("#save-url").attr("id","done-url")}},CheckDefaultUrl:function(){var e=this.collection.find(function(e){return 1===e.get("isSelected")});e||this.SetSelected()},CheckCollectionStatus:function(){return 0===this.collection.length?void(o.IsNullOrWhiteSpace(e("#serviceUrl").val())?navigator.notification.alert("Specify a Service URL in order to proceed.",null,"URL is Required","OK"):(this.AddServiceUrl(),this.Close())):(o.IsNullOrWhiteSpace(e("#serviceUrl").val())||(this.mode===r.MaintenanceType.CREATE?this.AddServiceUrl():this.UpdateServiceUrl()),void this.Close())},CheckDupe:function(){var t=this.FindUrl(r.ServiceUrl);if(t)navigator.notification.alert("Service URL already exists.",null,"URL Exists","OK"),e("#serviceUrl").val("");else{var i={url:r.ServiceUrl,isSelected:0};this.collection.create(i,{error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error adding service URL")},success:function(){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()}}),this.SetSelected(),this.ChangeButton()}},CheckIfOnline:function(){var e=navigator.onLine;e||navigator.notification.alert("Unable to process request. Please check your internet settings.",null,"Connection Error","OK")},CheckLimit:function(){if(this.collection.length>5){var e=this.collection.first();e.destroy()}},ClearServiceUrl:function(){e("#serviceUrl").val(""),this.isClear=null},Close:function(){e("#serviceUrl").blur(),this.mode=r.MaintenanceType.CREATE,this.ChangeButton("Add"),this.$el.hide(),e(".loginFormInput").removeAttr("disabled"),e(".loginFormButton").removeClass("ui-disabled"),e("#loginForm").fadeTo("fast",1),e("#loginBg").fadeTo("fast",1),this.trigger("Close")},EditUrl:function(t){this.mode=r.MaintenanceType.UPDATE,this.toBeEdited=t,this.ChangeButton("Edit"),e("#serviceUrl").val(t.get("url"))},FindUrl:function(e){if(!o.IsNullOrWhiteSpace(e)){var t=this,i=this.collection.find(function(i){var n=i.get("url").toUpperCase()===e.toUpperCase();return n&&(i.set("isSelected",1),t.SetDefault(i)),n});if(i)return!0}return!1},Hide:function(){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.$el.hide()},LoadUrl:function(){var e=this;this.collection.fetch({isLocalStorage:!0,error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Loading default URL")},success:function(){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.SetDefaultUrl()}})},ProcessAdd:function(){return this.mode===r.MaintenanceType.UPDATE&&this.collection.length>=1?void this.UpdateServiceUrl():void this.AddServiceUrl()},RemoveCheckImage:function(e){this.RenderUrlView()},RemoveUrl:function(e){this.isClear=!1,r.isBrowserMode||this.CheckIfOnline(),1===this.collection.length&&(r.ServiceUrl="");var t=e.get("isSelected");e.destroy(),t&&this.SetFirstUrlAsDefault()},RenderUrlView:function(t){e("#urlContainer").append("<div id='urlMainContainer'></div>"),this.urlview&&(this.urlview.remove(),this.urlview.unbind(),this.urlview=null),this.urlview=new a({el:e("#urlMainContainer"),collection:this.collection}),e("#serviceUrl-div > #serviceUrl").focus(),void 0===t&&this.ClearServiceUrl()},ResetSelected:function(){this.collection.each(this.ResetSelectedUrl,this)},ResetSelectedUrl:function(t){t.save({isSelected:0},{success:function(t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e("#urlList").attr("ui-disabled")},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error setting default URL")}})},ResetTextColor:function(t){e("#urlList li").css({"font-weight":"normal",color:"#000"}),e("#"+t.get("id")).css({"font-weight":"bold",color:"#324f85"})},SaveUrl:function(){var e=this.TrimServiceUrl();return e===!1?void navigator.notification.alert("URL specified is invalid. Please try again.",null,"Invalid URL","OK"):o.IsNullOrWhiteSpace(e)?void navigator.notification.alert("Specify a Service URL in order to proceed.",null,"URL is Required","OK"):void this.CheckIfActiveURL(e)},DoSaveUrl:function(e){if(r.ServiceUrl=e,this.mode==r.MaintenanceType.CREATE)this.CheckLimit(),this.CheckDupe(),this.RenderUrlView(),this.mode=r.MaintenanceType.CREATE,this.LoadUrl(),this.SetDefaultCredentials(),console.log(this.collection.length);else{try{this.ResetSelected(),this.toBeEdited.save({url:e,isSelected:1},{success:function(){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()}}),this.RenderUrlView()}catch(t){this.mode=r.MaintenanceType.CREATE,this.AddServiceUrl()}this.toBeEdited=null}this.mode=r.MaintenanceType.CREATE,this.ChangeButton("Add"),r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()},CheckIfActiveURL:function(e){this.LockConnectionScreen(!0,"Validating URL Service");var t=this;r.Username="",r.password="";var i=new c;i.url=e+s.POS+"signin?isFromAutoSignIn=false",i.save(null,{success:function(i,n){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.LockConnectionScreen(!1),t.DoSaveUrl(e)},error:function(e,i,n){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.LockConnectionScreen(!1),navigator.notification.alert("The Service URL entered is not active.",null,"Inactive Service URL","OK")}},!0)},SetDefault:function(t){this.collection.length>=1&&(r.isBrowserMode||this.CheckIfOnline(),this.ResetSelected(t),t.save({isSelected:1}),this.RenderUrlView(this.isClear),r.ServiceUrl=t.get("url"),this.mode===r.MaintenanceType.UPDATE&&(e("#serviceUrl").val(""),this.ChangeButton("Add"),this.mode=r.MaintenanceType.CREATE),this.ChangeButton(),this.SetDefaultCredentials())},SetDefaultCredentials:function(){e("#username").val(""),e("#password").val(""),r.BetaServerUrl.CB==r.ServiceUrl&&(e("#username").val("admin"),e("#password").val("admin"))},SetDefaultUrl:function(){if(!this.collection||0===this.collection.length){var e={url:r.BetaServerUrl.CB,isSelected:0};this.collection.create(e),r.ServiceUrl=r.BetaServerUrl.CB,this.SetSelected()}this.CheckDefaultUrl(),this.CheckLimit(),this.RenderUrlView()},SetFirstUrlAsDefault:function(){var e=this.collection.last();this.SetDefault(e),this.mode=r.MaintenanceType.CREATE},SetSelected:function(){this.collection.each(function(e){var t=this.collection.last();e===t?e.save({isSelected:1},{success:function(e){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error setting default URL")}}):e.save({isSelected:0},{success:function(e){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error setting default URL")}})},this)},Show:function(){this.$el.show(),this.LoadUrl(),r.isBrowserMode&&e("#serviceUrl").focus()},TrimServiceUrl:function(){var t=e("#serviceUrl").val().trim();if(""!=t){var i=0!==t.indexOf("http://"),n=0!==t.indexOf("https://"),r=0!==t.indexOf("http:/"),o=0!==t.indexOf("https:/");if(!r&&i?t=t.replace("http:/",""):!o&&n&&(t=t.replace("https:/","")),i&&n&&(t="http://"+t),"/"!=t.charAt(t.length-1))t+="/";else{for(var s=t.length-1,l=s;l>0;l--)t=t.slice(0,-1),t=t.trim(),"/"!=t.charAt(t.length-1)&&(l=0);t+="/"}if(!this.CheckURL(t))return!1}return t},CheckURL:function(e){var t=new RegExp("^(http|https|ftp)://([a-zA-Z0-9.-]+(:[a-zA-Z0-9.&amp;%$-]+)*@)*((25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]).(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0).(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0).(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])|([a-zA-Z0-9-]+.)*[a-zA-Z0-9-]+.(com|edu|gov|int|mil|net|org|biz|arpa|info|name|pro|aero|coop|museum|[a-zA-Z]{2}))(:[0-9]+)*(/($|[a-zA-Z0-9.,?'\\+&amp;%$#=~_-]+))*$");return!!t.test(e)},UpdateServiceUrl:function(){var t=this.TrimServiceUrl(),i=this.FindUrl(t);return t===!1?(navigator.notification.alert("The specified URL is invalid. Please try again.",null,"Invalid URL","OK"),void e("#serviceUrl").val("")):o.IsNullOrWhiteSpace(t)?void navigator.notification.alert("Specify a Service URL in order to proceed.",null,"URL is Required","OK"):i?(navigator.notification.alert("Service URL already exists.",null,"URL Exists","OK"),void e("#serviceUrl").val(this.toBeEdited.attributes.url)):void this.CheckIfActiveURL(t)}});return v});