define(["jquery","mobile","underscore","backbone","shared/global","shared/service","shared/method","shared/enum","shared/shared","model/lookupcriteria","collection/transactions","view/22.0.0/pos/transactions/transaction","view/22.0.0/pos/transactions/options","view/spinner","text!template/22.0.0/pos/transactions/transactions.tpl.html","text!template/22.0.0/pos/transactions/transactionlist.tpl.html","js/libs/format.min.js","js/libs/iscroll.js"],function(e,t,i,n,a,o,s,r,c,h,d,p,l,u,k,b){var f=!1,g=n.View.extend({_template:i.template(k),_transactionsTemplate:i.template(b),events:{"tap .right-popover-btn":"btnClose_tap","keypress #transactions-search":"inputTransactionsSearch_keyPress","tap #btnSales":"btnSales_tap","tap #btnOrders":"btnOrders_tap","tap #btnPicknote":"btnPickNote_tap","tap #btnQuotes":"btnQuotes_tap","tap #btnReturns":"btnReturns_tap","tap #btnSuspend":"btnSuspended_tap","blur #transactions-search":"HideClearBtn","tap #transactions-searchClearBtn":"ClearText","tap #transactions-search":"ShowClearBtn","change #transaction-date":"TransactionDateOnChange","blur #transaction-date":"TransactionDateOnBlur","tap #btnSearch":"InitializeFetchData","tap #chkOption":"OptionChange","tap #picking-pending":"onPickupPending_Tap","tap #picking-inprogress":"onPickupInProgress_Tap","tap #picking-confirmed":"onPickupConfirmed_Tap"},initialize:function(){this.firstTymLoaded=!0,this.pickUpStage=this.options.pickUpStage||0,this.clearDateOnLoad=!!this.options.clearDateOnLoad,this.collection.bind("selected",this.TransactionSelected,this),this.render(),this.InitializeFetchData()},TransactionDateOnBlur:function(){a.isBrowserMode||""==e("#transaction-date").val()&&this.FilterByDate()},TransactionDateOnChange:function(){a.isBrowserMode?this.FilterByDate():""!=e("#transaction-date").val()&&this.FilterByDate()},ToggleSelectedTransaction:function(){switch(e("#reviewTransactions-footer .transaction-Type").removeClass("active-transaction-type"),a.LookupMode){case r.LookupMode.Invoice:e("#btnSales").addClass("active-transaction-type");break;case r.LookupMode.Order:this.pickUpStage=this.pickUpStage||0,0==this.pickUpStage?e("#btnOrders").addClass("active-transaction-type"):e("#btnPicknote").addClass("active-transaction-type");break;case r.LookupMode.Quote:e("#btnQuotes").addClass("active-transaction-type");break;case r.LookupMode.Return:e("#btnReturns").addClass("active-transaction-type");break;case r.LookupMode.Suspend:e("#btnSuspend").addClass("active-transaction-type")}},render:function(){this.$el.html(this._template()),a.Preference.IsTrackStorePickUp||(this.$el.find("#btnBuffer").show(),this.$el.find("#btnPicknote").hide()),f=!1,this.SetSelectedTransaction(),this.ToggleSelectedTransaction(),c.BrowserModeDatePicker("#transaction-date","datepicker"),this.InitializeTransactionDate(),e("#main-transaction-blockoverlay").show(),a.isBrowserMode&&e("#transactions-search").focus()},SetSelectedTransaction:function(){switch(this.optionsView=null,a.LookupMode){case r.LookupMode.Invoice:e(".btn-sales-alpha").show(),e(".btn-orders-alpha").hide(),e(".btn-picknote-alpha").hide(),e(".btn-forpickup-alpha").hide(),e(".btn-quotes-alpha").hide(),e(".btn-returns-alpha").hide(),e(".btn-suspend-alpha").hide(),e("#btn-sales img").attr({src:"img/sales_r@2x.png"}),e(".invoices-tableheader").show(),e(".orders-tableheader").hide(),e(".returns-tableheader").hide(),e(".suspend-tableheader").hide();break;case r.LookupMode.Order:e(".btn-sales-alpha").hide(),e(".btn-picknote-alpha").hide(),e(".btn-forpickup-alpha").hide(),e(".btn-orders-alpha").hide(),e(".btn-orders-alpha").show(),e("#btn-orders img").attr({src:"img/orders_r@2x.png"}),e(".btn-quotes-alpha").hide(),e(".btn-returns-alpha").hide(),e(".btn-suspend-alpha").hide(),e(".invoices-tableheader").hide(),e(".orders-tableheader").show(),e(".returns-tableheader").hide(),e(".suspend-tableheader").hide();break;case r.LookupMode.Quote:e(".btn-sales-alpha").hide(),e(".btn-orders-alpha").hide(),e(".btn-picknote-alpha").hide(),e(".btn-forpickup-alpha").hide(),e(".btn-quotes-alpha").show(),e(".btn-returns-alpha").hide(),e(".btn-suspend-alpha").hide(),e("#btn-quotes img").attr({src:"img/quotes_r@2x.png"}),e(".invoices-tableheader").hide(),e(".orders-tableheader").show(),e(".returns-tableheader").hide(),e(".suspend-tableheader").hide();break;case r.LookupMode.Return:e(".btn-sales-alpha").hide(),e(".btn-orders-alpha").hide(),e(".btn-picknote-alpha").hide(),e(".btn-forpickup-alpha").hide(),e(".btn-quotes-alpha").hide(),e(".btn-returns-alpha").show(),e(".btn-suspend-alpha").hide(),e("#btn-returns img").attr({src:"img/returns_r@2x.png"}),e(".invoices-tableheader").hide(),e(".orders-tableheader").hide(),e(".returns-tableheader").show(),e(".suspend-tableheader").hide();break;case r.LookupMode.Suspend:e(".btn-sales-alpha").hide(),e(".btn-orders-alpha").hide(),e(".btn-picknote-alpha").hide(),e(".btn-forpickup-alpha").hide(),e(".btn-quotes-alpha").hide(),e(".btn-returns-alpha").hide(),e(".btn-suspend-alpha").show(),e("#btn-suspend img").attr({src:"img/suspended_r@2x.png"}),e(".invoices-tableheader").hide(),e(".orders-tableheader").hide(),e(".returns-tableheader").hide(),e(".suspend-tableheader").show()}},OptionChange:function(){f=c.CustomCheckBoxChange("#chkOption",f),console.log(f),this.InitializeFetchData()},Close:function(){this.Hide(),e("#main-transaction-blockoverlay").hide(),c.FocusToItemScan()},Show:function(){f=!1,this.firstTymLoaded=!0,this.render(),this.InitializeTransactionDate(),this.InitializeFetchData(),this.$el.show(),c.BrowserModeDatePicker("#transaction-date","datepicker","",!0)},InitializeTransactionDate:function(){if(this.clearDateOnLoad)return void this.$("#transaction-date").val("");if(a.isBrowserMode){var e=new Date;this.$("#transaction-date").val(this.JSONtoDate(e))}},Hide:function(){this.$el.hide()},JsonToAspDate:function(e){var t=Date.parse(e),i=new Date(t),n=i.getMonth(),a=i.getDate(),o=i.getFullYear();return i=Date.UTC(o,n,a),i="/Date("+i+")/"},JSONtoDate:function(e){var t="MM/DD/YYYY",i=moment(e).format(t);return i},InitializeFetchData:function(){var t=e("#transactions-search").val(),i=e("#transaction-date").val();c.IsNullOrWhiteSpace(i)||(i=this.JsonToAspDate(i)),this.FetchData(t,i)},FilterByDate:function(){this.InitializeFetchData()},TogglePickupFilter:function(t){return 0==t?void e("#picking-filter").hide():(e("#picking-filter").show(),e("#picking-filter span").removeClass("active-filter"),1==t&&e("#picking-filter #picking-pending").addClass("active-filter"),2==t&&e("#picking-filter #picking-inprogress").addClass("active-filter"),void(3==t&&e("#picking-filter #picking-confirmed").addClass("active-filter")))},FetchData:function(t,i){var n,d,p=this,l=new h,u="100",k="",b=f;this.isFetching=!0,this.clearDateOnLoad=!1,t||(t=""),b&&(k=a.CustomerCode),d=i?1:0,l.set({CustomerCode:k,CriteriaString:t,DateTimeTicks:d,IsTrackStorePickUp:a.Preference.IsTrackStorePickUp}),c.IsNullOrWhiteSpace(i)||l.set({DateFilter:i});var g=this.pickUpStage||0;switch(this.TogglePickupFilter(g),a.LookupMode==r.LookupMode.Order&&g>0&&l.set({PickupStage:g,WarehouseCode:a.Preference.DefaultLocation}),a.LookupMode){case r.LookupMode.Invoice:n=a.ServiceUrl+o.SOP+s.INVOICELOOKUP+u,a.LookupMode=r.LookupMode.Invoice,l.set({IsPosted:!0});break;case r.LookupMode.Order:n=a.ServiceUrl+o.SOP+s.ORDERLOOKUP+u,a.LookupMode=r.LookupMode.Order;break;case r.LookupMode.Quote:n=a.ServiceUrl+o.SOP+s.QUOTELOOKUP+u,a.LookupMode=r.LookupMode.Quote;break;case r.LookupMode.Return:n=a.ServiceUrl+o.SOP+s.RETURNLOOKUP+u,a.LookupMode=r.LookupMode.Return;break;case r.LookupMode.Suspend:n=a.ServiceUrl+o.SOP+s.INVOICELOOKUP+u,a.LookupMode=r.LookupMode.Suspend,l.set({IsPosted:!1})}this.ShowActivityIndicator(),e("<h5>Loading...</h5>").appendTo(e("#spin")),this.$("#reviewTransactions-content").html(""),this.$("#reviewTransactions-content").append(this._transactionsTemplate()),l.url=n,l.save(null,{success:function(e,t){a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),p.AddAllTransactionToList(e,t,p),p.RefreshScroll(),p.isFetching=!1},error:function(e,t,i){a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),p.HideActivityIndicator(),p.isFetching=!1,e.RequestError(t,"Error Loading Transactions")}})},AddAllTransactionToList:function(t,i,n){if(i){var o;i.PrintPickNoteCount;switch(a.LookupMode){case r.LookupMode.Invoice:o=i.Invoices;break;case r.LookupMode.Order:o=i.SalesOrders;break;case r.LookupMode.Quote:o=i.SalesOrders;break;case r.LookupMode.Return:o=i.Returns;break;case r.LookupMode.Suspend:o=i.Invoices}this.collection.reset(o),this.CalculateResultsAndTotal(),this.collection.each(this.AddOneTransactionToList,this),a.isBrowserMode&&e("#transactions-search").focus()}this.HideActivityIndicator(),0===this.collection.length?(this.$(".table-caption").html("No Data Found."),this.$(".table-caption").show()):(this.$(".table-caption").html(""),this.$(".table-caption").hide()),this.firstTymLoaded&&this.notifyPickingNoteIsOn&&a.CustomerPreference.IsRequirePickingNote&&i.PrintPickNoteCount>0&&(this.notifyPickingNoteIsOn=!1,this.firstTymLoaded=!1,this.NotifyMsg("Require picking note configuration for Sales Order in Customer Preference of Connected Business is enabled. There are order transactions that will not appear in Transaction List.","Require picking note"))},RemoveModelByOrderCode:function(e,t){if(this.collection){var i;this.collection.each(function(n){var a=n.get("SalesOrderCode")==e,o=n.get("Stage");(a&&!t||a&&t&&1==o)&&(n.trigger("destroy-view"),i=n)}),i&&this.collection.remove(i)}},CalculateResultsAndTotal:function(){var e=0;a.LookupMode!=r.LookupMode.Return?(this.collection.each(function(t){var i=0;i=parseFloat(t.get("BalanceRate")),e+=i}),this.$("#transaction-total").show(),this.$("#transaction-total").text("Total Balance : "+a.CurrencySymbol+" "+format("#,##0.00",e))):this.$("#transaction-total").hide(),this.$("#transaction-result").text("Results : "+this.collection.length)},RefreshScroll:function(){var e=this;return a.isBrowserMode?void c.UseBrowserScroll("#reviewTransactions-list"):(c.IsNullOrWhiteSpace(this.myScroll)||this.myScroll.destroy(),this.myScroll=new iScroll("reviewTransactions-list",{vScrollbar:!0,vScroll:!0,snap:!1,momentum:!0,onScrollMove:function(){e.$(".div-options").hide()},onScrollEnd:function(){e.$(".div-options").hide()}}),void this.myScroll.refresh())},AddOneTransactionToList:function(e){var t=new p({model:e});this.$("#reviewTransactions-content tbody").append(t.render().el)},TransactionSelected:function(e,t,i){this.ShowOptions(e,t,i)},ShowOptions:function(e,t,i){this.optionsView||(this.optionsView=new l,this.$(".div-options").append(this.optionsView.render().el)),this.$(".div-options").show(),this.optionsView.Show(e,t,i,{PickupStage:this.pickUpStage})},btnClose_tap:function(t){t.preventDefault(),e("#transactions-search").blur(),a.IsPosted=!0,this.trigger("userclosedform",this),this.Close()},inputTransactionsSearch_keyPress:function(e){13===e.keyCode?this.InitializeFetchData():this.ShowClearBtn(e)},btnSales_tap:function(e){e.preventDefault(),this.isFetching||(a.LookupMode=r.LookupMode.Invoice,this.pickUpStage=0,a.IsPosted=!0,this.render(),this.InitializeFetchData())},btnOrders_tap:function(e){e.preventDefault(),this.isFetching||(a.LookupMode=r.LookupMode.Order,this.pickUpStage=0,this.render(),this.notifyPickingNoteIsOn=!0,this.InitializeFetchData())},onPickupPending_Tap:function(e){this.btnPickNote_tap(e,1)},onPickupInProgress_Tap:function(e){this.btnPickNote_tap(e,2)},onPickupConfirmed_Tap:function(e){this.btnPickNote_tap(e,3)},btnPickNote_tap:function(e,t){e.preventDefault(),t=t||1,this.isFetching||(this.clearDateOnLoad=!0,a.LookupMode=r.LookupMode.Order,this.pickUpStage=t,this.render(),this.firstTymLoaded=!1,this.InitializeFetchData()),this.trigger("update-pickup-count")},btnForPickup_tap:function(e){e.preventDefault(),this.isFetching||(a.LookupMode=r.LookupMode.Order,this.pickUpStage=0,this.render(),this.firstTymLoaded=!1,this.InitializeFetchData()),this.trigger("update-pickup-count")},btnQuotes_tap:function(e){e.preventDefault(),this.isFetching||(a.LookupMode=r.LookupMode.Quote,this.pickUpStage=0,this.render(),this.InitializeFetchData())},btnSuspended_tap:function(e){e.preventDefault(),this.isFetching||(a.LookupMode=r.LookupMode.Suspend,a.TransactionType=r.LookupMode.Suspend,a.IsPosted=!1,this.pickUpStage=0,this.render(),this.InitializeFetchData())},btnReturns_tap:function(e){e.preventDefault(),this.isFetching||(a.LookupMode=r.LookupMode.Return,this.pickUpStage=0,this.render(),this.InitializeFetchData())},checkbox_change:function(){this.InitializeFetchData()},ShowActivityIndicator:function(){e("#spin").remove(),e("<div id='spin'></div>").appendTo(this.$("#reviewTransactions-inner"));var t=document.getElementById("spin");this._spinner=u,this._spinner.opts.color="#fff",this._spinner.opts.lines=13,this._spinner.opts.length=7,this._spinner.opts.width=4,this._spinner.opts.radius=10,this._spinner.opts.top="auto",this._spinner.opts.left="auto",this._spinner.spin(t)},HideActivityIndicator:function(){e("#spin").remove(),this._spinner=u,this._spinner.stop()},ShowClearBtn:function(t){t.stopPropagation();var i=t.target.id,n=e("#"+i).val(),a=n.length;console.log(i),a<=0?this.HideClearBtn():(e("#"+i+"ClearBtn").css({top:"68px",right:"80px"}),e("#"+i+"ClearBtn").show())},HideClearBtn:function(){e(".clearTextBtn").fadeOut()},ClearText:function(t){var i=t.target.id,n=i.substring(0,i.indexOf("ClearBtn"));e("#"+n).val(""),this.HideClearBtn()},NotifyMsg:function(e,t){navigator.notification.alert(e,null,t,"OK")}});return g});