define(["jquery","mobile","underscore","backbone","base64","shared/global","shared/shared","model/base","view/22.0.0/settings/general/email/formats","text!template/22.0.0/settings/general/email/email.tpl.html","text!template/22.0.0/settings/general/email/defaultmessage.tpl.html","js/libs/iscroll.js"],function(e,t,i,a,s,n,o,l,r,d,m){var c=a.View.extend({events:{"keydown #main-body-source":"onTextKeydown","change #main-body-source":"onMainBodySource_Change"},_template:i.template(d),_defaultMessageTemplate:i.template(m),initialize:function(){e("#settings-location-search").remove(),this.render()},render:function(){e("#back-general").show(),this.$el.html(this._template);var t=Base64.decode(this.model.get("B64EmailTemplate")||"");t&&""!=(t||"").trim()?(this.$el.find("#main-body-source").text(t),this.updateModel()):this.useDefaultTemplate(),this.$el.trigger("create"),this.initFormattingTools(),this.refreshIScroll(),this.changeModalSize()},useDefaultTemplate:function(){this.$el.find("#main-body-source").val(this._defaultMessageTemplate()),this.updateModel()},refreshIScroll:function(){},initFormattingTools:function(){this.formatsView||(this.formatsView=new r({el:"#formatting-controls",editor:e("#editor")})),this.formatsView.on("update-model",this.updateModel,this),this.formatsView.on("save-changes",this.savePreference,this),this.formatsView.on("reset-template",this.resetTemplate,this)},resetTemplate:function(){var e=this;navigator.notification.confirm("Are you sure you want to reset email template to default?",function(t){1==t&&e.useDefaultTemplate()},"Reset Template","Yes,No")},onMainBodySource_Change:function(e){this.updateModel()},onTextKeydown:function(e){if(9==e.keyCode||9==event.which){e.preventDefault();var t=e.target,i=t.selectionStart;t.value=t.value.substring(0,t.selectionStart)+"\t"+t.value.substring(t.selectionEnd),t.selectionEnd=i+1}},updateModel:function(){var e=this.$el.find("#main-body-source").val()||"";e=Base64.encode(e),this.model.set({B64EmailTemplate:e}),this.refreshIScroll()},validateFields:function(){var t=this.$el.find(".cs-field");if(t&&t.length>0)for(var i=1;i<=t.length;){var a=e(t[i-1]),s=a.html()||"",n=a.attr("cs-field-value")||"";s.length>n.length?a.text(n):n!=s&&a.remove(),i++}},savePreference:function(e,t){this.updateModel();var i=this,a=new l;a.url=n.ServiceUrl+"System/maintainpickupemailpreference/",a.set(i.model.attributes),a.save(a,{success:function(i,a){return a.ErrorMessage?(o.ShowNotification(a.ErrorMessage,!0),void(t&&t())):void(e&&e())},error:function(e,i,a){o.ShowNotification("Error saving email template.",!0),t&&t()}})},changeModalSize:function(){e("#settings-modal-container").addClass("settings-modal-email-template"),e("#settings-modal").css("width","auto")}});return c});