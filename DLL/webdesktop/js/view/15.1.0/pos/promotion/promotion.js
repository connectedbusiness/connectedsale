define(["jquery","mobile","underscore","backbone","model/base","collection/base","shared/global","shared/service","shared/shared","shared/method","shared/enum","view/15.1.0/pos/promotion/promotionlist","text!template/15.1.0/pos/promotion/promotion.tpl.html","view/15.1.0/pos/promotion/promotionitemlist","js/libs/iscroll.js"],function(e,t,o,i,n,s,r,l,c,m,d,h,a,u){var f=i.View.extend({template:o.template(a),rules:new s,events:{"click #close":"close"},initialize:function(){this.$el.html(this.template({})),this.getPromoItems(this.collection),this.getPromoItems2(this.options.promoitems)},render:function(){return e("#main-transaction-blockoverlay").show(),this},close:function(){var t=new s(this.collection.filter(function(e){return 1==e.get("IsSelected")}.bind(this)));this.collection.each(function(e){this.options.promoitems.each(function(t){e.get("GetItemCode")==t.get("GetItemCode")&&1==e.get("IsSelected")&&t.set("IsSelected",!0)})}.bind(this));var o=new s(this.options.promoitems.filter(function(e){return 1==e.get("IsSelected")}.bind(this))),i=new n,l=new n;this.collection.each(function(e){0==e.get("IsSelected")&&(i=e),l.url=r.ServiceUrl+"Transactions/DeleteNotIncludedItems?PromoDocumentCode="+i.get("PromoDocumentCode")+"&GetItemCode="+i.get("ItemCode"),l.save(null,{})}),this.trigger("getPromoItems",t,o),e("#main-transaction-blockoverlay").hide(),this.unbind(),this.remove()},getPromoItems:function(t){var i=this;i.rules=new s,t.each(function(e){e.set("IsSelected",!1),i.renderPromoPerItem(e)}),this.rules.on("resetSelected",function(){var t=this.$("ul").children();o.each(t,function(t){e(t).removeClass("selected")})}.bind(this))},getPromoItems2:function(t){var i=this;i.rules=new s,t.each(function(e){e.set("IsSelected",!1)}),this.rules.on("resetSelected",function(){var t=this.$("ul").children();o.each(t,function(t){e(t).removeClass("selected")})}.bind(this))},renderPromoPerItem:function(e){var t=new h({model:e,collection:this.collection});this.$("#promo-form-list").find("ul").append(t.render().el),t.setSelected(e.cid)}});return f});