define(["jquery","mobile","underscore","backbone","bigdecimal","shared/enum","shared/global","shared/shared","shared/service","shared/method","view/19.2.0/pos/reason/itemreason","view/19.2.0/pos/manageroverride/manageroverride","model/lookupcriteria","model/reason","model/override","model/base","collection/reasons","collection/base","text!template/19.2.0/pos/cart/cartItem.tpl.html","js/libs/format.min.js"],function(e,t,i,n,a,o,s,r,c,u,l,d,h,p,m,f,g,y,T){var v={Discount:"Discount",Price:"SalesPriceRate",Quantity:"QuantityOrdered"},I={Price:" #changePrice-input ",Qauntity:" #changeQuantity-input ",Discount:" #changeDiscount-input "},C=n.View.extend({_template:i.template(T),tagName:"tbody",events:{"swipeleft td":"td_swipeleft","swiperight td":"td_swiperight","tap .remove-itembutton":"removeItem_tap","tap #display-kit":"displayKit"},resetItemTapEvents:function(){this.$("#"+this.model.cid).find(".itemName").find("#display-itemName").off("tap").on("tap",function(e){this.itemName_tap(e)}.bind(this))},displayKit:function(t){t.stopImmediatePropagation();var i=this.model.get("ItemCode")+"-"+this.model.get("LineNum"),n=e("#kit-"+i);n.is(":hidden")?(n.show().fadeIn("slow"),this.$(t.currentTarget).find("i").attr("class","icon-chevron-up")):(n.hide().fadeOut("slow"),this.$(t.currentTarget).find("i").attr("class","icon-chevron-down"))},bindEvents:function(){e("#kit-"+this.model.get("ItemCode")+"-"+this.model.get("LineNum")).find("#kit-edit").on("tap",function(e){e.preventDefault(),this.model.editKit()}.bind(this)),s.TransactionType!=o.TransactionType.SalesPayment&&s.TransactionType!=o.TransactionType.VoidTransaction&&this.$el.find("#quantityDisplay").on("tap",function(e){e.preventDefault(),this.changeQty_tap()}.bind(this)),s.Preference.AllowItemDiscount&&s.TransactionType!=o.TransactionType.Return&&s.TransactionType!=o.TransactionType.SalesPayment&&s.TransactionType!=o.TransactionType.VoidTransaction&&this.$el.find("#discountDisplay").on("tap",function(e){e.preventDefault(),this.changeDiscount_tap()}.bind(this)),s.Preference.AllowChangePrice&&s.TransactionType!=o.TransactionType.SalesRefund&&s.TransactionType!=o.TransactionType.Return&&s.TransactionType!=o.TransactionType.SalesPayment&&s.TransactionType!=o.TransactionType.VoidTransaction&&this.model.get("ItemType")!=o.ItemType.Kit&&this.$el.find("#itemPriceDisplay").on("tap",function(e){e.preventDefault(),this.changePrice_tap()}.bind(this)),this.PreventRemoveItem()},HasCoupon:function(){return!!s.Coupon&&!(!s.Coupon.get("CouponCode")||""==s.Coupon.get("CouponCode"))},toggleBindEvents:function(t,i){switch(t){case I.Qauntity:if(s.TransactionType!=o.TransactionType.SalesPayment&&s.TransactionType!=o.TransactionType.VoidTransaction)if(i){var n="#"+this.cid+" #changeQuantity-input";e(n).on("keypress",function(t){if(s.TransactionType!==o.TransactionType.SalesRefund&&0==e(n).val().length&&48==t.which)return!1}.bind(this)),e(n).on("change",function(e){this.finalizeChangeQty_tap(e)}.bind(this)),e("#"+this.cid+" #changeQuantity-input").on("focusout",function(e){this.finalizeFocusOutQty_tap(e)}.bind(this)),!this.ValidateNegativeQuantity(-1)||this.HasCoupon()||this.IsGiftCredits()?e(n).on("focus",function(e){r.Input.NonNegative("#"+self.cid+" #changeQuantity-input")}.bind(this)):e(n).on("focus",function(e){r.Input.Integer("#"+this.cid+" #changeQuantity-input")}.bind(this))}else e("#"+this.cid+" #changeQuantity-input").off("change"),e("#"+this.cid+" #changeQuantity-input").off("focusout"),e("#"+this.cid+" #changeQuantity-input").off("focus");break;case I.Discount:if(s.Preference.AllowItemDiscount&&s.TransactionType!=o.TransactionType.Return&&s.TransactionType!=o.TransactionType.SalesPayment&&s.TransactionType!=o.TransactionType.VoidTransaction)if(i){var n="#"+this.cid+" #changeDiscount-input";e(n).on("change",function(e){this.finalizeChangeDiscount_tap(e)}.bind(this)),e(n).on("focusout",function(e){this.finalizeFocusOutDiscount_tap(e)}.bind(this)),e(n).on("focus",function(e){r.Input.NonNegative("#"+this.cid+" #changeDiscount-input")}.bind(this)),e(n).on("keypress",function(e){r.MaxDecimalPlaceValidation(this.$("#changeDiscount-input"),e,"#"+this.cid)}.bind(this))}else e("#"+this.cid+" #changeDiscount-input").off("change"),e("#"+this.cid+" #changeDiscount-input").off("focusout"),e("#"+this.cid+" #changeDiscount-input").off("focus");break;case I.Price:if(s.Preference.AllowChangePrice&&s.TransactionType!=o.TransactionType.SalesRefund&&s.TransactionType!=o.TransactionType.Return&&s.TransactionType!=o.TransactionType.SalesPayment&&s.TransactionType!=o.TransactionType.VoidTransaction)if(i){var n="#"+this.cid+" #changePrice-input";e(n).on("change",function(e){this.finalizeChangePrice_tap(e)}.bind(this)),e(n).on("focusout",function(e){this.finalizeFocusOutPrice_tap(e)}.bind(this)),e(n).on("focus",function(e){console.log("FOCUS"+e.currentTarget.value),r.Input.NonNegative("#"+this.cid+" #changePrice-input")}.bind(this)),e(n).on("keypress",function(e){r.MaxDecimalPlaceValidation(this.$("#changePrice-input"),e,"#"+this.cid)}.bind(this)),e(n).on("keyup",function(t){"."==t.currentTarget.value&&e(n).val("0.").focus()}.bind(this))}else e("#"+this.cid+" #changePrice-input").off("change"),e("#"+this.cid+" #changePrice-input").off("focusout"),e("#"+this.cid+" #changePrice-input").off("focus")}},changeDiscount_tap:function(){this.model.get("QuantityOrdered")<0||(e("#"+this.cid+" #discountDisplay").hide(),e("#"+this.cid+" #changeDiscount-container").show(),e("#"+this.cid+" #changeDiscount-input").val(""),this.toggleBindEvents(I.Discount,!0),e("#"+this.cid+" #changeDiscount-input").focus())},changePrice_tap:function(){s.TransactionType!=o.TransactionType.Recharge&&(e("#"+this.cid+" #itemPriceDisplay").hide(),e("#"+this.cid+" #changePrice-container").show(),e("#"+this.cid+" #changePrice-input").val(""),this.toggleBindEvents(I.Price,!0),e("#"+this.cid+" #changePrice-input").focus())},changeQty_tap:function(){s.TransactionType!=o.TransactionType.Recharge&&(e("#"+this.cid+" #quantityDisplay").hide(),e("#"+this.cid+" #changeQuantity-container").show(),e("#"+this.cid+" #changeQuantity-input").val(""),this.toggleBindEvents(I.Qauntity,!0),e("#"+this.cid+" #changeQuantity-input").focus())},finalizeChangeDiscount_tap:function(t){t.preventDefault(),t.stopImmediatePropagation(),this.ContinueNextLine()&&("change"==t.type&&e("#"+this.cid+" #changeDiscount-input").off("focusout"),this.processDiscount(),this.HideKeyboard())},finalizeChangePrice_tap:function(t){t.stopImmediatePropagation(),"change"==t.type&&e("#"+this.cid+" #changePrice-input").off("focusout");var i=e("#"+this.cid+" #changePrice-input");console.log("PRICE: "+i.val()),this.processPrice()},finalizeChangeQty_tap:function(t){t.preventDefault(),t.stopImmediatePropagation(),"change"==t.type&&e("#"+this.cid+" #changeQuantity-input").off("focusout"),this.processQuantity()},finalizeFocusOutDiscount_tap:function(t){t.preventDefault(),t.stopImmediatePropagation(),"focusout"==t.type&&e("#"+this.cid+" #changeDiscount-input").off("change"),this.processDiscount()},finalizeFocusOutPrice_tap:function(t){t.stopImmediatePropagation(),"focusout"==t.type&&e("#"+this.cid+" #changePrice-input").off("change"),this.processPrice()},finalizeFocusOutQty_tap:function(t){t.stopImmediatePropagation(),"focusout"==t.type&&e("#"+this.cid+" #changeQuantity-input").off("change"),this.processQuantity()},itemName_tap:function(e){e.preventDefault(),this.ViewDetails()},magnifier_touchstart:function(e){e.preventDefault(),this.ViewDetails()},td_swipeleft:function(e){if(e.stopPropagation,s.TransactionType==o.TransactionType.Recharge)this.NotifyMsg("Item modification is not allowed in recharge Transaction.","Invalid action");else{if(s.TransactionType==o.TransactionType.ConvertQuote&&0==this.model.get("QuantityOrdered"))return;this.IsAllowedToDeductQuantity()&&this.SubtractQuantity()}},td_swiperight:function(e){e.stopPropagation,s.TransactionType==o.TransactionType.Recharge?this.NotifyMsg("Item modification is not allowed in recharge Transaction.","Invalid action"):this.AddQuantity()},processDiscount:function(){var t=e("#"+this.cid+" #changeDiscount-input").val().trim();this.IsNullOrWhiteSpace(t)||this.ValidateDiscount("Discount")&&this.UpdateFieldValue(v.Discount),e("#"+this.cid+" #discountDisplay").show(),e("#"+this.cid+" #changeDiscount-container").hide(),this.toggleBindEvents(I.Discount,!1)},processPrice:function(){var t=e("#"+this.cid+" #changePrice-input").val().trim();this.price=t,this.IsNullOrWhiteSpace(t)||(s.ActionType=o.ActionType.ChangePrice,this.ValidateManagerOverride(s.ActionType)&&this.UpdateFieldValue(v.Price)),e("#"+this.cid+" #itemPriceDisplay").show(),e("#"+this.cid+" #changePrice-container").hide(),this.toggleBindEvents(I.Price,!1)},processQuantity:function(){var t=e("#"+this.cid+" #changeQuantity-input").val().trim();this.IsNullOrWhiteSpace(t)||this.UpdateFieldValue(v.Quantity),e("#"+this.cid+" #quantityDisplay").show(),e("#"+this.cid+" #changeQuantity-container").hide(),this.toggleBindEvents(I.Qauntity,!1)},removeItem_tap:function(e){e.preventDefault(),this.PreventRemoveItem()||this.CheckReason(o.ActionType.VoidItem)},HideKeyboard:function(){s.isBrowserMode||(document.activeElement.blur(),e("input").blur())},initialize:function(){this.type=this.options.type,this.totalDiscount=this.options.totalDiscount,this.model.on("change",this.UpdateCart,this),this.model.on("remove",this.RemoveItemFromCart,this),this.model.get("IsPromoItem")&&this.$el.attr("style","background: #ECF5FE")},render:function(){this.ManageBinding();var e=this.model.cid,t=new f;switch(t.set(this.model.attributes),t.set({cid:e}),this.type){case"POS":this.$el.html(this._template(t.toJSON()))}this.$el.attr("id",this.cid);var i=s.TransactionType===o.TransactionType.SalesRefund;return this.ShowOutstanding(i),this.PreventRemoveItem(),this.AdjustElementStyle(),this.resetItemTapEvents(),this.model.get("IsPromoItem")&&this.$el.find(".cart-details").addClass("promo-item"),this.displayPromoCaption(),this},displayPromoCaption:function(){var e=document.getElementsByClassName("promo-item");for(x=0;x<=e.length-1;x++){var t=e[x];t.getElementsByClassName("promotag")[0].style.display="block"}},renderKit:function(){return this.$el.html(this.kitTemplate()),this},AdjustElementStyle:function(){var e=this.model.get("ItemName"),t=!1;if(s.Preference.IsUseItemDescription&&(e=this.model.get("ItemDescription")),e.length>12){var i=e.split(" ");for(var n in i)i[n].length>11&&(t=!0);t&&this.$("#cart-itemName").css("word-break","break-all")}this.model.get("ItemType")!=o.ItemType.Kit?this.$el.find("#display-itemName").attr("style","display: table-cell;"):this.$el.find("#display-kit").show().attr("style","display: table-cell; width: 20%; vertical-align: middle;")},CheckOnLoadIfPhasedOut:function(){var t="#"+this.cid,i=this,n=this.model.get("QuantityOrdered");r.CheckIfItemIsPhaseout(this.model,n,0,!1,s.CartCollection,!0)&&s.TransactionType==o.TransactionType.ConvertQuote&&(r.IsNullOrWhiteSpace(s.AdjustedQtyItemCollection)&&(s.AdjustedQtyItemCollection=new y),r.AdjustPhasedOutItem(this.model,n,s.CartCollection)&&s.AdjustedQtyItemCollection.add(this.model),navigator.notification.alert("One or more Item(s) is already phased out. The quantity must be lower than or equal the freestock",null,"Action Not Allowed","OK")),r.IsNullOrWhiteSpace(s.AdjustedQtyItemCollection)||s.AdjustedQtyItemCollection.each(function(n){i.model.get("ItemCode")==n.get("ItemCode")&&i.model.get("UnitMeasureCode")==n.get("UnitMeasureCode")&&e(t).css("color","red")})},PreventRemoveItem:function(){if(s.TransactionType===o.TransactionType.SalesPayment||s.TransactionType===o.TransactionType.VoidTransaction||s.TransactionType===o.TransactionType.Recharge)return e("#"+this.cid+" .remove-itembutton i").css("color","gray"),!0;if(s.TransactionType===o.TransactionType.ConvertOrder&&s.CurrentOrders&&s.CurrentOrders.length>0){var t=!1,i=this;if(s.CurrentOrders.each(function(e){t||i.model.get("ItemCode")==e.get("ItemCode")&&i.model.get("UnitMeasureCode")==e.get("UnitMeasureCode")&&(t=!0)}),t)return e("#"+this.cid+" .remove-itembutton i").css("color","gray"),!0}return!1},AcceptManagerOverride:function(e,t){var i=this,n=s.Username,a=s.Password,o=new m;s.Username=e,s.Password=t,o.url=s.ServiceUrl+c.POS+u.MANAGEROVERRIDE+s.POSWorkstationID+"/"+s.OverrideMode,o.save(null,{success:function(e,t){s.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),i.AcceptManagerOverrideCompleted(e,t)},error:function(e,t,i){s.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Saving Manager Override")}}),s.Username=n,s.Password=a},AcceptManagerOverrideCompleted:function(t,i){if(null==i.ErrorMessage||""==i.ErrorMessage){if(mode=s.OverrideMode,mode===o.ActionType.ItemDiscount){var n=e("#"+this.cid+" #changeDiscount-input").val().trim();this.IsNullOrWhiteSpace(n)||this.UpdateFieldValue(v.Discount),e("#"+this.cid+" #discountDisplay").show(),e("#"+this.cid+" #changeDiscount-container").hide(),s.Preference.IsReasonDiscount&&this.SaveReason()}else"ChangePrice"===mode&&this.UpdateFieldValue(v.Price);this.managerOverrideView.Close()}else console.log(i.ErrorMessage),navigator.notification.alert(i.ErrorMessage,null,"Override Failed","OK")},AcceptReason:function(){switch(s.ReasonViewRendered=!1,s.ActionType){case o.ActionType.ItemDiscount:this.ValidateManagerOverride(s.ActionType)&&this.SaveReason();break;default:this.ValidateManagerOverride(s.ActionType)&&(this.SaveReason(),this.RemoveThisItem(this.model))}},AddCommas:function(e){e+="",x=e.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var t=/(\d+)(\d{3})/;t.test(1);)x1=x1.replace(t,"$1,$2");return x1+x2},AddQuantity:function(){var t="#"+this.cid;e(t).css("color","black"),s.TransactionType!==o.TransactionType.SalesPayment&&s.TransactionType!==o.TransactionType.VoidTransaction&&this.model.addQuantity()},CheckReason:function(e){switch(e){case o.ActionType.VoidItem:s.ReasonCode.Item&&s.TransactionType!=o.TransactionType.SalesRefund?this.LoadReason(100,"",e):(this.model.removeSerial(),this.model.removeItem());break;default:this.LoadReason(100,"",e)}},FormatName:function(e){var t=e.replace(/\s+/g," ").trim(),i=t.indexOf(" "),n=t.split(" "),a=12,o=24,s=[],r="<br />";if(t.length>a&&(i>a||i===-1))s[0]=t.substr(0,a-1),s[1]=e.substr(a-1,t.length);else{var c=0,u=n;s[0]="";for(var l=0;l<u.length;l++)if(c<o){if(n[l].length>a){s[0]=s[0]+u[l].substr(0,a)+r;var d=u[l].substr(a,u[l].length);u[l+1]=d+u[l+1]}else s[0]=s[0]+u[l]+" ";c=s[0].length;var h=l}h===n.length?s[0]=s[0]:h<n.length?s[0]=s[0].substr(0,o-3)+"...":s[0]=s[0].substr(0,o-3)+"..."}var p="";return p=s[0],void 0!==s[1]&&(console.log("in"),s[1].length>a-3?p=p+r+s[1].substr(0,a-3)+"...":p+=s[1]),console.log(p),p},InitializeManagerOverrideView:function(){this.managerOverrideView||(this.managerOverrideView=new d({el:e("#managerOverrideContainer")}),this.managerOverrideView.on("ManagerOverrideAccepted",this.AcceptManagerOverride,this),this.managerOverrideView.on("CloseClicked",this.ResetValue,this))},IsNullOrWhiteSpace:function(e){return!e||(""===e||null===e||void 0===e)},IsNumeric:function(e){return i.isNumber(e)},IsZero:function(e){return!e||("0"===e||0===e)},LoadReason:function(e,t,i){var n;n&&n++,console.log("REPEAT:"+n);var a=this,r=new h,l=e;s.ActionType;this.itemReasonCollection?this.itemReasonCollection.reset():(this.itemReasonCollection=new g,this.itemReasonCollection.unbind(),this.itemReasonCollection.on("acceptReason",this.AcceptReason,this),i===o.ActionType.ItemDiscount||i===o.ActionType.SaleDiscount||i===o.ActionType.VoidItem?this.itemReasonCollection.on("savedItem",this.ProceedToAction,this):this.itemReasonCollection.off("savedItem",this.ProceedToAction,this)),r.set({StringValue:t}),r.url=s.ServiceUrl+c.POS+u.REASONLOOKUP+l,r.save(null,{success:function(e,t){s.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),a.itemReasonCollection.reset(t.Reasons,{silent:!0}),a.ShowReasonView(a.itemReasonCollection,i)},error:function(e,t,i){s.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Loading Reason Codes")}})},ManageBinding:function(){var e,t=!1,i=12,n=this.model.get("Outstanding"),a=1,c="<br />",u="<br />";switch(s.TransactionType){case o.TransactionType.SalesRefund:e=this.model.get("Good");break;default:e=this.model.get("QuantityOrdered"),n=0}var l=this.model.get("ItemName");s.Preference.IsUseItemDescription&&(l=this.model.get("ItemDescription")),l=r.Escapedhtml(l);var d=this.model.get("CouponCode");null!=d&&""!==d.trim()||s.Coupon&&null!=s.Coupon.get("CouponID")&&(d=s.Coupon.get("CouponCode"));var h=this.model.get("CouponDiscountAmount");this.IsReturn()&&this.model.get("Outstanding")<1&&(h=0),this.IsNullOrWhiteSpace(h)||(a=h.length),null==d||""===d.trim()?(u="",c="",h=""):(h&&("Percent"===this.model.get("CouponDiscountType")?h+=" %":h="("+h.toFixed(2)+")"),l.length>i&&(d=""+d),i=14);var p=!1,m=!1,f=format("#,##0.00",this.model.get("ExtPriceRate"));this.model.get("IsIncludedInCoupon")===!1&&s.CouponIncludeAll===!1&&(d=null,h=null,c="",t=!1),this.IsNullOrWhiteSpace(d)||this.model.get("IsNewLine")&&s.TransactionType==o.TransactionType.SalesRefund||(t=!0,m=!0),1==s.Preference.AllowTaxOnLineItems&&(t=!0),1==t&&(_cartAlign="top");var g=this.model.get("SalesTaxAmountRate"),y=format("#,##0.00",this.RoundNumber(g,2)),T="Sales Tax";if(this.IsReturn()){var v=parseFloat(parseFloat(g).toFixed(4)),I=parseFloat(this.preciseRound(g,2));y=.005==parseFloat((v-I).toFixed(3))?I:v,y=format("#,##0.00",this.RoundNumber(y,2))}this.IsNullOrWhiteSpace(y)||0==parseFloat(y)?(y="",T=""):p=!0;var C="none",w="none";1==m&&(w=""),1==p&&1==s.Preference.AllowTaxOnLineItems?C="":1==m&&(c=""),this.model.set({FormattedItemName:l,Outstanding:n,QuantityDisplay:e,DisplayExtPriceRate:f,FormattedCouponCode:d,FormattedCouponDiscountAmount:h,ItemNameLineBreak:u,CouponDiscountLineBreak:c,TaxLabel:T,TaxAmount:y,ShowTax:C,ShowCoupon:w},{silent:!0})},preciseRound:function(e,t){null==t&&(t=2);var i=e.toString();return i.indexOf(".")==-1?i:i.substr(0,i.indexOf(".")+t+1)},RoundNumber:function(e,t){if(!e)return e;var i=format("0.0000",e),n=new a.BigDecimal(i);return parseFloat(1*n.setScale(t,a.MathContext.ROUND_HALF_UP))},IsReturn:function(){return s.TransactionType===o.TransactionType.SalesRefund||s.TransactionType===o.TransactionType.SalesCredit},ResetValue:function(){this.ItemReasonView||(e("#"+this.cid+" #changePrice-input").val(""),e("#"+this.cid+" #changeQuantity-input").val(""),e("#"+this.cid+" #changeDiscount-input").val(""))},RemoveItemFromCart:function(){e("#kit-"+this.model.get("ItemCode")+"-"+this.model.get("LineNum")).remove(),e("#"+this.model.get("PromoDocumentCode")).remove(),this.remove()},RemoveThisItem:function(){this.model.removeItem(),this.trigger("RemoveItem")},SaveReason:function(){this.ItemReasonView&&this.ItemReasonView.SaveReason()},SetActionType:function(e){s.ActionType=e},ShowDeleteButton:function(){s.TransactionType!==o.TransactionType.SalesPayment&&s.TransactionType!==o.TransactionType.SalesRefund&&(e(".deletebtn-overlay").hide(),this.$(".deletebtn-overlay").show())},ShowManagerOverride:function(){return this.InitializeManagerOverrideView(),this.managerOverrideView.Show(),!1},ShowOutstanding:function(t){t?(e(".itemRemaining").show(),e(".itemName").addClass("itemNameRefund"),e(".itemExtPrice").addClass("itemExtPriceRefund")):(e(".itemRemaining").hide(),e(".itemName").removeClass("itemNameRefund"),e(".itemExtPrice").removeClass("itemExtPriceRefund"))},ShowReasonView:function(t,i){console.log("reasonView type :"+i),e("#reasonPageContainer").append("<div id='reasonMainContainer'></div>"),this.ItemReasonView&&(this.ItemReasonView.remove(),this.ItemReasonView.unbind(),this.ItemReasonView=null),this.ItemReasonView=new l({el:e("#reasonMainContainer"),collection:t,type:i}),s.ActionType=i},SubtractQuantity:function(){var t="#"+this.cid;e(t).css("color","black"),s.TransactionType!==o.TransactionType.SalesPayment&&s.TransactionType!==o.TransactionType.VoidTransaction&&this.ValidateSubtractQuantity()&&this.model.subtractQuantity()},UpdateCart:function(){this.render(),this.bindEvents()},UpdateFieldValue:function(t){var i,n;switch(t){case v.Quantity:i=e("#"+this.cid+" #changeQuantity-input");break;case v.Discount:i=e("#"+this.cid+" #changeDiscount-input");break;case v.Price:this.SetActionType(o.ActionType.ChangePrice),i=e("#"+this.cid+" #changePrice-input")}n=i.val().trim(),isNaN(n)&&(n=0);var a="QuantityOrdered"===t;if(a)if(this.IsGiftCredits()){if(!this.IsValidGiftCreditsQty(n))return}else if(1==this.cartHasGiftCredit()&&n<0)return i.blur(),void navigator.notification.alert("Item exchange is not allowed for transactions with Gift Cards. Please create a separate transaction.",null,"Negative Quantity","OK");if(!this.ValidateNegativeQuantity(n)){var r=s.TransactionType;s.TransactionType!==o.TransactionType.SalesRefund&&s.TransactionType!==o.TransactionType.Return||(r=o.TransactionType.Return,i.val(this.model.get("Good")));var c="Negative quantities are not allowed for "+r+" transactions.";return void navigator.notification.alert(c,null,"Negative Quantity","OK")}switch(s.TransactionType){case o.TransactionType.SalesRefund:var u=this.model.get("Outstanding");if(a){if(n>u)return i.val(this.model.get("Good")),void navigator.notification.alert("Value must be less than or equal to the Outstanding quantity.",null,"Incorrect Value","OK");if(this.model.get("ItemType")==o.ItemType.GiftCard){var l=this.model.get("NumOfActivatedGCard"),d=0;if(l>0&&(d=u-l-n,d<0))return i.val(this.model.get("Good")),navigator.notification.alert("Returning an activated gift card is not allowed.",null,"Action Not Allowed","OK"),null}}break;default:n=i.val().trim(),isNaN(n)&&(n=0),this.IsNullOrWhiteSpace(n)||i.val().trim();if(a&&this.IsZero(n)&&("P"==!this.model.get("Status")||this.IsGiftCredits()))return i.val(this.model.get(t)),console.log("Please enter at least 1 quantity."),void navigator.notification.alert("Please enter at least 1 quantity.",null,"Quantity Required","OK");if(a){var h=(n-this.model.get("QuantityOrdered"),"#"+this.cid);e(h).css("color","black")}}this.UpdateModel(t,n)},IsValidGiftCreditsQty:function(e){var t=this.model.get("ItemType");return!this.IsNegative(e)||(navigator.notification.alert("Negative quantity is not allowed for "+t+" item",null,"Negative Quantity","OK"),!1)},UpdateModel:function(e,t){switch(this.delegateEvents(),e){case v.Quantity:s.TransactionType===o.TransactionType.SalesRefund||s.TransactionType===o.TransactionType.Return?this.model.updateQuantityGood(parseInt(t)):this.model.updateQuantityOrdered(parseInt(t));break;case v.Discount:this.model.updateDiscount(parseFloat(t));break;case v.Price:this.model.set({DoNotChangePrice:!0,Pricing:s.Username}),this.model.updateSalesPriceRate(parseFloat(t),"UpdatePrice")}},ValidateDiscount:function(t){var i=e("#"+this.cid+" #changeDiscount-input"),n=parseFloat(i.val().trim()),a=(s.Preference.DiscountOverrideLevel,s.Preference.MaxItemDiscount),r=(s.Preference.MinItemDiscount,parseFloat(window.sessionStorage.getItem("MaxSaleDiscount"))),c=parseFloat(this.model.get("Discount"));return"Discount"===t&&this.SetActionType(o.ActionType.ItemDiscount),n>0?!this.ValidateReason(t)||!this.ValidateManagerOverride(s.ActionType)||(!s.Preference.AllowSaleDiscount||(c>0&&(r+=c),r-n<0?(navigator.notification.alert("Discount must not exceed max sale discount of "+s.Preference.MaxSaleDiscount+"%",null,"Action Not Allowed","OK"),!1):(r-=n,window.sessionStorage.setItem("MaxSaleDiscount",r),r>=0||function(){return navigator.notification.alert("Discount must not exceed max sale discount of "+s.Preference.MaxSaleDiscount+"%",null,"Action Not Allowed","OK"),!1}()))):n>a?(navigator.notification.alert("Discount must not exceed max item discount of "+a+"%",null,"Action Not Allowed","OK"),!1):n<0?(navigator.notification.alert("Please enter a valid discount amount",null,"Action Not Allowed","OK"),!1):(0==n&&(r+=c,window.sessionStorage.setItem("MaxSaleDiscount",r)),!0)},IsDiscountManagerOverrideLevel:function(){var e=s.Preference.DiscountOverrideLevel.toLowerCase(),t=s.UserInfo.RoleCode.toLowerCase();return!e||e==t},ValidateManagerOverride:function(t){var i=null;if(t===o.ActionType.ItemDiscount){var n=0,a=e("#"+this.cid+" #changeDiscount-input").val().trim();if(n=s.Preference.MaxItemDiscount,a<=n)return!0;i=s.Preference.DiscountOverrideLevel}else t===o.ActionType.ChangePrice&&(i=s.Preference.PriceChangeOverrideLevel);return""==i||null==i||s.UserInfo.RoleCode==i||(s.OverrideMode=t,this.ShowManagerOverride(),!1)},ValidateNegativeQuantity:function(e){return s.TransactionType!==o.TransactionType.SalesRefund&&s.TransactionType!==o.TransactionType.Return&&s.TransactionType==o.TransactionType.Sale&&"Kiosk"!==s.ApplicationType||!(e<0)},ValidateReason:function(e){var t=s.ReasonCode.Discount;if(t){var i=s.ActionType;return this.CheckReason(i),!1}return!0},ValidateSubtractQuantity:function(){if(s.TransactionType!=o.TransactionType.SalesRefund){var e=1===this.model.get("QuantityOrdered"),t=s.TransactionType!=o.TransactionType.Sale||"Kiosk"===s.ApplicationType;if(e&&t)return!1}return!0},ViewDetails:function(){this.model.viewDetails()},ContinueNextLine:function(){var t=e("#"+this.cid+" #changeDiscount-input").val();return this.prevDiscValue||(this.prevDiscValue=0),t!=this.prevDiscValue&&(this.prevDiscValue=t,!0)},IsNegative:function(e){return e<0},IsGiftCredits:function(e){var t=e;return t||(t=this.model.get("ItemType")),t===o.ItemType.GiftCard||t===o.ItemType.GiftCertificate},IsAllowedToDeductQuantity:function(){var e=this.model.get("ItemType"),t=this.model.get("QuantityOrdered");if(s.TransactionType!==o.TransactionType.SalesRefund||s.TransactionType!=o.TransactionType.Return)if(s.TransactionType!==o.TransactionType.Sale){if(1==t)return navigator.notification.alert("This item must have at least 1 quantity..",null,"Quantity Required","OK"),!1}else if(this.IsGiftCredits(e)&&1==t)return navigator.notification.alert("This item must have at least 1 quantity..",null,"Quantity Required","OK"),!1;return!this.IsGiftCredits(e)||!this.IsZero(t)||(navigator.notification.alert("Negative quantity is not allowed for "+e+" item",null,"Negative Quantity","OK"),!1)},cartHasGiftCredit:function(){var e=s.CartCollection,t=e.find(function(e){return e.get("ItemType")==o.ItemType.GiftCard||e.get("ItemType")==o.ItemType.GiftCertificate});return!!t},NotifyMsg:function(e,t){navigator.notification.alert(e,null,t,"OK")}});return C});