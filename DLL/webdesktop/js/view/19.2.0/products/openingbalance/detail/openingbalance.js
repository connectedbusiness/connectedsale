define(["jquery","mobile","underscore","backbone","shared/service","shared/method","shared/shared","shared/global","model/base","model/lookupcriteria","collection/base","text!template/19.2.0/products/openingbalance/detail/openingbalance.tpl.html","text!template/19.2.0/products/openingbalance/detail/openingbalance/oblist.tpl.html","js/libs/moment.min.js","js/libs/iscroll.js","js/libs/format.min.js"],function(e,t,n,o,i,a,l,r,c,s,u,d,h){var C={INAME:" .td-itemname input ",TDATE:" .td-tdate input ",OBC:" .td-obcode input ",LOC:" .td-location select ",QTY:" .td-quantity input ",COST:" .td-cost input ",DEL:" .del #btn-del "},f=o.View.extend({_obTemplate:n.template(d),_obLine:n.template(h),events:{"tap .ob-add span":"btnClick_Add"},btnClick_Add:function(e){e.preventDefault(),this.AddNew()},initialize:function(){this.uomList=new u,this.$el.show()},render:function(){return this.$el.html(this._obTemplate()),this.LoadOBCollection(!0),l.BrowserModeDatePicker(C.TDATE,"datepicker","yy-mm-dd"),this},Show:function(){this.render()},Close:function(){this.remove(),this.unbind()},InitializeChildViews:function(){},LoadOBCollection:function(t){var n=this,o=0;e("#ob-table-additional").html(""),this.collection.each(function(e){n.RenderOB(e,o,!t),o++})},AddNew:function(){this.BlurAllElements();var e=new c;e.set(this.NewOBSchema),e.set({IsNew:!1,IsBase:!1}),this.collection.add(e),this.RenderOB(e,this.collection.models.length-1)},RefreshiScroll:function(){this.myScroll?(this.myScroll.refresh(),e("#opening-balance-body").height()<e("#ob-details").height()&&this.myScroll.scrollToElement("li:first-child",100)):this.myScroll=new iScroll("opening-balance-body",{vScrollbar:!0,vScroll:!0,snap:!0,momentum:!0,useTransform:!1,onBeforeScrollStart:function(e){for(var t=e.target;1!=t.nodeType;)t=t.parentNode;"SELECT"!=t.tagName&&"INPUT"!=t.tagName&&"TEXTAREA"!=t.tagName&&e.preventDefault()}}),e("#opening-balance-body div:first-child").css("width","100%"),e(".tables").css("width","96%")},RenderOB:function(t,n,o){var i="-additional",a="obIndex"+n,c="#ob-table"+i;t.set({obIndex:a}),e(c).append(this._obLine(t.toJSON()));var s=c+" #"+a;this.LoadLocationCodes(s,t.get("ItemCode")),this.SetSelectedLocation(s,t,o),this.BindEvents(t,s),l.BrowserModeDatePicker("#"+a+"> .td-tdate > input","datepicker","yy-mm-dd"),r.isBrowserMode?l.UseBrowserScroll("#opening-balance-body"):this.RefreshiScroll()},ValidateDefaultLocationStatus:function(e){var t=new c;t.url=r.ServiceUrl+i.PRODUCT+"iswarehouseactive/",t.set({StringValue:r.Preference.DefaultLocation}),t.save(t,{success:function(t,n){n.Value?e(r.Preference.DefaultLocation):(l.ShowNotification("Default Location '"+r.Preference.DefaultLocation+"' is inactive.",!0),e())},error:function(t,n,o){e()}})},SetSelectedLocation:function(t,n,o){var i=function(o){var i=o||n.get("WarehouseCode");n.set({WarehouseCode:i}),e(t+C.LOC+" > option[value='"+i+"']").attr("selected","selected")};return o?void i():void this.ValidateDefaultLocationStatus(i)},LoadLocationCodes:function(t,n){0!==this.locationCodeCollection.length&&this.locationCodeCollection.each(function(n){if(n.get("IsActive")){var o=n.get("WarehouseCode");e(t+C.LOC).append(new Option(o,o))}})},BindEvents:function(t,n){t.set({cid:n});var o=this;e(n+C.INAME).on("tap",function(e){e.preventDefault(),o.LoadItemLookUp(n,C.INAME)}),e(n+C.TDATE).on("change",function(){o.ChangeModelAttribute(n,C.TDATE)}),e(n+C.LOC).on("change",function(){o.ChangeModelAttribute(n,C.LOC)}),e(n+C.OBC).on("change",function(){o.ChangeModelAttribute(n,C.OBC)}),e(n+C.OBC).on("focus",function(){o.ClearField(n,C.OBC)}),e(n+C.OBC).on("blur",function(){o.RevertField(n,C.OBC)}),e(n+C.QTY).on("change",function(){o.ChangeModelAttribute(n,C.QTY)}),e(n+C.QTY).on("focus",function(){o.SaveAndClearValue(n,C.QTY)}),e(n+C.QTY).on("blur",function(){o.RevertPreviousValue(n,C.QTY)}),e(n+C.COST).on("change",function(){o.ChangeModelAttribute(n,C.COST)}),e(n+C.COST).on("focus",function(){o.SaveAndClearValue(n,C.COST)}),e(n+C.COST).on("blur",function(){o.RevertPreviousValue(n,C.COST)}),e(n+C.COST).on("keyup",function(e){o.Cost_Keyup(e)}),e(n+C.DEL).on("tap",function(e){e.preventDefault(),o.ChangeModelAttribute(n,C.DEL)})},Cost_Keyup:function(t){"0."!=t.currentTarget.value&&"."!=t.currentTarget.value||(e(t.target).val("0.0"),e(t.target).focus(),e(t.target).val("0."))},ChangeModelAttribute:function(e,t){var n=this;this.collection.each(function(o){o.get("cid")==e&&n.DoChangeAttribute(o,e,t)})},HasDucplicateOBCode:function(e,t,n){var o=!1;t.find(function(t){t.get("OpeningBalanceCode")==e&&t.get("cid")!=n&&(o=!0)});return o&&l.ShowNotification("Duplicate Opening Code exists.",!0),o},CheckIfOBCodeAlreadyExist:function(e,t){var n=new c;n.set({StringValue:t}),n.url=r.ServiceUrl+i.PRODUCT+a.OPENINGBALANCELOOKUP+"100",n.save(null,{success:function(t,n,o){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e(n)}})},DoChangeAttribute:function(t,n,o){var i=null,a=this;switch(o!=C.DEL&&(i=e(n+o).val()),o){case C.DEL:if(!t)return;this.collection.remove(t),this.LoadOBCollection();break;case C.INAME:this.currentCID=n,this.currentItemCode=t.get("ItemCode"),this.trigger("itemChanged"),console.log("itemChanged");break;case C.TDATE:var l=this.JsonToAspDate(i);t.set({TransactionDate:l,ConvertedTransactionDate:i});break;case C.OBC:if(""===i)return;if("[To be generated]"===i)return;var r="OBI-",c=i,s=i.slice(0,4);if("OBI-"!==s&&(c=r+i),this.HasDucplicateOBCode(c,this.collection,n))return e(n+o).val("[To be generated]"),void t.set({OpeningBalanceCode:"[To be generated]"});var d=function(i){var l=new u;return l.reset(i.InventoryOpeningBalance),console.log("Openning balance code found : "+l.length),l.length>0&&a.HasDucplicateOBCode(c,l,n)?(e(n+o).val("[To be generated]"),void t.set({OpeningBalanceCode:"[To be generated]"})):(e(n+o).val(c),void t.set({OpeningBalanceCode:c}))};this.CheckIfOBCodeAlreadyExist(d,c);break;case C.LOC:t.set({WarehouseCode:i});break;case C.QTY:t.set({Quantity:i});break;case C.COST:t.set({Cost:i})}},RevertField:function(t,n){var o=e(t+n).val();""===o&&e(t+n).val("[To be generated]")},ClearField:function(t,n){var o=e(t+n).val();"[To be generated]"===o&&e(t+n).val("")},LoadItemLookUp:function(e,t){var n=this;this.BlurAllElements(),this.collection.each(function(o){o.get("cid")==e&&n.SetCurrentModel(o,e,t)})},BlurAllElements:function(t,n){e(C.TDATE).blur(),e(C.OBC).blur(),e(C.QTY).blur(),e(C.COST).blur()},SetCurrentModel:function(e,t,n){this.currentmodel||(this.currentmodel=new c),this.currentmodel=e,this.currentCID=t,console.log("tappped! :cid "+t),this.trigger("itemLookup")},ReplaceModelByCID:function(e){var t=this.currentCID,n=this;this.collection.each(function(o){if(o.get("cid")==t){var i=o.clone();o.set(e);var a=o.get("TransactionDate"),l=e.Cost.toFixed(2);o.set({ConvertedTransactionDate:n.JSONtoDate(a),Cost:l,WarehouseCode:i.get("WarehouseCode")}),console.log(o.get("cid")),n.LoadOBCollection()}})},GetCurrentCollection:function(){return console.log(this.collection.length),_tmp=new u,_tmp=this.collection,_tmp},JsonToAspDate:function(e){var t=Date.parse(e),n=new Date(t),o=n.getMonth(),i=n.getDate(),a=n.getFullYear();return n=Date.UTC(a,o,i),n="/Date("+n+")/"},JSONtoDate:function(e){var t="YYYY-MM-DD",n=moment(e).format(t);return n},SaveAndClearValue:function(t,n){var o=t+n,i=e(o).val();switch(n){case C.QTY:this.lastQty=i;break;case C.COST:this.lastCost=i}e(o).val(""),this.AssignNumericValidation(t,n)},RevertPreviousValue:function(t,n){elemID=t+n;var o=e(elemID).val(),i="";if(""!==o)i=parseFloat(o);else switch(n){case C.QTY:i=this.lastQty;break;case C.COST:i=this.lastCost}e(elemID).val(i)},AssignNumericValidation:function(e,t){var n=e+t;switch(t){case C.QTY:l.Input.NonNegativeInteger(n);break;case C.COST:l.Input.Numeric(n)}}});return f});