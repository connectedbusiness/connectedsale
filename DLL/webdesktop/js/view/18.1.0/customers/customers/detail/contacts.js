define(["jquery","mobile","underscore","backbone","shared/global","shared/service","shared/method","shared/shared","model/base","model/lookupcriteria","collection/base","collection/countries","collection/postal","text!template/18.1.0/customers/customers/detail/contacts.tpl.html","view/18.1.0/pos/postal/addpostal","js/libs/iscroll.js"],function(t,e,o,a,l,i,s,n,d,r,c,u,h,C,p){var y,m=function(t){1==t?y.AddNewPostal():y.ClearPostalDetails()},v=a.View.extend({_contactTemplate:o.template(C),events:{"tap #btn-search-entity-name":"seachBtn_Tapped","change #data-city":"SetState","change #data-postal-code":"buttonLoadOnFocus","change #data-country":"CountryChanged","keyup #data-postal-code":"Postal_keyup","keydown #data-business-phone":"AssignNumericValidation"},IsNew:!1,initialize:function(){this.$el.show(),y=this},render:function(){return this.onLoad=!0,this.FormatContactName(),this.$el.html(this._contactTemplate(this.model.toJSON())),this.DisplayCityOnLoad(),this},FormatContactName:function(){var t=n.EscapedModel(this.model);this.model.set({FormattedName:t.get("ContactFullName"),FormattedEntityName:t.get("EntityName")})},Show:function(){console.log("contactview"),this.InitializeThings(),this.render(),this.RefreshiScroll(),this.LoadDrapDowns(),this.ManageButtons()},ManageButtons:function(){this.IsNew&&t("#data-contact-full-name").val("")},EnableButtons:function(){t("#data-contact-full-name").val(""),t("#data-postal-code").attr("readonly",!1),t("#data-city").removeClass("ui-disabled"),t("#data-country").removeClass("ui-disabled"),t("#data-contact-full-name").attr("readonly",!1),t("#data-postal-code").attr("readonly",!1),t("#data-address").attr("readonly",!1),t("#data-email").attr("readonly",!1),t("#data-business-phone").attr("readonly",!1),t("#data-state").attr("readonly",!1)},InitializeThings:function(){this.countrySelected=this.model.get("Country"),this.ContactCode=this.model.get("ContactCode"),this.county=this.model.get("County"),this.timeZone=this.model.get("TimeZone"),this.InitializeModelsAndCollections()},InitializeModelsAndCollections:function(){var t=1e4;this.countryModel||(this.countryModel=new r,this.countryModel.url=l.ServiceUrl+i.CUSTOMER+s.COUNTRYCODELOOKUP+t),this.postalmodel||(this.postalmodel=new d),this.postalCollection||(this.postalCollection=new c),this.countryCollection||(this.countryCollection=new u)},DisplayCityOnLoad:function(){if(console.log("onload : "+this.onLoad),!n.IsNullOrWhiteSpace(this.onLoad)){this.onLoad=!1;var e=this.model.get("City"),o=this.model.get("State");n.IsNullOrWhiteSpace(e)||"Please enter city"==e?this.ClearCity():(t('#data-city > option[val !=""]').remove(),t("#data-city").append(new Option(e,e)),t("#data-city").prop("selectedIndex",0),console.log("Change City")),n.IsNullOrWhiteSpace(o)||"Please enter state code"==o?t("#data-state").val(""):t("#data-state").val(o),console.log("CITY : "+e+" , STATE :"+o),console.log("onload : "+this.onLoad)}},buttonLoadOnFocus:function(){this.postal=t("#data-postal-code").val(),this.LoadPostal(this.postal)},ClearPostalInfo:function(){t("#data-postal-code").val(""),t("#data-state").val(""),this.ClearCity()},ClearCity:function(){t('#data-city > option[val !=""]').remove(),t("#data-city").append(new Option("City","")),t("#data-city").val(""),t("#data-state").val("")},LoadPostal:function(e){if(""==e)this.ClearCity();else{var o=this;n.LoadPostalByCode(e,function(t){o.DisplayResultOnPostal(t);var e=o.IsPrioritizeFromPostalCode(o.countryCollection,o.countrySelected);switch(e){case!0:o.LoadClasscodeFromPostal()}},function(e){o.postalCollection.reset(),o.postalCollection.RequestError(e,"Error Loading Postal Code"),o.model?t("#data-postal-code").val(o.model.get("PostalCode")):t("#data-postal-code").val("")})}},IsPrioritizeFromPostalCode:function(t,e){var o=t.find(function(t){return t.get("CountryCode")===e&&(t.get("IsRetailCustomerBillToClassPostal")===!0||t.get("IsWholesaleCustomerBillToClassPostal")===!0)});return o&&(o.get("IsRetailCustomerBillToClassPostal")===!0?this.priorityPostalType="Retail":o.get("IsWholesaleCustomerBillToClassPostal")===!0&&(this.priorityPostalType="Wholesale")),!!o},LoadClasscodeFromPostal:function(){var e=this.postalCollection.at(0);if(!n.IsNullOrWhiteSpace(this.postalCollection)&&this.postalCollection.length>0){var e=this.postalCollection.at(0),o=e.get("DefaultRetailCustomerBillToClassTemplate"),a=e.get("DefaultRetailCustomerShipToClassTemplate"),l=e.get("DefaultWholesaleCustomerBillToClassTemplate"),i=e.get("DefaultWholesaleCustomerShipToClassTemplate");!n.IsNullOrWhiteSpace(o)&&!n.IsNullOrWhiteSpace(a)||!n.IsNullOrWhiteSpace(l)&&!n.IsNullOrWhiteSpace(i)?"Retail"===this.priorityPostalType?(t("#data-class-template option[value='"+o+"']").attr("selected","selected"),t("#data-shiptoclass-template option[value='"+a+"']").attr("selected","selected"),this.SelectedClassCode=o,this.SelectedShipToClassCode=a):(t("#data-class-template option[value='"+l+"']").attr("selected","selected"),t("#data-shiptoclass-template option[value='"+defaultWholesaleShipto+"']").attr("selected","selected"),this.SelectedClassCode=l,this.SelectedShipToClassCode=defaultWholesaleShipto):(t("#data-class-template option[value='"+this.SelectedClassCode+"']").attr("selected","selected"),t("#data-shiptoclass-template option[value='"+this.SelectedShipToClassCode+"']").attr("selected","selected"))}},Postal_keyup:function(){l.ListJustTapped=!1},RemoveInvalidPostals:function(t){var e=t.get("CountryCode");e===this.countrySelected&&this.newCollection.add(t)},AddNewPostal:function(){var e=t("#addPostalCodeContainer"),o=t("#data-postal-code").val();t(e).html("<div id='addPostalContainer' style='display: none'></div>");var a=t("#addPostalContainer");n.IsNullOrWhiteSpace(this.newPostalView)?this.newPostalView=new p({el:a}):(this.newPostalView.remove(),this.newPostalView=new p({el:a})),this.newPostalView.on("AcceptPostal",this.AcceptPostal,this),this.newPostalView.on("ClearPostal",this.ClearPostalDetails,this),this.newPostalView.Show(o,this.countrySelected,this.countryCollection)},AcceptPostal:function(e){this.countrySelected=e.CountryCode,this.SetSelectedCountry(),t("#data-country").trigger("change"),t("#data-postal-code").val(e.PostalCode),t("#data-state").val(e.StateCode),this.postal=e.PostalCode,this.city=e.City,this.LoadPostal(this.postal)},ClearPostalDetails:function(){t("#data-postal-code").val(""),this.postal="",this.ClearCity()},DisplayResultOnPostal:function(e){var o=t("#data-postal-code").val();if(this.newCollection=new h,this.postalCollection.reset(e),this.postalCollection.each(this.RemoveInvalidPostals,this),this.postalCollection=this.newCollection,0===this.postalCollection.length){if(l.ListJustTapped)return;navigator.notification.confirm("The Postal Code '"+o+"' does not exist in the Country selected. Do you want to add '"+o+"' ?",m,"Postal Not Found",["Yes","No"])}else t('#data-city > option[val !=""]').remove(),this.LoadRetrievedPostal(),t("#data-city").prop("selectedIndex",0),t("#data-city").trigger("change")},SetFields:function(e){var o=e.get("City");this.SetCounty(e),t("#data-city").append(new Option(o,o))},SetState:function(){var e=t("#data-city option:selected").val();if(""!=e){var o=this.postalCollection.find(function(t){return e=t.get("City")});if(!o)return void t("#data-state").val("");var a=o.get("StateCode");t("#data-state").val(a)}else t("#data-state").val("")},SetCounty:function(t){this.county=t.get("County"),this.timeZone=t.get("TimeZone")},LoadRetrievedPostal:function(){this.postalCollection.each(this.SetFields,this)},RefreshiScroll:function(){this.myScroll?this.myScroll.refresh():this.myScroll=new iScroll("detail-body",{vScrollbar:!0,vScroll:!0,snap:!0,momentum:!0,onBeforeScrollStart:function(t){for(var e=t.target;1!=e.nodeType;)e=e.parentNode;"SELECT"!=e.tagName&&"INPUT"!=e.tagName&&"TEXTAREA"!=e.tagName&&t.preventDefault()}})},LoadDrapDowns:function(){var e=this.model.get("City");this.LoadCountries(),t("#data-city").append(new Option(e,e))},LoadCountries:function(){var t=this;this.index=0,this.countryModel.set({Criteria:""}),this.countryModel.save(null,{success:function(e,o){l.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.countryCollection.reset(o.Countries),t.DisplayCountries(),t.SetSelectedCountry()},error:function(t,e,o){l.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.RequestError(e,"Error Loading Country List")}})},DisplayCountries:function(){0===this.countryCollection.length?(console.log("no countries available."),navigator.notification.alert("No country available.",null,"No Country Found","OK")):(t('#data-country > option[val !=""]').remove(),this.LoadRetrievedCountry())},LoadRetrievedCountry:function(){this.countryCollection.each(this.SetCountryOptions,this)},SetCountryOptions:function(e){var o=e.get("CountryCode");t("#data-country").append(new Option(o,o))},SetSelectedCountry:function(){t("#data-country > option[value='"+this.countrySelected+"']").attr("selected","selected")},CountryChanged:function(e){var o=e.target.id,a=t("#"+o).val(),l=t("#data-postal-code").val();this.countrySelected!=a&&l.length>0&&this.ClearPostalInfo(),this.countrySelected=a,this.PreviousCountrySelected=a},GetUpdatedModelAttributes:function(){var e=t("#data-contact-full-name").val(),o=t("#data-postal-code").val(),a=t("#data-country").val(),l=t("#data-address").val(),i=t("#data-city").val(),s=t("#data-email").val(),n=t("#data-business-phone").val(),d=t("#data-state").val(),r=this.model.attributes.IsAllowWebAccess,c=this.model.attributes.Password;return 1==r&&(s||c?s&&!c&&(r=!1):r=!1),this.model.set({ContactFullName:e,PostalCode:o,Country:a,Address:l,City:i,State:d,Email1:s,BusinessPhone:n,County:this.county,TimeZone:this.timeZone,IsAllowWebAccess:r}),this.model.attributes},ValidData:function(){this.GetUpdatedModelAttributes();var e=t("#data-email").val(),o=t("#data-contact-full-name").val(),a="";if(null===o||void 0===o||""===o)a="Name is required";else{if(!(e.length>0))return!0;if(!this.ValidateEmailFormat(e))return!0;a="Email format is invalid."}return n.Customers.ShowNotification(a,!0),!1},InitializeCustomerLookup:function(){this.trigger("initializeCustomerLookup",this)},seachBtn_Tapped:function(t){t.preventDefault(),this.InitializeCustomerLookup()},InitializeChildViews:function(){},Close:function(){this.remove(),this.unbind()},ValidateEmailFormat:function(t){var e=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i;return t.search(e)==-1},AssignNumericValidation:function(t){n.Input.NonNegativeInteger("#"+t.target.id)}});return v});