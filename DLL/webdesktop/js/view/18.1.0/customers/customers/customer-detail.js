define(["jquery","mobile","underscore","backbone","shared/global","shared/service","shared/method","shared/shared","model/base","model/lookupcriteria","model/contact","collection/base","view/18.1.0/customers/customers/detail/general","view/18.1.0/customers/customers/detail/contacts","view/18.1.0/customers/customers/detail/note","text!template/18.1.0/customers/customers/customer-detail.tpl.html"],function(e,t,o,s,i,n,r,a,c,h,l,d,u,C,m,w){var g,v={Body:".detail-body"},S={General:"General",Contact:"Contact",Info:"Info",Note:"Note"},f=s.View.extend({_customerDetailTemplate:o.template(w),events:{"tap #general":"tabGeneral_click","tap #contact":"tabContact_click","tap #info":"tabInfo_click","tap #note":"tabNote_click","tap #btn-finish":"btnFinish_Tapped","tap #btn-cancel":"btnCancel_click","tap #btn-save":"btnSave_click","tap #btn-delete":"btnDelete_click"},CurrentTab:"General",tabGeneral_click:function(e){e.preventDefault(),this.ChangeTab("#general",S.General)},tabContact_click:function(e){e.preventDefault(),this.ChangeTab("#contact",S.Contact)},tabNote_click:function(e){e.preventDefault(),this.ChangeTab("#note",S.Note)},tabInfo_click:function(e){e.preventDefault(),this.ChangeTab("#info",S.Info)},btnCancel_click:function(e){e.preventDefault(),this.trigger("cancel",this)},btnDelete_click:function(e){e.preventDefault(),g=this;var t=this.GetTabName();navigator.notification.confirm("Are you sure you want to delete this "+t+"?",g.ConfirmDelete,"Delete Customer",["Yes","No"])},btnFinish_Tapped:function(e){if(e.preventDefault(),this.model||this.CurrentTab==S.Note)switch(this.CurrentTab){case S.General:this.generalView.ValidData()&&this.SaveNewCustomer();break;case S.Contact:this.contactView.ValidData()&&this.SaveNewContact();break;case S.Note:this.noteView.ValidData()&&this.SaveNewNote()}},btnSave_click:function(e){switch(e.preventDefault(),this.CurrentTab){case S.General:this.generalView.ValidData()&&this.SaveCustomerChanges();break;case S.Contact:this.contactView.ValidData()&&this.SaveContactChanges();break;case S.Note:this.noteView.ValidData()&&this.SaveNoteChanges()}},initialize:function(){this.CurrentTab=S.General,this.$el.show()},render:function(){return this.model?this.$el.html(this._customerDetailTemplate):this.CurrentTab==S.Note||(this.$el.html(""),this.DisplayNoRecordFound()),this},DisplayNoRecordFound:function(){a.Products.DisplayNoRecordFound("#right-panel",".list-wrapper",this.toBeSearched)},GetTabName:function(){var e="";switch(this.CurrentTab){case"General":e="Customer";break;case"Contact":e="Contact";break;case"Note":e="Note";break;default:console.log("No tabName got.")}return e},ChangeTab:function(e,t){this.CurrentTab!=t&&(this.CurrentTab=t,t==S.General&&this.TriggerCustomerLookup(),t==S.Contact&&this.TriggerContactLookup(),t==S.Info&&this.LoadInfoView(),t==S.Note&&this.TriggerNoteLookup())},ChangeDisplayTab:function(t){e(".detail-header .tab-active").addClass("tab"),e(".detail-header .tab").removeClass("tab-active"),e(t).addClass("tab-active"),e(t).removeClass("tab")},TriggerCustomerLookup:function(e){i.fromContactsToGeneralTab=!0,this.trigger("loadCustomers")},LoadGeneralView:function(t){this.model&&(this.SetCustomerDetails(),this.ChangeDisplayTab("#general"),t=this.IsNew,t&&e("#customers-details").addClass("addmode"),this.CurrentTab=S.General,this.generalView=new u({el:v.Body}),this.generalView.el=v.Body,this.generalView.model=this.model,this.generalView.IsNew=t,this.generalView.CustomerCode=this.model.get("CustomerCode"),this.generalView.Show())},LoadContactView:function(t){this.model&&(this.SetContactDetails(),this.ChangeDisplayTab("#contact"),t=this.IsNew,t&&e("#customers-details").addClass("addmode"),this.CurrentTab=S.Contact,this.contactView=new C({el:v.Body}),this.contactView.el=v.Body,this.contactView.model=this.model,this.contactView.IsNew=t,this.contactView.ContactCode=this.model.get("ContactCode"),this.contactView.Show())},LoadNoteView:function(t){var o=!1,s="",i="";this.model?(this.SetNoteDetails(),s=this.model.get("CustomerCode")||this.model.get("EntityCode"),i=this.model.get("DefaultContactCode")||this.model.get("ContactCode")):(o=!0,this.generalView&&(s=this.generalView.CustomerCode),this.contactView&&(i=this.contactView.ContactCode)),this.ChangeDisplayTab("#note"),t=this.IsNew,t&&e("#customers-details").addClass("addmode"),this.CurrentTab=S.Note,this.noteView=new m({el:v.Body}),this.noteView.el=v.Body,this.noteView.model=this.model,this.noteView.IsNew=t,this.noteView.entityCode=s,this.noteView.contactCode=i,this.noteView.IsNoRecord=o,this.noteView.toBeSearched=this.toBeSearched,t?this.noteView.AddMode():this.noteView.Show()},SetCustomerDetails:function(){this.customerModel||(this.customerModel=new c),this.customerModel.set(this.model.attributes),this.CustomerCode=this.customerModel.get("CustomerCode"),this.CustomerName=this.customerModel.get("CustomerName"),e("#newcustomer-title").text("New Customer")},TriggerContactLookup:function(){var e="";if(this.model)e=this.model.get("CustomerCode");else if(console.log("No customer selected."),this.contactView)this.model=this.contactView.model;else{if(!this.noteView)return;e=this.noteView.entityCode}this.trigger("loadCustomerContacts",e)},TriggerNoteLookup:function(){if(!this.model){if(console.log("No customer selected."),!this.noteView)return;this.model=this.noteView.model}this.trigger("loadCustomerNotes",this.model.get("CustomerCode")||this.model.get("EntityCode"))},SetContactDetails:function(){this.contactModel||(this.contactModel=new c),this.contactModel.set(this.model.attributes),this.ContactCode=this.contactModel.get("ContactCode"),this.ContactEntityCode=this.contactModel.get("EntityCode"),e("#newcustomer-title").text("New Contact")},SetNoteDetails:function(){this.noteModel||(this.noteModel=new c),this.noteModel.set(this.model.attributes),this.EntityCode=this.noteModel.get("EntityCode"),this.ContactCode=this.noteModel.get("ContactCode"),this.NoteCode=this.noteModel.get("NoteCode"),this.ContactEntityCode=this.noteModel.get("EntityCode")||this.noteCode.get("ContactCode"),e("#newcustomer-title").text("New Note")},ResetMain:function(){e(v.Main).html("<div></div>")},Show:function(e){this.render(),this.DisplayWait(),this.DisplayDetails(),this.CheckProductEdition()},CheckProductEdition:function(){i._UserIsCS},InitializeChildViews:function(){},DisplayWait:function(){e(v.Body).html('<center><div class="loading"><i class="icon-spinner icon-spin"></i></div></center>')},DisplayError:function(){e(v.Body).html('<center><div class="loading"><i class="icon-warning-sign"></i></div></center>')},DisplayDetails:function(){switch(this.CurrentTab){case S.General:this.LoadGeneralView(this.IsNew);break;case S.Contact:this.LoadContactView(this.IsNew);break;case S.Note:this.LoadNoteView(this.IsNew)}},AddMode:function(){switch(a.Customers.Overlay.Show(),this.CurrentTab){case S.General:this.InitializeCustomerSchema();break;case S.Contact:this.InitializeContactSchema();break;case S.Note:this.InitializeCustomerNote()}},InitializeCustomerSchema:function(){var e=this;this.customerschema=new c,this.customerschema.url=i.ServiceUrl+n.CUSTOMER+r.GETNEWCUSTOMERSCHEMA,this.customerschema.fetch({success:function(t,o,s){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.SuccessCustomerSchema(o)},error:function(e,t,o){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),a.Customers.Overlay.Hide(),e.RequestError(t,"Error Fetching customer schema")}})},SuccessCustomerSchema:function(e){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.customerschema=new c,this.customerschema.set(e),this.customerschema.set({CustomerName:"New Customer"}),this.trigger("schemaFetched",this)},ErrorCustomerSchema:function(e,t,o){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(error,"Error generating new customer schema","An error was encountered when trying to generate customer schema contacts.")},GetCustomerJsonValues:function(){return this.generalView.UpdateModelValues(),this.generalView.model.attributes},InitializeContactSchema:function(){var e=this.CustomerCode;this.contactschema=new l,this.contactschema.url=i.ServiceUrl+n.CUSTOMER+r.GETNEWCONTACTSCHEMA,this.contactschema.on("sync",this.SuccessContactSchema,this),this.contactschema.on("error",this.ErrorContactSchema,this),this.contactschema.set({EntityCode:e,Type:"CustomerContact"}),this.contactschema.save()},SuccessContactSchema:function(e,t){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.SetContactSchema(t)},ErrorContactSchema:function(e,t,o){a.Customers.Overlay.Hide(),e.RequestError(error,"Error retrieving contact schema")},SetContactSchema:function(e){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.contactschema.set(e),this.contactschema.set({ContactFullName:"New Customer Contact"}),this.trigger("schemaFetched",this)},SaveResponse:function(e){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.model.set(e)},GetContactJsonValues:function(){return this.contactView.GetUpdatedModelAttributes()},GetNoteJsonValues:function(){return this.noteView.GetUpdatedModelAttributes()},SaveCustomerChanges:function(){a.Customers.Overlay.Show();var e=new c;e.url=i.ServiceUrl+n.CUSTOMER+r.UPDATECUSTOMER,e.on("sync",this.SuccessfullySaved,this),e.on("error",this.ErrorEncountered,this),e.set(this.GetCustomerJsonValues()),e.save()},SaveContactChanges:function(){a.Customers.Overlay.Show();var e=new c;e.url=i.ServiceUrl+n.CUSTOMER+r.UPDATECONTACT,e.on("sync",this.SuccessfullySaved,this),e.on("error",this.ErrorEncountered,this),e.set(this.GetContactJsonValues()),e.save()},SaveNoteChanges:function(){a.Customers.Overlay.Show();var e=new c;e.url=i.ServiceUrl+n.CUSTOMER+r.UPDATECUSTOMERNOTE,e.on("sync",this.SuccessfullySaved,this),e.on("error",this.ErrorEncountered,this),e.set(this.GetNoteJsonValues()),e.save()},DeleteCustomer:function(){var e=this.model.get("CustomerCode");this.CustomerCode=e;var t=new c;t.url=i.ServiceUrl+n.CUSTOMER+r.DELETECUSTOMERBYCUSTOMERCODE,t.on("sync",this.SuccessfullyDeleted,this),t.on("error",this.ErrorDeleting,this),t.set({StringValue:e}),t.save()},DeleteContact:function(){var e=this.model.get("ContactCode");this.ContactCode=e;var t=new c;t.url=i.ServiceUrl+n.CUSTOMER+r.DELETECONTACT,t.on("sync",this.SuccessfullyDeleted,this),t.on("error",this.ErrorDeleting,this),t.set({ContactCode:e}),t.save()},DeleteNote:function(){var e=this.model.get("NoteCode");this.NoteCode=e;var t=new c;t.url=i.ServiceUrl+n.CUSTOMER+r.DELETECUSTOMERNOTE,t.on("sync",this.SuccessfullyDeleted,this),t.on("error",this.ErrorDeleting,this),t.set({NoteCode:e}),t.save()},SuccessfullyDeleted:function(e,t,o){return i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.CurrentTab==S.Note?void this.trigger("deleted"):void(null===t.ErrorMessage?this.trigger("deleted"):(this.errorDeleteMsg=t.ErrorMessage,this.trigger("cannotDelete")))},ErrorDeleting:function(e,t,o){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),a.Customers.Overlay.Hide(),e.RequestError(t,"Error Deleting "+this.GetTabName()+".")},SaveNewCustomer:function(){a.Customers.Overlay.Show();var e=new c;e.url=i.ServiceUrl+n.CUSTOMER+r.CREATECUSTOMER,e.on("sync",this.SuccessfullySaved,this),e.on("error",this.ErrorEncountered,this),e.set(this.GetCustomerJsonValues()),e.save()},SaveNewContact:function(){a.Customers.Overlay.Show();var e=new l;e.url=i.ServiceUrl+n.CUSTOMER+r.CREATENEWCONTACT,e.on("sync",this.SuccessfullySaved,this),e.on("error",this.ErrorEncountered,this),e.set(this.GetContactJsonValues()),e.save()},SaveNewNote:function(){a.Customers.Overlay.Show();var e=new c;e.url=i.ServiceUrl+n.CUSTOMER+r.ADDCUSTOMERNOTE,e.on("sync",this.SuccessfullySaved,this),e.on("error",this.ErrorEncountered,this),e.set(this.GetNoteJsonValues()),e.save()},SuccessfullySaved:function(e,t,o){if(i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),""===t.ErrorMessage||null===t.ErrorMessage){switch(this.model?this.model.set(t):(this.model=new c,this.model.set(t)),this.CurrentTab){case S.General:this.SetCustomerDetails();break;case S.Contact:this.SetContactDetails();break;case S.Note:this.SetNoteDetails()}this.IsNew?this.SaveCompleted():this.trigger("updated")}else a.Customers.ShowNotification(t.ErrorMessage,!0),this.trigger("failed",this.model)},ErrorEncountered:function(e,t,o){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),a.Customers.Overlay.Hide(),e.RequestError(t,"Error Saving New "+this.GetTabName()+".")},SaveCompleted:function(){switch(this.CurrentTab){case S.General:this.trigger("newCustomerSaved",this);break;case S.Contact:this.trigger("newContactSaved",this);break;case S.Note:this.trigger("newNoteSaved",this)}},ConfirmDelete:function(e){if(1===e)switch(a.Customers.Overlay.Show(),g.CurrentTab){case S.General:g.DeleteCustomer();break;case S.Contact:g.DeleteContact();break;case S.Note:g.DeleteNote()}},NotifyMsg:function(e,t){console.log(e),navigator.notification.alert(e,null,t,"OK")},InitializeCustomerNote:function(){this.IsNew=!0,this.LoadNoteView(this.IsNew)}});return f});