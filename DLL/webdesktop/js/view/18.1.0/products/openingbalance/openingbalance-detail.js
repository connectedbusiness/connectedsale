define(["jquery","mobile","underscore","backbone","shared/global","shared/service","shared/method","shared/shared","model/base","model/lookupcriteria","collection/base","view/18.1.0/products/openingbalance/detail/general","view/18.1.0/products/openingbalance/detail/openingbalance","text!template/18.1.0/products/openingbalance/openingbalance-detail.tpl.html"],function(e,t,i,o,n,a,s,l,r,c,h,d,u,w){var p,C={Body:".opening-balance-body div",Main:".opening-balance-body"},b={General:"General",OpeningBalance:"OpeningBalance"},g=o.View.extend({_openingBalanceDetailTemplate:i.template(w),events:{"tap #general":"tabGeneral_click","tap #btn-cancel":"btnClick_Cancel","tap #btn-finish":"btnClick_Finish"},tabGeneral_click:function(e){e.preventDefault(),this.ChangeTab(b.General)},btnClick_Cancel:function(e){e.preventDefault(),this.trigger("cancel",this)},btnClick_Finish:function(e){e.preventDefault(),this.SaveOpeningBalance()},CurrentTab:"General",initialize:function(){p=this,this.CurrentTab=b.General,this.IsNew=!1,this.$el.show()},render:function(){return this.model?this.$el.html(this._openingBalanceDetailTemplate()):(this.$el.html(""),this.$el.html(this._openingBalanceDetailTemplate()),this.IsNew||this.DisplayNoRecordFound()),this},Show:function(){this.render(),this.DisplayWait(),this.GetItemDetails()},InitializeChildViews:function(){},DisplayWait:function(){l.Products.DisplayWait(C.Body)},DisplayError:function(){l.Products.DisplayError(C.Body)},DisplayNoRecordFound:function(){l.Products.DisplayNoRecordFound("#right-panel","#list-wrapper",this.toBeSearched)},ChangeTab:function(e){this.CurrentTab!=e&&(e==b.General&&this.LoadGeneralView(),e==b.OpeningBalance&&this.LoadOBView(),this.CurrentTab=e)},ChangeDisplayTab:function(t){e(".opening-balance-detail-header .tab-active").addClass("tab"),e(".opening-balance-detail-header .tab").removeClass("tab-active"),e(t).addClass("tab-active"),e(t).removeClass("tab")},InitializeNewModels:function(){this.InitializeItemModel(),this.InitializeOBCollection()},InitializeItemModel:function(){this.model=new r},InitializeOBCollection:function(){this.obCollection=new h;var e=new r;e.set(this.NewOBSchema()),this.obCollection.add(e)},ResetMain:function(){e(C.Main).html("<div></div>")},LoadGeneralView:function(){this.ChangeDisplayTab("#general"),this.model&&(this.CurrentTab=b.General,this.generalView&&this.generalView.Close(),this.ResetMain(),this.generalView=new d({el:C.Body}),this.generalView.el=C.Body,this.generalView.model=this.model,this.generalView.IsNew=this.IsNew,this.DisplayWait(),this.generalView.Show())},LoadOBView:function(){if(this.ChangeDisplayTab("#openingbalance"),this.obCollection)return this.obView&&this.obView.Close(),this.obView=new u({el:C.Body}),this.obView.on("itemLookup",this.TriggerItemLookUp,this),this.obView.on("itemChanged",this.LoadNewOBSchemaByItemCode,this),this.obView.collection=this.obCollection,this.obView.NewOBSchema=this.NewOBSchema(),this.obView.IsNew=this.IsNew,this.DisplayWait(),this.IsNew?void this.LoadLocation():void this.obView.Show()},TriggerItemLookUp:function(){console.log("ob-detail itemLookup"),this.trigger("itemLookup"),this.GetCurrentOBDetails()},GetCurrentOBDetails:function(){this.currentOBCID=this.obView.currentCID,this.currentOBModel=this.currentmodel},GetItemDetails:function(){return this.model?void this.LoadGeneralView():void e(C.Body).html("")},AddMode:function(){this.IsNew=!0,this.render(),e("#opening-balance-details").addClass("addmode"),this.InitializeNewModels(),this.LoadOBView()},SaveOpeningBalance:function(){this.ValidateOBCollection()&&this.Save()},LoadLocation:function(){this.InitializeLocationLookup(),this.locationLookup.url=n.ServiceUrl+a.PRODUCT+s.GETLOCATIONLOOKUP+"100",this.locationLookup.set({StringValue:null}),this.locationLookup.save()},InitializeLocationLookup:function(){this.locationLookup||(this.locationLookup=new c,this.locationLookup.on("sync",this.LookupSuccess,this),this.locationLookup.on("error",this.LookupError,this))},LookupSuccess:function(e,t,o){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.locationCodeCollection||(this.locationCodeCollection=new h);var a=i.reject(t.Warehouses,function(e){return 0==e.IsActive});this.locationCodeCollection.reset(a),this.obView.locationCodeCollection=this.locationCodeCollection,this.obView.Show()},LookupError:function(e,t,i){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),l.Products.RequestTimeOut(),this.obView.Show()},LoadNewOBSchemaByItemCode:function(e){if(void 0!==e&&""!==e.trim()&&null!==e){var t=new r;t.url=n.ServiceUrl+a.PRODUCT+s.GETITEMOPENINGBALANCE+e,t.on("sync",this.LoadOBSchemaSuccess,this),t.on("error",this.LoadOBSchemaFailed,this),l.Products.Overlay.Show(),t.save()}},LoadOBSchemaSuccess:function(e,t){n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),l.Products.Overlay.Hide(),this.tmp=new r,this.tmp.set(t),this.obView.ReplaceModelByCID(t)},LoadOBSchemaFailed:function(e,t,i){l.Products.Overlay.Hide(),l.Products.RequestTimeOut()},Save:function(){var e=new r,t=new h;t.reset(this.obView.GetCurrentCollection().models);var i=new Array;t.each(function(e){""===e.get("ItemName")&&(i[i.length]=e)});for(var o=0;o<i.length;o++)t.remove(i[o]);return 0==t.length?void navigator.notification.alert("Please enter an item!",null,"No item found.","OK"):(e.url=n.ServiceUrl+a.PRODUCT+s.CREATEITEMOPENINGBALANCE,e.on("sync",this.SaveNewOBSuccess,this),e.on("error",this.SaveNewOBFailed,this),e.set({InventoryOpeningBalance:t.toJSON()}),l.Products.Overlay.Show(),void e.save())},SaveNewOBSuccess:function(e,t){return n.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),l.Products.Overlay.Hide(),e.get("ErrorMessage")?void navigator.notification.alert(e.get("ErrorMessage"),null,"Saving Error","OK"):(this.collection||(this.collection=new h),this.collection.reset(t.InventoryOpeningBalance),this.model||(this.savedmodel=new r),this.savedModel=this.collection.at(0),void this.trigger("saved",this))},SaveNewOBFailed:function(e,t,i){l.Products.Overlay.Hide(),l.Products.RequestTimeOut()},ValidateOBCollection:function(){if(!this.obCollection)return!1;var e="",t=!1;return this.obCollection.reset(this.obView.GetCurrentCollection().models),this.obCollection.each(function(i){if(!t&&""!==i.get("ItemName"))return 0==i.get("Quantity")||""===i.get("Quantity")?(t=!0,void(e="Quantity")):""===i.get("ConvertedTransactionDate")?(t=!0,void(e="TransactionDate")):void 0}),!t||(this.ShowWarning(e),!1)},ShowWarning:function(e){var t;switch(e){case"ItemName":t="Item Name";break;case"Quantity":t="Quantity";break;case"TransacationDate":t="Transaction Date";break;case"Cost":t="Cost"}return navigator.notification.alert(t+" is required!",null,"Incomplete Details","OK"),!1},NewOBSchema:function(){return{IsNew:!1,IsBase:!1,AccountCode:"",Cost:0,DatePosted:"",IsPosted:!1,IsPrinted:!1,IsVoided:!1,ItemCode:"",ItemDescription:"",ItemName:"",LocationCode:"",OpeningBalanceCode:"[To be generated]",PrintCount:0,Quantity:0,Reason:"",WarehouseCode:"",TransactionDate:"",ConvertedTransactionDate:"",TransactionType:"",UnitMeasureCode:"",UnitMeasureQty:1}},GetCurrentCollection:function(){return this.obCollection.reset(this.obView.GetCurrentCollection().models)}});return g});