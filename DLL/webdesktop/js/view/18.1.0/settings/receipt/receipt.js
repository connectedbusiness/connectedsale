define(["jquery","mobile","underscore","backbone","shared/global","shared/service","shared/method","shared/shared","model/receipt","collection/receipts","collection/preferences","view/18.1.0/settings/receipt/print/printsetting","view/18.1.0/settings/receipt/typelist/receipttypelist","view/18.1.0/settings/modal/modal","text!template/18.1.0/settings/receipt/receipt.tpl.html","js/libs/iscroll.js","js/libs/ui.checkswitch.min.js"],function(e,t,i,r,o,n,s,a,c,p,l,d,h,R,u){var C=r.View.extend({_template:i.template(u),events:{"tap #printer-settings":"showPrintSettings","change #AutoPrintReceipt":"AutoPrintReceipt_toggled","tap #sale-receipt":"SaleReceiptTapped","tap #order-receipt":"OrderReceiptTapped","tap #quote-receipt":"QuoteReceiptTapped","tap #return-receipt":"ReturnReceiptTapped","tap #credit-card-receipt":"CreditCardReceiptTapped","tap #sale-payment-receipt":"SalePaymentReceiptTapped","tap #pick-note-receipt":"PickNoteTapped","tap #z-tape-report":"ZTapeTapped","tap #x-tape-report":"XTapeTapped","change #CreditCardReceiptCopies":"CreditCardReceiptCopies_Change","tap #IsSinglePageTransactionReceipt, #ShowPrintOptions, #AutoEmailReceipt, #AutoPrintReceipt":"Chkbox_click"},SaleReceiptTapped:function(e){e.preventDefault(),this.UpdatePreference(),this.InitializeReceiptModel("InvoiceReportCode")},OrderReceiptTapped:function(e){e.preventDefault(),this.UpdatePreference(),this.InitializeReceiptModel("OrderReportCode")},QuoteReceiptTapped:function(e){e.preventDefault(),this.UpdatePreference(),this.InitializeReceiptModel("QuoteReportCode")},ReturnReceiptTapped:function(e){e.preventDefault(),this.UpdatePreference(),this.InitializeReceiptModel("ReturnReportCode")},CreditCardReceiptTapped:function(e){e.preventDefault(),this.UpdatePreference(),this.InitializeReceiptModel("CreditCardReportCode")},SalePaymentReceiptTapped:function(e){e.preventDefault(),this.UpdatePreference(),this.InitializeReceiptModel("SalePaymentReportCode")},PickNoteTapped:function(e){e.preventDefault(),this.UpdatePreference(),this.InitializeReceiptModel("PickNoteReportCode")},ZTapeTapped:function(e){e.preventDefault(),this.UpdatePreference(),this.InitializeReceiptModel("ZTapeReportCode")},XTapeTapped:function(e){e.preventDefault(),this.UpdatePreference(),this.InitializeReceiptModel("XTapeReportCode")},Chkbox_click:function(e){e.preventDefault();var t="#"+e.currentTarget.id,i=this.GetCheckState(t);this.SetChkState(e.currentTarget.id,!i)},InitializeReceiptModel:function(e){this.receiptCollection=new p,this.receiptCollection.on("selected",this.UpdateReportCodeSelected,this),this.lookupReportMode=e,this.receiptModel;var t=100;this.receiptModel=new c,this.receiptModel.url=o.ServiceUrl+n.POS+s.REPORTCODELOOKUP+e+"/"+t,this.RetrieveReportCodes()},RetrieveReportCodes:function(){var e=this,t=" ";this.receiptModel.set({Criteria:t}),this.receiptModel.save(null,{success:function(t,i){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.receiptCollection.reset(i.ReportViews),e.ValidateCollection(e.receiptCollection)},error:function(e,t,i){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Retrieving Report Codes")}})},ValidateCollection:function(e){0===e.length?(console.log("No Data Found!"),navigator.notification.alert("No Report found.",null,"No Report Found","OK")):this.ShowReceiptTypePage(e)},ShowReceiptTypePage:function(t){_selectedReportCode=this.GetSelectedReportCode(),this.SetSelectedPage("ReceiptTypeListPage"),this.settingsModal=new R({el:e("#settings-modal-container"),collection:t,preferencetype:"Receipt",selectedReport:_selectedReportCode})},UpdateReportCodeSelected:function(e){if(this.preferenceCollection&&0!==this.preferenceCollection.length&&this.preferences&&0!==this.preferences.length){_prevReportCode=this.GetSelectedReportCode(),_prevReportCode!==e.get("ReportCode")&&(this.AssignChangesToPreference(e),this.Save(),this.InitializeDisplay(),this.CloseModal())}},CloseModal:function(){null!=this.settingsModal&&this.settingsModal.close()},AssignChangesToPreference:function(e){var t=this.preferenceCollection.at(0);e.get("ReportCode");switch(console.log("lookupmode ="+this.lookupReportMode),this.lookupReportMode){case"InvoiceReportCode":t.set({InvoiceReportCode:e.get("ReportCode"),InvoiceReportName:e.get("ReportName")});break;case"ReturnReportCode":t.set({ReturnReportCode:e.get("ReportCode"),ReturnReportName:e.get("ReportName")});break;case"OrderReportCode":t.set({OrderReportCode:e.get("ReportCode"),OrderReportName:e.get("ReportName")});break;case"QuoteReportCode":t.set({QuoteReportCode:e.get("ReportCode"),QuoteReportName:e.get("ReportName")});break;case"CreditCardReportCode":t.set({CreditCardReportCode:e.get("ReportCode"),CreditCardReportName:e.get("ReportName")});break;case"SalePaymentReportCode":t.set({SalePaymentReportCode:e.get("ReportCode"),SalePaymentReportName:e.get("ReportName")});break;case"PickNoteReportCode":t.set({PickNoteReportCode:e.get("ReportCode"),PickNoteReportName:e.get("ReportName")});break;case"XTapeReportCode":t.set({XTapeReportCode:e.get("ReportCode"),XTapeReportName:e.get("ReportName")});break;case"ZTapeReportCode":t.set({ZTapeReportCode:e.get("ReportCode"),ZTapeReportName:e.get("ReportName")})}this.preferenceCollection.reset(t)},GetSelectedReportCode:function(){var e,t=this.preferenceCollection.at(0);switch(this.lookupReportMode){case"InvoiceReportCode":e=t.get("InvoiceReportCode");break;case"ReturnReportCode":e=t.get("ReturnReportCode");break;case"OrderReportCode":e=t.get("OrderReportCode");break;case"QuoteReportCode":e=t.get("QuoteReportCode");break;case"CreditCardReportCode":e=t.get("CreditCardReportCode");break;case"SalePaymentReportCode":e=t.get("SalePaymentReportCode");break;case"PickNoteReportCode":e=t.get("PickNoteReportCode");break;case"XTapeReportCode":e=t.get("XTapeReportCode");break;case"ZTapeReportCode":e=t.get("ZTapeReportCode")}return e},SearchReport:function(e){console.log(e),this.FetchReport(50,e)},FetchReport:function(e,t){var i=this,r=new c,a=e;r.set({StringValue:t}),r.url=o.ServiceUrl+n.POS+s.REPORTCODELOOKUP+this.lookupReportMode+"/"+a,r.save(null,{success:function(e,t){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),i.receiptCollection.reset(t.ReportViews),i.ValidateCollection(i.receiptCollection)},error:function(e,t,i){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Retrieving Report Code")}})},ValidateData:function(){if(!this.preferenceCollection)return!0;var e=this.preferenceCollection.at(0);return!(!o.isBrowserMode&&e.get("UseCashDrawer")&&e.get("AutoPrintReceipt")&&a.IsNullOrWhiteSpace(o.Printer.PrinterModel)&&a.IsNullOrWhiteSpace(o.Printer.IpAddress))||(navigator.notification.alert("There is no Printer connected as of the moment. Please try again",null,"No Printer Connected","OK"),o.BackToMain=!1,this.IsFocusReceipt=!0,!1)},Save:function(){switch(this.selectedPage){case"Receipt":case"ReceiptTypeListPage":this.UpdateReceiptPreference();break;case"PrintSetting":console.log("UpdatePrintSettings")}this.backToMain&&this.SaveCompleted()},initialize:function(){this.AllowSilentSave=!0,this.on("ReportLookup",this.SearchReport,this),this.render()},GetCheckState:function(t){return!!e(t).hasClass("icon-ok-sign")},ToggleCheckbox:function(t,i){i?(e("#"+t).addClass("icon-ok-sign").css("color",""),e("#"+t).removeClass("icon-circle-blank")):(e("#"+t).addClass("icon-circle-blank").css("color","#DADADA"),e("#"+t).removeClass("icon-ok-sign"))},SetChkState:function(e,t){var i=this;switch(e){case"AutoEmailReceipt":i.autoEmailReceipt=t;break;case"ShowPrintOptions":i.showPrintOptions=t;break;case"AutoPrintReceipt":i.autoPrintReceipt=t,t&&(t=i.autoPrintReceipt_change(t));break;case"IsSinglePageTransactionReceipt":i.singlePageTransaction=t}i.ToggleCheckbox(e,t)},ToggleCheckboxes:function(){var e=this,t=this.preferenceCollection.at(0),r=["AutoEmailReceipt","ShowPrintOptions","AutoPrintReceipt","IsSinglePageTransactionReceipt"],o=t.get("PromptEmailAddress")||t.get("PromptToPrintReceipt");t.set({ShowPrintOptions:o}),i.each(r,function(i){switch(i){case"IsSinglePageTransactionReceipt":e.singlePageTransaction=t.attributes.IsSinglePageTransactionReceipt;break;case"AutoEmailReceipt":e.autoEmailReceipt=t.attributes.AutoEmailReceipt;break;case"ShowPrintOptions":e.showPrintOptions=t.attributes.ShowPrintOptions;break;case"AutoPrintReceipt":e.autoPrintReceipt=t.attributes.AutoPrintReceipt}t.get(i)?e.SetChkState(i,!0):e.SetChkState(i,!1)})},autoPrintReceipt_change:function(e){return!!(""!==o.Printer.IpAddress&&null!==o.Printer.IpAddress||o.isBrowserMode)||(navigator.notification.alert("Please set printer IP address first before enabling AutoPrint.",null,"Required Action","OK"),this.autoPrintReceipt=!1,!1)},UpdatePreference:function(){var e=this,t=e.preferenceCollection.at(0),r=["AutoEmailReceipt","ShowPrintOptions","AutoPrintReceipt","IsSinglePageTransactionReceipt"];i.each(r,function(i){var r=!1;switch(i){case"IsSinglePageTransactionReceipt":r=e.singlePageTransaction,t.set({IsSinglePageTransactionReceipt:r});break;case"AutoEmailReceipt":r=e.autoEmailReceipt,t.set({AutoEmailReceipt:r});break;case"ShowPrintOptions":r=e.showPrintOptions,t.set({PromptEmailAddress:r,PromptToPrintReceipt:r});break;case"AutoPrintReceipt":r=e.autoPrintReceipt,t.set({AutoPrintReceipt:r})}}),this.preferenceCollection.reset(t)},InitializeDisplay:function(){console.log("Initialize Display"),this.SetSelectedPage("Receipt");var t=this.preferenceCollection.at(0);this.AssignAirprint(t),e("#settings-report-search").remove(),e("#right-pane-content").html(""),e("#right-pane-content").css("padding",""),this.$el.html(this._template(t.toJSON())),o.isBrowserMode&&e(".printerSettings").remove(),this.ToggleCheckboxes(),this.ConfigureListItems(t),o.isBrowserMode?a.UseBrowserScroll(".settings-left-pane #receipt-left-pane-content"):this.myScroll=new iScroll("scroll-wrapper")},AssignAirprint:function(e){e.get("IsAirprint")?e.set({IsAirprintDisplay:"AirPrint-enabled Printer"}):e.set({IsAirprintDisplay:"Receipt Printer"})},ConfigureListItems:function(t){var i=t.get("IsAirprint");i&&!o.isBrowserMode?e("#auto-print-receipt").addClass("ui-disabled"):e("#auto-print-receipt").removeClass("ui-disabled")},ToggleAskToPrint:function(){this.allowAskToPrintReceipt===!1?(e("#li-ask-to-print-receipt").addClass("ui-disabled"),e("#div-ask-to-print-receipt > h1 > span").removeClass("ui_check_switch_on").addClass("ui_check_switch_off"),e("#div-ask-to-print-receipt > h1 > div > span .ui_check_switch_slider").css("margin-left","-50px")):e("#li-ask-to-print-receipt").removeClass("ui-disabled")},AutoPrintReceipt_toggled:function(e){_isChecked?this.allowAskToPrintReceipt=!1:this.allowAskToPrintReceipt=!0},showPrintSettings:function(){this.UpdatePreference(),this.InitializePrintSettings()},render:function(){this.AllowSilentSave=!0,this.FetchPreference()},InitializePrintSettings:function(){this.SetSelectedPage("PrintSetting");var t=this.preferenceCollection.at(0);this.settingsModal=new R({el:e("#settings-modal-container"),model:t,preferencetype:"Printer"}),this.settingsModal.on("ModalClose",this.OnModalClose,this),this.settingsModal.printSettings.on("SaveCompleted",this.SaveCompleted,this),this.settingsModal.printSettings.SetPreferences(this.preferences)},OnModalClose:function(){e("#settings-modal-container").removeClass("settings-modal-receipt-printer"),this.UpdatePrintSettings()},InitializePreferences:function(){this.preferences||(this.preferences=new l)},InitializePreferenceCollection:function(){this.preferenceCollection||(this.preferenceCollection=new l)},FetchPreference:function(){var e=this;this.InitializePreferenceCollection(),this.InitializePreferences(),this.preferences.url=o.ServiceUrl+n.POS+s.GETPREFERENCEBYWORKSTATION+o.POSWorkstationID,this.preferences.fetch({success:function(t,i){e.ResetPreferenceCollection(i.Preference)},error:function(e,t,i){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Retrieving Workstation Preference")}})},UpdateReceiptPreference:function(){if(this.preferenceCollection&&0!==this.preferenceCollection.length&&this.preferences&&0!==this.preferences.length){this.UpdatePreference();var e=this,t=this.preferences.at(0);t.set({Preference:this.preferenceCollection.at(0)}),t.url=o.ServiceUrl+n.POS+s.UPDATEPREFERENCE,t.save(null,{success:function(t,i){e.IsSilentSave()?e.SilentSaveCompleted():e.SaveCompleted()},error:function(e,t,i){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Saving Workstation Preference")}})}},UpdatePrintSettings:function(){this.settingsModal.printSettings.Save()},SetSelectedPage:function(e){this.selectedPage=e},SaveCompleted:function(){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e("#settings-report-search").remove(),console.log("SaveReceipt"),this.trigger("SaveCompleted",this)},ResetPreferenceCollection:function(e){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.preferenceCollection.reset(e),this.InitializeDisplay()},SilentSaveCompleted:function(){this.render(),this.RemoveSearchTemplate()},IsSilentSave:function(){return"ReceiptTypeListPage"==this.selectedPage&&!a.IsNullOrWhiteSpace(this.AllowSilentSave)},RemoveSearchTemplate:function(){e("#settings-report-search").remove(),e("#back-general").hide()},CreditCardReceiptCopies_Change:function(t){this.preferenceCollection.at(0)&&this.preferenceCollection.at(0).set({CreditCardReceiptCopies:parseInt(e("#CreditCardReceiptCopies").val())})}});return C});