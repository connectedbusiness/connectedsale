define(["jquery","mobile","underscore","backbone","bigdecimal","shared/global","shared/enum","shared/service","shared/method","shared/shared","model/lookupcriteria","model/transaction","model/summary","model/salespayment","model/creditmemo","model/coupon","model/print","model/reportsetting","model/override","model/base","model/workstation","model/signature","collection/base","collection/items","collection/cart","collection/categories","collection/itemprices","collection/invoices","collection/invoicedetails","collection/salesorders","collection/salesorderdetails","collection/payments","collection/products","collection/stocks","collection/preferences","collection/transactions","collection/accessories","collection/reasons","collection/coupons","collection/localpreferences","collection/customers","collection/printers","collection/reportsettings","collection/shipto","collection/currentorders","collection/serialnumbers","collection/lotnumbers","collection/customersalereps","view/21.0.0/pos/actions/actions","view/21.0.0/pos/item/header-info/headerinfo","view/21.0.0/pos/item/items","view/21.0.0/pos/cart/cart","view/21.0.0/pos/item/category/categories","view/21.0.0/pos/payment/payment","view/21.0.0/pos/tax/taxlist","view/21.0.0/pos/item/search/product/products","view/21.0.0/pos/item/search/productdetail","view/21.0.0/pos/item/search/stock/stocks","view/21.0.0/pos/transactiontype/transactiontype","view/21.0.0/pos/transactions/transactions","view/21.0.0/pos/payment/payments","view/21.0.0/pos/coupon/coupon","view/21.0.0/pos/signature/signature","view/21.0.0/pos/reason/transactionreason","view/21.0.0/pos/print/printoptions","view/21.0.0/pos/print/printpreview","view/21.0.0/pos/print/dynamicprint","view/21.0.0/pos/print/printer","view/21.0.0/pos/manageroverride/manageroverride","view/21.0.0/pos/payment/refund","view/21.0.0/pos/drawerbalance/openingamount","view/21.0.0/pos/drawerbalance/closingamount","view/21.0.0/pos/report/statusreport","view/21.0.0/pos/payment/paymenttype","view/21.0.0/pos/seriallot/seriallot","view/21.0.0/pos/notes/notescontrol","view/21.0.0/pos/customerpo/customerpo","view/21.0.0/pos/giftcard/giftcard","view/21.0.0/pos/item/upcitem/upcitems","view/21.0.0/pos/item/gcitem/gcitems","view/21.0.0/pos/pickup/pickuplist","view/21.0.0/pos/bundle/configurator","view/21.0.0/pos/kit/configurator","view/21.0.0/pos/promotion/promotion","text!template/21.0.0/header/header.tpl.html","text!template/21.0.0/pos/item/search/search.tpl.html","text!template/21.0.0/pos/item/search/lookup.tpl.html","text!template/21.0.0/pos/pos.tpl.html","view/spinner","js/libs/iscroll.js","js/libs/moment.min.js","js/libs/format.min.js","js/libs/signalr/jquery.signalR-2.0.3.js"],function(e,t,o,n,a,r,s,c,l,u,d,h,p,C,m,T,g,y,S,f,I,v,P,w,O,R,D,k,L,A,N,M,b,V,U,G,E,B,W,x,Q,F,z,H,K,q,_,J,j,Z,Y,X,$,ee,te,ie,oe,ne,ae,re,se,ce,le,ue,de,he,pe,Ce,me,Te,ge,ye,Se,fe,Ie,ve,Pe,we,Oe,Re,De,ke,Le,Ae,Ne,Me,be,Ve,Ue){var Ge,Ee,Be,We,xe=100,Qe="",Fe="ItemName",ze="",He="",Ke=!1,qe=n.View.extend({_MainTemplate:o.template(Ve),_SearchTemplate:o.template(Me),_HeaderTemplate:o.template(Ne),events:{"tap #review-transaction-btn":"buttonReviewTransaction_Tap","tap #complete-btn":"buttonComplete_Tap","tap #void-btn":"buttonCancel_Tap","tap #coupon-btn":"buttonCoupon_Tap","tap #searchGo-btn":"buttonSearchGo_Tap","keypress #search-input":"inputSearch_KeyPress","tap #search-input":"ShowClearBtn","blur #search-input":"HideClearBtn","focus #search-input":"SearchOnFocus","tap #search-inputClearBtn":"ClearText","tap #lookup-btn":"ShowLookup","tap #done-lookup":"LookupDone","tap #back-details":"BackToDetails","tap #back-products":"BackToProductLookup","tap #lookup-product":"SortProductLookUp","tap #lookup-category":"SortCategoryLookUp","tap #onHand-btn":"LoadFreeStockView","tap #add-lookup":"AddLookUpItemToCart","keypress #lookup-search":"inputLookUpSearch_KeyPress","tap #lookup-search":"ShowLookupClearBtn","blur #lookup-search":"HideClearBtn","tap #lookup-searchClearBtn":"ClearText","tap #transaction-selector":"ShowTransactionPopover","tap #action-btn":"ShowActionsPopover","tap #customer-lookup":"ShowCustomerList","tap #customer-selector":"ShowCustomerPopover","tap #lbl-customerName":"ShowCustomerList","tap #gift-card-btn":"ShowGiftCardRecharge","tap #content-wrapper":"FocusToItemScan","tap #cartContainer":"FocusToItemScan","tap .main-toolbar-header":"FocusToItemScan","tap #button-container":"FocusToItemScan","tap #notification-btn":"Notification_Tap","tap #lbl-salesrepName":"ShowSalesRepList"},render:function(){r.PrintPluginLoaded=!1,r.ApplicationType="POS",Ke=!1,this.$el.html(this._MainTemplate),this.$("#searchContainer").html(this._SearchTemplate);var e=r.CustomerName,t=r.SalesRepGroupName,i=r.CommissionPercent;return this.$("#main-transaction-page").prepend(this._HeaderTemplate({type:r.TransactionType,Customer:u.Escapedhtml(e),Salesrep:u.Escapedhtml(t),CommissionPercent:u.Escapedhtml(i)})),this.InitializeLoggedReasonsCollection(),this.IsReloadedTransaction=!1,this.StartSignalR(),this.InitializeStorePickupChecker(),this},InitializeStorePickupChecker:function(){if(r.Preference.IsTrackStorePickUp===!1)return void this.UpdateBadge(null,!0);var e=this;this.storePickupModel||(this.storePickupModel=new f),this.storePickupModel.on("notify",function(t){e.UpdateBadge(t)}),u.StorePickup.StartChecker(this.storePickupModel)},UpdateBadge:function(t,i){t=t||{};var o=t.Value,n=e("#notification-btn");return i?(n.length>0&&n.hide(),this.$(".toolbar-header-right").attr("style","width: 24.9%;"),void e(".label-transactioncode").css("width","85%")):(this.$(".toolbar-header-right").attr("style","width: 16.9%;"),e(".label-transactioncode").css("width","98%"),o>0?(n.hasClass("notification-active")||n.addClass("notification-active"),n.find("b").text(o>99?"99+":o),t.Forced||(n.find("div").removeClass("shake").addClass("shake"),setTimeout(function(){n.find("div").removeClass("shake")},2e3))):(n.find("div").removeClass("shake"),n.removeClass("notification-active").find("b").text("")),n.show(),this.UpdateTransactionPopoverPosition(),void this.UpdatePickupDropdownPosition())},Notification_Tap:function(e){return e.stopPropagation(),this.HasOpenTransaction()?(u.FocusToItemScan(),void navigator.notification.alert("Please complete or void the current transaction first.",null,"Action Not Allowed","OK")):(this.pickupListView||(this.pickupListView=new De({el:"#pickup-list-container"}),this.pickupListView.off("print-picking-ticket").on("print-picking-ticket",this.PrintPickNote,this),this.pickupListView.off("ready-for-invoice").on("ready-for-invoice",this.SendReadyForInvoiceEmailNotification,this)),this.pickupListView.render(),this.TriggerUpdatePickupCount(),void this.UpdatePickupDropdownPosition())},UpdatePickupNotificationList:function(e,t){this.pickupListView&&this.pickupListView.trigger("update-list",e,t)},UpdatePickupDropdownPosition:function(){try{var t=e("#notification-btn"),i=e("#pickup-list-container"),o=t.offset().left-i.width()+t.outerWidth()/2+22;i.offset({left:o})}catch(n){console.log(n)}},TriggerUpdatePickupCount:function(){this.storePickupModel&&this.storePickupModel.trigger("force-notify")},InitializeLoggedReasonsCollection:function(){r.LoggedReasons?r.LoggedReasons.reset():r.LoggedReasons=new P},InitializeChildViews:function(){this.InitializeLocalPreference(),this.InitializePreference(),this.InitializeTransactionType(r.TransactionType),this.InitializeCategory(),this.InitializeCoupon(),this.InitializeAccessory(),this.InitializeCart(),this.InitializeActionsView(),u.FocusToItemScan(),e("body, html,a").on("tap",this.outsideMenuHandler),navigator.notification.overrideAlert(!0)},InitializeTransactionType:function(e){this.transactionTypeView=new ae,this.$(".main-toolbar-header").append(this.transactionTypeView.render(e).el),this.$(".main-toolbar-header").append(this.transactionTypeView.render(e).el),this.transactionTypeView.on("transactionTypeChanged",this.SetTransactionType,this)},InitializeActionsView:function(){this.actionsView=new j({collection:this.cartCollection}),this.actionsView.on("LogOut",this.SignOut,this),this.actionsView.on("OpenCashDrawer",this.OpenCashDrawer,this),this.actionsView.on("CloseWorkstation",this.PromptCloseWorkstation,this),this.actionsView.on("PrintWorkstationReport",this.PromptWorkstationReport,this),this.actionsView.on("VoidTransaction",this.LeavePOSView,this),this.actionsView.on("stopSignalR",this.StopSignalR,this),this.$(".main-toolbar-header").append(this.actionsView.render().el)},createGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,i="x"===e?t:3&t|8;return i.toString(16)})},InitializeLocalPreference:function(){r.GUID=this.createGuid(),this.promoItemCollection=new P,this.localpreference=new x,this.localpreference.fetch({success:function(e,t){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),0!=e.length&&(r.POSWorkstationID=e.at(0).get("WorkstationID")),r.Category=""}})},InitializeCoupon:function(){this.couponModel||(this.couponModel=new T)},PromptOpenWorkstation:function(){switch(r.Preference.TrackDrawerBalance){case!0:null!==r.Status&&r.Status.IsOpen||this.ShowOpeningAmount()}},ShowCustomerList:function(){this.headerinfo||this.InitializeMainTransactionHeader(),this.headerinfo.ShowCustomerList()},ShowCustomerPopover:function(e){e.stopPropagation(),this.headerinfo.ShowCustomerPopover()},ShowSalesRepList:function(){this.headerinfo.ShowSalesRepList()},ShowOpeningAmount:function(){this.openingAmountView?this.openingAmountView.Show():(this.openingAmountView=new ge({el:e("#openingAmountContainer")}),this.openingAmountView.on("SaveAmount",this.OpenWorkstation,this))},ShowActionsPopover:function(e){e.stopPropagation(),u.FocusToItemScan(),this.actionsView.SetHasOpenTransaction(this.HasOpenTransaction()),this.actionsView.Show()},ShowTransactionPopover:function(e){e.stopPropagation(),u.FocusToItemScan(),r.TransactionType!==s.TransactionType.SalesPayment&&r.TransactionType!==s.TransactionType.UpdateOrder&&r.TransactionType!==s.TransactionType.ConvertOrder&&r.TransactionType!==s.TransactionType.ConvertQuote&&r.TransactionType!==s.TransactionType.SalesRefund&&(this.transactionTypeView.Show(r.TransactionType,this.paymentCollection&&this.paymentCollection.length>0),this.UpdateTransactionPopoverPosition())},UpdateTransactionPopoverPosition:function(){u.SetStyle("#transaction-popover","right",e(".toolbar-header-btn").outerWidth()+93+"px !important")},SetTransactionType:function(e){if(this.ValidateUpdateTransactionType(e)){switch(r.TransactionType=e,this.SetReturnMode(!1),e){case s.TransactionType.UpdateOrder:e=s.TransactionType.Order,this.isQuoteRemoveCoupon=!1;break;case s.TransactionType.ConvertOrder:e=s.TransactionType.Sale,this.isQuoteRemoveCoupon=!1;break;case s.TransactionType.ConvertQuote:e=s.TransactionType.Order,this.isQuoteRemoveCoupon=!1;break;case s.TransactionType.UpdateQuote:e=s.TransactionType.Quote,this.isQuoteRemoveCoupon=!1;break;case s.TransactionType.SalesRefund:e=s.TransactionType.Return,this.isQuoteRemoveCoupon=!1;break;case s.TransactionType.UpdateInvoice:e=s.TransactionType.Sale,this.isQuoteRemoveCoupon=!1;break;case s.TransactionType.Recharge:r.TransactionType=s.TransactionType.Recharge,e=s.TransactionType.Recharge,this.isQuoteRemoveCoupon=!1;break;case s.TransactionType.Return:this.SetReturnMode(!0)}this.SetTransactionTypeDisplay(e);var t=r.TransactionType!=s.TransactionType.Quote&&r.TransactionType!=s.TransactionType.UpdateQuote,i=r.TransactionType!=s.TransactionType.Order&&r.TransactionType!=s.TransactionType.ConvertInvoice&&r.TransactionType!=s.TransactionType.UpdateOrder&&r.TransactionType!=s.TransactionType.ConvertQuote&&r.TransactionType!=s.TransactionType.Sale&&r.TransactionType!=s.TransactionType.UpdateInvoice&&r.TransactionType!=s.TransactionType.ResumeSale&&r.TransactionType!=s.TransactionType.Quote&&r.TransactionType!=s.TransactionType.UpdateQuote;this.TogglePaymentButtons(t),this.ToggleOrderNotes(i)}},SetReturnMode:function(t){return t?(e(".complete").attr("style","Background: #8D0B0B !important;"),e("#cartContainer .total").attr("style","color: #B85C5C !important;"),void e("#view-payment").attr("style","color: #900000 !important;")):(e(".complete").removeAttr("style"),e("#cartContainer .total").removeAttr("style"),void e("#view-payment").removeAttr("style"))},ToggleOrderNotes:function(e){u.ShowHideOrderNotes("view-notes",e)},outsideMenuHandler:function(t){e(".deletebtn-overlay").hide(),e(".popover").hide(),e("#lookup-search").blur(),e("#pickup-list").find(t.target).length>0||e("#pickup-list-container").hide()},remove:function(){e("body, html,a").off("click",this.outsideMenuHandler),n.View.prototype.remove.call(this)},InitializeAccessory:function(){this.accessory=new E,this.accessory.bind("add",this.AddToCart,this)},InitializeItems:function(){this.InitializeItemPriceCollection(),this.InitializeItemCollection(),this.itemsView=new Y({el:e("#itemContainer"),collection:this.itemCollection})},InitializeCart:function(){this.InitializeCartCollection(),this.InitializeSummaryModel(),this.cartView=new X({el:e("#cartContainer"),collection:this.cartCollection,summary:this.summaryModel,accessory:this.accessory,type:r.ApplicationType}),this.cartView.on("viewPayments",this.ShowPaymentsSummaryForm,this),this.cartView.on("ItemRemoved",this.VoidItem,this),this.cartView.on("viewSignature",this.ViewSignature,this),this.cartView.on("ShowSerialLot",this.ShowSerialLotForm,this),this.cartView.on("loadOrderNotes",this.ProcessPublicNoteForm,this),this.cartView.on("showNotes",this.ShowOrderNotesForm,this),this.cartView.on("updateSerialLot",this.UpdateSerialLot,this),this.cartView.on("viewTaxOverrideList",this.ShowTaxList,this),this.cartView.on("changeTaxCode",function(){this.ChangeItemGroupTax(this.cartCollection)}.bind(this)),this.cartView.on("editKitItem",this.ShowKitConfigurator,this)},UpdateSerialLot:function(e){this.cartCollection.length;this.cartCollection.each(function(e){if(void 0!=this.serializeLotCollection)var t=this.serializeLotCollection.filter(function(t){return t.get("ItemCode")===e.get("ItemCode")&&t.get("UnitMeasureCode")===e.get("UnitMeasureCode")});!u.IsNullOrWhiteSpace(t)&&t.length>0&&o.each(t,function(t){t.set({LineNum:e.get("LineNum")})})}.bind(this))},InitializeCartCollection:function(){this.tempCart=[],this.cartCollection?(this.cartCollection.reset(),r.CartCollection=this.cartCollection):(this.cartCollection=new O,this.cartCollection.on("quantityAdded",this.QuantityAdded,this),this.cartCollection.on("quantitySubtracted",this.QuantitySubtracted,this),this.cartCollection.on("salesPriceRateUpdated",this.UpdateCartItem,this),this.cartCollection.on("unitMeasureUpdated",this.ChangeItemPriceOnUnitMeasure,this),this.cartCollection.on("warehouseCodeUpdated",this.ChangeItemPriceOnWarehouseCode,this),this.cartCollection.on("quantityOrderedUpdated",this.UpdateCartItem,this),this.cartCollection.on("quantityGoodUpdated",this.UpdateCartItem,this),this.cartCollection.on("discountUpdated",this.UpdateCartItem,this),this.cartCollection.on("discountAppliedToAll",this.ApplyDiscountToAll,this),this.cartCollection.on("clearedTransaction",this.VoidTransactionWithValidation,this),r.CartCollection=this.cartCollection)},InitializeItemCollection:function(){var e=this,t=r.Category,i=new d;this.RoundRequestQueue(),this.itemCollection=new w,this.itemCollection.on("selected",this.AddToItemsOnQueue,this),""!==r.Category&&null!==r.Category&&(i.set({StringValue:t,WarehouseCode:r.Preference.DefaultLocation,WebSiteCode:u.GetWebsiteCode(),ShowPhasedOutItems:e.IsReturn(),CustomerCode:r.CustomerCode,DefaultPrice:r.CurrentCustomer?r.CurrentCustomer.DefaultPrice:r.Preference.CustomerDefaultPrice,ShowWholesalePrice:r.Preference.ShowWholesalePrice}),i.url=r.ServiceUrl+c.PRODUCT+l.LOADITEMBYCATEGORY,i.save(null,{success:function(t,i,o){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),null!=i?e.itemCollection.reset(i.Items):null==i&&""!=r.Category&&(e.itemCollection.reset(),e.CategoryItemNoRecordFound()),e.HideActivityIndicator()},error:function(t,i,o){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.RequestError(i,"Error"),e.LockTransactionScreen(!1)}}))},CategoryItemNoRecordFound:function(){e("#itemListContainer").append("<h5 style='text-align:center; position:relative; top:190px;'>No Items Found...</h5>")},InitializeItemPriceCollection:function(){this.itemPriceCollection=new D,this.itemPriceCollection.on("reset",this.AddNewItemToCart,this)},InitializePaymentCollection:function(){this.paymentCollection=new M,this.paymentCollection.on("add",this.PaymentCollection_Add,this),this.paymentCollection.on("remove",this.PaymentCollection_Removed,this)},InitializeGiftPaymentCollection:function(){this.giftPaymentCollection=new P},InitializeCategory:function(){this.InitializeCategoryCollection(),this.categoryCollection.sort({silent:!0}),this.categoriesView=new $({el:e("#categoryContainer"),collection:this.categoryCollection})},InitializeShipTo:function(){this.shipToCollection||(this.shipToCollection=new H)},InitializePreference:function(){this.InitializeShipTo();var e=this;this.preferenceCollection=new U,this.preferenceCollection.url=r.ServiceUrl+c.POS+l.GETPREFERENCEBYWORKSTATION+r.POSWorkstationID,this.preferenceCollection.fetch({success:function(t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.AssignCurrency(i.Currency),e.ResetStatus(i.Status),e.ResetSalesRepUserAccount(i.SalesRepUserAccount),e.ResetPreferenceCollection(i.Preference),e.ResetCategoryCollection(i.Categories),e.ResetUserRoleCollection(i.UserRoles),e.GetDefaultCustomerDetails(i.Preference),e.ResetCustomerPreference(i.CustomerPreference),e.ValidateDefaultLocation(i.Warehouses),e.ResetAccountingPreference(i.AccountingPreference),e.RetrievePrinterDetails(i.Preference)},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error")}})},GetCustomerPOSReport:function(e,t){var i=r.POSSalesReceipt||1,o="",n=1;switch(e.toLowerCase()){case"createinvoice":case"updateinvoice":case"convertorder":o=1==i?t.InvoiceReportCode:t.InvoiceReportCode2,printer=1==i?t.InvoiceReportPrinter:t.InvoiceReportPrinter2,n=1==i?t.InvoiceReceiptCopies:t.InvoiceReceiptCopies2;break;case"createorder":case"updateorder":case"convertquote":o=t.OrderReportCode,printer=t.OrderReportPrinter,n=t.OrderReceiptCopies;break;case"createquote":o=t.QuoteReportCode,printer=t.QuoteReportPrinter,n=t.QuoteReceiptCopies;break;case"createcreditmemo":case"createrefund":o=t.ReturnReportCode,printer=t.ReturnReportPrinter,n=t.ReturnReceiptCopies;break;case"creditcard":o=t.CreditCardReportCode,printer=t.CreditCardReportPrinter,n=t.CreditCardReceiptCopies;break;case"createinvoicepayment":o=t.SalePaymentReportCode,printer=t.SalePaymentReportPrinter,n=t.SalePaymentReceiptCopies;break;case"createpicknote":o=t.PickNoteReportCode,printer=t.PickNoteReportPrinter,n=t.PickNoteReportPrinter;break;default:printer=t.DefaultPrinter,n=1}return{printer:printer||t.DefaultPrinter,reportCode:o,copies:n}},ResetSalesRepUserAccount:function(e){r.SalesRepUserAccount=e},GetDefaultCustomerDetails:function(e){this.defaultCustomerDetails=new P,this.defaultCustomerDetails.reset(e),r.CurrentCustomerSourceCode=this.defaultCustomerDetails.at(0).get("DefaultSourceCode")},ResetCustomerAdvancedPreference:function(e){r.CustomerAdvancedPreference=e},ResetCustomerPreference:function(e){r.CustomerPreference=e},ResetAccountingPreference:function(e){r.AccountingPreference=e,this.ValidateLocationBankAccount()},ValidateLocationBankAccount:function(){return!this.IsMultiLocation()||""!=(r.BankAccountCode||"").toString().trim()||(u.ShowNotification("Default Location's Bank Account is not set. Please go to Connected Business and setup a Bank Account for your Location.",!0,null,!0),!1)},RetrievePrinterDetails:function(e){this.InitializePrinterCollection(),!r.isBrowserMode&&u.IsNullOrWhiteSpace(r.Printer.PrinterModel)&&u.IsNullOrWhiteSpace(r.Printer.IpAddress)&&(e.UseCashDrawer||e.AutoPrintReceipt)&&navigator.notification.alert("IP for Printer and Cash Drawer is not present. Please go to settings module.",null,"Printer details missing","OK")},ResetStatus:function(e){r.Status=e},ResetCategoryCollection:function(e){r.CategoryDuplucates=0;for(var t="",i=new Array,o=e.length,n=0;n<o;n++)t===e[n].CategoryCode&&i.push(n),t=e[n].CategoryCode;r.CategoryDuplucates=i.length,this.categoryCollection.reset(e),this.SetSelected()},ResetPreferenceCollection:function(e){this.preferenceCollection.reset(e),r.Preference=e,r.TrackDrawerBalance=r.Preference.TrackDrawerBalance,r.IsTrackLoyaltyPoints=e.TrackLoyaltyPoints;var t={CustomerName:e.CustomerName,CustomerCode:e.CustomerCode,Email:e.CustomerEmail,DefaultPrice:e.CustomerDefaultPrice,LocationCode:e.DefaultLocation,PaymentTermCode:e.PaymentTermCode};null==e.DefaultShipTo?r.InitialDiscountPercent=0:r.InitialDiscountPercent=e.DefaultShipTo.DiscountPercent,r.IsOverrideSalesRep=e.IsOverrideSalesRep,this.SetCurrentCustomer(t),u.CheckSalesRep(e),this.UseDefaultCustomer(),r.CompanyName=e.CompanyName,r.CustomerName=e.CustomerName,r.CustomerCode=e.CustomerCode,r.CustomerEmail=e.CustomerEmail,r.POSSalesReceipt=e.POSSalesReceipt,r.DefaultContactEmail=e.DefaultContactEmail,r.DefaultPrice=e.CustomerDefaultPrice,r.LocationCode=e.DefaultLocation,r.ShipToName=e.DefaultShipTo.ShipToName,r.ShipToAddress=e.DefaultShipTo.Address,r.PrintOptions.CustomizePrint=!r.isBrowserMode&&e.IsAirprint,r.Preference.IsAirprint=!r.isBrowserMode&&e.IsAirprint,r.BankAccountCode=e.BankAccountCode||"",r.DefaultShipTo=e.DefaultShipTo.ShipToName+",",r.DefaultShipToAddress=e.DefaultShipTo.Address,r.DefaultShipToCity=e.DefaultShipTo.City,r.DefaultShipToState=e.DefaultShipTo.State,r.DefaultShipToCounty=e.DefaultShipTo.County,r.DefaultShipToPostalCode=e.DefaultShipTo.PostalCode,r.ShipTo={};for(var i in e.DefaultShipTo)r.ShipTo[i]=e.DefaultShipTo[i];r.InitialShipToCode=r.ShipTo.ShipToCode,r.CompanyName=e.CompanyName,r.ReasonCode.Discount=e.IsReasonDiscount,r.ReasonCode.Transaction=e.IsReasonTransactionVoid,r.ReasonCode.Item=e.IsReasonItemVoid,r.ReasonCode.Return=e.IsReasonReturns,r.Preference.ShowWholesalePrice=e.ShowWholesalePrice,r.Preference.IsAutoAdjustmentStock=e.IsAutoAdjustmentStock,this.CheckTransactionType(),this.InitializeMainTransactionHeader(),this.ConfirmDrawerBalanceTracking(),this.SetImageLocation(e),r.ClosingWorkStation=!1,r.PreviousReprintValue=!1,r.OnRechargeProcess=!1,r.TransactionCode=null,r.AskPIN=null,r.AskSignature=null,this.InitializeItems(),e.TaxByLocation?this.LoadLocationTaxCode():window.sessionStorage.removeItem("selected_taxcode"),r.invDetailSerialCollection=null},CheckIfCustomerHasLoyalty:function(){this.tempModel=new f;var e,t=this;e=u.IsNullOrWhiteSpace(r.CurrentCustomer.CustomerCode)?r.CustomerCode:r.CurrentCustomer.CustomerCode,this.tempModel.set({StringValue:e}),this.tempModel.url=r.ServiceUrl+c.SOP+l.GETCUSTOMERLOYALTYPOINTS,this.tempModel.save(null,{success:function(e,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.AssignCustomerHasLoyalty(i)},error:function(){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()}})},AssignCustomerHasLoyalty:function(e){u.IsNullOrWhiteSpace(e.LoyaltyPoints)?r.CustomerHasLoyalty=!1:r.CustomerHasLoyalty=!0},CheckTransactionType:function(){var t=["AllowSales","AllowOrders","AllowQuotes","AllowReturns"],i=0,n=this;switch(o.each(t,function(e){switch(e){case"AllowSales":r.Preference.AllowSales===!0&&(i+=1,n.SetTransactionType(s.TransactionType.Sale));break;case"AllowOrders":if(r.Preference.AllowOrders===!0){if(i+=1,i>1)return;n.SetTransactionType(s.TransactionType.Order)}break;case"AllowQuotes":if(r.Preference.AllowQuotes===!0){if(i+=1,i>1)return;n.SetTransactionType(s.TransactionType.Quote)}break;case"AllowReturns":if(r.Preference.AllowReturns===!0){if(i+=1,i>1)return;n.SetTransactionType(s.TransactionType.Return)}break;default:n.SetTransactionType(s.TransactionType.Sale)}}),r.Preference.DefaultPOSTransaction){case 0:n.SetTransactionType(s.TransactionType.Sale);break;case 1:n.SetTransactionType(s.TransactionType.Order);break;case 2:n.SetTransactionType(s.TransactionType.Quote);break;case 3:n.SetTransactionType(s.TransactionType.Return)}i<=1&&(this.$el.undelegate("#transaction-text","tap"),e(".arrow-down").css("opacity","0.3")),this.SetTransactionTypeDisplay(r.TransactionType)},ResetUserRoleCollection:function(e){if(r.UserRoles=e,r.AdministratorRole=!1,r.UserRoles.length>0)for(var t=0;t<r.UserRoles.length;t++)r.UserRoles[t].RoleCode==r.UserInfo.RoleCode&&(r.AdministratorRole=!0);else r.AdministratorRole=!0},InitializeCategoryCollection:function(){this.categoryCollection=new R,this.categoryCollection.on("selected",this.IsSelected,this)},InitializeSummaryModel:function(){this.summaryModel=null,this.summaryModel=new p},InitializeTransaction:function(){this.transactionModel?this.transactionModel.clear({silent:!0}):(this.transactionModel=new h,this.transactionModel.on("sync",this.SaveTransactionCompleted,this),this.transactionModel.on("error",this.SaveTransactionError,this)),this.transactionModel.off("before-save"),this.transactionModel.on("before-save",this.OnTransactionModelBeforeSave,this)},OnTransactionModelBeforeSave:function(){this.LogWithTime("Begin Saving Transaction..."),this.IsSavingTransactionOngoing=!0,this.ToggleInprogressOverlay(),this.DoDrawerKick()},DoDrawerKick:function(){var e=this;r.TransactionType===s.TransactionType.SalesRefund?(void 0===e.refundCollection&&(e.refundCollection=new M),e.AllowToOpenCashDrawer(e.refundCollection)):e.AllowToOpenCashDrawer(e.paymentCollection),1==r.Preference.UseCashDrawer&&r.isOkToOpenCashDrawer&&(r.isBrowserMode?u.PrintBrowserMode.DrawerKick():u.Printer.DrawerKick())},InitializeMainTransactionHeader:function(){var t=new N;t.on("recalculated",this.UpdateRecalculatedItems,this),t.on("recalculateCompleted",this.UpdateRecalculatedItemsCompleted,this),this.headerinfo||(this.headerinfo=new Z({el:e("#headerInfoContainer"),cart:this.cartCollection,preference:this.preferenceCollection,item:this.itemCollection,SO:t}),this.headerinfo.on("customerchanged",this.CustomerChanged,this),this.headerinfo.on("shiptochanged",this.ShipToChanged,this),this.headerinfo.on("customernotes",this.ShowOrderNotesForm,this),this.headerinfo.on("removeNote",this.ProcessNoteRemoval,this),this.headerinfo.on("proceedToLookupItems",this.ProcessItemLookup,this))},CustomerChanged:function(){r.CurrentCustomerChanged=!0,this.paymentCollection&&this.paymentCollection.reset(),this.cartCollection.length>0&&this.cartCollection.each(function(e){e.set({CouponDiscountRate:0,Discount:0})}),this.serializeLotCollection&&this.serializeLotCollection.length>0&&this.serializeLotCollection.each(function(e){e.set({OriginalSerialRecipient:e.get("SerialRecipient"),SerialRecipient:r.DefaultContactEmail})}),this.RemoveCoupon(),this.headerinfo&&this.headerinfo.PricingHasChanged()&&this.InitializeItems(),this.CheckIfCustomerHasLoyalty(),this.SearchOnFocus()},ShipToChanged:function(){if(this.cartCollection.length>0){window.sessionStorage.getItem("selected_taxcode");this.cartCollection.each(function(e){e.set({IsModified:!0})})}this.ResetTermDiscount(),this.ChangeItemGroupTax(this.cartCollection),this.SearchOnFocus(),r.Preference.TaxByLocation||window.sessionStorage.removeItem("selected_taxcode")},ResetTermDiscount:function(){this.RemoveTermDiscountPayment(),this.summaryModel.set({TermDiscount:0}),r.TermDiscount=0},InitializeReviewTransaction:function(t){this.InitializeReviewTransactionCollection(),this.reviewTransactionsView=new re({el:e("#transactionsContainer"),collection:this.reviewTransactionCollection,pickUpStage:t?1:0,clearDateOnLoad:t}),this.reviewTransactionsView.on("userclosedform",this.SetToDefaultTransaction,this),this.reviewTransactionsView.on("update-pickup-count",this.TriggerUpdatePickupCount,this)},InitializeReviewTransactionCollection:function(){this.reviewTransactionCollection=new G,this.reviewTransactionCollection.on("applyPayment",this.LoadInvoiceForApplyPayment,this),this.reviewTransactionCollection.on("updateOrder",this.LoadOrderForUpdateOrder,this),this.reviewTransactionCollection.on("convertOrder",this.LoadOrderForConvertOrder,this),this.reviewTransactionCollection.on("convertQuote",this.LoadOrderForConvertQuote,this),this.reviewTransactionCollection.on("updateQuote",this.LoadOrderForUpdateQuote,this),this.reviewTransactionCollection.on("returnInvoice",this.LoadInvoiceForReturnRefund,this),this.reviewTransactionCollection.on("printTransaction",this.PrintAndEmailReviewTransaction,this),this.reviewTransactionCollection.on("resumeTransaction",this.LoadInvoiceForResume,this),this.reviewTransactionCollection.on("printPickNote",this.PrintPickNote,this),this.reviewTransactionCollection.on("readyForPickUp",this.SendReadyForInvoiceEmailNotification,this),this.reviewTransactionCollection.on("repickItem",this.SetOrderPrintPickNote,this)},PrintPickNote:function(e){var t=this,i=new f,o=e.get("SalesOrderCode");i.url=r.ServiceUrl+c.SOP+"printpicknote/"+o,i.save(null,{success:function(){t.PrintReceipt(o,"CreatePickNote",null),t.TriggerUpdatePickupCount(),t.UpdatePickupNotificationList(o,!0),t.RemoveTransactionFromList(o,!0)},error:function(e,t,i){navigator.notification.alert("Error.",null,"Error","OK")}})},SetOrderReadyToInvoice:function(e){this.SetOrderWorkflow(e,"Ready To Invoice")},SetOrderPrintPickNote:function(e){var t=this;this.SetOrderWorkflow(e,"Print Pick Note",function(){t.PrintPickNote(e)})},SetOrderWorkflow:function(e,t,i){var o=this,n=new f,a=e.get("SalesOrderCode");n.url=r.ServiceUrl+c.SOP+"setworkflowstage/"+a+"/"+t,n.save(null,{success:function(){o.TriggerUpdatePickupCount();var e="Ready To Invoice"==t;e&&o.UpdatePickupNotificationList(a),i&&i.call(o),o.RemoveTransactionFromList(a)},error:function(e,t,i){navigator.notification.alert("Error.",null,"Error","OK")}})},SendReadyForInvoiceEmailNotification:function(e){r.PrintOptions.EmailAddress=e.get("DefaultContactEmail"),this.EmailReceipt(e.get("SalesOrderCode"),"CreateOrder","",!0)},RemoveTransactionFromList:function(e,t){var i=this;try{i.reviewTransactionsView.RemoveModelByOrderCode(e,t)}catch(o){console.log("Handle - Transaction form not visible.")}},ShowSpinnerItems:function(){var t=document.getElementById("item-wrapper");this.ShowActivityIndicator(t),e("<h5>Loading...</h5>").appendTo(e("#spin"))},InitializeLookup:function(){e("#item-wrapper").append(o.template(be)),e("#lookup").hide(),this.hideOtherButtons(),this.InitializeProductLookup(),e("#lookup-search").focus()},CheckLookUpSortVar:function(){"CategoryCode"===Fe?(e("#lookup-product").removeClass("lookup-selected"),e("#lookup-category").addClass("lookup-selected")):(e("#lookup-category").removeClass("lookup-selected"),e("#lookup-product").addClass("lookup-selected"))},InitializeProductLookup:function(){this.GetLookupItems(xe,Qe,null),this.ReloadProductsView()},InitializeSerializeLotCollection:function(){this.serializeLotCollection||(this.serializeLotCollection=new q),this.BindOnResetOfSerializeLotCollection(this.serializeLotCollection)},BindOnResetOfSerializeLotCollection:function(e){e.off("reset"),e.on("reset",this.SetGCRecipients)},SetGCRecipients:function(){r.TransactionType==s.TransactionType.ConvertOrder&&this.each(function(e){e.get("IsEmailModified")||e.get("SerialRecipient")||!r.DefaultContactEmail||(e.set({OriginalSerialRecipient:e.get("SerialRecipient")}),e.set({SerialRecipient:r.DefaultContactEmail}))})},InitializeSerializeLot:function(t,i,o,n,a,c,l,d){var h=this;if(this.InitializeSerializeLotCollection(),!(u.IsNullOrWhiteSpace(this.cartEventTriggered)||"UpdatePrice"!=this.cartEventTriggered&&"UpdateDiscount"!=this.cartEventTriggered&&u.IsNullOrWhiteSpace(r.IsChangeWarehouse)))return this.cartEventTriggered=null,void(r.IsChangeWarehouse=!1);var p=function(r){h.cartView.trigger("serialLotReady",h.serializeLotCollection),h.serializeLot&&(h.serializeLot.unbind(),h.serializeLot.remove(),h.serializeLot=null),e("#serialLotContainer").append("<div id='mainSerialContainer'></div>"),
h.serializeLot=new Ie({el:e("#mainSerialContainer"),type:t,itemCode:i,itemName:o,lineNum:n,itemType:a,unitMeasure:c,collection:h.serializeLotCollection,itemModel:d,serialEvent:l,cartCollection:h.cartCollection,serialList:r?r:null}),h.BindOnResetOfSerializeLotCollection(h.serializeLotCollection),h.BindOnResetOfSerializeLotCollection(h.serializeLot.collection),h.serializeLot.on("Close",h.AddSerialByUPCItem,this),h.serializeLot.on("SerialGenerated",function(){h.gcItemList&&h.gcItemList.afterGeneration()},this),h.serializeLot.Show()};if(r.TransactionType===s.TransactionType.SalesRefund){var C="";return d instanceof f?d.get("IsNewLine")||(C=r.TransactionCode):d.IsNewLine||(C=r.TransactionCode),void this.RetrieveSerialNumberList(r.CustomerCode,i,a,n,C,"Invoice",p)}p(null)},RetrieveSerialNumberList:function(e,t,i,o,n,a,l){var d=new f,h=new P,p={CustomerCode:e,ItemCode:t,LineNum:o,DocumentCode:n};u.IsNullOrWhiteSpace(a)&&(a=null),d.url=r.ServiceUrl+c.SOP+"getseriallotnumberlist/"+a,d.set(p),d.save(d,{success:function(e,t,o){if(r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),u.IsNullOrWhiteSpace(t.SerialLotNumbers)||i==s.ItemType.GiftCard||i==s.ItemType.GiftCertificate)i!==s.ItemType.GiftCard&&i!==s.ItemType.GiftCertificate||l(null);else{if(!u.IsNullOrWhiteSpace(t.ErrorMessage))return void navigator.notification.alert(t.ErrorMessage,null,"Error","OK");l(h.reset(t.SerialLotNumbers))}},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),navigator.notification.alert("Error retrieving SerialLotNumber List.",null,"Error","OK")}})},ShowSerialLotForm:function(e){this.ValidateSerializeLot(e.get("SerializeLot"),e.get("ItemCode"),this.GetItemDisplayName(e),e.get("LineNum"),e.get("ItemType"),e.get("UnitMeasureCode"),"ItemDetail",e),"None"===e.get("SerializeLot")&&e.get("ItemType")!=s.ItemType.GiftCard&&e.get("ItemType")!=s.ItemType.GiftCertificate&&navigator.notification.alert("Item selected has no SerializeLot type set.",null,"Invalid Action","OK")},AddLookUpItemToCart:function(e){e.preventDefault(),this.AddToCart(Ge),this.LookupDone(e)},AddLookupItemDirectlyToCart:function(t){var i=this.AddToCart(t);if(e("#lookup").remove(),null==t.get("SerializeLot")||"None"==t.get("SerializeLot")?e("#main-transaction-blockoverlay").hide():r.TransactionType!=s.TransactionType.Sale&&e("#main-transaction-blockoverlay").hide(),i){if(t.get("ItemType")===s.ItemType.GiftCard||t.get("ItemType")===s.ItemType.GiftCertificate)switch(r.TransactionType){case s.TransactionType.ConvertOrder:case s.TransactionType.Sale:case s.TransactionType.UpdateInvoice:case s.TransactionType.ResumeSale:e("#main-transaction-blockoverlay").show();break;default:e("#main-transaction-blockoverlay").hide()}}else e("#main-transaction-blockoverlay").hide();Fe="ItemName"},GetLookupItems:function(e,t,i){var o=this,n=new d,a=e;this.productCollection=new b,this.productCollection.sortVar=Fe,this.productCollection.on("selected",this.LoadItemDetail,this),this.productCollection.on("addItem",this.AddLookupItemDirectlyToCart,this),this.ShowSpinner(),n.set({ItemCode:i,CriteriaString:t,WebsiteCode:u.GetWebsiteCode(),WarehouseCode:r.Preference.DefaultLocation,ShowPhasedOutItems:o.IsReturn()}),this.EnableProductLookUpButton(!1),n.url=r.ServiceUrl+c.PRODUCT+l.ITEMLOOKUP+a,n.save(null,{success:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),o.productCollection.reset(t.Items),o.HideActivityIndicator(),r.OnRechargeProcess&&o.ConitinueRechargeGiftCard(t.Items),o.EnableProductLookUpButton(!0)},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),o.EnableProductLookUpButton(!0),e.RequestError(t,"Error"),o.HideActivityIndicator()}})},EnableProductLookUpButton:function(t){t?(e("#lookup-product").removeClass("ui-disabled"),e("#lookup-category").removeClass("ui-disabled")):(e("#lookup-product").addClass("ui-disabled"),e("#lookup-category").addClass("ui-disabled"))},ReloadProductsView:function(){this.productsview=new ie({el:e("#lookup-content"),collection:this.productCollection})},hideOtherButtons:function(){e("#back-products").hide(),e("#add-lookup").hide(),e("#back-details").hide()},ShowSpinner:function(){var t=document.getElementById("main-transaction-page");this.ShowActivityIndicator(t),this.DisableButton(),e("<h5>Loading...</h5>").appendTo(e("#spin"))},DisableButton:function(){},EnableLookupButton:function(){e("#lookup-footer").removeClass("ui-disabled")},ShowLookup:function(t){t.preventDefault(),e("#lookup").remove(),e("#spin").remove(),this.InitializeLookup(),e("#lookup").show(),r.isBrowserMode&&u.BlurItemScan(),e("#main-transaction-blockoverlay").show()},LookupDone:function(t){t.preventDefault(),u.FocusToItemScan(),e("#lookup-search").blur(),e("#lookup").hide(),this.HideActivityIndicator(),e("#main-transaction-blockoverlay").hide(),Fe="ItemName"},LoadScroll:function(){this.myScroll?this.myScroll.refresh():this.myScroll=new iScroll("lookup-content",{hScroll:!1})},showItemDetailButtons:function(){e("#done-lookup").hide(),e("#back-details").hide(),e("#back-products").show(),e("#add-lookup").show()},LoadItemDetail:function(t){this.showItemDetailButtons(),e("#lookup-title").text("Details"),this.detailView=new oe({model:t}),ze=t.get("ItemCode"),He=t.get("UnitMeasureCode"),Ge=t},showFreeStockButton:function(){e("#back-products").hide(),e("#add-lookup").hide(),e("#back-details").show(),e("#done-lookup").show()},LoadFreeStock:function(){var t=this;this.showFreeStockButton(),e("#lookup-title").text("Free Stock"),this.stockCollection=new V;var i=new f;i.url=r.ServiceUrl+c.PRODUCT+l.LOCATIONSTOCKLOOKUP,i.set({ItemCode:ze,UnitMeasureCode:He}),i.save(null,{success:function(e,i,o){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.LoadFreeStockByUnitOfMeasure(i)},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Retrieving Free Stock Preference")}})},LoadFreeStockByUnitOfMeasure:function(e){if(this.stockContainer=new V,this.stockContainer.reset(e.StockTotalDetails),this.stockCollection=new V,this.stockContainer.length>0){var t=this;this.stockContainer.each(function(e){e.get("UnitMeasureCode")==He&&t.stockCollection.add(e)})}this.stockView=new ne({collection:this.stockCollection})},LoadFreeStockView:function(){this.LoadFreeStock()},ReloadStockView:function(){this.stockView=new ne({collection:this.stockCollection})},BackToProductLookup:function(t){t.preventDefault(),e("#spin").remove(),e("#lookup").replaceWith(o.template(be)),this.hideOtherButtons(),this.CheckLookUpSortVar(),this.InitializeProductLookup(),this.productCollection.sortVar=Fe,this.productCollection.sort()},BackToDetails:function(t){t.preventDefault(),e("#spin").remove(),e("#lookup").replaceWith(o.template(be)),this.showItemDetailButtons(),e("#lookup-title").text("Details"),this.productCollection.each(function(e){e.get("ItemCode")===ze&&e.get("UnitMeasureCode")===He&&(this.detailView=new oe({model:e}))})},FindLookUpItem:function(){var t=e("#lookup-search").val();this.GetLookupItems(xe,t,null),this.ReloadProductsView()},inputLookUpSearch_KeyPress:function(e){13===e.keyCode?this.FindLookUpItem():this.ShowLookupClearBtn(e)},SortProductLookUp:function(t){t.preventDefault(),e("#spin").remove(),Fe="ItemName",e("#lookup").replaceWith(o.template(be)),this.hideOtherButtons(),e("#lookup-category").removeClass("lookup-selected"),e("#lookup-product").addClass("lookup-selected"),this.InitializeProductLookup(),this.productCollection.sortVar=Fe},SortCategoryLookUp:function(t){t.preventDefault(),e("#spin").remove(),Fe="CategoryCode",e("#lookup").replaceWith(o.template(be)),this.hideOtherButtons(),e("#lookup-product").removeClass("lookup-selected"),e("#lookup-category").addClass("lookup-selected"),this.InitializeProductLookup(),this.productCollection.sortVar=Fe},SetSelected:function(){this.categoryCollection.each(function(t){t.get("IsDefault")===!0&&(r.Category=t.get("CategoryCode"),e("#"+t.cid).addClass("selected"))}),""===r.Category&&(e("#itemContainer").append("<h5 style='text-align:center; position:relative; top:190px;'>No Items Found...</h5>"),e("#itemContainer").append("<h5 style='text-align:center; position:relative; top:200px;'>No Category Selected. Please select one above or go to settings..</h5>")),this.InitializeItems()},IsSelected:function(e){r.Category=e.get("CategoryCode"),this.InitializeItems(),this.itemsView.undelegateEvents()},AddItemToCart:function(t){if(r.ManagerValidated=!1,r.Preference.DefaultPOSTransaction<=3){new f(t);this.NotifyIfItemIsOutOfStock(t),!u.IsNullOrWhiteSpace(this.couponModel.get("CouponCode"))&&this.IsRequireRecalculateCoupon()?(this.isNoCouponAtFirst=!1,this.LockTransactionScreen(!0,"Computing Coupon"),this.cartCollection&&this.cartCollection.length>0&&this.cartCollection.each(function(e){this.tempCart.push(e.toJSON())}.bind(this)),this.tempCart.push(this.UpdateNewLineForReturn(t))):(this.isNoCouponAtFirst=!0,r.Preference.AutoAllocateOverrideLevel&&""!=r.Preference.AutoAllocateOverrideLevel&&r.Preference.AutoAllocateOverrideLevel!=r.UserInfo.RoleCode?0==r.Preference.IsAutoAdjustmentStock&&1==t.IsOutOfStock?(r.msgTitle="Stock Verification",r.msg1="Item '"+t.ItemName+"' does not have enough stock. Turn on Auto Adjustment stock on Settings to add item with no stock.",navigator.notification.alert(r.msg1,null,r.msgTitle,"OK")):1==r.Preference.IsAutoAdjustmentStock&&1==t.IsOutOfStock?(r.CurrentItem=this.UpdateNewLineForReturn(t),this._lastItemChecked=null):this.cartCollection.add(this.UpdateNewLineForReturn(t)):0==r.Preference.IsAutoAdjustmentStock&&1==t.IsOutOfStock?(r.msgTitle="Stock Verification",r.msg1="Item '"+t.ItemName+"' does not have enough stock. Turn on Auto Adjustment stock on Settings to add item with no stock.",navigator.notification.alert(r.msg1,null,r.msgTitle,"OK")):this.cartCollection.add(this.UpdateNewLineForReturn(t))),this.cartCollection.each(function(t){1==t.get("IsPromoItem")&&(e("#"+t.cid+" #quantityDisplay").addClass("ui-disabled").css("opacity",1),e("#"+t.cid+" #display-itemName").addClass("ui-disabled").css("opacity",1),e("#"+t.cid+" #itemPriceDisplay").addClass("ui-disabled").css("opacity",1),e("#"+t.cid+" #discountDisplay").addClass("ui-disabled").css("opacity",1),e("#"+t.cid+" #extPriceRate-td").addClass("ui-disabled").css("opacity",1))}),this.UpdateCouponWithValidation()}},UpdateNewLineForReturn:function(e){if(r.TransactionType!=s.TransactionType.SalesRefund)return e;var t=new f(e);return t.set({Good:e.QuantityOrdered,QuantityDisplay:e.QuantityOrdered,IsNewLine:!0}),t.attributes},QuantityAdded:function(e){this.UpdateCartItem(e,1,"QuantityOrderedUpdated",!0)},QuantitySubtracted:function(e){this.UpdateCartItem(e,-1,"QuantityOrderedUpdated",!0)},GetSaleItemPriceTax:function(e,t,i,o,n,a,h,p){this.RemoveTermDiscountPayment();var C=this,m=h,T=new d,g=(new d,h.get("LineNum")),y=new N,S=new A;y.add(this.cartCollection.models);var I=new f,v=new Date;v=this.JsonToAspDate(v),I.set({BillToCode:r.CustomerCode,POSWorkstationID:r.POSWorkstationID,POSClerkID:r.Username,IsFreightOverwrite:!0,IsOverrideSalesRep:r.Preference.IsOverrideSalesRep,IsTaxByLocation:r.Preference.TaxByLocation,WarehouseCode:r.Preference.DefaultLocation,PublicNotes:r.PublicNote.PublicNotes,ShippingDate:v,WebSiteCode:r.Preference.WebSiteCode,SalesOrderCode:"[To be generated]",SourceSalesOrderCode:"[To be generated]",Type:"Sales Order",SalesOrderDate:v}),u.IsNullOrWhiteSpace(this.customerPOModel)||I.set(self.customerPOModel.attributes),S.add(I),a||(a=""),this.AssignTransactionShipTo(S.at(0)),this.SetCouponToTransactionHeader(S.at(0),!1);var P=r.TransactionType;r.TransactionType==s.TransactionType.UpdateInvoice&&(P=s.TransactionType.ResumeSale);var w=window.sessionStorage.getItem("selected_taxcode");null==w&&(w=r.ShipTo.TaxCode),T.set({ItemCode:e,CustomerCode:t,WarehouseCode:i,UnitMeasureCode:o,IsTaxByLocation:n,CouponId:a,ShipToCode:r.ShipTo.ShipToCode,WebsiteCode:u.GetWebsiteCode(),DiscountPercent:r.ShipTo.DiscountPercent,DiscountType:r.ShipTo.DiscountType,LineNum:g,TaxCode:w,SalesOrderCode:"[To be generated]",ItemName:"None",IsUsePOSShippingMethod:r.Preference.IsUsePOSShippingMethod,POSShippingMethod:r.Preference.POSShippingMethod}),y.add(T),T.set({SimilarItemsOnCart:C.GetSimilarItemsOnCart(T,!0,!p),DocumentCode:C.GetTransactionCodeForStockVerification(),TransactionType:P,ShowPhasedOutItems:C.IsReturn()}),T.url=r.ServiceUrl+c.SOP+l.SALEITEMPRICETAX,T.save(null,{success:function(t,i,o){if(r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),i.ErrorMessage)"UpdateWarehouseCode"===p&&C.revertWarehouseCode(m),C.RemoveFromItemsOnQueue(m),navigator.notification.alert(t.get("ErrorMessage"),null,"Error","OK");else{switch(p){case"UpdateUnitMeasure":C.UpdateItemPriceOnUnitMeasure(t,e,g);break;case"UpdateWarehouseCode":C.UpdateItemPriceOnWarehouseCode(t,e,h);break;default:C.itemPriceCollection.reset(i),C.RemoveFromItemsOnQueue(m)}C.OnRequestCompleted(l.SALEITEMPRICETAX)}C.SearchOnFocus()},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error"),C.RemoveFromItemsOnQueue(m)}})},revertWarehouseCode:function(e){e.revertWarehouseCode()},GetSaleItemPriceTaxByUPC:function(e,t,i,o,n){var a=this,h=new d,p=new d;n||(n="");var C=r.TransactionType;r.TransactionType==s.TransactionType.UpdateInvoice&&(C=s.TransactionType.ResumeSale);var m=window.sessionStorage.getItem("selected_taxcode");null==m&&(m=r.ShipTo.TaxCode),p.set({IsTaxByLocation:o,TransactionType:C,ItemCode:e,ShipToCode:r.ShipTo.ShipToCode,TaxCode:m,WarehouseCode:r.Preference.DefaultLocation,IsUsePOSShippingMethod:r.Preference.IsUsePOSShippingMethod,POSShippingMethod:r.Preference.POSShippingMethod}),p.url=r.ServiceUrl+c.SOP+l.SALEITEMTAXOVERRIDE,p.save(null,{success:function(s,d,p){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),d.ErrorMessage||(m=d.Value,h.set({ItemCode:e,CustomerCode:t,WarehouseCode:i,UnitMeasureCode:null,IsTaxByLocation:o,CouponId:n,WebsiteCode:u.GetWebsiteCode(),ShipToCode:r.ShipTo.ShipToCode,DiscountType:r.ShipTo.DiscountType,DiscountPercent:r.ShipTo.DiscountPercent,DiscountableDays:r.ShipTo.DiscountableDays,TaxCode:m,IsUsePOSShippingMethod:r.Preference.IsUsePOSShippingMethod,POSShippingMethod:r.Preference.POSShippingMethod}),h.set({SimilarItemsOnCart:a.GetSimilarItemsOnCart(h,!0),DocumentCode:a.GetTransactionCodeForStockVerification(),TransactionType:C,ShowPhasedOutItems:a.IsReturn()}),h.url=r.ServiceUrl+c.SOP+l.SALEITEMPRICETAXBYUPC,h.save(null,{success:function(t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),a.LoadUPCItemList(i,e)},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error")}}))}})},LoadUPCItemList:function(t,i){if(!u.IsNullOrWhiteSpace(t.SaleItems)){var o=t.SaleItems.length,n=new P;if(n.reset(t.SaleItems),o>1)u.IsNullOrWhiteSpace(this.upcItemListView)||(this.upcItemListView.unbind(),this.upcItemListView.remove(),this.upcItemListView=null),e("#upcItemListContainer").append("<div id='upcMainListContainer'></div>"),this.upcItemListView=new Oe({el:e("#upcMainListContainer"),collection:n,parentEl:e("#upcItemListContainer")}),this.upcItemListView.InitializeChildViews(i),this.upcItemListView.on("AddSelectedItem",this.AddSelectedUpcItem,this),e("#main-transaction-blockoverlay").show();else{var a=new P;a.reset(t.SaleItems),this.AddSelectedUpcItem(a)}}},AddSelectedUpcItem:function(t){var i=this,o=[],n=[];t.each(function(e){e.set({IsLoadedByUpc:!0});var t=r.TransactionType===s.TransactionType.SalesRefund,n=i.cartCollection.find(function(i){var o=e.get("ItemCode"),n=e.get("UnitMeasureCode");return t?i.get("ItemCode")===o&&i.get("UnitMeasureCode")===n&&i.get("IsNewLine")&&""==i.get("PromoDocumentCode"):i.get("ItemCode")==o&&i.get("UnitMeasureCode")==n&&""==i.get("PromoDocumentCode")});n?i.UpdateCartItem(n,1,"QuantityOrderedUpdated",!1):o.push(e)}),o.length>0&&this.itemPriceCollection.reset(o),this.OnRequestCompleted(l.SALEITEMPRICETAXBYUPC);var a=r.TransactionType===s.TransactionType.Sale||r.TransactionType===s.TransactionType.Suspend||r.TransactionType===s.TransactionType.UpdateInvoice||r.TransactionType===s.TransactionType.ResumeSale||r.TransactionType===s.TransactionType.SalesRefund||r.TransactionType===s.TransactionType.ConvertOrder;t.each(function(e){var t=i.cartCollection.find(function(t){return t.get("ItemCode")===e.get("ItemCode")&&t.get("UnitMeasureCode")===e.get("UnitMeasureCode")});t&&n.push(t)}),n.length>0&&(a?this.GetUPCSerialLotItems(new P(n)):e("#main-transaction-blockoverlay").hide())},GetUPCSerialLotItems:function(t){var i=[];t.each(function(e){var t=e.get("SerializeLot"),o=!u.IsNullOrWhiteSpace(t)&&"None"!=t,n=e.get("ItemType")===s.ItemType.GiftCard||e.get("ItemType")===s.ItemType.GiftCertificate;(o||n)&&i.push(e)}),i.length>0?(this.upcItems=new P(i),1===i.length?this.AddSerialByUPCItem():this.RenderGCList(this.upcItems)):e("#main-transaction-blockoverlay").hide()},AddSerialByUPCItem:function(t){var i=this;u.IsNullOrWhiteSpace(this.upcItems)?u.IsNullOrWhiteSpace(t)||e("#main-transaction-blockoverlay").hide():this.upcItems.each(function(e){i.ValidateUPCSerialLotItems(e,t)})},ValidateUPCSerialLotItems:function(t,i){var o=t.get("ItemCode"),n=t.get("UnitMeasureCode"),a=this.cartCollection.find(function(e){return e.get("ItemCode")==o&&e.get("UnitMeasureCode")==n});u.IsNullOrWhiteSpace(a)?u.IsNullOrWhiteSpace(i)||e("#main-transaction-blockoverlay").hide():this.ValidateSerializeLot(t.get("SerializeLot"),t.get("ItemCode"),this.GetItemDisplayName(t),a.get("LineNum"),t.get("ItemType"),t.get("UnitMeasureCode"),"",a)},IsItemHasLocation:function(e){var t=!0;switch(e){case"Non-Stock":case"Service":case"Gift Certificate":case"Gift Card":t=!1}return t},ValidateSerializeLot:function(e,t,i,o,n,a,c,l){if(void 0===e||null===e||"None"===e)return void(r.OnRechargeProcess?this.AssignExistingSerial("Serial",t,i,o,n,a):r.TransactionType!==s.TransactionType.Sale&&r.TransactionType!==s.TransactionType.Suspend&&r.TransactionType!==s.TransactionType.UpdateInvoice&&r.TransactionType!==s.TransactionType.ResumeSale&&r.TransactionType!==s.TransactionType.SalesRefund&&r.TransactionType!==s.TransactionType.Recharge&&r.TransactionType!==s.TransactionType.ConvertOrder||n!=s.ItemType.GiftCard&&n!=s.ItemType.GiftCertificate||this.InitializeSerializeLot("Serial",t,i,o,n,a,c,l));if(r.TransactionType===s.TransactionType.Sale||r.TransactionType===s.TransactionType.Suspend||r.TransactionType===s.TransactionType.UpdateInvoice||r.TransactionType===s.TransactionType.ResumeSale||r.TransactionType===s.TransactionType.ConvertOrder||r.TransactionType===s.TransactionType.SalesRefund)this.InitializeSerializeLot(e,t,i,o,n,a,c,l);else{if(r.TransactionType!==s.TransactionType.SalesRefund)return;if(!this.serializeLotCollection)return;var u=this.serializeLotCollection.filter(function(e){return t==e.get("ItemCode")&&e.get("LineNum")==o});u.length>0&&this.InitializeSerializeLot(e,t,i,o,n,a,c,l)}},IsGC:function(e){return"Gift Card"==e||"Gift Certificate"==e},IsMultiLocation:function(){return!!r.AccountingPreference&&!!r.AccountingPreference.IsLocation},CheckIfCartHasDifferentLocation:function(){var e=this;if(!e.cartCollection)return!1;if(0==e.cartCollection.length)return!1;var t=!1;return e.cartCollection.each(function(e){t||(t=e.get("WarehouseCode")!=r.Preference.DefaultLocation)}),t},AddFreeItemToCart:function(e,t){var i,o,n=this,a=new f;this.ValidateLocationBankAccount()&&(e.each(function(e){o=e.get("IsOutOfStock");var t=e.get("ErrorMessage");if(t)return void navigator.notification.alert(t,null,"Error","OK");if(n.IsReturn()&&n.IsGC(e.get("ItemType")))return void navigator.notification.alert("Adding "+e.get("ItemType")+" is not allowed on return transactions.",null,"Action Not Allowed","OK");if(1==this.IsItemGiftCredit(e)&&1==this.CartHasNegativaQty())return void navigator.notification.alert("Item exchange is not allowed for transactions with Gift Cards. Please create a separate transaction.",null,"Action Not Allowed","OK");var l=this.GetLineNum();n.IsReturn()&&e.set({CouponDiscountAmount:0,IsIncludedInCoupon:!1,IsNewLine:!0}),r.OnRechargeProcess&&e.get("ItemType")==s.ItemType.GiftCard&&e.set({Price:r.GCardAttributes.SalesPriceRate});var d=this.CalculateExtPrice(0===e.get("Quantity")?1:e.get("Quantity"),e.get("Price"),e.get("Discount"),e.get("CouponDiscountType"),e.get("CouponDiscountAmount"),e.get("CouponComputation"));e.get("WarehouseCode")||e.get("ItemType")!=s.ItemType.Service&&e.get("ItemType")!=s.ItemType.NonStock||e.set({WarehouseCode:r.LocationCode});var h=0;e.get("OriginalQuantityAllocated")&&(h=e.get("OriginalQuantityAllocated"));var p={ItemCode:e.get("ItemCode"),ItemName:e.get("ItemName"),ItemDescription:e.get("ItemDescription"),QuantityOrdered:0===e.get("Quantity")?1:e.get("Quantity"),QuantityShipped:1,SalesPriceRate:e.get("Price"),SalesPrice:e.get("Price"),SalesTaxAmountRate:e.get("Tax"),UPCCode:e.get("UPCCode"),ItemType:e.get("ItemType"),Discount:u.ApplyAllowedDecimalFormat(e.get("Discount")),LineNum:l,WarehouseCode:e.get("WarehouseCode"),CouponDiscountType:e.get("CouponDiscountType"),CouponCode:e.get("CouponCode"),CouponDiscountAmount:e.get("CouponDiscountAmount"),CouponComputation:e.get("CouponComputation"),IsIncludedInCoupon:e.get("IsIncludedInCoupon"),ExtPriceRate:d,UnitMeasureCode:e.get("UnitMeasureCode"),UnitMeasureQty:e.get("UnitMeasureQty"),SourceLineNum:0,IsOutOfStock:e.get("IsOutOfStock"),Filename:e.get("Filename"),SerializeLot:e.get("SerializeLot"),IsModified:!0,InvoiceCode:"[To be generated]",OriginalQuantityAllocated:h,Status:e.get("Status"),FreeStock:e.get("FreeStock"),IsNewLine:!e.get("IsNewLine")||e.get("IsNewLine"),AutoGenerate:e.get("AutoGenerate"),GetFreeItemCode:e.get("GetItemCode"),BuyItemCode:e.get("BuyItemCode"),PromoDocumentCode:e.get("PromoDocumentCode"),IsPromoItem:e.get("IsPromoItem")},C=e.get("IsLoadedByUpc");if(r.TransactionType===s.TransactionType.Return&&(p.Good=p.QuantityOrdered,p.QuantityAllocated=p.QuantityOrdered),a.url=r.ServiceUrl+c.SOP+"updatelinenum?SessionID="+r.GUID+"&PromoDocumentCode="+e.get("PromoDocumentCode")+"&LineNum="+l+"&ItemCode="+e.get("ItemCode"),a.save(null,{success:function(e,t){},error:function(){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()}}),this.IsRequireRecalculateCoupon())this.isFocusOnThisModel=p;else{if(C||this.ValidateSerializeLot(e.get("SerializeLot"),e.get("ItemCode"),this.GetItemDisplayName(e),p.LineNum,e.get("ItemType"),e.get("UnitMeasureCode"),"",p),e.get("ItemType")===s.ItemType.Bundle)return void this.ShowBundleConfigurator(e);if(e.get("ItemType")===s.ItemType.Kit&&this.isShowConfigurator)return void this.ShowKitConfigurator(e)}this.AddItemToCart(p),i=p.QuantityOrdered,r.HasChanges=!0},this),r.OnRechargeProcess&&this.CompleteRechargeAction(),o&&!r.Preference.IsAutoAdjustmentStock||this.cartView.trigger("updatePromoDisplay",t,i))},AddNewItemToCart:function(e){var t=this;this.ValidateLocationBankAccount()&&(e.each(function(e){var i=e.get("ErrorMessage");if(i)return void navigator.notification.alert(i,null,"Error","OK");if(t.IsReturn()&&t.IsGC(e.get("ItemType")))return void navigator.notification.alert("Adding "+e.get("ItemType")+" is not allowed on return transactions.",null,"Action Not Allowed","OK");if(1==this.IsItemGiftCredit(e)&&1==this.CartHasNegativaQty())return void navigator.notification.alert("Item exchange is not allowed for transactions with Gift Cards. Please create a separate transaction.",null,"Action Not Allowed","OK");var o=this.GetLineNum();t.IsReturn()&&e.set({CouponDiscountAmount:0,IsIncludedInCoupon:!1,IsNewLine:!0}),r.OnRechargeProcess&&e.get("ItemType")==s.ItemType.GiftCard&&e.set({Price:r.GCardAttributes.SalesPriceRate});var n=this.CalculateExtPrice(0===e.get("Quantity")?1:e.get("Quantity"),e.get("Price"),e.get("Discount"),e.get("CouponDiscountType"),e.get("CouponDiscountAmount"),e.get("CouponComputation"));e.get("WarehouseCode")||e.get("ItemType")!=s.ItemType.Service&&e.get("ItemType")!=s.ItemType.NonStock||e.set({WarehouseCode:r.LocationCode});var a=0;e.get("OriginalQuantityAllocated")&&(a=e.get("OriginalQuantityAllocated"));var c={ItemCode:e.get("ItemCode"),ItemName:e.get("ItemName"),ItemDescription:e.get("ItemDescription"),QuantityOrdered:0===e.get("Quantity")?1:e.get("Quantity"),QuantityShipped:1,SalesPriceRate:e.get("Price"),SalesPrice:e.get("Price"),SalesTaxAmountRate:e.get("Tax"),UPCCode:e.get("UPCCode"),ItemType:e.get("ItemType"),Discount:u.ApplyAllowedDecimalFormat(e.get("Discount")),LineNum:o,WarehouseCode:e.get("WarehouseCode"),CouponDiscountType:e.get("CouponDiscountType"),CouponCode:e.get("CouponCode"),CouponDiscountAmount:e.get("CouponDiscountAmount"),CouponComputation:e.get("CouponComputation"),IsIncludedInCoupon:e.get("IsIncludedInCoupon"),ExtPriceRate:n,UnitMeasureCode:e.get("UnitMeasureCode"),UnitMeasureQty:e.get("UnitMeasureQty"),SourceLineNum:0,IsOutOfStock:e.get("IsOutOfStock"),Filename:e.get("Filename"),SerializeLot:e.get("SerializeLot"),IsModified:!0,InvoiceCode:"[To be generated]",OriginalQuantityAllocated:a,Status:e.get("Status"),FreeStock:e.get("FreeStock"),IsNewLine:!e.get("IsNewLine")||e.get("IsNewLine"),AutoGenerate:e.get("AutoGenerate"),PromoDocumentCode:"",PromoID:"",RuleID:"",BuyLineNum:o,IsPromoItem:!1,QuantityDisplayed:0===e.get("Quantity")?1:e.get("Quantity"),SalesTaxCode:e.get("SalesTaxCode"),Tax:e.get("TaxCode")},l=e.get("IsLoadedByUpc");if(r.TransactionType===s.TransactionType.Return&&(c.Good=c.QuantityOrdered,c.QuantityAllocated=c.QuantityOrdered),this.IsRequireRecalculateCoupon())this.isFocusOnThisModel=c;else{if(l||this.ValidateSerializeLot(e.get("SerializeLot"),e.get("ItemCode"),this.GetItemDisplayName(e),c.LineNum,e.get("ItemType"),e.get("UnitMeasureCode"),"",c),e.get("ItemType")===s.ItemType.Bundle)return void this.ShowBundleConfigurator(e);if(e.get("ItemType")===s.ItemType.Kit&&this.isShowConfigurator)return void this.ShowKitConfigurator(e)}this.AddItemToCart(c),r.HasChanges=!0},this),r.OnRechargeProcess&&this.CompleteRechargeAction())},AddFreeItems:function(e,t){var o,n,a=this,l=new N,d=new A,h=new f,p=new Date,C=new f,m=window.sessionStorage.getItem("selected_taxcode"),T=r.TransactionType;r.TransactionType==s.TransactionType.UpdateInvoice&&(T=s.TransactionType.ResumeSale),p=this.JsonToAspDate(p),h.set({BillToCode:r.CustomerCode,POSWorkstationID:r.POSWorkstationID,POSClerkID:r.Username,IsFreightOverwrite:!0,IsOverrideSalesRep:r.Preference.IsOverrideSalesRep,IsTaxByLocation:r.Preference.TaxByLocation,WarehouseCode:r.Preference.DefaultLocation,PublicNotes:r.PublicNote.PublicNotes,ShippingDate:p,WebSiteCode:r.Preference.WebSiteCode,SalesOrderCode:"[To be generated]",SourceSalesOrderCode:"[To be generated]",Type:"Sales Order",SalesOrderDate:p,SourceCode:"KVSupply",FreightRate:0}),u.IsNullOrWhiteSpace(this.customerPOModel)||h.set(a.customerPOModel.attributes),d.add(h),this.AssignTransactionShipTo(d.at(0)),this.SetCouponToTransactionHeader(d.at(0),!1),e.set({SalesOrderCode:"[To be generated]"}),l.add(e),C.set({SalesOrders:d,SalesOrderDetails:l,TaxCode:m?m:r.ShipTo.TaxCode,IsTaxByLocation:r.Preference.TaxByLocation,TransactionType:T});var g;a.cartCollection&&a.cartCollection.length>0&&a.cartCollection.each(function(t){t.get("ItemCode")==e.get("ItemCode")&&t.get("LineNum")==e.get("LineNum")&&(g=t.get("PromoDocumentCode"))}),C.url=r.ServiceUrl+c.SOP+"getfreeitems?SessionID="+r.GUID+"&PromoDocumentCode="+g+"&IsCoupon="+t,C.save(null,{success:function(e,t){if(t.SaleItems.length>0){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),o=new P(t.SaleItems),n=new P(t.PromoItemDetail);var s,l,u;a.GetLineNum();o.each(function(e){l=e.get("ItemCode"),u=e.get("Quantity"),e.set("IsPromoItem",!0),a.cartCollection.each(function(o){for(i=0;i<e.get("BuyItemCode")[0].BuyItemCode.length;i++)o.get("ItemCode")==e.get("BuyItemCode")[0].BuyItemCode[i]&&o.get("LineNum")==e.get("BuyItemCode")[0].BuyLineNum[i]&&(o.set("PromoID",e.get("PromoID")),o.set("RuleID",e.get("RuleID")),o.set("PromoDocumentCode",t.PromoCode),o.set("GetItemCode",e.get("GetItemCode")))}),s=a.cartCollection.find(function(t){return t.get("ItemCode")==e.get("ItemCode")&&l&&t.get("SalesPriceRate")==e.get("Price")&&t.get("BuyItemCode")[0].BuyItemCode[0]==e.get("BuyItemCode")[0].BuyItemCode[0]&&t.get("BuyItemCode")[0].BuyLineNum[0]==e.get("BuyItemCode")[0].BuyLineNum[0]})}),s?o.each(function(e){a.cartCollection.each(function(t){t.get("ItemCode")==e.get("ItemCode")&&t.get("SalesPriceRate")==e.get("Price")&&t.get("BuyItemCode")[0].BuyItemCode[0]==e.get("BuyItemCode")[0].BuyItemCode[0]&&t.get("BuyItemCode")[0].BuyLineNum[0]==e.get("BuyItemCode")[0].BuyLineNum[0]&&t.set("QuantityOrdered",u),e.set("LineNum",t.get("LineNum"))}),C.url=r.ServiceUrl+c.SOP+"updatelinenum?SessionID="+r.GUID+"&PromoDocumentCode="+e.get("PromoDocumentCode")+"&LineNum="+e.get("LineNum"),C.save(null,{success:function(e,t){},error:function(){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()}})}):1==o.length?a.AddFreeItemToCart(o,n):o.length>1&&a.ShowPromotionConfigurator(o,n)}},error:function(){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()}})},ShowPromotionConfigurator:function(e,t){var i=new Ae({collection:e,promoitems:t});i.on("getPromoItems",this.ProcessPromoItems,this),this.$el.find("#promotion-configurator-container").html(i.render().el),this.$el.find("#promotion-configurator-container").find("ul").listview().listview("refresh")},ProcessPromoItems:function(e,t){this.AddFreeItemToCart(e,t)},AddToItemsOnQueue:function(e){this.AllowedToAddAnItem(e)&&(this.ItemsOnQueue||(this.ItemsOnQueue=new w,this.ItemsOnQueue.on("add",this.AddToCart,this)),this.ItemsOnQueue.add(e))},ShowMsg:function(e,t){t||(t="Action Not Allowed"),navigator.notification.alert(e,null,t,"OK")},AllowedToAddAnItem:function(e){var t;switch(r.TransactionType){case s.TransactionType.SalesPayment:t="Adding items is not allowed for Payment on Account transactions.";break;case s.TransactionType.SalesRefund:return!0;case s.TransactionType.Recharge:t="Adding items is not allowed for Recharge transactions.";break;default:if(1!=this.IsItemGiftCredit(e)||1!=this.CartHasNegativaQty())return!0;t="Item exchange is not allowed for transactions with Gift Cards. Please create a separate transaction."}return this.ShowMsg(t,null,"Action not allowed"),!1},PreventAddingOfItemsFromOriginalInvoice:function(e){var t=!1;return this.cartCollection.each(function(i){t||i.get("ItemCode")==e.get("ItemCode")&&i.get("UnitMeasureCode")==e.get("UnitMeasureCode")&&(t=!0)}),!t&&(r.LoadedItems&&r.LoadedItems.length>0&&r.LoadedItems.each(function(i){t||i.get("ItemCode")==e.get("ItemCode")&&i.get("UnitMeasureCode")==e.get("UnitMeasureCode")&&(t=!0)}),t)},RemoveFromItemsOnQueue:function(e){this.isProcessing=!1,this.ItemsOnQueue&&(this.ItemsOnQueue.remove(e),this.ItemsOnQueue.length>0&&this.AddToCart(this.ItemsOnQueue.at(0)))},AddToCart:function(e){if(!this.isProcessing&&this.AllowedToAddAnItem(e)){if(!r.ValidLocation)return void this.NotifyMsg("The Current Status of the Default Location is Inactive.","Unable to add Item");this.cartEventTriggered=!1;var t=e.get("ItemCode"),i=e.get("UnitMeasureCode"),o=this.IsReturn(),n=this.cartCollection.find(function(e){return o?e.get("ItemCode")==t&&e.get("UnitMeasureCode")==i&&e.get("IsNewLine")&&e.get("ItemType")!=s.ItemType.Kit&&""==e.get("PromoDocumentCode"):e.get("ItemCode")==t&&e.get("UnitMeasureCode")==i&&e.get("ItemType")!=s.ItemType.Kit&&""==e.get("PromoDocumentCode")});if(this.isProcessing=!0,n)this.UpdateCartItem(n,1,"QuantityOrderedUpdated",!1),this.RemoveFromItemsOnQueue(e);else{this.couponModel&&(u.IsNullOrWhiteSpace(this.couponModel.get("CustomerCode"))||this.couponModel.get("CustomerCode")==r.CustomerCode||this.RemoveCoupon());var a=r.LocationCode;1!=this.IsMultiLocation()||r.TransactionType!=s.TransactionType.ConvertOrder&&r.TransactionType!=s.TransactionType.UpdateOrder&&r.TransactionType!=s.TransactionType.UpdateQuote&&r.TransactionType!=s.TransactionType.ConvertQuote||(a=r.TransactionObject.WarehouseCode),
this.GetSaleItemPriceTax(t,r.CustomerCode,a,e.get("UnitMeasureCode"),r.Preference.TaxByLocation,this.GetCouponID(),e)}return!0}},AddItemByUPC:function(e){switch(r.TransactionType){case s.TransactionType.SalesPayment:return void navigator.notification.alert("Adding items is not allowed for Payment on Account transactions.",null,"Action Not Allowed","OK");case s.TransactionType.Recharge:return void navigator.notification.alert("Adding items is not allowed for Recharge transactions.",null,"Action Not Allowed","OK")}if(!r.ValidLocation)return void this.NotifyMsg("The Current Status of the Default Location is Inactive.","Unable to add Item");e=e.toLowerCase();var t=r.LocationCode;1!=this.IsMultiLocation()||r.TransactionType!=s.TransactionType.ConvertOrder&&r.TransactionType!=s.TransactionType.UpdateOrder&&r.TransactionType!=s.TransactionType.ConvertQuote&&r.TransactionType!=s.TransactionType.UpdateQuote||(t=r.TransactionObject.WarehouseCode),this.GetSaleItemPriceTaxByUPC(e,r.CustomerCode,t,r.Preference.TaxByLocation,this.GetCouponID())},UpdateRecalculatedItems:function(e){if(!r.CurrentCustomerChanged&&r.Coupon)this.RecalculateCoupon();else{this.VoidCoupon(!1);for(var t=0;t<this.cartCollection.length;t++){var i=this.cartCollection.at(t);this.RecalculateItem(i,e)}}r.HasChanges=!0},UpdateRecalculatedItemsCompleted:function(){this.OnRequestCompleted("UpdateRecalculatedItemsCompleted"),r.OnRechargeProcess&&this.ProcessItemLookup()},RecalculateItem:function(e,t){if(e.get("ItemCode")===t.get("ItemCode")&&e.get("UnitMeasureCode")===t.get("UnitMeasureCode")){var i=this.CalculateExtPrice(t.get("QuantityOrdered"),t.get("SalesPriceRate"),t.get("Discount"),t.get("CouponDiscountType"),t.get("CouponDiscountAmount"),t.get("CouponComputation"),t.get("LineNum"));e.set({SalesPriceRate:t.get("SalesPriceRate"),SalesPrice:t.get("SalesPrice"),ExtPriceRate:i})}},CanChangeQuantity:function(e){return!this.HasCoupon()||(!(e.get("QuantityOrdered")<0)||(navigator.notification.alert("Negative quantity is not allowed.\nPlease remove coupon first.",null,"Negative Quantity","OK"),!1))},HasCoupon:function(){return!!r.Coupon&&!(!r.Coupon.get("CouponCode")||""==r.Coupon.get("CouponCode"))},CheckNegativeQuantities:function(){this.RemoveDiscountOnNegativeQuantityItem()},RemoveDiscountOnNegativeQuantityItem:function(){this.cartCollection&&0!=this.cartCollection.length&&this.cartCollection.each(function(e){e.get("QuantityOrdered")<0&&e.set("Discount",0)})},AssignQuantityToBeAddded:function(e,t){return r.TransactionType==s.TransactionType.Sale&&(1==e&&t==-1?t=-2:e==-1&&1==t&&(t=2)),t},AssignCartEventTriggered:function(e,t,i){this.cartEventTriggered=null,this.cartEventTriggered=t,!u.IsNullOrWhiteSpace(e.get("EventTriggered"))&&u.IsNullOrWhiteSpace(t)&&(this.cartEventTriggered=e.get("EventTriggered"))},UpdateCartItem:function(t,o,n,a,c){var l=this;new f;o=this.AssignQuantityToBeAddded(t.get("QuantityOrdered"),o);var d=!1,h=(t.get("Pricing"),t.get("QuantityOrdered")||0),p=this.GetUpdatedItemQuantity(t,o);if(this.AssignCartEventTriggered(t,n,a),u.IsNullOrWhiteSpace(t.get("DoNotChangePrice"))||(d=!0),t.set({DoNotChangePrice:d,DoNotCheckStock:!0,LastEvent:n}),u.IsNullOrWhiteSpace(n)||"QuantityOrderedUpdated"!==n&&"UnitMeasureUpdated"!==n||t.set("DoNotCheckStock",!1),""!==p&&null!==p&&void 0!==p&&0!=this.IsItemQuantityAllowed(p)){if(this.SetItemQuantity(t,p),!this.CanChangeQuantity(t))return void this.SetItemQuantity(t,h);if(this.CheckNegativeQuantities(),void 0!=a&&(r.TransactionType!=s.TransactionType.SalesRefund||r.TransactionType!=s.TransactionType.Return||t.get("ItemType")==s.ItemType.GiftCard||t.get("ItemType")==s.ItemType.GiftCertificate)){var C=!!t.get("IsLoadedByUpc");C||"QuantityOrderedUpdated"!=n&&"UnitMeasureUpdated"!=n||this.ValidateSerializeLot(t.get("SerializeLot"),t.get("ItemCode"),this.GetItemDisplayName(t),t.get("LineNum"),t.get("ItemType"),t.get("UnitMeasureCode"),t.get("LastEvent"),t)}this.IsRequireRecalculateCoupon()?(t.get("DoNotCheckStock")||this.NotifyIfItemIsOutOfStock(t.attributes,!0),"QuantityOrderedUpdated"===n?(this.isNoCouponAtFirst=!0,this.isFocusOnThisModel=t.toJSON(),this.ChangeItemExtendedPrice(t,p,!0)):this.holdRecomputeCoupon||this.RecalculateCoupon()):this.ChangeItemExtendedPrice(t,p),r.PreviousAssignedItemQty=t.get("QuantityDisplayed"),r.HasChanges=!0;var m=this.cartCollection.find(function(e){return e.get("ItemCode")==t.get("ItemCode")&&1==t.get("IsPromoItem")});void 0!=m&&(e("#"+m.cid+" #quantityDisplay").addClass("ui-disabled").css("opacity",1),e("#"+m.cid+" #display-itemName").addClass("ui-disabled").css("opacity",1),e("#"+m.cid+" #itemPriceDisplay").addClass("ui-disabled").css("opacity",1),e("#"+m.cid+" #discountDisplay").addClass("ui-disabled").css("opacity",1),e("#"+m.cid+" #extPriceRate-td").addClass("ui-disabled").css("opacity",1));var T=new P;T=new P(l.cartCollection.filter(function(e){if(null!=e.get("BuyItemCode")&&0!=e.get("BuyItemCode").length){if(void 0==e.get("BuyItemCode")[0].BuyItemCode)return 1==e.get("IsPromoItem")&&e.get("BuyItemCode")==t.get("ItemCode")&&carItem.get("PromoDocumentCode")==t.get("PromoDocumentCode");if(1==e.get("BuyItemCode")[0].BuyItemCode.length)return 1==e.get("IsPromoItem")&&e.get("BuyItemCode")[0].BuyItemCode[0]==t.get("ItemCode")&&e.get("PromoDocumentCode")==t.get("PromoDocumentCode");for(i=0;i<e.get("BuyItemCode")[0].BuyItemCode.length;i++)return 1==e.get("IsPromoItem")&&e.get("BuyItemCode")[0].BuyItemCode[i]==t.get("ItemCode")&&e.get("PromoDocumentCode")==t.get("PromoDocumentCode")}})),T.each(function(e){l.cartCollection.remove(e)})}},GetLineNum:function(){if(this.IsReturn()){var e=0;return r.LoadedItems.length>0&&r.LoadedItems.each(function(t){(t.get("LineNum")||0)>e&&(e=t.get("LineNum")||0)}),this.cartCollection.length>0&&this.cartCollection.each(function(t){(t.get("LineNum")||0)>e&&(e=t.get("LineNum")||0)}),e+1}return this.cartCollection.length+1},CalculateExtPrice:function(e,t,i,o,n,a,r){if(o)if("Stackable"===a){if("Percent"!==o)return this.CalculateExtPriceWithStackableAmountDiscount(e,t,i,n,r);t=this.CalculateNetPrice(t,n,o,!0)}else"Percent"===o&&(i+=n);var s=e*this.CalculateNetPrice(t,i,o);return s},CalculateExtPriceWithStackableAmountDiscount:function(e,t,i,o,n){var a=e*this.CalculateNetPrice(t,i);if(n=n||0,0!=n&&this.IsReturn()){var s;if(r.LoadedItems&&r.LoadedItems.length>0&&r.LoadedItems.each(function(e){s||e.get("LineNum")==n&&(s=e)}),s){var c=s.get("QuantityOrdered")||0,l=s.get("ExtPriceRate")||0,u=s.get("Outstanding")||0;if(o=s.get("CouponDiscount")||0,c==e)this.IsReturn()?a=l:a-=o;else{if(c<=0&&(c=1),u==e){var d=c-e,h=parseFloat((o/c).toFixed(4)),p=parseFloat(this.preciseRound(o/c,2));o-=.005==parseFloat((h-p).toFixed(3))?parseFloat(parseFloat(p*d).toFixed(2)):parseFloat((parseFloat(h.toFixed(2))*d).toFixed(2))}else{var h=parseFloat((o/c).toFixed(4)),p=parseFloat(this.preciseRound(o/c,2));o=.005==parseFloat((h-p).toFixed(3))?parseFloat(parseFloat(p*e).toFixed(2)):parseFloat((parseFloat(h.toFixed(2))*e).toFixed(2))}a-=o}this.cartCollection&&this.cartCollection.length>0?this.cartCollection.each(function(e){e.get("LineNum")==n&&e.set({CouponDiscount:o,CouponDiscountRate:o,CouponDiscountAmount:o})}):s.set({AlteredCoupon:!0,AlteredCouponDiscount:o})}else a-=o}else a-=o;return a<=0?0:a},preciseRound:function(e,t){null==t&&(t=2);var i=e.toString();return i.indexOf(".")==-1?i:i.substr(0,i.indexOf(".")+t+1)},CalculateItemExtPrice:function(e,t,i){this.RemoveTermDiscountPayment();var o=e.get("TaxCode");if(e.get("ItemType")===s.ItemType.Kit){var n=new P;n.add(JSON.parse(window.sessionStorage.getItem("kitItems-"+e.get("LineNum")))),n.each(function(t){t.set("Quantity",t.get("OriginalQuantity")*e.get("QuantityOrdered"))})}var a=e.clone();a.set({TaxCode:o?o:null,IsModified:!0,DiscountType:r.ShipTo.DiscountType,DiscountPercent:r.ShipTo.DiscountPercent,DiscountableDays:r.ShipTo.DiscountableDays,SalesOrderCode:r.TransactionCode,ItemKitDetails:n?n:null,IsUsePOSShippingMethod:r.Preference.IsUsePOSShippingMethod,POSShippingMethod:r.Preference.POSShippingMethod}),t?a.on("sync",t,this):a.on("sync",this.CalculateItemExtPriceDefaultCallback,this),i?a.on("sync",i,this):a.on("sync",this.CalculateItemExtPriceDefaultCallback,this),a.url=r.ServiceUrl+c.SOP+l.CALCULATEITEMEXTPRICE,a.save()},CalculateItemExtPriceDefaultCallback:function(e,t,i){this.CalculateItemExtPriceErrorHandler(e,t,i)},CalculateItemExtPriceErrorHandler:function(e,t,i){return r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),!(!e.get("ErrorMessage")||""==e.get("ErrorMessage"))&&(navigator.notification.alert(e.get("ErrorMessage")||"An error was encountered when trying to update an item.",null,"Error Updating Item","OK"),!0)},CalculateNetPrice:function(e,t,i,o){var n=e*(t/100),a=e-n;return a=format("0.0000",a),o?a:this.RoundNumber(a,2)},RoundRequestQueue:function(e){this.roundQueue=new w,this.roundQueue.on("add",this.RoundRequestOnQueue,this),this.roundQueue.on("remove",this.RoundRequestOnQueue,this)},RoundRequestOnQueue:function(e){this.RoundNumber(e)},RoundNumber:function(e,t){var i=new a.BigDecimal(e);return i.setScale(t,a.MathContext.ROUND_HALF_UP)},InitializePaymentType:function(t){this.paymentTypeView?this.paymentTypeView.Show(t):(this.paymentTypeView=new fe({el:e("#paymentContainer"),isPaid:t}),this.paymentTypeView.on("cash",this.AddCashPayment,this),this.paymentTypeView.on("check",this.AddCheckPayment,this),this.paymentTypeView.on("card",this.AddCreditCardPayment,this),this.paymentTypeView.on("offline",this.AddOfflinePayment,this),this.paymentTypeView.on("onAccount",this.AddOnAccount,this),this.paymentTypeView.on("suspend",this.AddSuspend,this),this.paymentTypeView.on("gift",this.AddGift,this),this.paymentTypeView.on("loyalty",this.AddLoyalty,this))},ValidateCartItemsQty:function(){if(!r.TransactionType==s.TransactionType.ConvertQuote||r.TransactionType==s.TransactionType.SalesRefund)return!1;var e=this.cartCollection.find(function(e){return 0==e.get("QuantityOrdered")});return e},buttonComplete_Tap:function(e){if(e.preventDefault(),this.cartCollection.length>0&&this.ValidateCartItemsQty())return void navigator.notification.alert("One or more item(s) in the cart has a quantity of 0, Item(s) with 0 quantity is not allowed. ",null,"Action Not Allowed","OK");if(this.cartCollection.total()<0)navigator.notification.alert("Negative exchange is not allowed. You may need to create a separate sale or return transaction.",null,"Action Not Allowed","OK");else switch(r.TransactionType){case s.TransactionType.Quote:case s.TransactionType.UpdateQuote:this.CreateTransaction("partial");break;default:if(this.cartCollection.length>0){var t=!1;if(this.paymentCollection&&this.paymentCollection.length>0&&(t=!0),!this.AllowToCompleteTransaction())return;this.CheckPotentialDiscount(t);var i=this.cartCollection.pluck("Discount");o.each(i,function(e,t){if(e>0)return r.IsUseINVDiscountReport=!0})}else navigator.notification.alert("There are no items to process.",null,"Action Not Allowed","OK")}},GetTransactionDates:function(){var e=u.GetJsonUTCDate();switch(r.TransactionType){case s.TransactionType.ResumeSale:case s.TransactionType.UpdateInvoice:case s.TransactionType.Recharge:case s.TransactionType.ConvertOrder:case s.TransactionType.UpdateOrder:case s.TransactionType.SalesPayment:return{DocumentDate:r.TransactionDocumentDate,StartDate:r.TransactionObject.StartDate}}return{DocumentDate:e,DateCreated:e}},CheckPotentialDiscount:function(e,t,i){r.TermDiscount=0;var o=r.Summary;_mdl=new f,_mdl.url=r.ServiceUrl+c.SOP+l.COMPUTETERMDISCOUNT,transactionDates=this.GetTransactionDates(),_mdl.set(transactionDates),_mdl.set({SubTotal:o.SubTotal,SubTotalRate:o.SubTotal,DiscountType:r.ShipTo.DiscountType,DiscountPercent:r.ShipTo.DiscountPercent,DiscountableDays:r.ShipTo.DiscountableDays,DueType:r.ShipTo.DueType}),i&&_mdl.set({PaymentDate:i}),_mdl.save(null,{success:function(i,o){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.ProcessPotentialDiscountResult(o,t,e)}.bind(this),error:function(i,o,n){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.ProcessPotentialDiscountResult(n,t,e)}.bind(this)})},ProcessPotentialDiscountResult:function(e,t,i){if(e.ErrorMessage)this.NotifyMsg("Error Fetching Potential Discount");else{var o=format("0.0000",e.Value);if(r.TermDiscount=1*this.RoundNumber(o,2),this.summaryModel.set({TermDiscount:r.TermDiscount}),r.AllowToFetchPotentialDiscount)return r.AllowToFetchPotentialDiscount=!1,void(this.summaryModel&&(this.summaryModel.DeductPotentialDiscountFromBalance()>0?this.RemoveTermDiscountPayment():this.AddTermDiscountToPayment(r.TermDiscount),this.summaryModel.set({TermDiscount:0})))}t||this.InitializePaymentType(i)},InitializePrinterCollection:function(){this.printerCollection||(this.printerCollection=new F,this.printerCollection.on("reset",this.SetValues,this)),this.printerCollection.fetch({success:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()}})},SetValues:function(e){var t=e.find(function(e){return e.get("PrinterModel")}),i=e.find(function(e){return e.get("IpAddress")});t&&(r.Printer.PrinterModel=t.get("PrinterModel")),i&&(r.Printer.IpAddress=i.get("IpAddress"))},CreateTransaction:function(e){switch(Ee=e,r.TransactionType){case s.TransactionType.Sale:this.CreateInvoiceWithValidaton(e);break;case s.TransactionType.Order:this.CreateOrderWithValidation(e);break;case s.TransactionType.Quote:this.CreateQuoteWithValidation();break;case s.TransactionType.UpdateInvoice:case s.TransactionType.Recharge:this.UpdateInvoiceWithValidation(e);break;case s.TransactionType.SalesPayment:this.CreateInvoicePaymentWithValidaton(r.TransactionCode,e);break;case s.TransactionType.UpdateOrder:this.UpdateOrderWithValidation(e);break;case s.TransactionType.ConvertOrder:this.ConvertOrderWithValidaton(r.TransactionCode,e);break;case s.TransactionType.ConvertQuote:this.ConvertQuoteWithValidaton(r.TransactionCode,e);break;case s.TransactionType.UpdateQuote:this.UpdateQuoteWithValidaton(r.TransactionCode);break;case s.TransactionType.SalesRefund:this.CreateRefundWithValidation(e);break;case s.TransactionType.Return:this.CreateRefundWithValidation(e);break;case s.TransactionType.Suspend:case s.TransactionType.Recharge:if(this.IsExistingTransaction()){this.UpdateInvoiceWithValidation(e);break}this.CreateInvoiceWithValidaton(e);break;default:return!0}},IsExistingTransaction:function(){return!(!r.TransactionObject||!r.TransactionObject.InvoiceCode||""==r.TransactionObject.InvoiceCode)},CreateLoyaltyWithValidaton:function(e){this.ValidateTransaction()&&this.ValidatePayment(e)&&this.PromptCustomerPO(e)&&this.PromptSignature()&&this.PromptToPrint()&&this.ValidateOutOfStockItems()&&this.CreateInvoice(r.IsPosted)},CreateInvoiceWithValidaton:function(e){this.ValidateTransaction()&&this.ValidatePayment(e)&&this.PromptCustomerPO(e)&&this.PromptSignature()&&this.PromptToPrint()&&this.ValidateOutOfStockItems()&&this.CreateInvoice(r.IsPosted)},ResetCustomerPODetails:function(){this.customerPOModel=null,this.isSetCustomerPO=!1,this.previousTransactionDetals=null,this.signatureTimeInterval&&this.StopFetchingSignature()},SetCustomerPODetails:function(t,i){this.customerPOModel=t,e("#main-transaction-blockoverlay").show(),this.isSetCustomerPO=!0,this.CreateTransaction(i)},PromptCustomerPO:function(t){return!!r.OnRechargeProcess||(!(r.Preference.AskForCustomerPO||r.Preference.AskForShipDate||r.Preference.AskForSource)||!u.IsNullOrWhiteSpace(this.isSetCustomerPO)&&0!=this.isSetCustomerPO||(e("#main-transaction-blockoverlay").show(),this.InitializeCustomerPOView(),this.customerPOModel=new f,this.customerPOView.Show(this.customerPOModel,t,r.CurrentCustomerSourceCode,this.previousTransactionDetals),this.customerPOView.on("AddCustomerPO",this.SetCustomerPODetails,this),this.customerPOView.on("ResetCustomerPO",this.ResetCustomerPODetails,this),!1))},InitializeCustomerPOView:function(){this.customerPOView?(this.customerPOView.unbind(),this.customerPOView=new Pe({el:e("#customerPOContainer")})):this.customerPOView=new Pe({el:e("#customerPOContainer")})},CheckAndLogLastItem:function(e,t){return this._lastItemChecked||(this._lastItemChecked={ItemCode:"",QuantityOrdered:0,WarehouseCode:""}),(this._lastItemChecked.ItemCode!=e.ItemCode||this._lastItemChecked.QuantityOrdered!=e.QuantityOrdered||this._lastItemChecked.WarehouseCode!=e.WarehouseCode||this._lastItemChecked.UnitMeasureCode!=e.UnitMeasureCode)&&(!!t||(this._lastItemChecked.ItemCode=e.ItemCode,this._lastItemChecked.QuantityOrdered=e.QuantityOrdered,this._lastItemChecked.WarehouseCode=e.WarehouseCode,this._lastItemChecked.UnitMeasureCode=e.UnitMeasureCode,!0))},NotifyIfItemIsOutOfStock:function(e,t){var i=this;if(e.ItemType==s.ItemType.Service||e.ItemType==s.ItemType.NonStock||e.ItemType==s.ItemType.GiftCard||e.ItemType==s.ItemType.GiftCertificate)return void i.CheckAndLogLastItem(e);if(r.CustomerPreference&&r.CustomerPreference.IsIgnoreStockLevels)return void i.CheckAndLogLastItem(e);if(r.TransactionType!=s.TransactionType.Sale&&r.TransactionType!=s.TransactionType.ConvertOrder&&r.TransactionType!=s.TransactionType.Suspend&&r.TransactionType!=s.TransactionType.UpdateInvoice)return void i.CheckAndLogLastItem(e);if(e.DoNotCheckStock)return void i.CheckAndLogLastItem(e);if(!e.IsOutOfStock&&!t)return void i.CheckAndLogLastItem(e);if(this.CheckAndLogLastItem(e,t)){if(t){var o=new f;return o.set(e),o.set({Quantity:e.QuantityOrdered}),o.url=r.ServiceUrl+c.SOP+l.ISITEMOUTOFSTOCK,void o.save(o,{success:function(t,o){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.get("IsOutOfStock")&&(e.IsOutOfStock=!0,i.NotifyIfItemIsOutOfStock(e))},error:function(e,t,i){console.log(t)}})}var n=!1,a=!1;if(!u.IsNullOrWhiteSpace(i.upcItemCollection)&&i.upcItemCollection.length>0){var d=0;i.upcItemCollection.each(function(t){t.get("IsOutOfStock")===!0&&d++,t.get("ItemCode")==e.ItemCode&&t.get("UnitMeasureCode")==e.UnitMeasureCode&&t.get("WarehouseCode")==e.WarehouseCode&&t.set({Scanned:!0})}),d>1&&(n=!0);var h=0;i.upcItemCollection.each(function(e){e.get("Scanned")&&h++}),h>1&&(a=!0,h==d&&i.upcItemCollection.reset())}if(!a){r.msg1="Item '"+e.ItemName+"' does not have enough stock. ConnectedSale will automatically adjust stock when the sale transaction is created.";return r.msgTitle="Stock Verification",u.IsNullOrWhiteSpace(n)||(_msg1="One or more Item does not have enough stock. ConnectedSale will automatically adjust stock when the sale transaction is created."),r.Preference.AutoAllocateOverrideLevel&&""!=r.Preference.AutoAllocateOverrideLevel&&r.Preference.AutoAllocateOverrideLevel!=r.UserInfo.RoleCode?(0!=r.Preference.IsAutoAdjustmentStock||1!=e.IsOutOfStock)&&(1==r.Preference.IsAutoAdjustmentStock&&1==e.IsOutOfStock?(this.ValidateManagerOverride(s.ActionType.AutoAllocate),r.CurrentAssignedItemQty=e.QuantityOrdered,!1):void navigator.notification.alert(r.msg1,null,r.msgTitle,"OK")):(0!=r.Preference.IsAutoAdjustmentStock||1!=e.IsOutOfStock)&&void navigator.notification.alert(r.msg1,null,r.msgTitle,"OK")}}},ValidateOutOfStockItems:function(){if(r.CustomerPreference&&r.CustomerPreference.IsIgnoreStockLevels)return!0;if(r.TransactionType!=s.TransactionType.Sale&&r.TransactionType!=s.TransactionType.ConvertOrder&&r.TransactionType!=s.TransactionType.Suspend&&r.TransactionType!=s.TransactionType.UpdateInvoice)return!0;var e=!1;return this.cartCollection.each(function(t){t.get("IsOutOfStock")&&(e=!0)}),!e||(!r.Preference.AutoAllocateOverrideLevel||""==r.Preference.AutoAllocateOverrideLevel||r.Preference.AutoAllocateOverrideLevel==r.UserInfo.RoleCode||this.ValidateManagerOverride(s.ActionType.AutoAllocate,!0))},UpdateInvoiceWithValidation:function(t){r.HasChanges||this.AllowSaveWithOutChanges()?this.ValidateTransaction()&&this.ValidatePayment(t)&&this.PromptCustomerPO(t)&&this.PromptSignature()&&this.PromptToPrint()&&this.ValidateOutOfStockItems()&&this.UpdateInvoice():(navigator.notification.alert("There are no changes to save.",null,"Cannot Save Transaction","OK"),e("#main-transaction-blockoverlay").hide())},AllowSaveWithOutChanges:function(){return r.TransactionType==s.TransactionType.Suspend||(r.TransactionType==s.TransactionType.Recharge||r.TransactionType==s.TransactionType.UpdateInvoice)},CreateOrderWithValidation:function(e){this.ValidateTransaction()&&this.ValidatePayment(e)&&this.PromptCustomerPO(e)&&this.PromptSignature()&&this.PromptToPrint()&&this.CreateOrder()},UpdateOrderWithValidation:function(t){r.HasChanges?this.ValidateTransaction()&&this.ValidatePayment(t)&&this.PromptCustomerPO(t)&&this.PromptSignature()&&this.PromptToPrint()&&this.UpdateOrder():(navigator.notification.alert("There are no changes to save.",null,"Cannot Save Transaction","OK"),e("#main-transaction-blockoverlay").hide())},CreateQuoteWithValidation:function(){this.ValidateTransaction()&&this.PromptCustomerPO()&&this.PromptToPrint()&&this.CreateQuote()},UpdateQuoteWithValidaton:function(e){this.ValidateTransaction()&&this.PromptCustomerPO()&&this.PromptToPrint()&&this.UpdateQuote(e)},CreateInvoicePaymentWithValidaton:function(e,t){this.ValidatePayment(t)&&(payments=this.GetNewPayments(),payments&&payments.length>0?this.PromptToPrint()&&this.CreateInvoicePayment(e):(navigator.notification.alert("There are no new payments to process.",null,"No Payments Found","OK"),this.RemoveScreenOverLay()))},CreateCreditMemoWithValidation:function(e){this.ValidateTransaction()&&this.PromptToPrint()&&this.PromptCustomerPO(e)&&this.ValidateReason("Return")&&this.ValidateManagerOverride(s.ActionType.Returns)&&this.CreateCreditMemo()},CreateCreditMemo:function(){this.InitializeTransaction();var e=new k,t=new L,i=new Date,o=new P;i=this.JsonToAspDate(i),t.add(this.cartCollection.models),t.each(function(e){var t=window.sessionStorage.getItem("selected_taxcode");t=t?t:r.ShipTo.TaxCode,e.set("TaxCode",t)}),this.cartCollection.each(function(e){var t=JSON.parse(window.sessionStorage.getItem("kitItems-"+e.get("LineNum")));t&&o.add(t)});var n=this,a=new f;a.set({BillToCode:r.CustomerCode,POSWorkstationID:r.POSWorkstationID,POSClerkID:r.Username,IsFreightOverwrite:!0,IsOverrideSalesRep:r.Preference.IsOverrideSalesRep,SignatureSVG:r.Signature,ShippingDate:r.TransactionObject?r.TransactionObject.ShippingDate:i,WarehouseCode:r.Preference.DefaultLocation,IsTaxByLocation:r.Preference.TaxByLocation}),u.IsNullOrWhiteSpace(this.customerPOModel)||a.set(n.customerPOModel.attributes),e.add(a),this.AssignTransactionShipTo(e.at(0)),this.transactionModel.set({Invoices:e.toJSON(),InvoiceDetails:t.toJSON(),KitDetails:o.toJSON(),SalesRep:null==r.SalesRepList?null:r.SalesRepList}),this.RemoveWarehouseCodeByItemType(this.transactionModel.get("InvoiceDetails")),this.transactionModel.url=r.ServiceUrl+c.SOP+l.CREATECREDITMEMO,this.LockTransactionScreen(!0,"Saving..."),this.transactionModel.save(null,{connectionID:this.signalRConnectionID}),this.ResetCustomerPODetails()},ValidatePaymentWithoutCreditMemo:function(){for(var e=0,t=0;t<this.paymentCollection.length;t++){var i=this.paymentCollection.at(t).get("PaymentType");"Credit Memo"!=i&&"Term Discount"!=i&&(e+=this.paymentCollection.at(t).get("AmountPaid"))}var o=format("0.0000",e);return e=1*this.RoundNumber(o,2),!(e<=0)},ValidateReturnSerialLot:function(e,t,i){var o=i,n=0,a=t.filter(function(e){return e.get("ItemType")===s.ItemType.GiftCard||e.get("ItemType")===s.ItemType.GiftCertificate});if(e){for(var r=0;r<a.length;r++){var c=a[r],l=!1,u=e.filter(function(e){return e.get("ItemCode")===c.get("ItemCode")});l=u.length===c.get("Good"),l||n++}return n>0?o:void 0}return a.length>0?o:void 0},CreateRefundWithValidation:function(e){return r.TransactionType!==s.TransactionType.SalesRefund||"Partial"==e||this.ValidatePaymentWithoutCreditMemo()?(this.SetActionType(s.ActionType.Returns),"Partial"!=e&&"Completed"!=e?(this.AddRefund(),null):(this.ValidateTransaction()&&this.PromptCustomerPO(e)&&this.PromptToPrint()&&this.ValidateReason("Return")&&this.ValidateManagerOverride(s.ActionType.Returns)&&this.CreateRefund(),!1)):(navigator.notification.alert("There's no payment to refund. Instead you can use 'Return' button to create a Return transaction.",null,"Action Not Allowed","OK"),this.RemoveScreenOverLay(),!1)},CreateRefund:function(){var e=new P;if(r.TransactionType==s.TransactionType.Return){e.add({Account:this.GetPaymentAccountInfo(),PaymentType:r.PaymentType,AmountPaid:this.GetTransactionBalance(),SignatureSVG:r.Signature}),null==this.refundCollection&&(this.refundCollection=e),0==this.refundCollection.length&&(this.refundCollection=e),this.InitializeTransaction();var t=new k,i=new L,o=new Date,n=new P;o=this.JsonToAspDate(o),i.add(this.cartCollection.models),i.each(function(e){var t=window.sessionStorage.getItem("selected_taxcode");t=t?t:r.ShipTo.TaxCode,e.set("TaxCode",t)}),this.cartCollection.each(function(e){var t=JSON.parse(window.sessionStorage.getItem("kitItems-"+e.get("LineNum")));t&&n.add(t)});var a,d;r.DejavooEnabled||r.OfflineCharge?(a=this.GenerateForceAuthorizationCode(),d=!0):(a="",d=!1);var h=this,p=new f;p.set({BillToCode:r.CustomerCode,Payment:this.refundCollection.at(0).toJSON(),POSWorkstationID:r.POSWorkstationID,POSClerkID:r.Username,IsFreightOverwrite:!0,IsOverrideSalesRep:r.Preference.IsOverrideSalesRep,SignatureSVG:r.Signature,ShippingDate:r.TransactionObject?r.TransactionObject.ShippingDate:o,WarehouseCode:r.Preference.DefaultLocation,IsTaxByLocation:r.Preference.TaxByLocation,IsUsePOSShippingMethod:r.Preference.IsUsePOSShippingMethod,POSShippingMethod:r.Preference.POSShippingMethod}),u.IsNullOrWhiteSpace(this.customerPOModel)||p.set(h.customerPOModel.attributes),t.add(p),this.AssignTransactionShipTo(t.at(0)),this.transactionModel.set({Invoices:t.toJSON(),InvoiceDetails:i.toJSON(),Payment:this.refundCollection.at(0).toJSON(),KitDetails:n.toJSON(),SalesRep:null==r.SalesRepList?null:r.SalesRepList,IsOfflineCharge:d,ForceAuthorizationCode:a,IsCreateRefund:r.IsCreateRefund}),this.RemoveWarehouseCodeByItemType(this.transactionModel.get("InvoiceDetails")),this.transactionModel.url=r.ServiceUrl+c.SOP+l.CREATECREDITMEMO,this.LockTransactionScreen(!0,"Saving..."),this.transactionModel.save(null,{connectionID:this.signalRConnectionID}),this.ResetCustomerPODetails()}else if(this.refundCollection&&this.refundCollection.length>0&&this.paymentCollection.at(0).get("PaymentType")!=s.PaymentType.CreditMemo){var a,d;r.DejavooEnabled||r.OfflineCharge?(a=this.GenerateForceAuthorizationCode(),d=!0):(a="",d=!1),this.InitializeTransaction();var i=new L;i.add(this.cartCollection.models);var C="";if(this.serializeLotCollection){this.serializeLotCollection.comparator=function(e){return e.get("ItemCode")},this.serializeLotCollection.sort({silent:!0});var h=this,m=[];this.cartCollection.each(function(e){h.serializeLotCollection.each(function(t){e.get("Good")>0&&t.get("ItemCode")===e.get("ItemCode")&&t.get("LineNum")===e.get("LineNum")&&t.get("IsIncluded")&&m.push(t)})});var T=new P;T.reset(m),C=T.toJSON()}var h=this;r.SVG_Hold=new Array,r.SVG_ReadyToSave=!1;var g=function(){!h.IsHoldSVG()&&r.SVG_ReadyToSave&&h.transactionModel.save(null,{connectionID:h.signalRConnectionID})};this.RemoveTermDiscountPayment();for(var y=0;y<this.refundCollection.length;y++)if(this.refundCollection.at(y).get("SignatureSVG")){var S=this.refundCollection.at(y).get("SignatureSVG");this.refundCollection.at(y).set({SignatureSVG:this.ValidateSVG(S,g)})}var I=this.cartCollection.at(0).get("CouponCode");i.each(function(e){e.get("IsNewLine")&&e.set({OriginalQuantityAllocated:0,Outstanding:0,QuantityOrdered:0,QuantityShipped:0})}),this.transactionModel.set({InvoiceDetails:i.toJSON(),Payment:this.refundCollection.at(0).toJSON(),Customer:r.CurrentCustomer,InvoiceCode:r.TransactionCode,CouponCode:I,IsTaxByLocation:r.Preference.TaxByLocation,WarehouseCode:r.Preference.DefaultLocation,PublicNotes:r.PublicNote.PublicNotes,SerialLotNumbers:C,ShippingDate:r.TransactionObject.ShippingDate,IsOfflineCharge:d,ForceAuthorizationCode:a}),u.IsNullOrWhiteSpace(this.customerPOModel)||this.transactionModel.set(h.customerPOModel.attributes),this.RemoveWarehouseCodeByItemType(this.transactionModel.get("InvoiceDetails")),this.transactionModel.url=r.ServiceUrl+c.SOP+l.CREATEREFUNDFROMINVOICE;try{this.LockTransactionScreen(!0,"Saving..."),this.ResetCustomerPODetails(),r.SVG_ReadyToSave=!0;var v="Error saving the CreditMemo. The following items do not have the same number of serial numbers with the shipped quantity.",w=this.ValidateSerialLot(T,this.cartCollection,v);if(void 0!==w&&""!==w)throw w;return g(),!0}catch(O){this.LockTransactionScreen(!1),navigator.notification.alert(O,null,"Action not Allowed","OK")}}else this.ConvertInvoice()},AddRefund:function(){r.PaymentType!=s.PaymentType.Cash;switch(this.refundCollection?this.refundCollection.reset():this.refundCollection=new M,this.refundCollection.unbind(),this.refundCollection.on("add",this.AddRefundCompleted,this),this.refundView||(this.refundView=new Te({el:e("#refundContainer"),collection:this.refundCollection,payment:this.paymentCollection}),this.refundView.on("allowUserToAttachSign",this.GetAttachedSignature,this),this.refundView.on("cancelSignRetrieval",this.StopRetrieval,this),this.refundView.on("deleteSavedSignature",this.DeleteSavedSignature,this)),r.PaymentType){case s.PaymentType.Cash:r.DejavooEnabled?this.RefundDejavooCreditCardPayment(this.GetRefundAmount()):this.refundView.AddCashPayment(this.GetRefundAmount());break;case s.PaymentType.CreditCard:r.DejavooEnabled?this.RefundDejavooCreditCardPayment(this.GetRefundAmount()):r.OfflineCharge?this.RefundDejavooCreditCardPayment(this.GetRefundAmount()):this.refundView.AddCreditCardPayment(this.GetRefundAmount());break;default:this.refundView.Show(this.GetRefundAmount())}},RefundDejavooCreditCardPayment:function(t){var i=this;if(r.DejavooEnabled){i.ShowDejavooProgress(!0);var o=r.Preference.DejavooConnectionProtocol+"://";o+=r.Preference.DejavooConnectionTerminal+":",o+=r.Preference.DejavooConnectionCGIPort+"/cgi.html?TerminalTransaction=",o+="<request>",o+="<PaymentType>Credit</PaymentType>",o+="<TransType>Return</TransType>",o+="<Amount>"+parseFloat(t).toFixed(2)+"</Amount>",o+="<Tip>0</Tip>",o+="<Frequency>"+r.Preference.DejavooTransactionFrequency+"</Frequency>",o+="<InvNum></InvNum>",o+="<RefId>"+this.GenerateForceAuthorizationCode()+"</RefId>",o+="<RegisterId>"+r.Preference.DejavooTransactionRegisterID+"</RegisterId>",o+="<AuthKey>"+r.Preference.DejavooConnectionAuthKey+"</AuthKey>",o+="<PrintReceipt>"+(0==r.Preference.DejavooTransactionPrintReceipt?"No":"Both")+"</PrintReceipt>",o+="<SigCapture>"+(0==r.Preference.DejavooTransactionSignature?"No":"Yes")+"</SigCapture>",o+="</request>";var n=new P;n.url=o,n.fetch({error:function(o,n,a){var r=e.parseXML(n.responseText.replace(/[\n\r]/g,"")),a=e(r);"0"==a.find("ResultCode").text()?(i.refundView.AddCashPayment(t),i.ShowDejavooProgress(!1)):(e("#main-transaction-blockoverlay").hide(),i.ShowDejavooProgress(!1),navigator.notification.alert(a.find("Message").text(),null,"Error","OK"))}})}},GenerateForceAuthorizationCode:function(){var e=r.DejavooEnabled?"DJV":"FP",t=new Date,i=t.getFullYear().toString(),o=("0"+(t.getMonth()+1)).slice(-2),n=("0"+t.getDate()).slice(-2),a=("0"+t.getHours()).slice(-2),s=("0"+t.getMinutes()).slice(-2),c=("0"+t.getSeconds()).slice(-2),l=e.concat(i,o.toString(),n.toString(),a.toString(),s.toString(),c.toString());return l},AddRefundCompleted:function(e){this.CreateRefundWithValidation("Completed")},ConvertInvoice:function(){var e=new L,t=this.cartCollection.at(0).get("CouponCode");e.add(this.cartCollection.models);var i="";if(this.serializeLotCollection){this.serializeLotCollection.comparator=function(e){return e.get("ItemCode")},this.serializeLotCollection.sort({silent:!0});var o=this,n=[];this.cartCollection.each(function(e){o.serializeLotCollection.each(function(t){e.get("Good")>0&&t.get("ItemCode")===e.get("ItemCode")&&t.get("LineNum")===e.get("LineNum")&&t.get("IsIncluded")&&n.push(t);
})});var a=new P;a.reset(n),i=a.toJSON()}e.each(function(e){e.get("IsNewLine")&&e.set({OriginalQuantityAllocated:0,Outstanding:0,QuantityOrdered:0,QuantityShipped:0})}),this.InitializeTransaction();var s=new Date;s=this.JsonToAspDate(s),this.transactionModel.set({InvoiceDetails:e,Customer:r.CurrentCustomer,InvoiceCode:r.TransactionCode,CouponCode:t,WorkstationID:r.POSWorkstationID,IsOverrideSalesRep:!1,WarehouseCode:r.LocationCode,PublicNotes:r.PublicNote.PublicNotes,SerialLotNumbers:i,ShippingDate:r.TransactionObject.ShippingDate,IsTaxByLocation:r.Preference.TaxByLocation});var o=this;if(!u.IsNullOrWhiteSpace(this.customerPOModel)){var d=this.customerPOModel.get("POCode"),h=this.customerPOModel.get("SourceCode"),s=this.customerPOModel.get("ShippingDate");this.transactionModel.set({POCode:d,SourceCode:h,ShippingDate:s})}this.transactionModel.url=r.ServiceUrl+c.SOP+l.CONVERTINVOICETOCREDITMEMO;try{this.LockTransactionScreen(!0,"Saving..."),this.ResetCustomerPODetails();var p="Error saving the CreditMemo. The following items do not have the same number of serial numbers with the shipped quantity.",C=this.ValidateSerialLot(a,this.cartCollection,p);if(void 0!==C&&""!==C)throw C;return this.transactionModel.save(null,{connectionID:this.signalRConnectionID}),!0}catch(m){this.LockTransactionScreen(!1),navigator.notification.alert(m,null,"Action not Allowed","OK")}},GetPaymentAccountInfo:function(){return r.Preference.IsDepositPayment?"Deposit":"Undeposited"},GetRefundAmount:function(){if(r.TransactionType===s.TransactionType.Return){var e=this.summaryModel.Balance();return e}var t=this.cartCollection.total()+this.cartCollection.totalTax(),i=0,o=format("0.0000",t),n=1*this.RoundNumber(o,2),a=0,c=this.paymentCollection.find(function(e){return"Term Discount"==e.get("PaymentType")});c&&(a=c.get("AmountPaid")||0),i=a&&a>0?this.paymentCollection.total()-a:this.paymentCollection.total();var l=format("0.0000",i),u=1*this.RoundNumber(l,2),d=i;n==u?d=u:n<u&&(d=n),t=d;var o=format("0.0000",t);return 1*this.RoundNumber(o,2)},ComputeTempRefundAmount:function(e){var t=format("0.0000",e);t=1*this.RoundNumber(t,3);var i=format("0.0000",t);return i=1*this.RoundNumber(i,2)},GetNewPayments:function(){return this.paymentCollection&&this.paymentCollection.length>0?this.paymentCollection.GetNewPayments():null},ValidateTransaction:function(){if(0===this.cartCollection.length)return navigator.notification.alert("No item(s) to checkout!",null,"Missing Items","OK"),this.RemoveScreenOverLay(),!1;if(""===r.CustomerCode)return navigator.notification.alert("Please select a Customer.",null,"Customer is Required","OK"),this.RemoveScreenOverLay(),!1;switch(r.TransactionType){case s.TransactionType.SalesRefund:var e=this.cartCollection.detect(function(e){return e.get("Good")>0});if(!e)return navigator.notification.alert("At least one item is required to return.",null,"Action Not Allowed","OK"),this.RemoveScreenOverLay(),!1;break;case s.TransactionType.Sale:if(total=this.cartCollection.total(),total<0)return navigator.notification.alert("Negative exchange is not allowed. You may need to create a separate sale or return transaction.",null,"Negative Balance","OK"),this.RemoveScreenOverLay(),!1}return!0},ValidatePayment:function(e){if(this.IsValidPaymentType(e)){if(!this.IsFullPayment())return!1}else if(!this.IsFullPayment()){var t=r.CurrentCustomer.PaymentTermCode;if(null==t||""===t.trim()){var i="Customer has no terms, transaction is not allowed without full payment.";return navigator.notification.alert(i,null,"Payment Required","OK"),!1}if(r.TransactionType==s.TransactionType.Order||r.TransactionType==s.TransactionType.UpdateOrder||r.TransactionType==s.TransactionType.ConvertQuote||r.TransactionType==s.TransactionType.Suspend)return!0;if("COD"===t){var i="Customer's terms is 'COD', transaction is not allowed without full payment.";return navigator.notification.alert(i,null,"Payment Required","OK"),this.LockTransactionScreen(!1),!1}}return!0},IsValidPaymentType:function(e){return e===s.PaymentType.Cash||e===s.PaymentType.Check||e===s.PaymentType.CreditCard||e===s.PaymentType.Gift||e===s.PaymentType.Loyalty},RemoveWarehouseCodeByItemType:function(e){},JsonToAspDate:function(e){var t=Date.parse(e),i=new Date(t),o=i.getMonth(),n=i.getDate(),a=i.getFullYear();return i=Date.UTC(a,o,n),i="/Date("+i+")/"},ModifyCardPayments:function(){var e="",t="";switch(r.TransactionType){case s.TransactionType.Sale:e="Authorize",t=u.GetSaleCreditCardTransactionType();break;case s.TransactionType.Order:e=1==r.AllowSaleCreditPreference?"Sale":"Auth/Capture",t="Authorize";break;default:return void console.log("no payment modified!")}this.paymentCollection&&this.paymentCollection.length>0&&this.paymentCollection.each(function(i){if(i.get("PaymentType")==s.PaymentType.CreditCard&&(i.get("CardTransactionType")==e||"Force"==i.get("CardTransactionType"))){if(i.get("CreditCardIsAuthorizedVerbally"))switch(r.TransactionType){case s.TransactionType.Sale:t="Force";break;case s.TransactionType.Order:t="Authorize"}i.set({CardTransactionType:t})}})},CreateInvoice:function(e){this.InitializeTransaction();var t=new k,i=new L,n=new M,a=new W,d=(new J,""),h=!1,p=this;if(this.serializeLotCollection){var C=[];this.cartCollection.each(function(e){var t=p.serializeLotCollection.filter(function(t){return t.get("ItemCode")===e.get("ItemCode")&&t.get("LineNum")===e.get("LineNum")&&t.get("UnitMeasureCode")===e.get("UnitMeasureCode")});u.IsNullOrWhiteSpace(t)||C.push(t)}),d=C.length>0?o.flatten(C):this.serializeLotCollection.toJSON()}this.couponModel&&a.add(this.couponModel);var p=this;r.SVG_Hold=new Array,r.SVG_ReadyToSave=!1;var m=function(){!this.IsHoldSVG()&&r.SVG_ReadyToSave&&this.transactionModel.save(null,{connectionID:this.signalRConnectionID})}.bind(this);i.add(this.cartCollection.models),r.OnRechargeProcess&&i.models[0].set({SalesPriceRate:r.GCardAttributes.SalesPriceRate});var T=new f,g=new Date;if(g=this.JsonToAspDate(g),kitItems=new P,this.cartCollection.each(function(e){var t=JSON.parse(window.sessionStorage.getItem("kitItems-"+e.get("LineNum")));t&&kitItems.add(t)}.bind(this)),r.OnRechargeProcess&&(h=!0),T.set({BillToCode:r.CustomerCode,POSWorkstationID:r.POSWorkstationID,POSClerkID:r.Username,IsFreightOverwrite:!0,IsOverrideSalesRep:r.Preference.IsOverrideSalesRep,SignatureSVG:this.ValidateSVG(r.Signature,m),IsPosted:e,IsTaxByLocation:r.Preference.TaxByLocation,WarehouseCode:r.Preference.DefaultLocation,ShippingDate:g,IsRecharged:h,PublicNotes:r.PublicNote.PublicNotes,WebSiteCode:r.Preference.WebSiteCode,IsUsePOSShippingMethod:r.Preference.IsUsePOSShippingMethod,POSShippingMethod:r.Preference.POSShippingMethod}),u.IsNullOrWhiteSpace(this.customerPOModel)||T.set(p.customerPOModel.attributes),t.add(T),this.AssignTransactionShipTo(t.at(0)),this.SetCouponToTransactionHeader(t.at(0),!0),this.paymentCollection&&(this.ModifyCardPayments(),this.paymentCollection.length>0)){n.add(this.paymentCollection.models),n.at(0).set({POSWorkstationID:r.POSWorkstationID,IsOverrideSalesRep:r.Preference.IsOverrideSalesRep,POSClerkID:r.Username,Mode:"Payment"});for(var y=0;y<n.length;y++)if(n.at(y).get("SignatureSVG")){var S=n.at(y).get("SignatureSVG");n.at(y).set({SignatureSVG:this.ValidateSVG(S,m)})}}this.transactionModel.set({Invoices:t.toJSON(),InvoiceDetails:i.toJSON(),Payments:n.toJSON(),Coupons:a.toJSON(),SerialLotNumbers:d,KitDetails:kitItems.toJSON(),SalesRep:null==r.SalesRepList?null:r.SalesRepList}),this.RemoveWarehouseCodeByItemType(this.transactionModel.get("InvoiceDetails"));var I="false";this.transactionModel.url=r.ServiceUrl+c.SOP+l.CREATEINVOICE+I+"/"+r.GUID;try{this.LockTransactionScreen(!0,"Saving..."),r.SVG_ReadyToSave=!0,this.ResetCustomerPODetails();var v="Error saving the Invoice. The following items do not have the same number of serial numbers with the shipped quantity.",w=this.ValidateSerialLot(this.serializeLotCollection,this.cartCollection,v);if(void 0!==w&&""!==w)throw w;m();this.cartCollection.filter(function(e){return e.get("ItemType")===s.ItemType.GiftCard||e.get("ItemType")===s.ItemType.GiftCertificate})}catch(O){this.LockTransactionScreen(!1),navigator.notification.alert(O,null,"Action not allowed","OK")}},CreateOrder:function(){this.InitializeTransaction();var e=new A,t=new N,i=new M,o=new W;new J;this.couponModel&&o.add(this.couponModel);var n=this;r.SVG_Hold=new Array,r.SVG_ReadyToSave=!1;var a=function(){!this.IsHoldSVG()&&r.SVG_ReadyToSave&&this.transactionModel.save(null,{connectionID:this.signalRConnectionID})}.bind(this),s=new P;this.cartCollection.each(function(e){var t=JSON.parse(window.sessionStorage.getItem("kitItems-"+e.get("LineNum")));t&&s.add(t)}.bind(this)),t.add(this.cartCollection.models);var d=new f,h=new Date;if(h=this.JsonToAspDate(h),d.set({BillToCode:r.CustomerCode,POSWorkstationID:r.POSWorkstationID,POSClerkID:r.Username,IsFreightOverwrite:!0,IsOverrideSalesRep:r.Preference.IsOverrideSalesRep,SignatureSVG:this.ValidateSVG(r.Signature,a),IsTaxByLocation:r.Preference.TaxByLocation,WarehouseCode:r.Preference.DefaultLocation,PublicNotes:r.PublicNote.PublicNotes,ShippingDate:h,WebSiteCode:r.Preference.WebSiteCode,IsUsePOSShippingMethod:r.Preference.IsUsePOSShippingMethod,POSShippingMethod:r.Preference.POSShippingMethod}),u.IsNullOrWhiteSpace(this.customerPOModel)||d.set(n.customerPOModel.attributes),e.add(d),this.AssignTransactionShipTo(e.at(0)),this.SetCouponToTransactionHeader(e.at(0),!1),this.paymentCollection){this.ModifyCardPayments(),this.paymentCollection.length>0&&i.add(this.paymentCollection.models);for(var p=0;p<i.length;p++)if(i.at(p).get("SignatureSVG")){var C=i.at(p).get("SignatureSVG");i.at(p).set({SignatureSVG:this.ValidateSVG(C,a)})}}this.transactionModel.set({SalesOrders:e.toJSON(),SalesOrderDetails:t.toJSON(),Payments:i.toJSON(),Coupons:o.toJSON(),KitDetails:s.toJSON(),SalesRep:null==r.SalesRepList?null:r.SalesRepList}),this.RemoveWarehouseCodeByItemType(this.transactionModel.get("SalesOrderDetails"));var m="false";this.transactionModel.url=r.ServiceUrl+c.SOP+l.CREATESALESORDER+m+"/"+r.GUID,this.LockTransactionScreen(!0,"Saving..."),r.SVG_ReadyToSave=!0,this.ResetCustomerPODetails(),a()},CreateQuote:function(){this.InitializeTransaction();var e=new A,t=new N,i=new P;new J;this.cartCollection.each(function(e){var t=JSON.parse(window.sessionStorage.getItem("kitItems-"+e.get("LineNum")));t&&i.add(t)}.bind(this)),this.RemoveCouponInfoFromSOPDetail(),t.add(this.cartCollection.models);var o=this,n=new f,a=new Date;a=this.JsonToAspDate(a),n.set({BillToCode:r.CustomerCode,POSWorkstationID:r.POSWorkstationID,POSClerkID:r.Username,IsFreightOverwrite:!0,IsOverrideSalesRep:r.Preference.IsOverrideSalesRep,IsTaxByLocation:r.Preference.TaxByLocation,WarehouseCode:r.Preference.DefaultLocation,PublicNotes:r.PublicNote.PublicNotes,ShippingDate:a,WebSiteCode:r.Preference.WebSiteCode,IsUsePOSShippingMethod:r.Preference.IsUsePOSShippingMethod,POSShippingMethod:r.Preference.POSShippingMethod}),u.IsNullOrWhiteSpace(this.customerPOModel)||n.set(o.customerPOModel.attributes),e.add(n),this.AssignTransactionShipTo(e.at(0)),this.transactionModel.set({SalesOrders:e.toJSON(),SalesOrderDetails:t.toJSON(),KitDetails:i.toJSON(),SalesRep:null==r.SalesRepList?null:r.SalesRepList}),this.RemoveWarehouseCodeByItemType(this.transactionModel.get("SalesOrderDetails")),this.transactionModel.url=r.ServiceUrl+c.SOP+l.CREATEQUOTE+"/"+r.GUID,this.LockTransactionScreen(!0,"Saving..."),this.transactionModel.save(null,{connectionID:this.signalRConnectionID}),this.ResetCustomerPODetails()},UpdateQuote:function(e){this.InitializeTransaction();var t=new A,i=new N,o=new P;this.cartCollection.each(function(e){var t=JSON.parse(window.sessionStorage.getItem("kitItems-"+e.get("LineNum")));t&&o.add(t)}.bind(this));var n=this;t.add(r.TransactionObject),t.at(0).set({POSWorkstationID:r.POSWorkstationID,POSClerkID:r.Username,IsFreightOverwrite:!0,IsOverrideSalesRep:!1,IsTaxByLocation:r.Preference.TaxByLocation,PublicNotes:r.PublicNote.PublicNotes,WebSiteCode:r.Preference.WebSiteCode,IsUsePOSShippingMethod:r.Preference.IsUsePOSShippingMethod,POSShippingMethod:r.Preference.POSShippingMethod}),u.IsNullOrWhiteSpace(this.customerPOModel)||t.at(0).set(n.customerPOModel.attributes),this.AssignTransactionShipTo(t.at(0)),i.add(this.cartCollection.models),this.transactionModel.set({SalesOrders:t.toJSON(),SalesOrderDetails:i.toJSON(),KitDetails:o.toJSON()}),this.RemoveWarehouseCodeByItemType(this.transactionModel.get("SalesOrderDetails")),this.transactionModel.url=r.ServiceUrl+c.SOP+l.UPDATEQUOTE+r.GUID,this.LockTransactionScreen(!0,"Saving..."),this.transactionModel.save(null,{connectionID:this.signalRConnectionID}),this.ResetCustomerPODetails()},CreateInvoicePayment:function(e){var t=this.GetNewPayments();if(t&&t.length>0){var i=new M,o=this;i.add(t);var n=new C;n.on("before-save",this.OnTransactionModelBeforeSave,this),n.model=i,r.SVG_Hold=new Array,r.SVG_ReadyToSave=!1;for(var a=function(){!o.IsHoldSVG()&&r.SVG_ReadyToSave&&n.save(null,{timeout:0,success:function(e,t){o.SaveTransactionCompleted(e,t)},error:function(e,t,i){o.SaveTransactionError(e,t,i)}})},s=0;s<i.length;s++)if(i.at(s).get("SignatureSVG")){var u=i.at(s).get("SignatureSVG");i.at(s).set({SignatureSVG:this.ValidateSVG(u,a)})}this.LockTransactionScreen(!0,"Saving..."),n.url=r.ServiceUrl+c.SOP+l.CREATEINVOICEPAYMENT+e,r.SVG_ReadyToSave=!0,a()}},SetCouponToTransactionHeader:function(e,t){this.couponModel?(e.set({CouponCode:this.couponModel.get("CouponCode"),CouponComputation:this.couponModel.get("CouponComputation"),CouponDiscountAmount:this.couponModel.get("DiscountAmount"),CouponDiscountIncludesFreeShipping:this.couponModel.get("DiscountIncludesFreeShipping"),CouponDiscountPercent:this.couponModel.get("DiscountPercent"),CouponDiscountType:this.couponModel.get("DiscountType"),CouponID:this.couponModel.get("CouponID"),CouponRequiresMinimumOrderAmount:this.couponModel.get("RequiresMinimumOrderAmount"),CouponType:this.couponModel.get("CouponType"),CouponUsage:this.couponModel.get("CouponUsage")}),t||(this.couponModel.get("DiscountIncludesFreeShipping")?e.set({CouponDiscountIncludesFreeShipping:1}):e.set({CouponDiscountIncludesFreeShipping:0}))):e.set({CouponCode:null,CouponComputation:null,CouponDiscountAmount:null,CouponDiscountIncludesFreeShipping:null,CouponDiscountPercent:null,CouponDiscountType:null,CouponID:null,CouponRequiresMinimumOrderAmount:null,CouponType:null,CouponUsage:null})},RemoveFailedPayment:function(){if(r.TransactionType!=s.TransactionType.SalesRefund){var e=this.paymentCollection.length-1;this.paymentCollection.remove(this.paymentCollection.at(e))}},GetSerialErrorMessage:function(e){var t="";if("Credit Memo"===e){if(this.serializeLotCollection){this.serializeLotCollection.comparator=function(e){return e.get("ItemCode")},this.serializeLotCollection.sort({silent:!0});var i=this,o=[];this.cartCollection.each(function(e){i.serializeLotCollection.each(function(t){e.get("Good")>0&&t.get("ItemCode")===e.get("ItemCode")&&t.get("LineNum")===e.get("LineNum")&&t.get("IsIncluded")&&o.push(t)})});var n=new P;n.reset(o),t=n}}else t=this.serializeLotCollection;var a="Error saving the "+e+". The following items do not have the same number of serial numbers with the shipped quantity.";return errMsg=this.ValidateSerialLot(t,this.cartCollection,a)},AllowToCompleteTransaction:function(){var e=null;switch(r.TransactionType){case s.TransactionType.Sale:case s.TransactionType.UpdateInvoice:case s.TransactionType.ConvertOrder:case s.TransactionType.ResumeSale:e=this.GetSerialErrorMessage("Invoice");break;case s.TransactionType.Return:case s.TransactionType.SalesRefund:e=this.GetSerialErrorMessage("Credit Memo");break;default:return!0}return!e||(u.ShowNotification(e,!0,5e3),!1)},AllowToOpenCashDrawer:function(e){if(void 0!=e){r.HasInvalidPayment=!!r.InvalidPaymentModel;var t=e.filter(function(e){return e.get("PaymentType")!==s.PaymentType.CreditCard&&e.get("PaymentType")!==s.PaymentType.Gift&&e.get("PaymentType")!==s.PaymentType.Loyalty}),i=e.filter(function(e){return e.get("PaymentType")==s.PaymentType.CreditCard||e.get("PaymentType")==s.PaymentType.Gift||e.get("PaymentType")==s.PaymentType.Loyalty});if(r.HasInvalidPayment)this.ValidateAllowOpenCashDrawer(i,t,e);else switch(r.TransactionType){case s.TransactionType.SalesPayment:case s.TransactionType.UpdateInvoice:case s.TransactionType.UpdateOrder:case s.TransactionType.ConvertOrder:case s.TransactionType.Resume:var o=e.filter(function(e){return(e.get("PaymentType")==s.PaymentType.CreditCard||e.get("PaymentType")==s.PaymentType.Gift||e.get("PaymentType")==s.PaymentType.Loyalty)&&1==e.get("IsNew")}),n=e.filter(function(e){return e.get("PaymentType")!==s.PaymentType.CreditCard&&e.get("PaymentType")!==s.PaymentType.Gift&&e.get("PaymentType")!==s.PaymentType.Loyalty&&1==e.get("IsNew")});this.ValidateAllowOpenCashDrawer(o,n,e);break;default:this.ValidateAllowOpenCashDrawer(i,t,e)}}},ValidateAllowOpenCashDrawer:function(e,t,i){e.length>=0&&0===t.length?r.isOkToOpenCashDrawer=!1:0===i.length?r.isOkToOpenCashDrawer=!1:e.length>=0&&t.length>0&&(r.isOkToOpenCashDrawer=!0)},SaveTransactionCompleted:function(e,t){var i=this;r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator();var o=r.Preference.PromptToPrintReceipt;if(this.UpdateLoggedReasons(t),this.IsSavingTransactionOngoing=!1,this.IsReloadedTransaction=!1,this.LogWithTime("Transaction Saved!"),this.ToggleInprogressOverlay(),t.ErrorMessage){"This customer is over the credit limit."===t.ErrorMessage&&(r.Signature=null);var n="Unable to process the following credit card payments",a=t.ErrorMessage.indexOf(n);navigator.notification.alert(t.ErrorMessage,null,"Error Saving","OK",!0),this.LockTransactionScreen(!1),a>=0&&this.ReloadTransaction()}else if(this.CheckIfCardHasError(t)){r.Signature=null,r.RecentPaymentArray=t.Payments,r.InvalidPaymentModel=this.GetInvalidPayment(t.Payments);var c=new P(this.GetResponseCollection(t)),n=c.models[0].get("Message");navigator.notification.alert(n,null,"Error Saving","OK",!0),this.ReloadTransaction(c.models[0])}else{if(r.OnRechargeProcess)return r.OnRechargeProcess=!1,this.ClearTransaction(),void this.LoadInvoiceForResume(new f(t.Invoices[0]));if(r.TransactionType==s.TransactionType.Sale||r.TransactionType==s.TransactionType.ConvertOrder){t.Invoices[0]}if(this.UpdateDrawerBalance(),r.PaymentType="",r.SelectedPaymentType="",this.paymentCollection){var i=this;this.paymentCollection.length>0&&this.paymentCollection.each(function(e){var t=e.get("SignatureSVG");t&&i.DeleteSavedSignature(t)},this),this.paymentCollection.reset()}this.refundCollection&&this.refundCollection.reset(),r.TransactionType==s.TransactionType.Return&&this.PrintAndEmailTransaction(t.Invoices[0].InvoiceCode),o?r.PrintOptions.PrintReceipt||r.PrintOptions.EmailReceipt||r.Preference.AutoSignOutUser&&this.SignOut():!r.PrintOptions.PrintReceipt&&r.PrintOptions.EmailReceipt&&r.Preference.AutoSignOutUser&&this.SignOut()}},CheckIfCardHasError:function(e){var t=new k;return t.reset(this.GetResponseCollection(e)),0!==t.length&&!!t.models[0].get("Message")},GetResponseCollection:function(e){switch(r.TransactionType){case s.TransactionType.Sale:case s.TransactionType.SalesPayment:case s.TransactionType.UpdateInvoice:case s.TransactionType.ResumeSale:case s.TransactionType.ConvertOrder:return e.Invoices;case s.TransactionType.Order:case s.TransactionType.UpdateOrder:case s.TransactionType.ConvertQuote:return e.SalesOrders}},ReloadTransaction:function(e){var t=new f;switch(r.PreviousTransactionType=r.TransactionType,this.IsReloadedTransaction=!0,this.refundCollection&&this.IsReturn()&&this.refundCollection.reset(),r.TransactionType){case s.TransactionType.Sale:this.LoadInvoiceForResume(e);break;case s.TransactionType.UpdateInvoice:this.LoadInvoiceForResume(e);break;case s.TransactionType.ResumeSale:this.LoadInvoiceForResume(e);break;case s.TransactionType.SalesPayment:t=r.PaymentInfoMdl,this.LoadInvoiceForApplyPayment(t);break;case s.TransactionType.ConvertOrder:r.TransactionType=s.TransactionType.UpdateInvoice,this.LoadInvoiceForResume(e);break;case s.TransactionType.Order:this.LoadOrderForUpdateOrder(e);break;case s.TransactionType.UpdateOrder:this.LoadOrderForUpdateOrder(e);break;case s.TransactionType.ConvertQuote:this.LoadOrderForUpdateOrder(e);break;default:console.log(r.TransactionType+" no handler for creditcard payment error.")}},GetInvalidPayment:function(e){var t=0,i=0;if(u.IsNullOrWhiteSpace(e))return null;for(var o=0;o<e.length;o++)if(e[o].ReceiptCode&&e[o].ReceiptCode.length>0&&null!==e[o].ReceiptCode&&void 0!==e[o].ReceiptCode&&e[o].ReceiptCode.length>0&&"AUTH-"===e[o].ReceiptCode.substr(0,5)){var n=parseFloat(e[o].ReceiptCode.substr(5,e[o].ReceiptCode.length));n>i&&(i=n,t=o)}return e[t]},RemoveCreditMemo:function(e){if(this.paymentCollection)for(var t=0;t<e.length;t++)e[t].PaymentType!=s.PaymentType.CreditMemo&&(e[t].AmountPaid>0&&(e[t].AmountPaid=e[t].AppliedAmountRate),this.paymentCollection.add(e[t]))},RemoveInvalidPayment:function(e,t){var i=new P,o=0,n=[];if(i.reset(e),i.each(function(e){return r.TransactionType===s.TransactionType.SalesRefund&&0==e.get("AppliedAmountRate")?(n[o]=e,void o++):void("Credit Card"==e.get("PaymentType")&&(t?1==e.get("CreditCardIsSold")||1==e.get("CreditCardIsAuthorized")&&(e.get("CreditCardIsCaptured")===!0||1==e.get("CreditCardIsForced"))||"Refund"==e.get("Mode")||(n[o]=e,o++):0==e.get("CreditCardIsAuthorized")&&(n[o]=e,o++)))}),0==n.length)return i.toJSON();for(var a=0;a<n.length;a++)i.remove(n[a]);return i.toJSON()},ResetPayment:function(){this.paymentCollection.reset()},SaveTransactionError:function(e,t,i){this.IsSavingTransactionOngoing=!1,this.ToggleInprogressOverlay(),r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error","An error was encountered while creating the transaction. Please try again later."),this.LockTransactionScreen(!1)},LockTransactionScreen:function(t,i){switch(t){case!0:e("#main-transaction-blockoverlay").is(":hidden")?e("#main-transaction-blockoverlay").show():e("#main-transaction-blockoverlay").show(),target=document.getElementById("main-transaction-page"),this.ShowActivityIndicator(target),e("<h5>"+i+"</h5>").appendTo(e("#spin"));break;default:e("#main-transaction-blockoverlay").hide(),this.HideActivityIndicator()}},AutoSignOutUser:function(){var e=r.Preference.AutoSignOutUser;e&&this.SignOut()},OpenCashDrawer:function(){printerTool&&printerTool.openCashDrawer(r.Preference.DefaultPrinter).then(function(){console.log("DrawerKick!")})},SignOut:function(){this.StopSignalR(),this.ShowActivityIndicator(),e("<h5>Logging Out...</h5>").appendTo(e("#spin"));var t=this,i=new f;i.url=r.ServiceUrl+c.POS+l.SIGNOUT,i.save(null,{wait:!0,success:function(){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator();var e=window.location.href.split("#")[0];e+="#login",window.location.href=e,t.HideActivityIndicator()},error:function(e,i,o){t.HideActivityIndicator(),e.RequestError(i,"Error Logging out.")}})},buttonCancel_Tap:function(e){e.preventDefault(),u.FocusToItemScan(),this.PromptVoidTransaction()},buttonReviewTransaction_Tap:function(e){e.preventDefault(),this.ShowReviewTransactionsView()},ShowReviewTransactionsView:function(e){return this.HasOpenTransaction()?(u.FocusToItemScan(),void navigator.notification.alert("Please complete or void the current transaction first.",null,"Action Not Allowed","OK")):(r.LookupMode=e?s.LookupMode.Order:s.LookupMode.Invoice,void(this.reviewTransactionsView?(this.reviewTransactionsView.pickUpStage=e?1:0,this.reviewTransactionsView.clearDateOnLoad=e,this.reviewTransactionsView.Show()):this.InitializeReviewTransaction(e)))},AddCashPayment:function(){r.IsCreateRefund=!0,r.PaymentType=s.PaymentType.Cash,this.ShowPaymentForm()},AddCheckPayment:function(){r.IsCreateRefund=!0,r.PaymentType=s.PaymentType.Check,this.ShowPaymentForm()},AddCreditCardPayment:function(){r.IsCreateRefund=!0,r.OfflineCharge=!1,r.PaymentType=s.PaymentType.CreditCard,this.ShowPaymentForm()},AddOfflinePayment:function(){r.IsCreateRefund=!0,r.OfflineCharge=!0,r.PaymentType=s.PaymentType.CreditCard,this.ShowPaymentForm()},AddOnAccount:function(){r.TransactionType===s.TransactionType.ConvertQuote&&(r.HasChanges=!0),r.IsCreateRefund=!1,r.PaymentType="Partial",this.CreateTransaction("Partial")},AddSuspend:function(){r.IsPosted=!1,r.TransactionType=s.TransactionType.Suspend,r.PaymentType="Partial",this.CreateTransaction("Partial")},AddGift:function(){r.PaymentType=s.PaymentType.Gift,this.ShowPaymentForm()},AddLoyalty:function(){r.PaymentType=s.PaymentType.Loyalty,this.ShowPaymentForm()},ShowPaymentForm:function(){if(r.TransactionType===s.TransactionType.SalesRefund||r.TransactionType===s.TransactionType.Return)return void(r.DejavooEnabled||r.OfflineCharge||r.PaymentType==s.PaymentType.Cash?this.CreateTransaction():r.PaymentType==s.PaymentType.CreditCard?this.InitializePayment():this.CreateTransaction());if(this.cartCollection.length>0)if(this.GetTransactionBalance()>0)switch(r.TransactionType){case s.TransactionType.Return:console.log("Payments are not allowed on Return transactions.");break;case s.TransactionType.SalesCredit:console.log("Payments are not allowed on Credit transactions.");break;default:this.InitializePayment()}else{if(!r.HasChanges&&r.TransactionType!=s.TransactionType.ConvertOrder&&r.TransactionType!=s.TransactionType.UpdateInvoice)return navigator.notification.alert("The transaction is fully paid and there are no changes made.",null,"No Changes","OK"),void this.RemoveScreenOverLay();Be=this,navigator.notification.confirm("The transaction is fully paid. Do you want to save it?",Je,"Save Transaction",["Yes","No"])}else console.log("There are no items in your cart."),navigator.notification.alert("There are no items in the transaction.",null,"No Items","OK")},InitializePayment:function(){if(this.paymentCollection||this.InitializePaymentCollection(),this.paymentView)this.paymentView.Show(this.GetTransactionBalance());else{var t=this;this.paymentView=new ee({el:e("#paymentContainer"),collection:this.paymentCollection,balance:this.GetTransactionBalance(),showForm:!0,GetTransactionBalance:function(){return t.GetTransactionBalance()}}),this.paymentView.on("allowUserToAttachSign",this.GetAttachedSignature,this),this.paymentView.on("cancelSignRetrieval",this.StopRetrieval,this),this.paymentView.on("deleteSavedSignature",this.DeleteSavedSignature,this),this.paymentView.on("askToEnterPIN",this.FetchGiftDetails,this),this.paymentView.on("stopAskingPIN",this.StopPINRetrieval,this),this.paymentView.on("showDejavooProgress",this.ShowDejavooProgress,this),this.paymentView.on("clearTransaction",this.ClearTransaction,this),this.paymentView.on("creditRefund",this.CreditRefund,this)}},CreditRefund:function(){this.CreateTransaction()},ShowDejavooProgress:function(e){e?this.LockTransactionScreen(e,"Please swipe your card..."):this.LockTransactionScreen(e)},GetTransactionBalance:function(){return this.summaryModel?this.summaryModel.get("TermDiscount")>0?this.summaryModel.DeductPotentialDiscountFromBalance():(r.TransactionType==s.TransactionType.SalesRefund||r.TransactionType==s.TransactionType.Return)&&r.PaymentType==s.PaymentType.CreditCard?r.DejavooEnabled?this.summaryModel.Balance():this.summaryModel.BalanceWithoutPayment():this.summaryModel.Balance():0},GetTransactionSubTotal:function(){return this.summaryModel?this.summaryModel.Subtotal():0},PaymentCollection_Add:function(e){var t=this.summaryModel.get("Payment"),i=e.get("AmountPaid"),o=e.get("PaymentType"),n=e.get("IsNew");r.TransactionType!==s.TransactionType.SalesRefund&&r.TransactionType!==s.TransactionType.Return||(i=0),t+=i,this.summaryModel.set({Payment:t}),n&&this.OnRequestCompleted("PaymentAdded"),n&&!e.get("IsReload")&&(r.HasChanges=!0,this.CreateTransaction(o))},PaymentCollection_Removed:function(e){var t=this.summaryModel.get("Payment"),i=e.previous("AmountPaid");e.previous("PaymentType");t-=i,this.summaryModel.set({Payment:t}),r.HasChanges=!0,e.get("SignatureSVG")&&this.DeleteSavedSignature(e.get("SignatureSVG")),this.OnRequestCompleted("PaymentRemoved")},IsFullPayment:function(){var e=this.GetTransactionBalance();return e<=0},SetToDefaultTransaction:function(){var e=this.preferenceCollection.at(0);switch(r.Preference.DefaultPOSTransaction=e.get("DefaultPOSTransaction"),r.Preference.DefaultPOSTransaction){case 0:this.SetTransactionType(s.TransactionType.Sale),u.ShowHideOrderNotes("view-notes",!1);break;case 1:this.SetTransactionType(s.TransactionType.Order),u.ShowHideOrderNotes("view-notes",!1);break;case 2:this.SetTransactionType(s.TransactionType.Quote),u.ShowHideOrderNotes("view-notes",!0);break;case 3:this.SetTransactionType(s.TransactionType.Return),u.ShowHideOrderNotes("view-notes",!1)}},ClearTransactionWithoutInitalization:function(){this.IsReloadedTransaction=!1,r.CurrentOrders=null,r.HasChanges=!1,r.IsPosted=!0,r.TransactionCode=null,r.AdjustedQtyItemCollection=null,this.orginalResumeInvoiceCollection=null,r.TermDiscount=0,r.InvalidPaymentModel=null,r.Summary={},r.Preference.TaxByLocation?this.LoadLocationTaxCode():window.sessionStorage.removeItem("selected_taxcode"),r.invDetailSerialCollection&&(r.invDetailSerialCollection=null),window.sessionStorage.clear(),this.UseDefaultShipTo(),r.InitialShipToCode&&r.ShipTo.ShipToCode!==r.InitialShipToCode&&(r.ShipTo.ShipToCode=r.InitialShipToCode),u.CheckSalesRep(r.Preference),this.UseDefaultCustomer(),this.cartCollection&&this.cartCollection.reset(),this.requestQueue&&(this.requestQueue.reset(),this.onQueueModel=null),this.couponView&&this.couponView.ClearCoupon(),this.couponModel&&(this.couponModel.clear(),r.Coupon=null),this.serializeLotCollection&&this.serializeLotCollection.reset(),this.transactionCollection&&this.transactionCollection.reset(),this.CheckTransactionType(),this.SetTransactionCodeDisplay(),this.SetToDefaultTransaction(),r.Signature=null,r.TransactionObject=null,r.SVGArray=new Array,r.PublicNote.PublicNotesCode="",r.PublicNote.PublicNotes="",r.PublicNote.PublicNotesDescription="",r.PublicNote.LineItemNote="",this._lastItemChecked=null,this.InitializeLoggedReasonsCollection(),this.OnRequestCompleted("ClearTransaction"),this.tempResponseStorage=null,this.orderType=null,r.CurrentShipToUpdated=!1,r.IsLoadByTransaction=!1,r.TransactionType!=s.TransactionType.SalesRefund&&(e(".summary-right").children("div:last-child").show(),r.Preference.AllowChangeTaxCode&&e(".summary-right").find("#view-tax").attr("style","color: #0B4A8D; cursor: pointer;"))},ClearTransaction:function(){r.GUID=this.createGuid(),this.IsReloadedTransaction=!1,r.CurrentOrders=null,r.HasChanges=!1,r.IsPosted=!0,r.TransactionCode=null,r.AdjustedQtyItemCollection=null,this.orginalResumeInvoiceCollection=null,r.TermDiscount=0,r.CurrentItem=null,r.ManagerValidated=!1,r.msg1="",r.msgTitle="",r.InvalidPaymentModel=null,r.Summary={},r.Summary={},r.Preference.TaxByLocation?this.LoadLocationTaxCode():window.sessionStorage.removeItem("selected_taxcode"),r.invDetailSerialCollection&&(r.invDetailSerialCollection=null),window.sessionStorage.clear(),this.UseDefaultShipTo(),r.InitialShipToCode&&r.ShipTo.ShipToCode!==r.InitialShipToCode&&(r.ShipTo.ShipToCode=r.InitialShipToCode),u.CheckSalesRep(r.Preference),this.UseDefaultCustomer(),this.cartCollection&&this.cartCollection.reset(),this.requestQueue&&(this.requestQueue.reset(),this.onQueueModel=null),this.couponView&&this.couponView.ClearCoupon(),this.couponModel&&(this.couponModel.clear(),r.Coupon=null),this.serializeLotCollection&&this.serializeLotCollection.reset(),this.transactionCollection&&this.transactionCollection.reset(),this.CheckTransactionType(),this.SetTransactionCodeDisplay(),this.SetToDefaultTransaction(),r.Signature=null,r.TransactionObject=null,r.SVGArray=new Array,r.PublicNote.PublicNotesCode="",r.PublicNote.PublicNotes="",r.PublicNote.PublicNotesDescription="",r.PublicNote.LineItemNote="",this._lastItemChecked=null,this.InitializeLoggedReasonsCollection(),this.OnRequestCompleted("ClearTransaction"),
this.tempResponseStorage=null,this.orderType=null,r.CurrentShipToUpdated=!1,r.IsLoadByTransaction=!1,r.TransactionType!=s.TransactionType.SalesRefund&&(e(".summary-right").children("div:last-child").show(),r.Preference.AllowChangeTaxCode&&e(".summary-right").find("#view-tax").attr("style","color: #0B4A8D; cursor: pointer;")),this.InitializeItems()},RetrieveShipTo:function(e,t){var i=this,o=new d;this.InitializeShipTo(),o.set({CriteriaString:t,CustomerCode:t}),o.url=r.ServiceUrl+c.CUSTOMER+l.SHIPTOLOOKUP+e,o.save(null,{success:function(e,t){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),i.shipToCollection.reset(t.ShipToCollection)},error:function(e,t,o){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),i.HideActivityIndicator(),e.RequestError(t,"Error Retrieving Ship To")}}),this.shipToCollection.each(function(e){r.ShipTo=e.toJSON()})},UseDefaultCustomer:function(){r.DefaultPrice=r.Preference.CustomerDefaultPrice;var t={CustomerName:r.Preference.CustomerName,CustomerCode:r.Preference.CustomerCode,Email:r.Preference.CustomerEmail,DefaultPrice:r.DefaultPrice,LocationCode:r.LocationCode,PaymentTermCode:r.Preference.PaymentTermCode,ShipToName:r.ShipTo.ShipToName,ShipToAddress:r.ShipTo.Address,SalesRepCode:r.SalesRepGroupCode,SalesRepName:r.SalesRepGroupName,CommissionPercent:r.CommissionPercent};this.SetCurrentCustomer(t);var i="(No Address)";r.CustomerName=r.Preference.CustomerName,r.CustomerCode=r.Preference.CustomerCode,r.CustomerEmail=r.Preference.CustomerEmail,r.DefaultContactEmail=r.Preference.DefaultContactEmail,r.POSSalesReceipt=r.Preference.POSSalesReceipt,e("#lbl-customerName").html(u.TrimCustomerName());var o=i,n=r.ShipTo.City,a=r.ShipTo.State,s=r.ShipTo.PostalCode;null==r.DefaultShipToAddress&&null==n&&null==a&&null==s||(u.IsNullOrWhiteSpace(n)&&(n=""),u.IsNullOrWhiteSpace(a)&&(a=""),u.IsNullOrWhiteSpace(s)&&(s=""),i=r.DefaultShipToAddress,u.IsNullOrWhiteSpace(i)&&(i=""),o=i+" "+n+", "+a+" "+s,i=o),r.DefaultShipTo=r.ShipToName+",",e("#label-shipto").html(u.TrimDefaultShipTo()),e("#label-shipto").append("<br/>"+u.Escapedhtml(i)),r.SalesRepList="",e("#lbl-salesrepName").html(u.TrimSalesRepName()),e("#splitrateName").html(u.TrimCommissionPercent())},UseDefaultShipTo:function(){r.ShipTo={};for(var e in r.Preference.DefaultShipTo)r.ShipTo[e]=r.Preference.DefaultShipTo[e]},VoidTransaction:function(){r.OnRechargeProcess=!1,this.ClearTransaction(),this.PerformAction()},VoidTransactionWithValidation:function(){this.HasOpenTransaction()&&(this.SetActionType(s.ActionType.VoidTransaction),this.ValidateReason()&&this.ValidateManagerOverride(s.ActionType.VoidTransaction)&&this.VoidTransaction())},PromptVoidTransaction:function(){this.HasOpenTransaction()&&(We=this,navigator.notification.confirm("Are you sure you want to cancel this transaction?",_e,"Cancel Transaction",["Yes","No"]))},ValidateReason:function(e){var t=!1;switch(e){case"Return":t=r.ReasonCode.Return;break;default:t=r.ReasonCode.Transaction,e="VoidTransaction"}return t!==!0||(this.CheckReason(e),!1)},ValidateManagerOverride:function(e,t){var i=null;return e===s.ActionType.VoidTransaction?i=r.Preference.TransactionVoidOverrideLevel:e===s.ActionType.Returns||e===s.ActionType.SalesCredit||e===s.ActionType.SalesRefund?i=r.Preference.ReturnsOverrideLevel:e===s.ActionType.AutoAllocate&&(i=r.Preference.AutoAllocateOverrideLevel),!(""!=i&&null!=i&&r.UserInfo.RoleCode!=i&&!r.ManagerValidated)||(r.OverrideMode=e,this.ShowManagerOverride(t),!1)},buttonSearchGo_Tap:function(e){e.preventDefault(),this.FindItemByUPC()},ShowActivityIndicator:function(t){t||(t=document.getElementById("main-transaction-page")),e("#spin").remove(),e("<div id='spin'></div>").appendTo(t);var i=document.getElementById("spin");_spinner=Ue,_spinner.opts.color="#fff",_spinner.opts.lines=13,_spinner.opts.length=7,_spinner.opts.width=4,_spinner.opts.radius=10,_spinner.opts.top="auto",_spinner.opts.left="auto",_spinner.spin(i)},HideActivityIndicator:function(){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),_spinner=Ue,_spinner.stop(),e("#spin").remove()},FindItemByUPC:function(){var t=e("#search-input").val();this.AddItemByUPC(t),e("#search-input").val("")},SearchOnFocus:function(t){e("#main-transaction-blockoverlay").is(":visible")?(e("#search-input").attr("readonly","readonly"),e("#search-input").val("")):e("#search-input").removeAttr("readonly")},inputSearch_KeyPress:function(e){13===e.keyCode?this.FindItemByUPC():this.ShowClearBtn(e)},ShowClearBtn:function(t){t.stopPropagation();var i=t.target.id,o=e("#"+i).val(),n=o.length,a=e("#"+i).position(),r=e("#"+i).width();n<=0?this.HideClearBtn():null===a&&""===a||(e("#"+i+"ClearBtn").css({top:a.top+7,left:a.left+(r-9)}),e("#"+i+"ClearBtn").show())},ShowLookupClearBtn:function(t){t.stopPropagation();var i=t.target.id,o=e("#"+i).val(),n=o.length,a=e("#"+i).position(),r=e("#"+i).width();n<=0?this.HideClearBtn():null===a&&""===a||(e("#"+i+"ClearBtn").css({top:a.top+9,left:a.left+(r-23)}),e("#"+i+"ClearBtn").show())},HideClearBtn:function(){e(".clearTextBtn").fadeOut()},ClearText:function(t){var i=t.target.id,o=i.substring(0,i.indexOf("ClearBtn"));e("#"+o).val(""),this.HideClearBtn(),u.FocusToItemScan()},ApplyDiscountToAll:function(e,t){if(this.CheckMaxDiscount(e))for(var i=0;i<this.cartCollection.length;i++)i==this.cartCollection.length-1?(this.cartCollection.at(i).set({LogCurrentTransaction:!0},{silent:!0}),this.holdRecomputeCoupon=!1):this.cartCollection.at(i).set({LogCurrentTransaction:!1},{silent:!0}),this.UpdateDiscount(this.cartCollection.at(i),e);else navigator.notification.alert("Discount must not exceed max discount of "+r.Preference.MaxSaleDiscount+"%",null,"Action Not Allowed","OK")},UpdateDiscount:function(e,t){e.updateDiscount(t)},CheckMaxDiscount:function(e){var t=e*this.cartCollection.length,i=r.Preference.MaxSaleDiscount;return i>t},LoadInvoiceForResume:function(e){r.IsPosted=!0,r.LookupMode=s.LookupMode.UpdateInvoice,this.ValidateInvoiceLookup(e)&&(this.reviewTransactionsView&&this.reviewTransactionsView.Close(),this.LoadInvoice(e.get("InvoiceCode"),!0))},LoadInvoiceForApplyPayment:function(e){r.PaymentInfoMdl=e,r.LookupMode=s.LookupMode.SalesPayment,this.ValidateInvoiceLookup(e)&&(this.reviewTransactionsView&&this.reviewTransactionsView.Close(),this.LoadInvoice(e.get("InvoiceCode")))},LoadInvoiceForReturnRefund:function(e){r.RefundModel=e,r.LookupMode=s.LookupMode.SalesRefund,this.ValidateInvoiceLookup(e)&&(this.reviewTransactionsView&&this.reviewTransactionsView.Close(),this.LoadInvoice(e.get("InvoiceCode")))},ValidateInvoiceLookup:function(e){if(this.ValidateLocationBankAccount()){if(0!=e.get("FreightRate"))return this.reviewTransactionsView&&this.reviewTransactionsView.optionsView.Hide(),navigator.notification.alert(e.get("InvoiceCode")+" includes freight tax that ConnectedSale will not be able to handle. Try to open it in Connected Business.",null,"Not Supported","OK"),r.LookupMode===s.LookupMode.UpdateInvoice?r.LookupMode=s.LookupMode.Suspend:r.LookupMode=s.LookupMode.Invoice,!1;switch(r.LookupMode){case s.LookupMode.SalesPayment:if(e.get("BalanceRate")<=0)return r.LookupMode=s.LookupMode.Invoice,navigator.notification.alert("Invoice "+e.get("InvoiceCode")+" is already fully paid.",null,"Cannot Apply Payment","OK"),!1;break;case s.LookupMode.SalesRefund:if(!e.get("IsPosted"))return navigator.notification.alert("Invoice "+e.get("InvoiceCode")+" is not yet posted.",null,"Cannot Refund Sale","OK"),!1;break;case s.LookupMode.SalesCredit:if(!e.get("IsPosted"))return navigator.notification.alert("Invoice "+e.get("InvoiceCode")+" is not yet posted.",null,"Cannot Credit Sale","OK"),!1}return!0}},LoadInvoice:function(e,t){var i=this;return r.TransactionType!=s.TransactionType.Suspend||i.IsReloadedTransaction?(i.IsReloadedTransaction=!1,void i.DoLoadInvoice(e,t)):void i.ValidateTransactionLocation(e,!1,function(o){i.IsReloadedTransaction=!1,i.DoLoadInvoice(e,t,o)})},DoLoadInvoice:function(e,t,i){if(!r.ValidLocation&&r.LookupMode!=s.LookupMode.SalesPayment)return void this.NotifyMsg("The Current Status of the Default Location is Inactive.","Unable to load items");this.invoiceTransactionModel||(this.invoiceTransactionModel=new f);var o=this;this.LockTransactionScreen(!0,"Loading..."),this.invoiceTransactionModel.set({TransactionCode:e,IsRecalculate:r.LookupMode!=s.LookupMode.SalesPayment&&r.LookupMode!=s.LookupMode.SalesRefund,IsTaxByLocation:r.Preference.TaxByLocation,TransactionType:r.LookupMode,WebsiteCode:u.GetWebsiteCode(),WarehouseToUse:i?r.Preference.DefaultLocation:""}),this.invoiceTransactionModel.url=r.ServiceUrl+c.SOP+l.LOADINVOICE,this.invoiceTransactionModel.save(null,{success:function(e,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),o.LoadCouponDetailsFromSalesInvoice(e,i,t)},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Loading Invoice"),o.LockTransactionScreen(!1)}})},LoadCouponDetailsFromSalesInvoice:function(e,t,i){if(t.ErrorMessage)return this.NotifyMsg(t.ErrorMessage,"Problem Loading Invoice"),this.ClearTransaction(),void this.LockTransactionScreen(!1);var o=t.Invoices[0].CouponID,n=this,a=o,s=new d;return a?(s.set({CustomerCode:r.CustomerCode,CriteriaString:a}),s.url=r.ServiceUrl+c.SOP+l.LOADCOUPONBYCOUPONID,void s.save(null,{success:function(o,a){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator();var s;a.Coupons&&1==a.Coupons.length&&(s=a.Coupons[0]),n.LoadInvoiceCompleted(e,t,s,i)},error:function(o,a,r){o.RequestError(a,"Error Retrieving Coupon Details"),n.LoadInvoiceCompleted(e,t,null,i)}})):void this.LoadInvoiceCompleted(e,t,null,i)},InitializeLoadedItemCollection:function(){r.LoadedItems||(r.LoadedItems=new P),r.LoadedItems.reset()},InitializeOriginalInvoiceDetailsForResume:function(e){this.orginalResumeInvoiceCollection=new P,this.orginalResumeInvoiceCollection.reset(e.InvoiceDetails)},LoadInvoiceCompleted:function(t,i,n,a){if(this.InitializeLoadedItemCollection(),u.IsNullOrWhiteSpace(a)||this.InitializeOriginalInvoiceDetailsForResume(i),i&&i.Invoices&&i.Invoices.length>0){var c=!1;switch(r.LookupMode){case s.LookupMode.SalesPayment:this.SetTransactionType(s.TransactionType.SalesPayment);break;case s.LookupMode.SalesRefund:this.SetTransactionType(s.TransactionType.SalesRefund);break;case s.LookupMode.SalesCredit:this.SetTransactionType(s.TransactionType.SalesCredit);break;case s.LookupMode.UpdateInvoice:c=!0,this.HasGCToRecharge(i.SerialLotNumbers)?this.SetTransactionType(s.TransactionType.Recharge):this.SetTransactionType(s.TransactionType.UpdateInvoice);break;case s.LookupMode.VoidTransaction:this.SetTransactionType(s.TransactionType.VoidTransaction)}this.IsReturn()&&this.InitializeItems();var l=i.Invoices[0],d=i.InvoiceDetails,h=i.InvoiceDetails,p=[],C=0,m=!1,T=this;if(r.TransactionCode=l.InvoiceCode,r.TransactionObject=l,r.OnRechargeProcess=!1,r.TransactionDocumentDate=l.InvoiceDate,this.SetTransactionCodeDisplay(r.TransactionCode),i.Customers&&i.Customers.length>0){var g=i.Customers[0],y=r.DefaultPrice!=g.DefaultPrice;r.CustomerCode=g.CustomerCode,r.DefaultPrice=g.DefaultPrice,r.DefaultContactEmail=g.DefaultContactEmail,y&&this.InitializeItems(),r.CustomerName=g.CustomerName,r.POSSalesReceipt=g.POSSalesReceipt,e("#lbl-customerName").html(u.TrimCustomerName()),r.IsLoadByTransaction=!0,r.Transaction=l,this.SetCurrentCustomer(g),this.AssignCustomerShipToFromLoadedTransaction(l)}if(l.PublicNotes&&(r.PublicNote.PublicNotes=l.PublicNotes),this.AddUnitMeasureCodeToSerial(i.InvoiceDetails,i.SerialLotNumbers,!0),i.InvoiceDetails&&i.InvoiceDetails.length>0){if(i.KitDetails&&o.each(d,function(e){var t=o.where(i.KitDetails,{LineNum:e.LineNum});window.sessionStorage.setItem("kitItems-"+e.LineNum,JSON.stringify(t))}),r.LookupMode!==s.TransactionType.SalesCredit&&r.LookupMode!==s.TransactionType.SalesRefund||(l.SubTotalRate=0,l.TaxRate=0,d=o.filter(d,function(e){return e.QuantityOrdered>0}),h=o.filter(h,function(e){return e.Outstanding>0}),o.each(h,function(e,t){var n=0,a=0;if(i.SerialLotNumbers){var c=i.SerialLotNumbers[t];if(e.ItemType===s.ItemType.GiftCard||e.ItemType===s.ItemType.GiftCertificate){m=!0;var l=o.filter(i.SerialLotNumbers,function(t){return t.ItemCode===e.ItemCode&&t.LineNum===e.LineNum}),u=o.filter(i.SerialLotNumbers,function(t){return t.ItemCode===e.ItemCode&&t.LineNum===e.LineNum&&(t.IsActivated===!0||t.IsReturned===!0||t.IsRecharged)}),d=o.filter(i.SerialLotNumbers,function(t){return t.ItemCode===e.ItemCode&&t.LineNum===e.LineNum&&(t.IsActivated===!0||t.IsRecharged)});if(n=u.length,a=d.length,0!=u.length){if(u.length===l.length)p.push(e);else{var g=i.SerialLotNumbers;o.each(u,function(e,t){o.each(g,function(t,o){e.SerialLotNumber===t.SerialLotNumber&&i.SerialLotNumbers.splice(o,1)})})}h.length-p.length===0&&C++}}}r.LoadedItems.add(e),e.Good=0,e.ExtPriceRate=0,e.SalesTaxAmount=0,e.SalesTaxAmountRate=0,e.ExtPriceRate=T.CalculateExtPrice(e.Good,e.SalesPriceRate,e.Discount,e.CouponDiscountType,e.CouponDiscount,e.CouponComputation,e.LineNum),r.LoadedItems.each(function(t){t.get("AlteredCoupon")&&t.get("LineNum")==e.LineNum&&(e.CouponDiscount=t.get("AlteredCouponDiscount"),e.CouponDiscountRate=t.get("AlteredCouponDiscount"),e.CouponDiscountAmount=t.get("AlteredCouponDiscount"))}),c&&e.ItemCode===c.ItemCode&&e.LineNum===c.LineNum&&(c.SerialLotType=e.SerializeLot)})),m&&C>0)return this.LockTransactionScreen(!1),this.VoidTransaction(),void navigator.notification.alert("You can no longer return gift card / gift certificate item\n because it has either been activated or returned.",null,"Action not allowed","OK");p.length>0&&(h=o.difference(h,p)),d=h;var S=o.sortBy(d,function(e){return e.LineNum});r.InvoiceDetailsResponse=S;var f=!0;r.LookupMode==s.LookupMode.SalesRefund&&(f=!0),r.TransactionType!=s.TransactionType.SalesPayment&&r.TransactionType!=s.TransactionType.SalesRefund||this.cartCollection.reset(),this.LoadItemsToCart(S,f),c&&(r.IsLoadingTransaction=!0,this.ChangeItemGroupTax(this.cartCollection))}if(n&&(this.LoadCouponFromTransationHeader(l),this.couponModel&&n&&this.couponModel.set({IncludeAllCustomer:n.IncludeAllCustomer,IncludeAllProduct:n.IncludeAllProduct})),this.paymentCollection||this.InitializePaymentCollection(),this.paymentCollection.reset(),i.Payments&&i.Payments.length>0){var I=this.RemoveInvalidPayment(i.Payments,!0);I.length>0&&(r.TransactionType===s.TransactionType.SalesRefund?this.RemoveCreditMemo(I):this.paymentCollection.add(I))}if(r.TransactionType==s.TransactionType.SalesPayment&&(u.IsNullOrWhiteSpace(this.previousCreditCardReceiptCodes)&&(this.previousCreditCardReceiptCodes=new P,this.previousCreditCardReceiptCodes.reset(i.Payments),this.paymentCollection.each(function(e){e.set({IsPrevCCPayment:!0})})),this.LoadCreditCardReceiptCodes(i)),r.TransactionObject.DiscountRate>0&&this.AddTermDiscountToPayment(r.TransactionObject.DiscountRate),this.paymentCollection.length>0&&this.paymentCollection.each(function(e){var t=e.get("CreditCardNumber");null!=t&&e.set({EncryptedCreditCardNumber:t})}),r.TransactionType==s.TransactionType.SalesRefund&&this.cartView&&this.cartView.summaryModel){var v=this.GetNonNegativePaymentTotal();this.cartView.summaryModel.set({Payment:v})}if(this.InitializePreviousTransactionDetails(i,"Invoice"),null!=i.SalesRep){var w="",O="",R=o.pluck(i.SalesRep,"CommissionPercent"),D=o.pluck(i.SalesRep,"SalesRepGroupName");R.length>1?o.each(R,function(e,t){w+=t>=R.length-1?e+"%":e+"%, ",t++}):w=R,o.each(D,function(e,t){O+=t>=D.length-1?e:e+", ",t++}),r.SalesRepGroupName=O,r.CommissionPercent=w,r.SalesRepList=i.SalesRep,e("#lbl-salesrepName").html(u.TrimSalesRepName()),e("#splitrateName").html(u.TrimCommissionPercent())}r.TransactionType==s.TransactionType.Recharge?(r.Summary&&(r.Summary={SubTotal:this.cartCollection.total()}),e("#complete-btn").trigger("tap"),this.HideActivityIndicator()):this.LockTransactionScreen(!1),this.OnRequestCompleted("LoadInvoiceCompleted")}},AddUnitMeasureCodeToSerial:function(e,t,i){t&&(this.serializeLotCollection||this.InitializeSerializeLotCollection(),o.each(t,function(i,n){var a=o.find(e,function(e){return e instanceof f?e.get("ItemCode")===i.ItemCode&&e.get("LineNum")===i.LineNum:e.ItemCode===i.ItemCode&&e.LineNum===i.LineNum});a&&(t[n].UnitMeasureCode=a instanceof f?a.get("UnitMeasureCode"):a.UnitMeasureCode)}),i&&(r.invDetailSerialCollection||(r.invDetailSerialCollection=new q),r.invDetailSerialCollection.reset(t)),this.serializeLotCollection.reset(t))},SetRefundTotalAmountColor:function(){r.TransactionType==s.TransactionType.SalesRefund?e("#cartContainer .total").css("color","#CB3333"):e("#cartContainer .total").css("color","#67cb33")},LoadCreditCardReceiptCodes:function(e){if(!u.IsNullOrWhiteSpace(this.previousCreditCardReceiptCodes)&&this.previousCreditCardReceiptCodes.length>0){var t=this,i=new P;if(i.reset(e.Payments),this.previousCreditCardReceiptCodes.each(function(e){if(e.get("PaymentType")==s.PaymentType.CreditCard){var t=e.get("ReceiptCode");i.each(function(e){e.get("PaymentType")==s.PaymentType.CreditCard&&e.get("ReceiptCode")==t&&e.set({IsPrevCCPayment:!0})})}}),i.length>0){var o=0;this.creditCardReceiptCodes="",i.each(function(e){if(e.get("PaymentType")==s.PaymentType.CreditCard&&u.IsNullOrWhiteSpace(e.get("IsPrevCCPayment"))){var i=e.get("ReceiptCode");u.IsNullOrWhiteSpace(t.receiptCodes)?t.creditCardReceiptCodes=i:t.creditCardReceiptCodes+=","+i,o+=1}})}}},AddTermDiscountToPayment:function(e){if(0!=e){var t=new f,i=r.TransactionObject.InvoiceDate;r.TransactionType!=s.TransactionType.UpdateOrder&&r.TransactionType!=r.TransactionType.ConvertOrder||(i=r.TransactionObject.SalesOrderDate),t.set({AmountPaid:e,PaymentType:"Term Discount",IsNew:!1,IsReload:!0,PaymentDate:i}),this.paymentCollection.add(t),r.AllowToFetchPotentialDiscount=!1}},GetNonNegativePaymentTotal:function(){var e=0;return this.paymentCollection&&this.paymentCollection.each(function(t){var i=t.get("AmountPaid")||0;i<0&&(i=0),e+=i}),e},HasGCToRecharge:function(e){var t=!1;if(!e)return t;for(var i=0;i<e.length;i++)if(e[i].IsRecharged===!0)return!0;return t},InitializePreviousTransactionDetails:function(e,t){var i,o=t;u.IsNullOrWhiteSpace(this.previousTransactionDetals)&&(this.previousTransactionDetals=new k),"Invoice"==t?(this.previousTransactionDetals.reset(e.InvoiceDetails),i=this.previousTransactionDetals.at(0).get("InvoiceCode"),this.previousTransactionDetals.reset(),this.previousTransactionDetals.add({TransactionType:o,InvoiceCode:i,SourceCode:e.Invoices[0].SourceCode,ShippingDate:e.Invoices[0].ShippingDate,POCode:e.Invoices[0].POCode})):(this.previousTransactionDetals.reset(e.SalesOrderDetails),i=this.previousTransactionDetals.at(0).get("SalesOrderCode"),this.previousTransactionDetals.reset(),this.previousTransactionDetals.add({TransactionType:o,SalesOrderCode:i,SourceCode:e.SalesOrders[0].SourceCode,ShippingDate:e.SalesOrders[0].ShippingDate,POCode:e.SalesOrders[0].POCode}))},UpdateInvoice:function(){if(r.HasChanges||this.AllowSaveWithOutChanges()){this.InitializeTransaction(),this.paymentCollection&&this.paymentCollection.length>0&&(this.recentPaymentCollection=new P,this.recentPaymentCollection.reset(this.paymentCollection.models));var t=new A,i=new N,o=new M,n=this.GetNewPayments(),a=new W;this.couponModel&&a.add(this.couponModel);var s="";this.serializeLotCollection&&(s=this.serializeLotCollection.toJSON());var d=this,h=new Date;h=this.JsonToAspDate(h);var p=new f;p.set(r.TransactionObject),p.set({POSWorkstationID:r.POSWorkstationID,POSClerkID:r.Username,IsFreightOverwrite:!0,IsOverrideSalesRep:!1,SignatureSVG:r.Signature,IsPosted:r.IsPosted,IsTaxByLocation:r.Preference.TaxByLocation,ShippingDate:h,PublicNotes:r.PublicNote.PublicNotes,WebSiteCode:r.Preference.WebSiteCode,IsUsePOSShippingMethod:r.Preference.IsUsePOSShippingMethod,POSShippingMethod:r.Preference.POSShippingMethod}),u.IsNullOrWhiteSpace(this.customerPOModel)||p.set(d.customerPOModel.attributes),t.add(p),this.AssignTransactionShipTo(t.at(0)),this.SetCouponToTransactionHeader(t.at(0),!1),i.add(this.cartCollection.models),n&&n.length>0&&o.add(n),this.transactionModel.set({Invoices:t.toJSON(),InvoiceDetails:i.toJSON(),Payments:o.toJSON(),Coupons:a.toJSON(),SerialLotNumbers:s}),this.RemoveWarehouseCodeByItemType(this.transactionModel.get("InvoiceDetails")),this.transactionModel.url=r.ServiceUrl+c.SOP+l.UPDATEINVOICE;try{var C="Error saving the Invoice. The following items do not have the same number of serial numbers with the shipped quantity.",m=this.ValidateSerialLot(this.serializeLotCollection,this.cartCollection,C);if(void 0!==m&&""!==m)throw m;this.LockTransactionScreen(!0,"Saving..."),this.transactionModel.save(null,{connectionID:this.signalRConnectionID}),this.ResetCustomerPODetails()}catch(T){this.LockTransactionScreen(!1),navigator.notification.alert(T,null,"Action not Allowed","OK")}}else navigator.notification.alert("There are no changes to save.",null,"Cannot Save Transaction","OK"),e("#main-transaction-blockoverlay").hide()},LoadItemsToCart:function(t,i){var o=this;if(t&&t.length>0)for(index=0;index<t.length;index++){var n,a,c=t[index],l="",d=null;d=c.TaxCode,r.TransactionType===s.TransactionType.Sale||r.TransactionType===s.TransactionType.Order?a=c.CouponDiscountAmount:(a=c.CouponDiscountRate,r.TransactionType!==s.TransactionType.ConvertOrder&&r.TransactionType!==s.TransactionType.UpdateOrder&&r.TransactionType!==s.TransactionType.UpdateInvoice&&r.TransactionType!==s.TransactionType.ConvertQuote||c.CouponDiscountRate||(a=c.CouponDiscountAmount)),0!=a&&(l=c.CouponCode);var h=0,p=0;c.Good&&(p=c.Good,c.ItemType==s.ItemType.GiftCard||c.ItemType==s.ItemType.GiftCertificate?(h=o.GetNumOfActivatedGCard(c.ItemCode),p-=h):p=c.Good);var C=u.IsNullOrWhiteSpace(c.IsQtyOrderedAdjusted);n={ItemCode:c.ItemCode,ItemName:c.ItemName,ItemDescription:c.ItemDescription,LineNum:c.LineNum,QuantityOrdered:c.QuantityOrdered,QuantityShipped:c.QuantityOrdered,SalesPriceRate:c.SalesPriceRate,SalesPrice:c.SalesPrice,ExtPriceRate:c.ExtPriceRate,Discount:u.ApplyAllowedDecimalFormat(c.Discount),SalesTaxAmountRate:c.SalesTaxAmountRate,UPCCode:c.UPCCode,ItemType:c.ItemType,WarehouseCode:o.IsReturn()?r.Preference.DefaultLocation:c.WarehouseCode,CouponDiscountAmount:a,CouponDiscount:a,CouponDiscountRate:a,CouponCode:l,CouponComputation:c.CouponComputation,CouponDiscountType:c.CouponDiscountType,IsIncludedInCoupon:c.IsIncludedInCoupon,UnitMeasureCode:c.UnitMeasureCode,UnitMeasureQty:c.UnitMeasureQty,Outstanding:c.Outstanding,SourceLineNum:c.SourceLineNum,Good:p,Outstanding:c.Outstanding,WebSiteCode:c.WebsiteCode,Filename:c.Filename,SerializeLot:c.SerializeLot,IsModified:c.IsModified,IsOutOfStock:c.IsOutOfStock||!1,OriginalQuantityAllocated:c.OriginalQuantityAllocated,NumOfActivatedGCard:h,TaxCode:d,Status:c.Status,FreeStock:c.FreeStock,IsQtyOrderedAdjusted:C,AutoGenerate:c.AutoGenerate,Pricing:c.Pricing,PromoDocumentCode:c.PromoDocumentCode,RuleID:c.RuleID,PromoID:c.PromoID,IsPromoItem:c.IsPromoItem},0===this.cartCollection.length?this.cartCollection.add(n):this.cartCollection.length<index+1?this.cartCollection.add(n):this.cartCollection.at(index).set(n)}this.cartView.RefreshScroll(),this.cartCollection.each(function(t){1==t.get("IsPromoItem")&&(e("#"+t.cid+" #quantityDisplay").addClass("ui-disabled").css("opacity",1),e("#"+t.cid+" #display-itemName").addClass("ui-disabled").css("opacity",1),e("#"+t.cid+" #itemPriceDisplay").addClass("ui-disabled").css("opacity",1),e("#"+t.cid+" #discountDisplay").addClass("ui-disabled").css("opacity",1),e("#"+t.cid+" #extPriceRate-td").addClass("ui-disabled").css("opacity",1))})},GetNumOfActivatedGCard:function(e){if(r.TransactionType!=s.TransactionType.SalesRefund||!this.serializeLotCollection)return 0;if(this.serializeLotCollection.length<0)return 0;var t=this.serializeLotCollection.filter(function(t){return t.get("ItemCode")==e&&(1==t.get("IsActivated")||1==t.get("IsRecharged"))});return t.length},SetTransactionCodeDisplay:function(t){t?(t=t,e("#transaction-text").hide(),e(".label-transactioncode").html(t),e(".label-transactioncode").show(),e(".label-transactioncode").css("font-size","17px"),e(".arrow-down").css("opacity","0.3")):(e("#transaction-text").show(),e(".label-transactioncode").hide(),e(".arrow-down").css("opacity","1"))},SetTransactionTypeDisplay:function(e){var t="";switch(e){case s.TransactionType.SalesPayment:t="Payment";break;case s.TransactionType.ConvertOrder:t=s.TransactionType.Sale;break;case s.TransactionType.VoidTransaction:t="Void";break;default:t=e}this.$("#transaction-text").html(t),this.SetRefundTotalAmountColor()},ShowPaymentsSummaryForm:function(e){if(this.paymentCollection&&this.paymentCollection.length>0)switch(r.TransactionType){case s.TransactionType.Quote:return;case s.TransactionType.Return:return;case s.TransactionType.SalesCredit:return;default:this.InitializePaymentSummary()}else navigator.notification.alert("There are no payments made for the current transaction.",null,"No Payment Found","OK")},InitializePaymentSummary:function(){this.paymentsSummaryView?this.paymentsSummaryView.Show():this.paymentsSummaryView=new se({el:e("#paymentsContainer"),collection:this.paymentCollection})},ValidateOrderLookup:function(e){if(this.ValidateLocationBankAccount())return 0==e.get("FreightRate")||(this.reviewTransactionsView&&this.reviewTransactionsView.optionsView.Hide(),navigator.notification.alert(e.get("SalesOrderCode")+" includes freight tax that ConnectedSale will not be able to handle. Try to open it in Connected Business.",null,"Not Supported","OK"),r.LookupMode===s.LookupMode.ConvertQuote&&(r.LookupMode=s.LookupMode.Quote),r.LookupMode===s.LookupMode.ConvertOrder&&(r.LookupMode=s.LookupMode.Order),r.LookupMode===s.LookupMode.UpdateOrder&&(r.LookupMode=s.LookupMode.Order),!1)},LoadOrderForUpdateOrder:function(e){r.LookupMode=s.LookupMode.UpdateOrder,this.ValidateOrderLookup(e)&&(this.reviewTransactionsView&&this.reviewTransactionsView.Close(),this.orderType="Update",this.LoadOrder(e.get("SalesOrderCode")))},LoadOrderForConvertOrder:function(e){r.LookupMode=s.LookupMode.ConvertOrder,this.ValidateOrderLookup(e)&&(this.reviewTransactionsView&&this.reviewTransactionsView.Close(),this.orderType="Convert",this.LoadOrder(e.get("SalesOrderCode")))},LoadOrderForConvertQuote:function(e){r.LookupMode=s.LookupMode.ConvertQuote,this.ValidateOrderLookup(e)&&(this.reviewTransactionsView.Close(),this.orderType="Quote",this.LoadOrder(e.get("SalesOrderCode"),"Quote"))},LoadOrderForUpdateQuote:function(e){r.LookupMode=s.LookupMode.UpdateQuote,this.ValidateOrderLookup(e)&&(this.reviewTransactionsView.Close(),this.orderType="Quote",this.LoadOrder(e.get("SalesOrderCode"),"Quote"))},ValidateTransactionLocation:function(e,t,i){var o=new f,n=this,a=this;o.url=r.ServiceUrl+c.SOP+"validatetransactionlocation/",o.set({InvoiceCode:e,TransactionType:t?"Order":"Sale",IsTaxByLocation:r.Preference.TaxByLocation,WarehouseCode:r.Preference.DefaultLocation}),o.save(o,{success:function(e,t){if(r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.ErrorMessage&&""!=t.ErrorMessage)return void navigator.notification.alert(t.ErrorMessage,null,"Load Transaction","OK");if(!t.Value){if(1!=n.IsMultiLocation()||r.LookupMode!=s.LookupMode.ConvertOrder)return a=r.LookupMode==s.LookupMode.ConvertOrder?"Location on selected transaction does not match the workstation's default location. Do you want to update the location of the header?":"Location on selected transaction does not match the workstation's default location. Do you want to update it?",void navigator.notification.confirm(a,function(e){i(1===e)},"Load Transaction",["Yes","No"]);navigator.notification.alert("The sales order is created from a different location. You may cancel this transaction and change the location on the sales order.",null,"Load Transaction","OK",!0)}i()},error:function(e,t,i){navigator.notification.alert("An error was encountered when trying to load transaction.",null,"Load Transaction","OK")}})},LoadOrder:function(e,t){var i=this;return i.IsReloadedTransaction?(i.IsReloadedTransaction=!1,void i.DoLoadOrder(e,t)):void i.ValidateTransactionLocation(e,!0,function(o){i.IsReloadedTransaction=!1,i.DoLoadOrder(e,t,o)})},DoLoadOrder:function(e,t,i){if(!r.ValidLocation)return void this.NotifyMsg("The Current Status of the Default Location is Inactive.","Unable to load Items");this.orderTransactionModel||(this.orderTransactionModel=new f);var o="Order",n=this;"Quote"===t&&(o=t);var a=i?r.Preference.DefaultLocation:"";1!=this.IsMultiLocation()&&1==i&&r.LookupMode==s.LookupMode.ConvertOrder&&(a=""),this.orderTransactionModel.set({TransactionCode:e,IsRecalculate:!0,IsTaxByLocation:r.Preference.TaxByLocation,WebsiteCode:u.GetWebsiteCode(),WarehouseToUse:a,WarehouseForHeader:i?r.Preference.DefaultLocation:"",TransactionType:r.TransactionType}),i&&(r.HasChanges=!0),this.orderTransactionModel.url=r.ServiceUrl+c.SOP+"loadorder?type="+o+"&sessionID="+r.GUID,this.LockTransactionScreen(!0,"Loading..."),this.orderTransactionModel.save(null,{success:function(e,t){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),n.LoadCouponDetailsFromSalesOrder(e,t)},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Loading Order"),n.LockTransactionScreen(!1)}})},LoadCouponDetailsFromSalesOrder:function(e,t){var i=t.SalesOrders[0].CouponID,o=this,n=i,a=new d;return n?(a.set({CustomerCode:r.CustomerCode,CriteriaString:n}),a.url=r.ServiceUrl+c.SOP+l.LOADCOUPONBYCOUPONID,void a.save(null,{success:function(i,n){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator();var a;n.Coupons&&1==n.Coupons.length&&(a=n.Coupons[0]),o.LoadOrderCompleted(e,t,a)},error:function(i,n,a){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),i.RequestError(n,"Error Retrieving Coupon Details"),o.LoadOrderCompleted(e,t,type)}})):void this.LoadOrderCompleted(e,t)},SetCurrentCustomer:function(e){r.CurrentCustomer=e},ValidateSerialLot:function(e,t,i){var o=i,n=0,a=t.filter(function(e){return e.get("ItemType")===s.ItemType.GiftCard||e.get("ItemType")===s.ItemType.GiftCertificate});if(e&&a){for(var c=0;c<a.length;c++){var l=a[c],u=!1,d=e.filter(function(e){return e.get("ItemCode")===l.get("ItemCode")&&e.get("UnitMeasureCode")===l.get("UnitMeasureCode")&&e.get("LineNum")===l.get("LineNum")}),h=l.get("Good")*l.get("UnitMeasureQty"),p=l.get("QuantityOrdered")*l.get("UnitMeasureQty");u=r.TransactionType==s.TransactionType.SalesRefund?d.length===h:d.length===p,u||n++}return n>0?o:void 0}return a.length>0?o:void 0},ValidateSerialNumbers:function(e,t,i){var o=[],n=t.filter(function(e){return e.get("ItemType")===s.ItemType.GiftCard||e.get("ItemType")===s.ItemType.GiftCertificate});if(e&&n)for(var a=0;a<n.length;a++){var r=n[a],c=e.find(function(e){return e.get("ItemCode")===r.get("ItemCode")});c||o.push(r)}return o},AssignTransactionShipTo:function(e){null!=r.CurrentCustomer.ShipToCode&&""!=r.CurrentCustomer.ShipToCode&&(r.CurrentCustomer.DefaultShipToCode==r.CurrentCustomer.ShipToCode&&e.get("ShipToCode")==r.CurrentCustomer.ShipToCode&&1!=r.CurrentShipToUpdated||e.set({ShipToCode:r.CurrentCustomer.ShipToCode,ShipToName:r.CurrentCustomer.ShipToName,ShipToCountry:r.CurrentCustomer.ShipToCountry,ShipToCounty:r.CurrentCustomer.ShipToCounty,ShipToCity:r.CurrentCustomer.ShipToCity,ShipToAddress:r.CurrentCustomer.ShipToAddress,ShipToPhone:r.CurrentCustomer.ShipToPhone,ShipToPhoneExtension:r.CurrentCustomer.ShipToPhoneExtension,ShipToPostalCode:r.CurrentCustomer.ShipToPostalCode,ShipToState:r.CurrentCustomer.ShipToState,PaymentTermGroup:r.ShipTo.PaymentTermGroup,PaymentTermCode:r.ShipTo.PaymentTermCode,DiscountType:r.ShipTo.DiscountType,DiscountPercent:r.ShipTo.DiscountPercent,DiscountableDays:r.ShipTo.DiscountableDays,DueType:r.ShipTo.DueType}))},AssignCustomerShipToFromLoadedTransaction:function(e){r.ShipTo.ShipToCode=e.ShipToCode,r.CurrentCustomer.ShipToCode=e.ShipToCode,r.CurrentCustomer.ShipToName=e.ShipToName,
r.CurrentCustomer.ShipToAddress=e.Address||e.ShipToAddress,r.CurrentCustomer.ShipToCountry=e.Country||e.ShipToCountry,r.CurrentCustomer.ShipToCity=e.City||e.ShipToCity,r.CurrentCustomer.ShipToPostalCode=e.PostalCode||e.ShipToPostalCode,r.CurrentCustomer.ShipToState=e.State||e.ShipToState,r.CurrentCustomer.ShipToCounty=e.County||e.ShipToCounty,r.CurrentCustomer.ShipToPhone=e.Telephone||e.ShipToTelephone,r.CurrentCustomer.ShipToPhoneExtension=e.TelephoneExtension||e.ShipToTelephoneExtension,r.CurrentCustomer.PaymentTermCode=e.PaymentTermCode,r.ShipTo.PaymentTermCode=e.PaymentTermCode,r.ShipTo.DiscountType=e.DiscountType,r.ShipTo.DiscountPercent=e.DiscountPercent,r.ShipTo.DueType=e.DueType,r.ShipTo.DiscountableDays=e.DiscountableDays},ProcessGenerateSerial:function(e){var t=e.get("ItemType")===s.ItemType.GiftCard||e.get("ItemType")===s.ItemType.GiftCertificate,i="";i=t?s.SerialLotType.Serial:e.get("SerializeLot"),this.InitializeSerializeLot(i,e.get("ItemCode"),e.get("ItemName"),e.get("LineNum"),e.get("ItemType"),e.get("UnitMeasureCode"),"",e)},RenderGCList:function(t){this.LockTransactionScreen(!1),this.gcItemList&&(this.gcItemList.remove(),this.gcItemList.unbind(),this.gcItemList=null),e("#item-wrapper").append("<div id='gcListLookup'></div>"),this.gcItemList=new Re({el:e("#gcListLookup"),collection:t,serialCollection:this.serializeLotCollection}),this.gcItemList.on("generateSerial",this.ProcessGenerateSerial,this),this.gcItemList.Show(),this.hideOtherButtons()},LoadOrderCompleted:function(t,i,n,a){if(i&&i.SalesOrders&&i.SalesOrders.length>0){switch(r.LookupMode){case s.LookupMode.UpdateOrder:this.SetTransactionType(s.TransactionType.UpdateOrder);break;case s.LookupMode.ConvertOrder:this.SetTransactionType(s.TransactionType.ConvertOrder);break;case s.LookupMode.ConvertQuote:this.SetTransactionType(s.TransactionType.ConvertQuote);break;case s.LookupMode.UpdateQuote:this.SetTransactionType(s.TransactionType.UpdateQuote);break;case s.LookupMode.VoidTransaction:this.SetTransactionType(s.TransactionType.VoidTransaction)}var c=i.SalesOrders[0];r.TransactionCode=c.SalesOrderCode,r.TransactionObject=c;if(r.TransactionDocumentDate=c.SalesOrderDate,this.SetTransactionCodeDisplay(r.TransactionCode),c.PublicNotes&&(r.PublicNote.PublicNotes=c.PublicNotes),i.Customers&&i.Customers.length>0){var l=i.Customers[0],d=r.DefaultPrice!=l.DefaultPrice;r.CustomerCode=l.CustomerCode,r.CustomerName=l.CustomerName,r.CustomerEmail=l.Email,r.DefaultContactEmail=l.DefaultContactEmail,r.DefaultPrice=l.DefaultPrice,r.POSSalesReceipt=l.POSSalesReceipt,d&&this.InitializeItems(),e("#lbl-customerName").html(u.TrimCustomerName()),r.IsLoadByTransaction=!0,r.Transaction=c,this.SetCurrentCustomer(l),this.AssignCustomerShipToFromLoadedTransaction(c)}if(i.SalesOrderDetails){var h=o.sortBy(i.SalesOrderDetails,function(e){return e.LineNum});i.KitDetails&&o.each(i.SalesOrderDetails,function(e){if(e.ItemType===s.ItemType.Kit){var t=o.where(i.KitDetails,{LineNum:e.LineNum});window.sessionStorage.setItem("kitItems-"+e.LineNum,JSON.stringify(t))}}.bind(this));var p=new P(i.CustomerPromotionDetails);i.CustomerPromotionDetails&&p.each(function(e){o.each(i.SalesOrderDetails,function(t){e.get("GetItemCode")==t.ItemCode&&e.get("GetLineNum")==t.LineNum&&(t.PromoDocumentCode=e.get("PromoDocumentCode"),t.PromoID=e.get("PromoID"),t.RuleID=e.get("RuleID"),t.IsPromoItem=!0)})}),"Convert"===this.orderType&&(this.SetCurrentOrderItems(h),this.CheckNonStockItems(i)),r.SalesOrderDetailsResponse=h,this.isCalculateByTaxCode=!0,u.IsNullOrWhiteSpace(i.Payments)||i.Payments.length>0&&(this.isCalculateByTaxCode=!0),this.LoadItemsToCart(h,this.isCalculateByTaxCode),r.IsLoadingTransaction=!0,this.ChangeItemGroupTax(this.cartCollection)}if(n&&(this.LoadCouponFromTransationHeader(c),this.couponModel&&n&&this.couponModel.set({IncludeAllCustomer:n.IncludeAllCustomer,IncludeAllProduct:n.IncludeAllProduct})),this.paymentCollection||this.InitializePaymentCollection(),this.paymentCollection.reset(),i.Payments&&i.Payments.length>0){var C=this.RemoveInvalidPayment(i.Payments);C.length>0&&this.paymentCollection.add(C)}if(r.AllowToFetchPaymentTerm=!1,this.paymentCollection.length>0&&this.paymentCollection.each(function(e){var t=e.get("CreditCardNumber");null!=e.get("CreditCardNumber")&&e.set({EncryptedCreditCardNumber:t})}),null!=i.SalesRep){var m="",T="",g=o.pluck(i.SalesRep,"CommissionPercent"),y=o.pluck(i.SalesRep,"SalesRepGroupName");g.length>1?o.each(g,function(e,t){m+=t>=g.length-1?e+"%":e+"%, ",t++}):m=g,o.each(y,function(e,t){T+=t>=y.length-1?e:e+", ",t++}),r.SalesRepGroupName=T,r.CommissionPercent=m,r.SalesRepList=i.SalesRep,e("#lbl-salesrepName").html(u.TrimSalesRepName()),e("#splitrateName").html(u.TrimCommissionPercent())}var S=null;r.TransactionType!=s.TransactionType.UpdateOrder&&r.TransactionType!=s.TransactionType.ConvertOrder||r.TransactionObject.DiscountPercent>0&&0==r.TransactionObject.DiscountRate&&(S=this.GetLatestPaymentDate(c)),S&&(r.LatestPaymentDate=S,r.AllowToFetchPotentialDiscount=!0),r.TransactionObject.DiscountRate>0&&this.AddTermDiscountToPayment(r.TransactionObject.DiscountRate),this.InitializePreviousTransactionDetails(i,"Order"),this.OnRequestCompleted("LoadOrderCompleted"),r.TransactionType===s.TransactionType.ConvertOrder&&this.ProcessAutoandManualGC(i),e("#gclookup").is(":visible")||this.LockTransactionScreen(!1)}else navigator.notification.alert("Unable to load order.",null,"Error","OK"),this.LockTransactionScreen(!1)},ProcessAutoandManualGC:function(e,t){var i=this,n=0;t=!!u.IsNullOrWhiteSpace(t);var a=this.cartCollection.filter(function(e){return(e.get("ItemType")===s.ItemType.GiftCard||e.get("ItemType")===s.ItemType.GiftCertificate)&&e.get("AutoGenerate")===!0}),r=this.cartCollection.filter(function(e){return(e.get("ItemType")===s.ItemType.GiftCard||e.get("ItemType")===s.ItemType.GiftCertificate)&&e.get("AutoGenerate")===!1});if(a&&a.length>0){this.serializeLotCollection||this.InitializeSerializeLotCollection();var c=function(e,s,c){return 0===n&&n++,i.serializeLotCollection.length>=1?o.each(s.SerialLotNumbers,function(e){var t=i.serializeLotCollection.where({ItemCode:e.ItemCode,LineNum:e.LineNum}).length||0,o=i.cartCollection.find(function(t){return t.get("ItemCode")===e.ItemCode&&t.get("LineNum")===e.LineNum});if(o&&!(t>=parseInt(o.get("QuantityOrdered")))){var n=i.serializeLotCollection.find(function(t){return t.get("SerialLotNumber")===e.SerialLotNumber});u.IsNullOrWhiteSpace(n)&&(u.IsNullOrWhiteSpace(e.UnitMeasureCode)&&(e.UnitMeasureCode=o.get("UnitMeasureCode")),i.serializeLotCollection.add(e))}}):i.AddUnitMeasureCodeToSerial(a,s.SerialLotNumbers),r&&r.length>0?void(t&&i.RenderGCList(new P(r))):void i.LockTransactionScreen(!1)},l=function(e,t,i){navigator.notification.alert(t,null,"Error","OK")};u.SerialNumbers.GenerateGiftSerialNumber(new P(a),this.serializeLotCollection,c,l,!0)}else if(r&&r.length>0)return void(t&&this.RenderGCList(new P(r)))},GetLatestPaymentDate:function(){if(0==this.paymentCollection)return null;if(1==this.paymentCollection.length)return this.paymentCollection.at(0).get("PaymentDate");for(var e=this.paymentCollection.pluck("PaymentDate"),t=this.paymentCollection.pluck("PaymentDate"),i=0;i<e.length;i++){var o=this.JSONtoDate(e[i]);t[i]=e[i],e[i]=new Date(o)}for(var n=0,a=0;a<e.length;a++)e[a]>e[n]&&(n=a);return t[n]},JSONtoDate:function(e){var t="YYYY-MM-DD",i=moment(e).format(t);return i},CheckNonStockItems:function(e){var t=new f,i=new Array;if(e.SalesOrderDetails)for(var n in e.SalesOrderDetails)if(e.SalesOrderDetails[n].QuantityAllocated<e.SalesOrderDetails[n].QuantityOrdered){var a={};for(var s in e.SalesOrderDetails[n])a[s]=e.SalesOrderDetails[n][s];i[i.length]=a}0!=i.length&&(t.set({StockTotalDetails:i}),t.url=r.ServiceUrl+c.PRODUCT+l.LOADGROUPLOCATIONSTOCK,t.save(null,{success:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator();var n=" However, this requires manager's approval.";if(r.Preference.AutoAllocateOverrideLevel&&""!=r.Preference.AutoAllocateOverrideLevel&&r.Preference.AutoAllocateOverrideLevel!=r.UserInfo.RoleCode||(n=""),o.isBoolean(t))t&&navigator.notification.alert("Item(s) you've added does not have enough stock. ConnectedSale will automatically adjust stock when the sale transaction is created."+n,null,"Stock Verification","OK");else{var a=o.find(t.StockTotalDetails,function(e){if("0"===e.FreeStock||0===e.FreeStock)return e});a&&navigator.notification.alert("Item(s) you've added does not have enough stock. ConnectedSale will automatically adjust stock when the sale transaction is created."+n,null,"Stock Verification","OK")}},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Retrieving Stock Details")}}))},SetCurrentOrderItems:function(e){var t=new K;t.add(e),r.CurrentOrders=t},UpdateOrder:function(){if(r.HasChanges){this.InitializeTransaction();var t=new A,i=new N,o=new M,n=this.GetNewPayments(),a=new W;this.couponModel&&a.add(this.couponModel);var s=this,d=new P;this.cartCollection.each(function(e){var t=JSON.parse(window.sessionStorage.getItem("kitItems-"+e.get("LineNum")));t&&d.add(t)}),r.SVG_Hold=new Array,r.SVG_ReadyToSave=!1;var h=function(){!this.IsHoldSVG()&&r.SVG_ReadyToSave&&this.transactionModel.save(null,{connectionID:this.signalRConnectionID})}.bind(this);if(t.add(r.TransactionObject),t.at(0).set({POSWorkstationID:r.POSWorkstationID,POSClerkID:r.Username,IsFreightOverwrite:!0,IsOverrideSalesRep:!1,SignatureSVG:this.ValidateSVG(r.Signature,h),IsTaxByLocation:r.Preference.TaxByLocation,PublicNotes:r.PublicNote.PublicNotes,WebSiteCode:r.Preference.WebSiteCode,IsUsePOSShippingMethod:r.Preference.IsUsePOSShippingMethod,POSShippingMethod:r.Preference.POSShippingMethod}),u.IsNullOrWhiteSpace(this.customerPOModel)||t.at(0).set(s.customerPOModel.attributes),this.AssignTransactionShipTo(t.at(0)),this.SetCouponToTransactionHeader(t.at(0),!1),i.add(this.cartCollection.models),this.RemoveTermDiscountPayment(),n&&n.length>0){o.add(n);for(var p=0;p<o.length;p++)if(o.at(p).get("SignatureSVG")){var C=o.at(p).get("SignatureSVG");o.at(p).set({SignatureSVG:this.ValidateSVG(C,h)})}}this.transactionModel.set({SalesOrders:t.toJSON(),SalesOrderDetails:i.toJSON(),Payments:o.toJSON(),Coupons:a.toJSON(),KitDetails:d.toJSON(),SessionID:r.GUID}),this.RemoveWarehouseCodeByItemType(this.transactionModel.get("SalesOrderDetails")),this.transactionModel.url=r.ServiceUrl+c.SOP+l.UPDATESALESORDER,this.LockTransactionScreen(!0,"Saving..."),r.SVG_ReadyToSave=!0,this.ResetCustomerPODetails(),h()}else navigator.notification.alert("There are no changes to save.",null,"Cannot Save Transaction","OK"),e("#main-transaction-blockoverlay").hide()},ConvertOrderWithValidaton:function(e,t){this.ValidateTransaction()&&this.ValidatePayment(t)&&this.PromptCustomerPO(t)&&this.PromptSignature()&&this.PromptToPrint()&&this.ValidateOutOfStockItems()&&this.ConvertOrder(e)},ConvertOrder:function(e){this.InitializeTransaction();var t=new A,i=new N,o=new M,n=(this.GetNewPayments(),new Q),a=new W,s="",d=new P;this.serializeLotCollection&&(s=this.serializeLotCollection.toJSON()),this.couponModel&&a.add(this.couponModel),this.cartCollection.each(function(e){var t=JSON.parse(window.sessionStorage.getItem("kitItems-"+e.get("LineNum")));t&&d.add(t)}),n.add(r.CurrentCustomer);var h=this;r.SVG_Hold=new Array,r.SVG_ReadyToSave=!1;var p=function(){!this.IsHoldSVG()&&r.SVG_ReadyToSave&&this.transactionModel.save(null,{connectionID:this.signalRConnectionID})}.bind(this);if(t.add(r.TransactionObject),t.at(0).set({POSWorkstationID:r.POSWorkstationID,POSClerkID:r.Username,IsFreightOverwrite:!0,IsOverrideSalesRep:!1,IsTaxByLocation:r.Preference.TaxByLocation,SignatureSVG:this.ValidateSVG(r.Signature,p),PublicNotes:r.PublicNote.PublicNotes,WebSiteCode:r.Preference.WebSiteCode}),u.IsNullOrWhiteSpace(this.customerPOModel)||t.at(0).set(h.customerPOModel.attributes),i.add(this.cartCollection.models),this.SetCouponToTransactionHeader(t.at(0),!1),this.RemoveTermDiscountPayment(),this.paymentCollection.each(function(e){1==e.get("CreditCardIsAuthorizedVerbally")?e.set({CardTransactionType:"Force"}):1==e.get("IsNew")&&1==r.AllowSaleCreditPreference?e.set({CardTransactionType:"Sale"}):e.set({CardTransactionType:"Auth/Capture"}),o.add(e)}),this.AssignTransactionShipTo(t.at(0)),this.transactionModel.set({Customers:n,SalesOrders:t.toJSON(),SalesOrderDetails:i.toJSON(),Payments:o.toJSON(),Coupons:a.toJSON(),SerialLotNumbers:s,KitDetails:d.toJSON(),SessionID:r.GUID}),r.HasChanges){for(var C=0;C<o.length;C++)if(o.at(C).get("SignatureSVG")){var m=o.at(C).get("SignatureSVG");o.at(C).set({SignatureSVG:this.ValidateSVG(m,p)})}this.transactionModel.set({Customers:n,SalesOrders:t.toJSON(),SalesOrderDetails:i.toJSON(),Payments:o.toJSON(),SerialLotNumbers:s,SessionID:r.GUID}),this.RemoveWarehouseCodeByItemType(this.transactionModel.get("SalesOrderDetails"))}this.transactionModel.url=r.ServiceUrl+c.SOP+l.CONVERTSALESORDERTOINVOICE+e;try{this.LockTransactionScreen(!0,"Saving..."),r.SVG_ReadyToSave=!0,this.ResetCustomerPODetails();var T="Error saving the Invoice. The following items do not have the same number of serial numbers with the shipped quantity.",g=this.ValidateSerialLot(this.serializeLotCollection,this.cartCollection,T);if(void 0!==g&&""!==g)throw g;p()}catch(y){this.LockTransactionScreen(!1),navigator.notification.alert(y,null,"Action not allowed","OK")}},ConvertQuoteWithValidaton:function(e,t){this.ValidateTransaction()&&this.ValidatePayment(t)&&this.PromptCustomerPO(t)&&this.PromptSignature()&&this.PromptToPrint()&&this.ConvertQuote(e)},ConvertQuote:function(e){this.InitializeTransaction();var t=new A,i=new N,o=new M,n=this.GetNewPayments(),a=new Q,s=new W;this.couponModel&&s.add(this.couponModel);var d=this,h=new P;this.cartCollection.each(function(e){var t=JSON.parse(window.sessionStorage.getItem("kitItems-"+e.get("LineNum")));t&&h.add(t)}),a.add(r.CurrentCustomer),t.add(r.TransactionObject),t.at(0).set({POSWorkstationID:r.POSWorkstationID,POSClerkID:r.Username,IsFreightOverwrite:!0,IsOverrideSalesRep:!1,IsTaxByLocation:r.Preference.TaxByLocation,PublicNotes:r.PublicNote.PublicNotes,WebSiteCode:r.Preference.WebSiteCode}),u.IsNullOrWhiteSpace(this.customerPOModel)||t.at(0).set(d.customerPOModel.attributes),this.SetCouponToTransactionHeader(t.at(0),!1),this.AssignTransactionShipTo(t.at(0)),this.transactionModel.set({Customers:a,SalesOrders:t.toJSON(),SalesOrderDetails:i.toJSON(),Coupons:s.toJSON()}),r.SVG_Hold=new Array,r.SVG_ReadyToSave=!1;var p=function(){!this.IsHoldSVG()&&r.SVG_ReadyToSave&&this.transactionModel.save(null,{connectionID:this.signalRConnectionID,success:function(e,t){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.SaveTransactionCompleted(e,t)}.bind(this),error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.SaveTransactionError(e,t,i)}.bind(this)})}.bind(this);if(r.HasChanges){if(i.add(this.cartCollection.models),n&&n.length>0){o.add(n);for(var C=0;C<o.length;C++)if(o.at(C).get("SignatureSVG")){var m=o.at(C).get("SignatureSVG");o.at(C).set({SignatureSVG:this.ValidateSVG(m,p)})}}this.transactionModel.set({Customers:a,SalesOrders:t.toJSON(),SalesOrderDetails:i.toJSON(),Payments:o.toJSON(),KitDetails:h.toJSON()}),this.RemoveWarehouseCodeByItemType(this.transactionModel.get("SalesOrderDetails"))}this.transactionModel.url=r.ServiceUrl+c.SOP+l.CONVERTQUOTETOSALESORDER+e+"/"+r.GUID,this.LockTransactionScreen(!0,"Saving..."),r.SVG_ReadyToSave=!0,this.ResetCustomerPODetails(),p()},TogglePaymentButtons:function(e){if(e)this.$(".payment").removeClass("ui-disabled");else{if(this.$(".payment").addClass("ui-disabled"),0===this.cartCollection.length)return void this.RemoveCoupon();void 0==this.couponModel.get("CouponCode")&&this.isQuoteRemoveCoupon||(this.RemoveCoupon(),this.ChangeItemGroupTax(this.cartCollection),this.isQuoteRemoveCoupon=!0)}},buttonCoupon_Tap:function(e){e.stopPropagation();var t;return this.cartCollection&&this.cartCollection.length>0&&this.cartCollection.each(function(e){if(e.get("QuantityOrdered")<0)return void(t=!0)}),t?void navigator.notification.alert("Coupon is not applicable for transactions with items having negative quantity.",null,"Negative Quantity","OK"):void this.ShowCouponView()},ShowCouponView:function(){this.couponView?this.couponView.Show():(this.couponView=new ce({el:e("#couponContainer"),model:this.couponModel}),this.couponView.on("AcceptCoupon",this.AcceptCoupon,this),this.couponView.on("RemoveCoupon",this.RemoveCoupon,this))},CheckReason:function(e){this.LoadReason(100,"",e)},ProceedToAction:function(e){var t=e.get("Action");switch(t){case"Transaction":r.ReasonCode.Transaction=this.preferenceCollection.at(0).get("IsReasonTransactionVoid");break;case"Return":r.ReasonCode.Return=this.preferenceCollection.at(0).get("IsReasonReturns")}},ShowReasonView:function(t,i){e("#reasonPageContainer").append("<div id='reasonMainContainer'></div>"),this.TransactionReasonView&&(this.TransactionReasonView.remove(),this.TransactionReasonView.unbind(),this.TransactionReasonView=null),this.TransactionReasonView=new ue({el:e("#reasonMainContainer"),collection:t,type:i})},LoadReason:function(e,t,i){var o=this,n=new d,a=e;this.transactionReasonCollection=new B,this.transactionReasonCollection.unbind(),this.transactionReasonCollection.on("acceptReason",this.AcceptReason,this),this.transactionReasonCollection.on("savedTransaction",this.ProceedToAction,this),n.set({StringValue:t}),n.url=r.ServiceUrl+c.POS+l.REASONLOOKUP+a,n.save(null,{success:function(e,t){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),o.transactionReasonCollection.reset(t.Reasons),o.ShowReasonView(o.transactionReasonCollection,i)},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Loading Reason Codes")}})},AcceptReason:function(e){switch(r.ActionType){case s.ActionType.Returns:this.ValidateManagerOverride(r.ActionType)&&(this.SaveReason(),this.CreateRefund());break;case s.ActionType.VoidTransaction:this.ValidateManagerOverride(r.ActionType)&&(this.SaveReason(),this.VoidTransaction());break;default:this.ValidateManagerOverride(r.ActionType)&&(this.SaveReason(),this.CreateCreditMemo())}},SaveReason:function(){this.TransactionReasonView&&this.TransactionReasonView.SaveReason()},AcceptCoupon:function(e){this.ValidateAcceptCouponInfo(e)&&(this.couponModel=e.clone(),r.Coupon=this.couponModel,this.couponView.Close(),this.cartCollection&&this.cartCollection.length>0&&this.RecalculateCoupon(!0))},RecalculateCoupon:function(t){this.requestQueue||this.InitializeRequestQueue();var o=this,n=function(n){var a=new T,d=new W;o.couponModel?d.add(o.couponModel.clone()):d.add(new T),"Orders"===o.couponModel.get("CouponType")?r.CouponIncludeAll=!0:r.CouponIncludeAll=o.couponModel.get("IncludeAllProduct");var h=r.TransactionType;r.TransactionObject&&r.TransactionObject.Type&&(h=r.TransactionObject.Type),h==s.TransactionType.Quote&&(h=s.TransactionType.Order);var p=new k;p.add({BillToCode:r.CustomerCode,POSWorkstationID:r.POSWorkstationID,IsFreightOverwrite:!0,IsOverrideSalesRep:r.Preference.IsOverrideSalesRep,IsTaxByLocation:r.Preference.TaxByLocation,Type:h,WarehouseCode:r.Preference.DefaultLocation}),o.AssignTransactionShipTo(p.at(0)),o.SetCouponToTransactionHeader(p.at(0));var C=new P;n.each(function(e){e.set({CustomerCode:r.CustomerCode,ShipToCode:r.ShipTo.ShipToCode,IsTaxByLocation:r.Preference.TaxByLocation});var t=JSON.parse(window.sessionStorage.getItem("kitItems-"+e.get("LineNum")));t&&C.add(t)}),a.set({Coupons:d.toJSON(),SOPDetails:n.toJSON(),CustomerCode:r.CustomerCode,Headers:p.toJSON(),KitDetails:C.toJSON()}),o.RemoveWarehouseCodeByItemType(a.get("SOPDetails")),o.RemoveTermDiscountPayment(),a.url=r.ServiceUrl+c.SOP+l.RECALCULATEAMOUNTDISCOUNTCOUPON,a.save(null,{timeout:0,success:function(n,a){if(r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),u.IsNullOrWhiteSpace(a.ErrorMessage)){if(a&&a.SOPDetails&&a.SOPDetails.length>0)for(i in a.SOPDetails)a.SOPDetails[i].CouponDiscountRate=a.SOPDetails[i].CouponDiscountAmount;o.RecalculateCouponCompleted(a,t)}else navigator.notification.alert(a.ErrorMessage,null,"Error","OK");e("#serialLot").is(":visible")?o.HideActivityIndicator():o.LockTransactionScreen(!1)},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.requesterror(t,"error recalculating coupon")}})};return this.tempCart&&this.tempCart.length>0?(n(new P(this.tempCart)),void(this.tempCart.length=0)):void(this.cartCollection&&this.cartCollection.length>0&&n(this.cartCollection))},InitializeRequestQueue:function(){this.requestQueue=new P,this.requestQueue.on("startQueue",this.StartRequestQueue,this)},StartRequestQueue:function(e){try{var t=this;if(e.length<=0)return;this.isCouponQueueProcess=!1,e.each(function(e){if(e.get("Entity")instanceof f&&!t.isCouponQueueProcess){t.isCouponQueueProcess=!0;var i=new f;i=e.get("Entity"),i.on("sync",t.ProcessRequestQueue,t),i.on("error",t.RemoveRequestQueue,t),t.onQueueModel=i.set({parentCID:e.cid}),i.save()}})}catch(i){navigator.notification.alert(i.message,null,i.name,"OK")}},ProcessRequestQueue:function(e,t,o){var n=this;if(this.isCouponQueueProcess){this.isCouponQueueProcess=!1;var a=this.requestQueue.find(function(e){return e.cid===n.onQueueModel.get("parentCID")});a&&this.requestQueue.remove(a),this.onQueueModel=null}if(0!=this.requestQueue.length)this.requestQueue.trigger("startQueue",this.requestQueue);else{if(r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),u.IsNullOrWhiteSpace(t.ErrorMessage)){if(t&&t.SOPDetails&&t.SOPDetails.length>0)for(i in t.SOPDetails)t.SOPDetails[i].CouponDiscountRate=t.SOPDetails[i].CouponDiscountAmount;this.RecalculateCouponCompleted(t)}else navigator.notification.alert(t.ErrorMessage,null,"Error","OK");this.LockTransactionScreen(!1)}},RemoveRequestQueue:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Recalculating Coupon"),this.requestQueue.remove(this.onQueueModel),this.onQueueModel=null,this.LockTransactionScreen(!1)},RemoveItemInQueue:function(e){try{this.requestQueue.remove(e)}catch(t){navigator.notification.alert(t.message,null,t.name,"OK")}},RecalculateCouponCompleted:function(e,t){this.LoadItemsToCart(e.SOPDetails);var i=e.Coupons[0];if(i){if(!this.IsReturn()&&this.couponModel.get("RequiresMinimumOrderAmount")>0){var o=0;if(this.cartCollection.each(function(e){o+=isNaN(e.get("CouponDiscountRate"))?0:e.get("CouponDiscountRate")}),o<=0){var n="A minimum transaction amount of "+r.CurrencySymbol+this.couponModel.get("RequiresMinimumOrderAmount").toFixed(2)+" is required to avail coupon "+this.couponModel.get("Description")+".";navigator.notification.alert(n,null,"Minimum Amount Required","OK"),this.RemoveCoupon()}}this.couponModel&&this.validateCouponRequirement(),r.CurrentCustomerChanged||this.ChangeItemGroupTax(this.cartCollection,t)}this.paymentCollection&&this.ReloadPayments(this.paymentCollection.models),r.HasChanges=!0},ReloadPayments:function(e){this.paymentCollection||this.InitializePaymentCollection(),this.summaryModel.set({Payment:0}),this.paymentCollection.reset();for(var t=0;t<e.length;t++)e[t].set({IsReload:!0});this.paymentCollection.add(e),this.paymentCollection.each(function(e){e.set({IsReload:!1})})},ValidateAcceptCouponInfo:function(e){if(!this.ValidateTransactionAmount(e,!1,0)){var t="A minimum transaction amount of "+r.CurrencySymbol+e.get("RequiresMinimumOrderAmount").toFixed(2)+" is required to avail coupon "+e.get("Description")+".";return navigator.notification.alert(t,null,"Minimum Amount Required","OK"),!1}return!this.couponModel||(null!=e&&this.couponModel.get("CouponID")!=e.get("CouponID")||(this.couponModel.get("CouponID")===e.get("CouponID")&&this.couponView.Close(),!1))},ValidateTransactionAmount:function(e,t,i){if(null!=e&&e.get("RequiresMinimumOrderAmount")>0){var o=this.CalculateExtPriceWithoutCoupon(t,i);if(o<e.get("RequiresMinimumOrderAmount"))return r.TransactionType==s.TransactionType.SalesRefund}return!0},CalculateExtPriceWithoutCoupon:function(e,t){for(var i=0,o=0,n=0;n<this.cartCollection.length;n++){var a=this.cartCollection.at(n);o=e?this.CalculateExtPrice(a.get("QuantityOrdered"),a.get("SalesPriceRate"),t,null,0,null,a.get("LineNum")):this.CalculateExtPrice(a.get("QuantityOrdered"),a.get("SalesPriceRate"),a.get("Discount"),null,0,null,a.get("LineNum")),i+=o}return i},GetCouponID:function(){var e=this.couponModel;return r.TransactionType==s.TransactionType.SalesRefund?null:e?"Stackable"===e.get("CouponComputation")&&"Amount"===e.get("DiscountType")?null:e.get("CouponID"):null},GetItemQuantity:function(e){return r.TransactionType===s.TransactionType.SalesRefund||r.TransactionType===s.TransactionType.Return?e.get("Good"):e.get("QuantityOrdered")},SetItemQuantity:function(e,t){return r.TransactionType===s.TransactionType.SalesRefund||r.TransactionType===s.TransactionType.Return?(e.get("IsNewLine")&&e.set({QuantityDisplay:t}),e.set({Good:t,QuantityOrdered:t,QuantityShipped:t,QuantityAllocated:t})):e.set({QuantityOrdered:t,QuantityShipped:t})},RecalculateStackableCoupon:function(e){for(var t=0,i=0;i<this.cartCollection.length;i++){var o=this.cartCollection.at(i);if("Stackable"===o.get("CouponComputation")&&o.get("CouponDiscountAmount")>0){var n=this.GetItemQuantity(o)*this.CalculateNetPrice(o.get("SalesPriceRate"),o.get("Discount"));t+=n}}for(var a=0,r=this.cartCollection.length-1;r>=0;r--){var o=this.cartCollection.at(r);if("Stackable"===o.get("CouponComputation")&&o.get("CouponDiscountAmount")>0){var n=this.GetItemQuantity(o)*this.CalculateNetPrice(o.get("SalesPriceRate"),o.get("Discount")),s=n/t,c=o.get("CouponDiscountAmount")*s;0==r&&(c=e-a),"Amount"===o.get("CouponDiscountType")&&(c=format("0.0000",c),c=1*this.RoundNumber(c,2),o.set({CouponDiscountAmount:c}),a+=c)}}},VoidCoupon:function(e){this.couponModel.clear(),r.Coupon=null,this.RemoveCouponInfoFromSOPDetail(),this.couponView&&this.couponView.ClearCoupon(),e&&this.RecalculateCoupon(),r.HasChanges=!0,this.cartView&&this.cartView.LoadiScroll()},RemoveCouponInfoFromSOPDetail:function(){if(this.cartCollection&&this.cartCollection.length>0)for(index=0;index<this.cartCollection.length;index++){var e=this.cartCollection.at(index);e.set({CouponCode:null,CouponId:null,CouponDiscountType:"",CouponDiscountAmount:0,CouponDiscountRate:0,CouponComputation:"",IsIncludedInCoupon:!1})}},RemoveCoupon:function(){this.VoidCoupon(this.cartCollection.length>0)},VoidItem:function(t){var o=this,n=new f;if(this.isNoCouponAtFirst=!0,this.validateCouponRequirement(),this.OnRequestCompleted("VoidItem"),this.UpdateCouponWithValidation(),this.CheckNegativeQuantities(),this.RemoveTermDiscountPayment(),this._lastItemChecked&&this.cartView&&this.cartView.LastItemRemoved){var a=new P;this.cartCollection.each(function(e){if(n=e,null!=e.get("BuyItemCode"))if(void 0==e.get("BuyItemCode")[0].BuyItemCode)e.get("BuyItemCode")==o.cartView.LastItemRemoved.ItemCode&&e.get("BuyItemCode")==o.cartView.LastItemRemoved.LineNum&&a.add(e);else if(1==e.get("BuyItemCode")[0].BuyItemCode.length)e.get("BuyItemCode")[0].BuyItemCode[0]==o.cartView.LastItemRemoved.ItemCode&&e.get("PromoDocumentCode")==o.cartView.LastItemRemoved.PromoDocumentCode&&a.add(e);else for(i=0;i<e.get("BuyItemCode")[0].BuyItemCode.length;i++)e.get("BuyItemCode")[0].BuyItemCode[i]==o.cartView.LastItemRemoved.ItemCode&&e.get("PromoDocumentCode")==o.cartView.LastItemRemoved.PromoDocumentCode&&a.add(e)}),this._lastItemChecked.ItemCode==this.cartView.LastItemRemoved.ItemCode&&(this._lastItemChecked=null)}void 0!=a&&this.RemoveFreeItems(a),r.CartCollection=this.cartCollection,u.FocusToItemScan(),this.cartCollection.each(function(t){1==t.get("IsPromoItem")&&(e("#"+t.cid+" #quantityDisplay").addClass("ui-disabled").css("opacity",1),e("#"+t.cid+" #display-itemName").addClass("ui-disabled").css("opacity",1),e("#"+t.cid+" #itemPriceDisplay").addClass("ui-disabled").css("opacity",1),e("#"+t.cid+" #discountDisplay").addClass("ui-disabled").css("opacity",1),e("#"+t.cid+" #extPriceRate-td").addClass("ui-disabled").css("opacity",1))})},RemoveFreeItems:function(e){if(e.length>0){var t=this,o=new f;e.each(function(n){for(e=n,t.cartCollection.remove(n),i=0;i<e.get("BuyItemCode")[0].BuyItemCode.length;i++)e.get("BuyItemCode")[0].BuyItemCode[i]==t.cartView.LastItemRemoved.ItemCode&&(o.url=r.ServiceUrl+"Transactions/deletelinenum?PromoDocumentCode="+t.cartView.LastItemRemoved.PromoDocumentCode+"&PromoID="+t.cartView.LastItemRemoved.PromoID+"&BuyItemCode="+e.get("BuyItemCode")[0].BuyItemCode[i],o.save(null,{}))})}},UpdateCouponWithValidation:function(){if(this.couponModel)if(this.ValidateTransactionAmount(this.couponModel,!1,0))this.IsRequireRecalculateCoupon()&&this.RecalculateCoupon();else{var e="A minimum transaction amount of "+r.CurrencySymbol+this.couponModel.get("RequiresMinimumOrderAmount").toFixed(2)+" is required to avail coupon "+this.couponModel.get("Description")+".";navigator.notification.alert(e,null,"Minimum Amount Required","OK"),this.RemoveCoupon()}},IsReturn:function(){return r.TransactionType===s.TransactionType.SalesRefund||r.TransactionType===s.TransactionType.SalesCredit},IsRequireRecalculateCoupon:function(){return!this.IsReturn()&&!(!this.couponModel||"Stackable"!==this.couponModel.get("CouponComputation")||"Amount"!==this.couponModel.get("DiscountType"))},LoadCouponFromTransationHeader:function(e){var t=new T;t.set({CouponCode:e.CouponCode,CouponComputation:e.CouponComputation,DiscountAmount:e.CouponDiscountAmount,DiscountIncludesFreeShipping:e.CouponDiscountIncludesFreeShipping,DiscountPercent:e.CouponDiscountPercent,DiscountType:e.CouponDiscountType,CouponID:e.CouponID,RequiresMinimumOrderAmount:e.CouponRequiresMinimumOrderAmount,CouponType:e.CouponType,CouponUsage:e.CouponUsage,CustomerCode:e.BillToCode}),this.LoadCoupon(t)},LoadCoupon:function(e){this.couponModel=e,r.Coupon=this.couponModel,this.couponView&&this.couponView.LoadCoupon(e)},PromptSignature:function(){var e=!1;if(r.OnRechargeProcess)return!0;switch(r.TransactionType){case s.TransactionType.Sale:case s.TransactionType.ConvertOrder:case s.TransactionType.UpdateInvoice:e=r.Preference.RequireSignatureOnOpenAccount&&null===r.Signature&&this.GetTransactionBalance()>0;break;case s.TransactionType.Order:case s.TransactionType.ConvertQuote:e=r.Preference.RequireSignatureOnOrder&&null===r.Signature;break;case s.TransactionType.UpdateOrder:e=r.Preference.RequireSignatureOnOrder&&null===r.Signature;break;case s.TransactionType.Suspend:e=!1}return!e||(this.ShowSignature(),!1)},ViewSignature:function(){return null!=r.TransactionObject&&""!=r.TransactionObject.SignatureSVG&&null!=r.TransactionObject.SignatureSVG?(this.ShowSignature(r.TransactionObject.SignatureSVG,!0),null):void navigator.notification.alert("There is no signature attached to the current transaction.",null,"No Signature Found","OK")},ShowSignature:function(e,t){this.InitializeSignatureView(),this.signatureView.viewType="POS",this.signatureView.ReadOnly=t,this.signatureView.Show(e)},InitializeSignatureView:function(){this.signatureView||(this.signatureView=new le({el:e("#signatureContainer")}),this.signatureView.on("SignatureAdded",this.AttachSignature,this),this.signatureView.on("CancelSignature",this.ResetCustomerPODetails,this),this.signatureView.on("allowUserToAttachSign",this.GetAttachedSignature,this),this.signatureView.on("cancelSignRetrieval",this.StopRetrieval,this),this.signatureView.on("deleteSavedSignature",this.DeleteSavedSignature,this))},GetAttachedSignature:function(e){this.viewSender=e,this.OnRequestCompleted("AskForSignature")},BeginFetchingSignature:function(){var e=this;this.signatureTimeInterval&&this.StopFetchingSignature(),this.signatureTimeInterval=window.setInterval(function(){e.FetchSignatureDetail()},250)},StopFetchingSignature:function(){window.clearInterval(this.signatureTimeInterval);
},StopRetrieval:function(){window.clearInterval(this.signatureTimeInterval),this.OnRequestCompleted("SignatureRetrieved"),this.StopFetchingSignature()},FetchSignatureDetail:function(){var e=new f;e.url=r.ServiceUrl+c.POS+l.CURRENTSIGNATURE,e.set({WorkstationID:r.POSWorkstationID,LastRetrievalDate:this.lastRetrievalDate});var t=this;e.save(null,{success:function(e,i,o){i&&(i.ErrorMessage?(t.NotifyMsg(i.ErrorMessage,null,"Error Fetching Signature"),t.StopFetchingSignature()):i.SignatureDetail&&(r.AskSignature=!1,t.StopFetchingSignature(),t.CheckSignatureFetched(i.SignatureDetail),t.OnRequestCompleted("SignatureRetrieved")))},error:function(e,i,o){t.StopFetchingSignature(),t.OnRequestCompleted("SignatureRetrieved")}})},CheckSignatureFetched:function(e){r.Signature=e,e.indexOf("[SVGID]:")==-1?this.SketchSignature(e):this.GetSignatureContent(e)},GetSignatureContent:function(e){var t=new f;t.url=r.ServiceUrl+c.POS+l.GETSIGNATURECONTENT,t.set({SignatureID:e});var i=this;t.save(null,{success:function(e,t,o){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t&&(t.ErrorMessage?i.NotifyMsg(t.ErrorMessage,null,"Error Fetching Signature content"):t.SignatureSVG&&(i.SketchSignature(t.SignatureSVG),r.SignatureContent=t.SignatureSVG))},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error")}})},PaymentCancelled:function(){this.paymentView&&this.paymentView.sketchView&&this.DeleteSavedSignature(r.Signature)},DeleteSavedSignature:function(e){if(e||(e=r.Signature),e&&e.indexOf("[SVGID]:")!=-1){var t=new f;t.url=r.ServiceUrl+c.POS+l.DELETESIGNATURE,t.set({SignatureID:e});var i=this;t.save(null,{success:function(e,t,o){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t&&(t.ErrorMessage?i.NotifyMsg(t.ErrorMessage,null,"Error Fetching Signature content"):console.log("Signature Deleted :"+t.Value))},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error")}})}},SketchSignature:function(e){var t=null;switch(this.viewSender){case"Refund":t=this.refundView;break;case"Payment":t=this.paymentView;break;default:t=this.signatureView}t.SketchSignature(e),t.ViewOnly=!1,this.HideActivityIndicator()},AttachSignature:function(){r.Signature&&(this.signatureTimeInterval&&this.StopFetchingSignature(),this.CreateTransaction(Ee))},PromptToPrint:function(t){var i=r.Preference.PromptToPrintReceipt,o=r.Preference.PromptEmailAddress;return r.PrintOptions.Reprint&&(i=!0,o=!1),r.OnRechargeProcess&&(i=!1,o=!1),i||o?(e("#main-transaction-blockoverlay").show(),this.InitializePrintOptionsView(),this.printOptionsView.SetTransactionToPrint(t),this.printOptionsView.Show(),!1):(r.PrintOptions.EmailReceipt=r.Preference.AutoEmailReceipt,r.PrintOptions.PrintReceipt=r.Preference.AutoPrintReceipt,r.PrintOptions.SilentPrint=r.Preference.AutoPrintReceipt,!0)},InitializePrintOptionsView:function(){e("#main-transaction-blockoverlay").show(),this.printOptionsView||(this.printOptionsView=new de({el:e("#printOptionsContainer")}),this.printOptionsView.on("PrintReceipt",this.AcceptPrintOption,this))},ValidatePrintOption:function(){if(r.PrintOptions.EmailReceipt&&!r.PrintOptions.Reprint||r.PrintOptions.EmailReceipt&&r.PrintOptions.Reprint){var e=r.PrintOptions.EmailAddress;if(""==e)return navigator.notification.alert("Please provide a valid email address.",null,"Invalid Email Address","OK"),!1;var t=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;if(!t.test(e))return navigator.notification.alert("Please provide a valid email address.",null,"Invalid Email Address","OK"),!1}return!0},ValidatePrintReview:function(e){return 0==e.get("FreightRate")||(void 0!=e.get("InvoiceCode")?this.receiptType="InvoiceCode":void 0!=e.get("SalesOrderCode")?this.receiptType="SalesOrderCode":void 0!=e.get("ReturnCode")&&(this.receiptType="ReturnCode"),navigator.notification.alert(e.get(this.receiptType)+" includes freight tax that ConnectedSale will not be able to handle. Try to open it in Connected Business.",null,"Not Supported","OK"),!1)},GetCustomerPaymentByTransactionCode:function(e,t){var i=this,o=new f,n=e;switch(t.get("TransactionType")){case s.TransactionType.Sale:case s.TransactionType.Suspend:case s.TransactionType.Return:case"Invoice":o.set({TransactionCode:n,IsRecalculate:!0,IsTaxByLocation:r.Preference.TaxByLocation,TransactionType:r.LookupMode}),o.url=r.ServiceUrl+c.SOP+l.LOADINVOICE;break;case s.TransactionType.Order:o.set({TransactionCode:n,IsRecalculate:!0,IsTaxByLocation:r.Preference.TaxByLocation}),o.url=r.ServiceUrl+c.SOP+"loadorder?type="+s.TransactionType.Order+"&sessionID="+r.GUID}o.save(null,{success:function(e,o){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),i.GetCustomerPaymentOnSuccess(o,t)},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Loading Order")}})},GetCustomerPaymentOnSuccess:function(e,t){this.customerPaymentCollection=new P,this.customerPaymentCollection.reset(e.Payments),this.PromptToPrint(t)},InitializeCustomerPayments:function(e){var t="";switch(e.get("TransactionType")){case s.TransactionType.Sale:case s.TransactionType.Suspend:case"Invoice":t=e.get("InvoiceCode");break;case s.TransactionType.Return:t=e.get("SourceDocument"),u.IsNullOrWhiteSpace(t)&&(t=e.get("ReturnCode"));break;case s.TransactionType.Order:t=e.get("SalesOrderCode")}return e.get("TransactionType")==s.TransactionType.Quote?void this.PromptToPrint(e):void this.GetCustomerPaymentByTransactionCode(t,e)},PrintAndEmailReviewTransaction:function(e){this.ValidatePrintReview(e)&&(r.PreviousReprintValue=!0,r.PrintOptions.Reprint=!0,this.reviewTransactionsView.Close(),this.InitializeCustomerPayments(e))},AcceptPrintOption:function(e,t){if(t||(r.PrintOptions.PrintReceipt=!1,r.PrintOptions.EmailReceipt=!1),this.ValidatePrintOption()){if(this.printOptionsView.Close(),r.PrintOptions.Reprint)return t?(null!=e.get("POSSalesReceipt")&&(r.POSSalesReceipt=e.get("POSSalesReceipt")),this.ReprintAndEmailTransaction(e)):r.PrintOptions.Reprint=!1,!1;switch(r.TransactionType){case s.TransactionType.Sale:this.ValidateOutOfStockItems()&&this.CreateInvoice(r.IsPosted);break;case s.TransactionType.Order:this.CreateOrder();break;case s.TransactionType.Quote:this.CreateQuote();break;case s.TransactionType.SalesPayment:this.CreateInvoicePayment(r.TransactionCode);break;case s.TransactionType.UpdateInvoice:case s.TransactionType.Recharge:this.ValidateOutOfStockItems()&&this.UpdateInvoice();break;case s.TransactionType.UpdateOrder:this.UpdateOrder();break;case s.TransactionType.ConvertOrder:this.ValidateOutOfStockItems()&&this.ConvertOrder(r.TransactionCode);break;case s.TransactionType.ConvertQuote:this.ConvertQuote(r.TransactionCode);break;case s.TransactionType.UpdateQuote:this.UpdateQuote(r.TransactionCode);break;case s.TransactionType.SalesRefund:this.ValidateReason("Return")&&this.ValidateManagerOverride(s.ActionType.Returns)&&this.CreateRefund();break;case s.TransactionType.Return:this.ValidateReason("Return")&&this.ValidateManagerOverride(s.ActionType.Returns)&&this.CreateRefund();break;case s.TransactionType.Suspend:if(this.IsExistingTransaction()){console.log("Do Suspend - Update Invoice"),this.ValidateOutOfStockItems()&&this.UpdateInvoice();break}console.log("Do Suspend - Create Invoice"),this.ValidateOutOfStockItems()&&this.CreateInvoice(r.IsPosted)}return!0}},PrintAndEmailTransaction:function(e){var t=null,i=null;switch(r.TransactionType){case s.TransactionType.Sale:case s.TransactionType.Suspend:t="CreateInvoice";break;case s.TransactionType.Order:case s.TransactionType.UpdateOrder:t="CreateOrder";break;case s.TransactionType.Quote:t="CreateQuote";break;case s.TransactionType.UpdateQuote:t="UpdateQuote";break;case s.TransactionType.SalesPayment:t="CreateInvoicePayment",i=this.GetReceiptCodes(e);break;case s.TransactionType.UpdateInvoice:case s.TransactionType.Recharge:t="UpdateInvoice";break;case s.TransactionType.ConvertOrder:t="ConvertOrder";break;case s.TransactionType.ConvertQuote:t="ConvertQuote";break;case s.TransactionType.SalesRefund:case s.TransactionType.Return:t="CreateCreditMemo"}this.ProcessPrintAndEmail(e,t,i)},ReprintAndEmailTransaction:function(e){if(r.PrintOptions.Reprint){switch(r.LookupMode){case s.LookupMode.Invoice:this.ProcessPrintAndEmail(e.get("InvoiceCode"),"CreateInvoice",null);break;case s.LookupMode.Order:this.ProcessPrintAndEmail(e.get("SalesOrderCode"),"CreateOrder",null);break;case s.LookupMode.Quote:this.ProcessPrintAndEmail(e.get("SalesOrderCode"),"CreateQuote",null);break;case s.LookupMode.Return:null==e.get("SourceDocument")||""==e.get("SalesOrderCode")?this.ProcessPrintAndEmail(e.get("ReturnCode"),"CreateCreditMemo",null):this.ProcessPrintAndEmail(e.get("SourceDocument"),"CreateRefund",e.get("ReturnCode"));break;case s.LookupMode.Suspend:this.ProcessPrintAndEmail(e.get("InvoiceCode"),"CreateInvoice",null);break;default:alert("Invalid transaction type.")}this.ClearTransaction()}},ProcessPrintAndEmail:function(e,t,i){var o=r.Preference.PromptEmailAddress||r.Preference.PromptToPrintReceipt,n=r.Preference.AutoPrintReceipt||!r.Preference.PromptToPrintReceipt,a=r.Preference.AutoEmailReceipt||!r.Preference.PromptEmailAddress,s=r.PrintOptions.Reprint;o||s?r.PrintOptions.PrintReceipt?this.PrintReceipt(e,t,i):r.PrintOptions.EmailReceipt?this.EmailReceipt(e,t,i):this.LockTransactionScreen(!1):(n||a)&&this.PrintReceipt(e,t,i)},PrintReceipt:function(e,t,i){if(this.reportType=t.split(" ").join(""),this.receiptCodes="",this.receiptType=t,null!=i&&(this.receiptCodes=i),null!=e||void 0!=e){var o=0;this.paymentCollection&&(o=this.paymentCollection.totalCashPayment()),"CreateCreditMemo"===t||"ConvertInvoice"===t?this.ProcessReceipt(e):"CreateInvoice"===t||"ConvertOrder"===t||"UpdateInvoice"===t?this.ProcessReceipt(e,o):"CreateOrder"===t||"UpdateOrder"===t||"ConvertQuote"===t?this.ProcessReceipt(e,o):"CreateQuote"===t||"UpdateQuote"===t?this.ProcessReceipt(e,o):"CreateRefund"===t?this.ProcessReceipt(e,i):"CreateInvoicePayment"===t?this.ProcessReceipt(e):"CreatePickNote"===t&&this.ProcessReceipt(e)}},EmailReceipt:function(e,t,i,o){(r.PrintOptions.EmailReceipt||o===!0)&&(this.reportType=t.split(" ").join(""),this.receiptCodes="",this.receiptType=t,null!=i&&(this.receiptCodes=i),null==e&&void 0==e||this.ProcessEmailReceipt(e,t,i,o))},ProcessPrintReceipt:function(e,t,i){var o=0;this.paymentCollection&&(o=this.paymentCollection.totalCashPayment()),"CreateCreditMemo"===t||"ConvertInvoice"===t?this.PrintCreditMemoReceipt(e):"CreateInvoice"===t||"ConvertOrder"===t||"UpdateInvoice"===t?this.PrintInvoiceReceipt(e,o):"CreateOrder"===t||"UpdateOrder"===t||"ConvertQuote"===t?this.PrintOrderReceipt(e,o):"CreateQuote"===t||"UpdateQuote"===t?this.PrintQuoteReceipt(e,o):"CreateRefund"===t?this.PrintRefundReceipt(e,i):"CreateInvoicePayment"===t&&this.PrintPaymentReceipt(e)},ProcessEmailReceipt:function(e,t,i,o){var n=0;this.paymentCollection&&(n=this.paymentCollection.totalCashPayment()),"CreateCreditMemo"===t||"ConvertInvoice"===t?this.EmailCreditMemoReceipt(e):"CreateInvoice"===t||"ConvertOrder"===t||"UpdateInvoice"===t?this.EmailInvoiceReceipt(e,n):"CreateOrder"===t||"UpdateOrder"===t||"ConvertQuote"===t?this.EmailOrderReceipt(e,n,null,o):"CreateQuote"===t?this.EmailQuoteReceipt(e,n):"CreateRefund"===t?this.EmailRefundReceipt(e,i):"CreateInvoicePayment"===t&&this.EmailPaymentReceipt(e)},InitializePrintReportSettingModel:function(){return this.printreportSettingModel?this.printreportSettingModel.clear({silent:!0}):(this.printreportSettingModel=new y,this.printreportSettingModel.on("sync",this.PrintReportComplete,this),this.printreportSettingModel.on("error",this.PrintReportFailed,this)),this.printreportSettingModel},InitializeEmailReportSettingModel:function(){return this.emailreportSettingModel?this.emailreportSettingModel.clear({silent:!0}):(this.emailreportSettingModel=new y,this.emailreportSettingModel.on("sync",this.EmailReportComplete,this),this.emailreportSettingModel.on("error",this.EmailReportFailed,this)),this.emailreportSettingModel},ResetEmail:function(){r.PrintOptions.EmailAddress=""},PrintReportFailed:function(e,t,i){this.LockTransactionScreen(!1),e.RequestError(t,"Error Processing Receipt","An error was encountered when trying to Generate Report."),this.HideActivityIndicator(),this.RemoveScreenOverLay(),r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()},PrintReportComplete:function(e,t,i){return this.LogWithTime("PrintReportComplete..."),this.LockTransactionScreen(!1),t.ErrorMessage?void this.NotifyMsg(t.ErrorMessage,"Error Generating Report"):(t.IsPrintPickNote=e.get("IsPrintPickNote")||!1,r.Preference.IsAirprint?this.PrintDynamicReceipt(t,this._transactionCode,this._reportCode,!1,this._isWorkstation):this.PrintDynamicReceipt(t,this._transactionCode,this._reportCode,!0,this._isWorkstation),!r.PrintOptions.EmailReceipt||this._isWorkstation||t.IsPrintPickNote||(this.StoreLastPrintingParameters(e),this.EmailReceipt(this._transactionCode,this.receiptType,this.receiptCodes)),r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.IsPrintPickNote&&u.ShowOverlayIfTransactionsViewIsVisible(),void(r.Preference.AutoSignOutUser?(this.ClearTransactionWithoutInitalization(),this.StopSignalR()):this.ClearTransaction()))},StoreLastPrintingParameters:function(e){var t=this,i=e.get("Parameters");t.lastPrintingParams={CreditCardReportCode:"",TransactionCode:""},i&&(i.where({Name:"CreditCardReportCode"}).length>0&&(t.lastPrintingParams.CreditCardReportCode=i.where({Name:"CreditCardReportCode"})[0].get("Value")),i.where({Name:"TransactionCode"}).length>0&&(t.lastPrintingParams.TransactionCode=i.where({Name:"TransactionCode"})[0].get("Value")))},GetCreditCardReportCodeFromLastParameters:function(e){var t=this;return t.lastPrintingParams&&t.lastPrintingParams.TransactionCode==e?(t.lastPrintingParams.TransactionCode="",t.lastPrintingParams.CreditCardReportCode):""},EmailReportFailed:function(t,i,o){t.RequestError(i,"Error Processing Receipt","An error was encountered when trying to Generate Report."),this.HideActivityIndicator(),this.RemoveScreenOverLay(),r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e("#customizePrintPreview").is(":visible")||this.LockTransactionScreen(!1),e("#spin").is(":visible")&&this.HideActivityIndicator(),r.PrintOptions.Reprint&&(r.PrintOptions.Reprint=!1)},EmailReportComplete:function(t,i,o){var n=t.get("IsReadyForInvoice")||!1;i.ErrorMessage?this.NotifyMsg(i.ErrorMessage,n?"Error Sending Email":"Error Sending Report",!0):n&&this.SetOrderReadyToInvoice(new f({SalesOrderCode:t.get("PickupOrderCode")})),r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e("#customizePrintPreview").is(":visible")||this.LockTransactionScreen(!1),e("#spin").is(":visible")&&this.HideActivityIndicator(),r.PrintOptions.Reprint&&(r.PrintOptions.Reprint=!1),n&&u.ShowOverlayIfTransactionsViewIsVisible()},ProcessPrintPreview:function(e,t,i){this.receiptPrint||(this.receiptPrint=new Ce({el:this.$el}),this.receiptPrint.on("SignOut",this.SignOut,this)),this.receiptPrint.ProcessPrinting(e,t,i)},PrintWorkstationReport:function(e,t,i){Ke=!0,this.reportType="LastZtape",this.openDate="",this.closeDate="";var o=new Date,n=o.getMonth()+1+o.getDate()+o.getFullYear()+o.getHours()+o.getMinutes()+o.getSeconds();this.GenerateReport(this.reportType,"z-tape-"+r.Preference.WorkstationID+"-"+n)},GetSelectedReportCode:function(e,t){if(u.IsNullOrWhiteSpace(t.SalesReportNoDiscount))return e;if("Credit Card"==r.PaymentType){var i=r.POSSalesReceipt||1,o=1==i?t.CreditCardReportCode:t.CreditCardReportCode2;return null==o&&1!=i&&(o=t.CreditCardReportCode),null==o&&(o=reportCode),r.IsUseINVDiscountReport?u.IsNullOrWhiteSpace(t.SalesReportDiscount)||o!=t.SalesReportNoDiscount?o:t.SalesReportDiscount:o}return e},GetReportCode:function(e,t){var i=this.GetCustomerPOSReport(e,t).reportCode,o=r.Preference.IsAirprint;return r.Preference.IsAirprint=!0,i&&""!=i||("CreateCreditMemo"==e||"ConvertInvoice"==e||"CreateRefund"==e?i=t.ReturnReportCode:"CreateInvoice"==e||"ConvertOrder"==e||"UpdateInvoice"==e||"Suspended"==e?i=r.Preference.IsAirprint?this.GetSelectedReportCode(t.InvoiceReportCode,t):r.ReportCode.Invoice:"CreateOrder"==e||"UpdateOrder"==e||"ConvertQuote"==e?i=r.Preference.IsAirprint?this.GetSelectedReportCode(t.OrderReportCode,t):r.ReportCode.Order:"CreateQuote"==e||"UpdateQuote"==e?i=r.Preference.IsAirprint?t.QuoteReportCode:r.ReportCode.Quote:"CreateInvoicePayment"==e?i=r.Preference.IsAirprint?t.SalePaymentReportCode:r.ReportCode.Payment:"Xtape"===e?i=t.XTapeReportCode:"LastZtape"===e||"SpecificZtape"===e||"DateZtape"===e?i=t.ZTapeReportCode:"GiftCard"===e?i=r.CustomerPreference.DefaultGiftCardReport:"GiftCertificate"===e?i=r.CustomerPreference.DefaultGiftCertificateReport:"CreatePickNote"===e&&(i=r.Preference.IsAirprint?t.PickNoteReportCode:r.ReportCode.PickNote)),r.Preference.IsAirprint=o,i},GetTransactionType:function(e){var t="";return"CreateInvoice"==e||"ConvertOrder"==e||"UpdateInvoice"==e||"Suspended"==e||"LastZtape"===e||"SpecificZtape"===e||"DateZtape"===e||"Xtape"===e||"CreateInvoicePayment"===e?t="Sale":"CreateCreditMemo"==e||"ConvertInvoice"==e||"CreateRefund"==e?t="Return":"CreateOrder"==e||"UpdateOrder"==e||"ConvertQuote"==e||"CreatePickNote"===e?t="Order":"CreateQuote"==e||"UpdateQuote"==e?t="Quote":"GiftCard"==e&&(t="Gift Card"),t},GenerateReport:function(e,t,i,o,n){var a,s,d=r.Preference,h=r.ServiceUrl+"ReportService.svc",p=this.GetReportCode(e,d),C=this.GetCustomerPOSReport(e,d),m=!1,T=!1,g=this.GetTransactionType(e,o);if(i)this.LockTransactionScreen(!0,"Emailing Report..."),s=this.InitializeEmailReportSettingModel(),a=r.ServiceUrl+c.SOP+l.EMAILREPORT;else{this.LockTransactionScreen(!0,"Processing Report..."),s=this.InitializePrintReportSettingModel(),a=r.ServiceUrl+c.POS+l.EXPORTREPORT;var y=r.Preference.AutoPrintReceipt&&r.PrintOptions.SilentPrint||r.PrintOptions.SilentPrint;"CreatePickNote"==e&&(y=!0),y||r.isBrowserMode&&(a=r.ServiceUrl+c.POS+l.SAVEREPORT)}"Xtape"===e?m=!0:"LastZtape"!==e&&"SpecificZtape"!==e&&"DateZtape"!==e||(T=!0);var S="";"CreateInvoice"===e||"CreateInvoicePayment"===e||"ConvertOrder"===e||"CreateCreditMemo"===e||"ConvertInvoice"===e||"CreateRefund"===e||"CreditCard"===e||"UpdateInvoice"===e||"GiftCard"===e?S="InvoiceCode":"CreateOrder"!==e&&"UpdateOrder"!==e&&"ConvertQuote"!==e&&"CreateQuote"!==e&&"UpdateQuote"!==e&&"CreatePickNote"!==e||(S="SalesOrderCode");var f=this,I=this.CreateReportSettingParameters(t,S,e,m,T,g,p,i),v=function(c){if(u.Reporting.AssignWorkstationID(I,c),o)var l="test@test.com";else var l=r.PrintOptions.EmailAddress;s.set({ServiceUri:h,ServiceContentUri:a,ReportName:p,UserName:r.Username,Password:r.Password,Parameters:I,IsEmail:i,IsAirPrint:d.IsAirprint,RecipientEmailAddress:l,IsBrowserMode:r.isBrowserMode,ReportFileName:t,PickupOrderCode:n?t:null,IsReadyForInvoice:n,IsPrintPickNote:"CreatePickNote"==e,WorkStationID:r.POSWorkstationID}),i&&f.ResetEmail(),f._transactionCode=t,f._isWorkstation=m||T,f._reportCode=p,f._reportPrinter=C.printer,f._reportCopies=C.copies,s.url=a,s.save(null,{timeout:0})};u.Reporting.GetReportCriterias(v,"",p),r.IsUseINVDiscountReport=!1},HasCreditCardPayments:function(e){var t=!1;return e?0==e.length?t:(e.each(function(e){(r.TransactionType!=s.TransactionType.SalesPayment||e.get("IsNew"))&&e.get("PaymentType")==s.PaymentType.CreditCard&&u.IsNullOrWhiteSpace(e.get("IsPrevCCPayment"))&&(t=!0)}),t):t},HasNewCreditCardPayments:function(){var e=this,t=!1;return e.paymentCollection&&e.paymentCollection.length>0&&e.paymentCollection.each(function(e){e.get("PaymentType")==s.PaymentType.CreditCard&&e.get("IsNew")&&(t=!0)}),e.refundCollection&&e.refundCollection.length>0&&e.refundCollection.each(function(e){e.get("PaymentType")==s.PaymentType.CreditCard&&e.get("IsNew")&&(t=!0)}),t},CreateReportSettingParameters:function(e,t,i,o,n,a,c,l){var d=new z,h="",p=r.Preference.IsSinglePageTransactionReceipt,C="",m="";o===!0||n===!0?n===!0&&(C=this.openDate,m=this.closeDate):(h=this.receiptCodes,r.TransactionType==s.TransactionType.SalesPayment&&(this.creditCardReceiptCodes=""),u.IsNullOrWhiteSpace(h)&&!u.IsNullOrWhiteSpace(this.creditCardReceiptCodes)&&(h=this.creditCardReceiptCodes),u.IsNullOrWhiteSpace(h)||u.IsNullOrWhiteSpace(this.creditCardReceiptCodes)||(h+=","+this.creditCardReceiptCodes),this.creditCardReceiptCodes=null);var T="",g=!1,y=l?this.GetCreditCardReportCodeFromLastParameters(e):"";return u.IsNullOrWhiteSpace(this.paymentCollection)&&u.IsNullOrWhiteSpace(this.customerPaymentCollection)||(!u.IsNullOrWhiteSpace(this.paymentCollection)&&this.paymentCollection.length>0&&(g=r.TransactionType==s.TransactionType.SalesRefund?this.HasCreditCardPayments(this.refundCollection):this.HasCreditCardPayments(this.paymentCollection),g&&(T=c)),r.PrintOptions.Reprint&&!u.IsNullOrWhiteSpace(this.customerPaymentCollection)&&this.customerPaymentCollection.length>0&&(g=this.HasCreditCardPayments(this.customerPaymentCollection),g&&(T=c))),d.add([{Name:"TransactionType",Value:a},{Name:"CreditCardReportCode",Value:T||y},{Name:"IsSinglePageTransactionReceipt",Value:p},{Name:"DocumentCode",Value:t},{Name:"TransactionCode",Value:e},{Name:"IsXTapeReport",Value:o},{Name:"IsZTapeReport",Value:n},{Name:"ReceiptCodes",Value:h}]),d=this.CreateZtapeParameters(i,d,C,m)},CreateZtapeParameters:function(e,t,i,o){var n=t,a=i,r=o;switch(e){case"SpecificZtape":n.add([{Name:"OpenDateStart",Value:a}]);break;case"DateZtape":n.add([{Name:"OpenDateStart",Value:a},{Name:"OpenDateEnd",Value:r}])}return n},PrintDynamicReceipt:function(t,i,o,n,a){e("#printPreviewContainer").html("<div></div>"),this.dynamicPrintView=new pe({el:e("#printPreviewContainer div"),model:i,reportType:o,IsReceiptPrinter:n||!1,IsWorkstation:a||!1,printer:this._reportPrinter,copies:this._reportCopies||1}),Ke&&this.dynamicPrintView.on("formclosed",this.SignOut,this),this.dynamicPrintView.on("AutoSignOut",this.SignOut,this),this.HideActivityIndicator(),this.dynamicPrintView.Show(t)},PrintInvoiceReceipt:function(e,t){this.GenerateReport(this.reportType,e,!1)},PrintOrderReceipt:function(e,t){this.GenerateReport(this.reportType,e,!1)},PrintQuoteReceipt:function(e,t){this.GenerateReport(this.reportType,e,!1)},PrintCreditMemoReceipt:function(e){this.GenerateReport(this.reportType,e,!1)},PrintRefundReceipt:function(e,t){this.GenerateReport(this.reportType,e,!1)},PrintPaymentReceipt:function(e){this.GenerateReport(this.reportType,e,!1)},ProcessReceipt:function(e,t){this.GenerateReport(this.reportType,e,!1)},EmailInvoiceReceipt:function(e,t,i){this.GenerateReport(this.reportType,e,!0)},EmailOrderReceipt:function(e,t,i,o){this.GenerateReport(this.reportType,e,!0,null,o)},EmailQuoteReceipt:function(e,t){this.GenerateReport(this.reportType,e,!0)},EmailCreditMemoReceipt:function(e,t){this.GenerateReport(this.reportType,e,!0)},EmailRefundReceipt:function(e,t,i){this.GenerateReport(this.reportType,e,!0)},EmailPaymentReceipt:function(e){this.GenerateReport(this.reportType,e,!0)},GetReceiptCodes:function(e){receiptCodes="";for(var t=0,i=e.PaymentResponses.length;t<i;t++){var o=e.PaymentResponses[t].PaymentCode;""!=o&&null!=o&&(receiptCodes=receiptCodes+o+",")}return""!=receiptCodes&&null!=receiptCodes&&(receiptCodes=receiptCodes.substring(0,receiptCodes.length-1)),receiptCodes},ShowManagerOverride:function(e){return this.InitializeManagerOverrideView(),this.managerOverrideView.off("CloseClicked"),e&&this.managerOverrideView.on("CloseClicked",this.LockTransactionScreen(!1),this),this.managerOverrideView.Show(),!1},InitializeManagerOverrideView:function(){this.managerOverrideView||(this.managerOverrideView=new me({el:e("#managerOverrideContainer")}),this.managerOverrideView.on("ManagerOverrideAccepted",this.AcceptManagerOverride,this))},AcceptManagerOverride:function(e,t){var i=this,o=r.Username,n=r.Password,a=new S;r.Username=e,r.Password=t,a.url=r.ServiceUrl+c.POS+l.MANAGEROVERRIDE+r.POSWorkstationID+"/"+r.OverrideMode,a.save(null,{success:function(e,t){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),i.AcceptManagerOverrideCompleted(e,t)},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error")}}),r.Username=o,r.Password=n},AcceptManagerOverrideCompleted:function(e,t){null==t.ErrorMessage||""==t.ErrorMessage?(mode=r.OverrideMode,mode===s.ActionType.VoidTransaction?(this.VoidTransaction(),r.Preference.IsReasonTransactionVoid&&this.SaveReason()):mode===s.ActionType.Returns||mode===s.ActionType.SalesCredit||mode===s.ActionType.SalesRefund?(this.CreateRefund(),r.Preference.IsReasonReturns&&this.SaveReason(),additem):mode===s.ActionType.AutoAllocate&&r.TransactionType===s.TransactionType.Sale?(r.ManagerValidated=!0,null!=r.CurrentItem?(this.cartCollection.add(r.CurrentItem),r.CurrentItem=null):(this.item.set({QuantityOrdered:r.CurrentAssignedItemQty}),this.UpdateCartItem(this.item,0,"QuantityOrderedUpdated",!0)),navigator.notification.alert(r.msg1,null,r.msgTitle,"OK")):mode===s.ActionType.AutoAllocate&&r.TransactionType===s.TransactionType.Suspend?(r.ManagerValidated=!0,null!=r.CurrentItem&&(this.cartCollection.add(r.CurrentItem),r.CurrentItem=null),navigator.notification.alert(r.msg1,null,r.msgTitle,"OK")):mode===s.ActionType.AutoAllocate&&r.TransactionType===s.TransactionType.UpdateInvoice?r.ManagerValidated=!0:mode===s.ActionType.AutoAllocate&&r.TransactionType===s.TransactionType.ConvertOrder&&(r.ManagerValidated=!0,null!=r.CurrentItem&&(this.cartCollection.add(r.CurrentItem),r.CurrentItem=null),navigator.notification.alert(r.msg1,null,r.msgTitle,"OK")),this.managerOverrideView.Close()):(console.log(t.ErrorMessage),navigator.notification.alert(t.ErrorMessage,null,"Override Failed","OK")),this.FocusToItemScan()},SetActionType:function(e){r.ActionType=e},HasOpenTransaction:function(){return!!(this.cartCollection&&this.cartCollection.length>0)||(null!=r.TransactionCode&&""!=r.TransactionCode||(null!=this.couponModel&&null!=this.couponModel.get("CouponCode")||!!(this.paymentCollection&&this.paymentCollection.length>0)))},UpdateDrawerBalance:function(){var e=r.Status;if(null!=e&&e.IsOpen){switch(r.SelectedPaymentType){case s.PaymentType.Cash:if(cashPayment=this.GetCashPayment(),null!=cashPayment)switch(r.TransactionType){case s.TransactionType.SalesRefund:e.TotalCashReturns=e.TotalCashReturns+cashPayment;break;case s.TransactionType.Return:var t=0;t=0==cashPayment?this.GetTransactionBalance():cashPayment,e.TotalCashReturns=e.TotalCashReturns+t;break;default:e.TotalCashSales=e.TotalCashSales+cashPayment}else if(r.TransactionType===s.TransactionType.Sale){var i=this.GetTransactionBalance();i<0&&(e.TotalCashReturns=e.TotalCashReturns+i)}break;case s.PaymentType.CreditCard:switch(r.TransactionType){case s.TransactionType.SalesRefund:if(r.DejavooEnabled||r.OfflineCharge){var o=this.GetCashPayment();e.TotalCardReturns=e.TotalCardReturns+o}else{var n=this.GetCardPayment();e.TotalCardReturns=e.TotalCardReturns+n}break;case s.TransactionType.Return:if(r.DejavooEnabled||r.OfflineCharge){var o=this.GetTransactionBalance();e.TotalCardReturns=e.TotalCardReturns+o}else{var n=this.GetCardPayment();e.TotalCardReturns=e.TotalCardReturns+n}break;default:var n=this.GetCardPayment();e.TotalCardSales=e.TotalCardSales+n}break;case s.PaymentType.Check:if(checkPayment=this.GetCheckPayment(),checkPayment>0)switch(r.TransactionType){case s.TransactionType.SalesRefund:e.TotalCheckReturns=e.TotalCheckReturns+checkPayment;break;case s.TransactionType.Return:e.TotalCheckReturns=e.TotalCheckReturns+checkPayment;break;default:e.TotalCheckSales=e.TotalCheckSales+checkPayment}else if(0==checkPayment)switch(r.TransactionType){case s.TransactionType.Return:var t=0;t=0==checkPayment?this.GetTransactionBalance():checkPayment,e.TotalCheckReturns=e.TotalCheckReturns+t}}var a=this.GetGiftCardPayment();if(a>0)switch(r.TransactionType){case s.TransactionType.SalesRefund:break;default:e.TotalGiftCardSales=e.TotalGiftCardSales+a}var c=this.GetGiftCertificatePayment();if(c>0)switch(r.TransactionType){case s.TransactionType.SalesRefund:break;default:e.TotalGiftCertificateSales=e.TotalGiftCertificateSales+c}r.Status=e,this.UpdateWorkstation(e)}},GetCashPayment:function(){var e,t=new M;switch(r.TransactionType){case s.TransactionType.SalesRefund:this.refundCollection&&(e=this.refundCollection.GetNewPayments());break;default:this.paymentCollection&&(e=this.paymentCollection.GetNewPayments())}return t.add(e),t.length>0?t.totalCashPayment():null},GetCheckPayment:function(){var e,t=new M;switch(r.TransactionType){case s.TransactionType.SalesRefund:this.refundCollection&&(e=this.refundCollection.GetNewPayments());break;default:this.paymentCollection&&(e=this.paymentCollection.GetNewPayments())}return t.add(e),t.length>0?t.totalCheckPayment():null},GetCardPayment:function(){var e,t=new M;switch(r.TransactionType){case s.TransactionType.SalesRefund:this.refundCollection&&(e=this.refundCollection.GetNewPayments());break;default:this.paymentCollection&&(e=this.paymentCollection.GetNewPayments())}return t.add(e),t.length>0?t.totalCardPayment():null},GetGiftCardPayment:function(){var e,t=new M;switch(r.TransactionType){case s.TransactionType.SalesRefund:this.refundCollection&&(e=this.refundCollection.GetNewPayments());break;default:this.paymentCollection&&(e=this.paymentCollection.GetNewPayments())}return t.add(e),t.length>0?t.totalGiftCardPayment():null},GetGiftCertificatePayment:function(){var e,t=new M;switch(r.TransactionType){case s.TransactionType.SalesRefund:this.refundCollection&&(e=this.refundCollection.GetNewPayments());break;default:this.paymentCollection&&(e=this.paymentCollection.GetNewPayments())}return t.add(e),t.length>0?t.totalGiftCertificatePayment():null},UpdateWorkstation:function(e){if(null!=e){workstationID=r.POSWorkstationID,""!==workstationID&&null!==workstationID||navigator.notification.alert("Workstation ID is required to update workstation status.",null,"Workstation ID is Required","OK");var t=new I(e);t.url=r.ServiceUrl+c.POS+l.UPDATEWORKSTATION+r.POSWorkstationID,t.save(null,{success:function(e,t){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Updating Workstation")}})}},OpenWorkstation:function(e){var t=this,i=r.POSWorkstationID;""!==i&&null!==i||navigator.notification.alert("Workstation ID is required to start tracking of sales.",null,"Workstation ID is Required","OK");var o=new I;o.url=r.ServiceUrl+c.POS+l.OPENWORKSTATION+r.POSWorkstationID+"/"+e,o.save(null,{success:function(e,i){printerTool&&printerTool.openCashDrawer(r.Preference.DefaultPrinter).then(function(){console.log("DrawerKick!")}),r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.OpenWorkstationCompleted(e,i)},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Opening Workstation")}})},OpenWorkstationCompleted:function(e,t){null!=t&&(r.Status=t)},PromptCloseWorkstation:function(){switch(this.StopSignalR(),r.Preference.TrackDrawerBalance){case!0:null!==r.Status&&r.Status.IsOpen?(r.ClosingWorkStation=!0,this.ShowClosingAmount(!0)):navigator.notification.alert("This workstation is currently closed.",null,"Workstation Closed","OK");break;case!1:navigator.notification.alert("Tracking of drawer balance is disabled. Go to Settings to enable 'Track Drawer Balance'.",null,"Track Drawer Balance Disabled","OK")}},ShowClosingAmount:function(t){r.ClosingWorkStation?r.isOkToOpenCashDrawer=!0:r.isOkToOpenCashDrawer=!1,r.isOkToOpenCashDrawer&&printerTool&&printerTool.openCashDrawer(r.Preference.DefaultPrinter).then(function(){console.log("DrawerKick!")}),this.closingAmountView?this.closingAmountView.Show(t):(this.closingAmountView=new ye({el:e("#closingAmountContainer"),AllowCancel:t}),this.closingAmountView.on("SaveAmount",this.CloseWorkstation,this));
},CloseWorkstation:function(e){var t=this,i=r.POSWorkstationID,o=r.Status;o.CloseAmount=e,""!==i&&null!==i||(console.log("Workstation ID is required to close workstation."),navigator.notification.alert("Workstation ID is required to close workstation.",null,"Workstation ID is Required","OK"));var n=new I(o);n.url=r.ServiceUrl+c.POS+l.CLOSEWORKSTATION+r.POSWorkstationID,n.save(null,{success:function(e,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.CloseWorkstationCompleted(e,i),console.log("CloseWorkstation")},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Closing Workstation")}})},CloseWorkstationCompleted:function(e,t){if(null!=t){r.Status=null,r.PreventDrawerKick=!1;r.AdministratorRole;r.AdministratorRole?this.PrintWorkstationReport(e,!1,!1):r.Preference.TrackDrawerBalance===!0&&r.Preference.BlindClose===!1?this.PrintWorkstationReport(e,!1,!1):this.SignOut()}},ConfirmDrawerBalanceTracking:function(){r.PromptCloseWorkstation?r.PromptCloseWorkstation=!1:this.PromptOpenWorkstation()},ValidateUpdateTransactionType:function(e){if(this.cartCollection&&this.cartCollection.length>0){if(e===s.TransactionType.Return)return navigator.notification.alert("Please complete or cancel the current transaction first.",null,"Action not Allowed","OK"),!1;if(e===s.TransactionType.Order||e===s.TransactionType.Quote){var t=this.cartCollection.find(function(e){return e.get("QuantityOrdered")<0});if(t){var i="The current transaction has a negative quantity. Changing the transaction to Order or Quote is not allowed.";return console.log(i),navigator.notification.alert(i,null,"Negative Quantity","OK"),!1}}}return!0},ShowStatusReport:function(){this.statusReportView?this.statusReportView.Show():(this.statusReportView=new Se({el:e("#printTapeContainer")}),this.statusReportView.on("Xtape",this.PrintXtape,this),this.statusReportView.on("LastZtape",this.PrintLastZtape,this),this.statusReportView.on("SpecificZtape",this.PrintSpecificZtape,this),this.statusReportView.on("DateZtape",this.PrintDateZtape,this))},PromptWorkstationReport:function(){this.StopSignalR(),this.ShowStatusReport()},PrintXtape:function(){if(e("#main-transaction-blockoverlay").show(),r.Preference.TrackDrawerBalance){r.PreventDrawerKick=!0,this.reportType="Xtape";var t=new Date,i=t.getMonth()+1+t.getDate()+t.getFullYear()+t.getHours()+t.getMinutes()+t.getSeconds();this.GenerateReport(this.reportType,"x-tape-"+r.Preference.WorkstationID+"-"+i)}else navigator.notification.alert("This report is unavailable when track drawer balance tracking is off. ",null,"Action Not Allowed","OK")},PrintLastZtape:function(){e("#main-transaction-blockoverlay").show(),r.PreventDrawerKick=!0,this.openDate="",this.closeDate="",this.reportType="LastZtape";var t=new Date,i=t.getMonth()+1+t.getDate()+t.getFullYear()+t.getHours()+t.getMinutes()+t.getSeconds();this.GenerateReport(this.reportType,"z-tape-"+r.Preference.WorkstationID+"-"+i)},PrintSpecificZtape:function(t){e("#main-transaction-blockoverlay").show(),r.PreventDrawerKick=!0,this.openDate=t,this.closeDate="",this.reportType="SpecificZtape";var i=new Date,o=i.getMonth()+1+i.getDate()+i.getFullYear()+i.getHours()+i.getMinutes()+i.getSeconds();this.GenerateReport(this.reportType,"specific-z-tape-"+r.Preference.WorkstationID+"-"+o)},PrintDateZtape:function(t,i){e("#main-transaction-blockoverlay").show(),r.PreventDrawerKick=!0,this.openDate=t,this.closeDate=i,this.reportType="DateZtape";var o=new Date,n=o.getMonth()+1+o.getDate()+o.getFullYear()+o.getHours()+o.getMinutes()+o.getSeconds();this.GenerateReport(this.reportType,"date-z-tape-"+r.Preference.WorkstationID+"-"+n)},ChangeItemPriceOnUnitMeasure:function(e){this.GetSaleItemPriceTax(e.get("ItemCode"),r.CustomerCode,e.get("WarehouseCode"),e.get("UnitMeasureCode"),r.Preference.TaxByLocation,this.GetCouponID(),e,"UpdateUnitMeasure")},ChangeItemPriceOnWarehouseCode:function(e){r.IsChangeWarehouse=!0,this.GetSaleItemPriceTax(e.get("ItemCode"),r.CustomerCode,e.get("WarehouseCode"),e.get("UnitMeasureCode"),r.Preference.TaxByLocation,this.GetCouponID(),e,"UpdateWarehouseCode")},UpdateItemPriceOnUnitMeasure:function(e,t,i){var o=e.get("UnitMeasureCode"),n=e.get("UnitMeasureQty"),a=this.cartCollection.find(function(e){return e.get("ItemCode")==t&&e.get("UnitMeasureCode")==o&&e.get("LineNum")==i});a&&(this.cartCollection.each(function(e){a.cid==e.cid&&e.set({UnitMeasureQty:n})},this),a.set({IsOutOfStock:e.get("IsOutOfStock")}),a.updateSalesPriceRate(parseFloat(e.get("Price")),"UnitMeasureUpdated"))},UpdateItemPriceOnWarehouseCode:function(e,t,i){var o=i.get("SalesPrice"),n=this.cartCollection.find(function(i){return i.get("ItemCode")===t&&i.get("LineNum")===e.get("LineNum")});n&&(n.set({IsOutOfStock:e.get("IsOutOfStock")}),n.updateSalesPriceRate(parseFloat(o),"QuantityOrderedUpdated"))},GetSimilarItemsOnCart:function(e,t,i){if(!e||!e.attributes)return null;var o=new Array;return this.cartCollection&&this.cartCollection.length>0&&(this.cartCollection.each(function(i){(t||i.attributes.LineNum!=e.attributes.LineNum)&&i.attributes.ItemCode==e.attributes.ItemCode&&i.attributes.WarehouseCode==e.attributes.WarehouseCode&&(o[o.length]={ItemCode:i.attributes.ItemCode,ItemType:i.attributes.ItemType,Quantity:i.attributes.QuantityOrdered,UnitMeasureCode:i.attributes.UnitMeasureCode,WarehouseCode:i.attributes.WarehouseCode})}),!t)?o:(t&&i&&(o[o.length]={ItemCode:e.attributes.ItemCode,ItemType:e.attributes.ItemType,Quantity:1,UnitMeasureCode:e.attributes.UnitMeasureCode,WarehouseCode:e.attributes.WarehouseCode}),o)},GetTransactionCodeForStockVerification:function(){return!r.TransactionCode||r.TransactionType!=s.TransactionType.UpdateInvoice&&r.TransactionType!=s.TransactionType.ConvertOrder?null:r.TransactionCode},ChangeItemExtendedPrice:function(e,t,i){if(!this.ValidateTransactionAmount(this.couponModel,!1,0)){var o="A minimum transaction amount of "+r.CurrencySymbol+this.couponModel.get("RequiresMinimumOrderAmount").toFixed(2)+" is required to avail coupon "+this.couponModel.get("Description")+".";navigator.notification.alert(o,null,"Minimum Amount Required","OK"),this.VoidCoupon(!1)}if(this.IsRequireRecalculateCoupon()&&!i)this.RecalculateCoupon();else{if(!this.IsReturn()&&e&&e.get("LastEvent")&&"QuantityOrderedUpdated"==e.get("LastEvent")){var n=r.TransactionType;r.TransactionType==s.TransactionType.UpdateInvoice&&(n=s.TransactionType.ResumeSale);var a=e.clone();a.get("ItemType")===s.ItemType.NonStock&&a.set({WarehouseCode:r.LocationCode,IsOutOfStock:!1}),a.set({TransactionType:n,CustomerCode:r.CustomerCode,ShipToCode:r.ShipTo.ShipToCode,IsTaxByLocation:r.Preference.TaxByLocation,WebSiteCode:u.GetWebsiteCode()});var c=this,l=function(o,n,a){if(!c.CalculateItemExtPriceErrorHandler(o,n,a)){switch(c.item=c.GetSelectedItem(o.get("ItemCode"),o.get("UnitMeasureCode"),o.get("LineNum")),r.TransactionType){case s.TransactionType.SalesRefund:c.item.set({Good:t,ExtPriceRate:o.get("ExtPriceRate")}),u.IsNullOrWhiteSpace(e.get("DoNotChangePrice"))&&c.item.set({SalesPriceRate:o.get("SalesPriceRate"),SalesPrice:o.get("SalesPriceRate")});break;default:if(c.item.set({QuantityOrdered:t,QuantityDisplayed:t,ExtPriceRate:o.get("ExtPriceRate"),IsModified:!0}),u.IsNullOrWhiteSpace(e.get("DoNotChangePrice"))&&c.item.set({SalesPriceRate:o.get("SalesPriceRate"),SalesPrice:o.get("SalesPriceRate")}),o.get("ItemType")==s.ItemType.Kit){var l=new P,d=0,h=0;l.add(JSON.parse(window.sessionStorage.getItem("kitItems-"+o.get("LineNum")))),l.each(function(e){e.set("Quantity",t),e.set("Total",e.get("OriginalQuantity")*e.get("SalesPrice")),e.set("TotalRate",e.get("OriginalQuantity")*e.get("SalesPriceRate")),d+=e.get("Total"),h+=e.get("TotalRate")}),o.set("SalesPrice",d),o.set("SalesPriceRate",h),o.set("ExtPriceRate",h*t),window.sessionStorage.removeItem("kitItems-"+o.get("LineNum")),window.sessionStorage.setItem("kitItems-"+o.get("LineNum"),JSON.stringify(l)),this.cartView&&this.cartView.trigger("updateKitDisplay",o)}}if(!u.IsNullOrWhiteSpace(this.orginalResumeInvoiceCollection)&&this.orginalResumeInvoiceCollection.length>0){var p=0,C=!0;C=this.orginalResumeInvoiceCollection.find(function(e){var t=e.get("ItemCode")==o.get("ItemCode")&&e.get("WarehouseCode")==o.get("WarehouseCode");return t&&(p=e.get("OriginalQuantityAllocated")),t}),c.item.set({OriginalQuantityAllocated:p})}if(!u.IsNullOrWhiteSpace(e.get("DoNotChangePrice"))){var m=c.CalculateExtPrice(t,c.item.get("SalesPriceRate"),c.item.get("Discount"),c.item.get("CouponDiscountType"),c.item.get("CouponDiscountAmount"),c.item.get("CouponComputation"),c.item.get("LineNum"));c.item.set({ExtPriceRate:m})}c.cartView.UpdateExtPriceField(c.item.get("ExtPriceRate"),c.item),c.TaxChangeSaveSuccess(o,n,a),i&&(u.IsNullOrWhiteSpace(c.couponModel.get("CouponCode"))||this.LockTransactionScreen(!0,"Computing Coupon"),c.RecalculateCoupon())}};return a.set({SimilarItemsOnCart:c.GetSimilarItemsOnCart(a),DocumentCode:c.GetTransactionCodeForStockVerification()}),void this.CalculateItemExtPrice(a,l)}console.log("Sales Price Rate : "+e.get("SalesPriceRate")+" Change Price : "+e.get("DoNotChangePrice"));var d=this.CalculateExtPrice(t,e.get("SalesPriceRate"),e.get("Discount"),e.get("CouponDiscountType"),e.get("CouponDiscountAmount"),e.get("CouponComputation"),e.get("LineNum")),h=e.get("SalesTaxCode");switch(null!=h&&""!=h||(h=e.get("TaxCode")),r.TransactionType){case s.TransactionType.SalesRefund:e.set({Good:t,ExtPriceRate:d});break;default:e.set({QuantityOrdered:t,ExtPriceRate:d,TaxCode:h})}this.cartView.UpdateExtPriceField(d,e),this.ChangeItemTax(e)}},GetSelectedItem:function(e,t,i){var o=this.cartCollection.find(function(o){return o.get("ItemCode")===e&&o.get("UnitMeasureCode")===t&&o.get("LineNum")==i});return o},TaxChangeSaveSuccess:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.item=this.GetSelectedItem(e.get("ItemCode"),e.get("UnitMeasureCode"),e.get("LineNum")),this.item.set({SalesTaxAmountRate:e.get("SalesTaxAmountRate"),SalesTaxAmountRateCache:e.get("SalesTaxAmountRateCache"),IsOutOfStock:e.get("IsOutOfStock")}),this.cartView.UpdateSalesTaxAmountField(this.item.get("SalesTaxAmountRate"),this.item);var o=this.NotifyIfItemIsOutOfStock(this.item.attributes);null==e.get("LogCurrentTransaction")||1==e.get("LogCurrentTransaction")?0==o?r.ManagerValidated||(this.item.set({QuantityOrdered:r.PreviousAssignedItemQty}),this.UpdateCartItem(this.item,0,"QuantityOrderedUpdated",!0),0==r.Preference.IsAutoAdjustmentStock&&1==this.item.get("IsOutOfStock")&&(r.msgTitle="Stock Verification",r.msg1="Item '"+this.item.get("ItemName")+"' does not have enough stock. Turn on Auto Adjustment stock on Settings to add item with no stock.",navigator.notification.alert(r.msg1,null,r.msgTitle,"OK"))):this.OnRequestCompleted("TaxChangeSaveSuccess"):this.item.set({LogCurrentTransaction:null},{silent:!0})},TaxChangeSaveError:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Updating Item"),r.IsLoadingTransaction=!1},TaxGroupChangeSaveSuccess:function(e,t,i){var n,a,c=this;r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator();var l=r.TransactionType==s.TransactionType.UpdateInvoice&&!r.IsLoadingTransaction;if(r.IsLoadingTransaction||(r.HasChanges=!0),r.IsLoadingTransaction=!1,null!=t.SOPDetails&&t.SOPDetails.length>0){this.cartCollection.reset(),u.IsNullOrWhiteSpace(this.isFocusOnThisModel)||(n=o.find(t.SOPDetails,function(e){return e.ItemCode===c.isFocusOnThisModel.ItemCode&&e.UnitMeasureCode===c.isFocusOnThisModel.UnitMeasureCode}),!u.IsNullOrWhiteSpace(n)&&"None"!=n.SerializeLot&&n.ItemType===s.ItemType.GiftCard&&n.ItemType===s.ItemType.GiftCertificate&&!u.IsNullOrWhiteSpace(this.serializeLotCollection)&&this.serializeLotCollection.length>0&&(a=this.serializeLotCollection.find(function(e){return e.get("ItemCode")===n.ItemCode&&e.get("LineNum")===n.LineNum&&e.get("UnitMeasureCode")===n.UnitMeasureCode})));for(var d=0;d<t.SOPDetails.length;d++)if(this.cartCollection.add(t.SOPDetails[d]),u.IsNullOrWhiteSpace(n)&&(n=t.SOPDetails[d]),1==t.SOPDetails[d].IsPromoItem){var h=new P(t.CustomerPromotionDetails[0]);this.cartView.trigger("updatePromoDisplay",h,t.SOPDetails[d].QuantityOrdered)}if(!this.isNoCouponAtFirst&&!e.isAcceptCoupon&&this.IsRequireRecalculateCoupon())if(r.TransactionType===s.TransactionType.ConvertOrder)if(n.ItemType===s.ItemType.GiftCard||n.ItemType===s.ItemType.GiftCertificate){if(u.IsNullOrWhiteSpace(a))if(n.AutoGenerate)var p=!0;else var p=!1;else var p=!1;this.ProcessAutoandManualGC(t.SOPDetails,p)}else this.ProcessGC(t,n);else(r.TransactionType!=s.TransactionType.UpdateInvoice||l)&&this.ProcessGC(t,n);this.cartView&&this.cartView.ReloadModel(),this.isFocusOnThisMOdel=null}this.paymentCollection&&this.ReloadPayments(this.paymentCollection.models),this.OnRequestCompleted("TaxGroupChangeSaveSuccess"),r.AllowToFetchPotentialDiscount&&this.CheckPotentialDiscount(!1,!0,r.LatestPaymentDate)},TaxGroupChangeSaveError:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Updating Items")},ProcessGC:function(e,t){var o=e.SOPDetails[i];u.IsNullOrWhiteSpace(t)||(o=t),o.QuantityShipped=o.QuantityOrdered,this.ValidateSerializeLot(e.SOPDetails[i].SerializeLot,o.ItemCode,this.GetItemDisplayName(new f(o)),o.LineNum?o.LineNum:this.GetLineNum(),o.ItemType,o.UnitMeasureCode,"",o)},ChangeItemTax:function(e){this.RemoveTermDiscountPayment();var t=this.ConvertToSaleItem(e);t.on("sync",this.TaxChangeSaveSuccess,this),t.on("error",this.TaxChangeSaveError,this),t.url=r.ServiceUrl+c.SOP+l.SALEITEMTAX,t.save()},ChangeItemGroupTax:function(e,t){for(var i=new f,o=[],n=0;n<e.length;n++)o[n]=this.ConvertToSaleItem(e.at(n));e.reset(o),i.set({SOPDetails:e,DiscountType:r.ShipTo.DiscountType,DiscountPercent:r.ShipTo.DiscountPercent,SalesOrderCode:r.TransactionCode,SessionID:r.GUID,TransactionType:r.TransactionType,IsUsePOSShippingMethod:r.Preference.IsUsePOSShippingMethod,POSShippingMethod:r.Preference.POSShippingMethod}),this.RemoveWarehouseCodeByItemType(i.get("SOPDetails")),i.isAcceptCoupon=t,i.on("sync",this.TaxGroupChangeSaveSuccess,this),i.on("error",this.TaxGroupChangeSaveError,this),i.url=r.ServiceUrl+c.SOP+l.SALEITEMGROUPTAX,i.save()},ConvertToSaleItem:function(e){var t=e.clone();t.set({CustomerCode:r.CurrentCustomer.CustomerCode,IsTaxByLocation:r.Preference.TaxByLocation,ShipToCode:r.ShipTo.ShipToCode,ExtPriceRate:e.get("ExtPriceRate"),DiscountType:r.ShipTo.DiscountType,DiscountPercent:r.ShipTo.DiscountPercent,DiscountableDays:r.ShipTo.DiscountableDays,IsUsePOSShippingMethod:r.Preference.IsUsePOSShippingMethod,POSShippingMethod:r.Preference.POSShippingMethod});var i=new P;return i.reset(r.InvoiceDetailsResponse),r.TransactionType==s.TransactionType.SalesRefund&&i.length>0&&i.each(function(e){e.get("ItemCode")==t.get("ItemCode")&&(t.TaxCode=e.get("TaxCode"))}),t},GetUpdatedItemQuantity:function(e,t){var i=0,o=0;switch(r.TransactionType){case s.TransactionType.Return:case s.TransactionType.SalesRefund:if(i=parseInt(e.get("Good")),0===i&&t===-1)return;o=e.get("Outstanding");break;default:i=parseInt(e.get("QuantityOrdered")),(1===i&&t===-1||i===-1&&1===t)&&"P"==!e.get("Status")&&(i=0)}if(t&&(i+=t),r.TransactionType==s.TransactionType.SalesRefund&&r.TransactionType==s.TransactionType.Return&&!e.get("IsNewLine")){if(i>o)return console.log("Quantity must be less than Outstanding."),navigator.notification.alert("Quantity must be less than or equal to the Outstanding quantity.",null,"Action Not Allowed","OK"),null;if(e.get("ItemType")==s.ItemType.GiftCard||e.get("ItemType")==s.ItemType.GiftCertificate){var n=e.get("NumOfActivatedGCard"),a=0;if(n>0&&(a=o-n-i,a<0))return navigator.notification.alert("Returning an activated gift card/certificate is not allowed.",null,"Action Not Allowed","OK"),null}}return i},IsHoldSVG:function(){if(!r.SVG_Hold)return!1;if(0==r.SVG_Hold.length)return!1;if(this.SVGHasError())return!0;for(var e=!1,t=0;t<r.SVG_Hold.length;t++)if(r.SVG_Hold[t].length>0)return!0;return r.SVG_Hold=new Array,e},SVGHasError:function(){if(!r.SVG_Hold)return!1;if(0==r.SVG_Hold.length)return!1;for(var e=!1,t=0;t<r.SVG_Hold.length;t++)if("ERROR"==r.SVG_Hold[t])return this.LockTransactionScreen(!1,"Saving..."),!0;return e},ValidateSVG:function(e,t){if(!e)return e;var i="[SVGID]:"+Math.random()+"-"+Math.random(),o=8e3,n=!1;if(r.SVGArray||(r.SVGArray=new Array),e.indexOf("[SVGID]:")!==-1){for(var a=0;a<r.SVGArray.length;a++)r.SVGArray[a].ID==e&&(e=r.SVGArray[a].SVG,n=!0);n||(r.SVGArray[r.SVGArray.length]={ID:e,SVG:e})}else r.SVGArray[r.SVGArray.length]={ID:i,SVG:e};if(e.length<=o)return e;for(var s=0,u=0,d=new Array,h=!0;h;){s+=1,u+=1;var p=e.substr((u-1)*o,o);0==e.substr(u*o).length&&(h=!1);var C={Part:u,SVG:p};d[d.length]=C}for(var m=new Array,a=0;a<d.length;a++){var T=new v;T.set({SignatureID:i,PartNumber:d[a].Part,PartCount:s,SignatureSVG:d[a].SVG}),T.url=r.ServiceUrl+c.POS+l.UPDATESIGNATURE;var g=r.SVG_Hold.length;r.SVG_Hold[g]=i+"OF"+d[a].Part,m[m.length]=T}return this.SaveSVG(m,1,t),console.log("SVG Validated"),i},SaveSVG:function(e,t,i){if(0!=e.length&&!(t>e[0].get("PartCount")))for(var o=this,n=e,a=t,s=(e[0].get("PartCount"),0);s<e.length;s++){var c=e[s];c.get("PartNumber")!=t||this.SVGHasError()||c.save(c,{success:function(e,t){if(r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.Value){console.log("SVG Part Number: "+a+" of "+e.get("SignatureID")+" Saved!");for(var s=0;s<r.SVG_Hold.length;s++)r.SVG_Hold[s]==e.get("SignatureID")+"OF"+e.get("PartNumber")&&(r.SVG_Hold[s]="");i(),o.SaveSVG(n,a+1,i)}},error:function(e,t,o){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator();for(var n=0;n<r.SVG_Hold.length;n++)r.SVG_Hold[n]==e.get("SignatureID")+"OF"+e.get("PartNumber")&&(r.SVG_Hold[n]="ERROR");i(),console.log("SVG Part Number: "+a+" of "+e.get("SignatureID")+" Error!"),navigator.notification.alert("An error was encoutered while trying to save signatures.",null,"Error Saving Signature","OK")}})}},AssignCurrency:function(e){r.CurrencySymbol=e.Symbol,r.CurrencyDecimalSeparator=e.CurrencyDecimalSeparator,r.CurrencyGroupSeparator=e.CurrencyGroupSeparator,r.CurrencyDecimalDigits=e.CurrencyDecimalDigits,r.CurrencyGroupSizes=e.CurrencyGroupSizes},SetImageLocation:function(e){r.ISEImageSize=this.AssignImageSize(e.ISEImageSize),r.IsUseISEImage=e.IsUseISEImage,r.WebSiteURL=this.ValidateURL(e.WebSiteURL),r.WebSiteCode=e.WebSiteCode,console.log(r.WebSiteURL+"/"+l.ISEIMAGES+r.ISEImageSize)},ValidateURL:function(e){var t=e;return t="/"!==e.charAt(e.length-1)?e:e.slice(0,-1)},AssignImageSize:function(e){var t;switch(e){case 0:t="medium/";break;case 1:t="large/";break;case 2:t="icon/";break;case 3:t="minicart/";break;case 4:t="mobile/"}return t},ValidateDefaultLocation:function(e){r.Preferences.Warehouses=e;var t=r.Preference.DefaultLocation,i=o.pluck(e,"WarehouseCode"),n=o.contains(i,t);n?r.ValidLocation=!0:r.ValidLocation=!1},NotifyMsg:function(e,t,i,o){console.log(e),o?u.ShowNotification("The coupon is not applied because items does not meet the coupon's requirements. Please check the coupon setup in Connected Business for more details.",!0,o,!0):navigator.notification.alert(e,null,t,"OK",i)},OnRequestCompleted:function(e){switch(e){case l.SALEITEMPRICETAX:case l.SALEITEMPRICETAXBYUPC:case l.SALEKITITEMTAX:case l.SALEBUNDLEGROUPTAX:case"VoidItem":this.couponModel&&(this.IsReturn()||"Amount"==this.couponModel.get("DiscountType")||this.validateCouponRequirement());case"TaxChangeSaveSuccess":case"TaxGroupChangeSaveSuccess":case"UpdateRecalculatedItemsCompleted":case"LoadInvoiceCompleted":case"LoadOrderCompleted":case"PaymentAdded":case"PaymentRemoved":case"ClearTransaction":case"SignatureRetrieved":case"PINRetrieved":case"SaveNotes":case"EditKitDetails":r.AskPIN=!1,r.AskSignature=!1,this.LogCurrentTransaction(e);break;case"AskForPIN":r.AskPIN=!0,r.AskSignature=!1,this.LogCurrentTransaction(e);break;case"AskForSignature":r.AskSignature=!0,r.AskPIN=!1,this.LogCurrentTransaction(e)}},validateCouponRequirement:function(){if(0!=this.cartCollection.length&&r.TransactionType!=s.TransactionType.SalesRefund&&this.couponModel&&(this.GetCouponID()||"Stackable"==this.couponModel.get("CouponComputation")&&"Amount"==this.couponModel.get("DiscountType"))){var e;e="Orders"==this.couponModel.get("CouponType")?this.cartCollection.find(function(e){return e.get("CouponCode")}):0==this.couponModel.get("IncludeAllProduct")?this.cartCollection.find(function(e){return 1==e.get("IsIncludedInCoupon")}):this.cartCollection.find(function(e){return e.get("CouponCode")}),e||(this.NotifyMsg("The coupon is not applied because items does not meet the coupon's requirements. Please check the coupon setup in Connected Business for more details. ","",!1,5e3),this.VoidCoupon(!1))}},LogCurrentTransaction:function(e){var t=new f({WorkstationID:r.POSWorkstationID}),i=r.TransactionCode,o=r.TransactionType,n=this.GetTransactionSubTotal(),a=this.summaryModel.get("TaxDisplay"),c=this.summaryModel.get("Payment"),l=this.summaryModel.get("Balance"),d=this.summaryModel.get("Qty"),h=!u.IsNullOrWhiteSpace(r.AskSignature)&&r.AskSignature,p=!u.IsNullOrWhiteSpace(r.AskPIN)&&r.AskPIN,C=format("0.0000",this.summaryModel.get("TotalTax")),m=new f({TransactionCode:i,Type:o,Total:n,TaxRate:a,Payment:c,BalanceRate:l,TotalQuantity:d,AskSignature:h,AskPIN:p,PINType:r.PINType});if(this.cartCollection&&this.cartCollection.length>0){r.TransactionType==s.TransactionType.SalesRefund&&(l=n+1*this.RoundNumber(C,2));var T=new P,g=new P,y=new P(r.Preference);this.cartCollection.each(function(e){var t=r.Preference.IsUseItemDescription?e.get("ItemDescription"):e.get("ItemName"),i=u.IsNullOrWhiteSpace(e.get("CouponDiscountAmount"))?0:e.get("CouponDiscountAmount"),o=0!=i?e.get("CouponCode"):"",n=0==e.get("QuantityDisplay")?0:i,a=e.get("ItemCode"),s=e.get("LineNum"),c=e.get("UnitMeasureCode"),l=e.get("CouponDiscountType"),d=u.IsNullOrWhiteSpace(e.get("Discount"))?0:e.get("Discount"),h=u.IsNullOrWhiteSpace(e.get("SalesPriceRate"))?0:e.get("SalesPriceRate"),p=u.IsNullOrWhiteSpace(e.get("QuantityDisplay"))?0:e.get("QuantityDisplay"),C=u.IsNullOrWhiteSpace(e.get("SalesTaxAmountRate"))?0:e.get("SalesTaxAmountRate"),y=u.IsNullOrWhiteSpace(e.get("ExtPriceRate"))?0:e.get("ExtPriceRate"),S=JSON.parse(window.sessionStorage.getItem("kitItems-"+s)),f=e.get("ItemType");T.add({ItemCode:a,LineNum:s,ItemName:t,UnitMeasureCode:c,CouponCode:o,CouponDiscountRate:n,CouponDiscountType:l,DiscountAmountRate:d,SalesPriceRate:h,QuantityOrdered:p,SalesTaxAmountRate:C,ExtPriceRate:y,ItemType:f});var I=T.reduce(function(e,t){return e+t.get("SalesPriceRate")*t.get("QuantityOrdered")},0),v=(T.reduce(function(e,t){return e+t.get("ExtPriceRate")},0),T.find(function(e){return e.get("DiscountAmountRate")>0}));v||(v=T.find(function(e){return e.get("CouponDiscountRate")>0})),_totalDiscount=I!=m.get("Total")&&v?I-m.get("Total"):0,m.set("TotalDiscount",_totalDiscount),S&&g.add(S)})}t.set({SOP:m,SOPDetails:T,SOPKitDetails:g,Preferences:y}),this.LogCurrentTransactionSignalR(t,e)},LogCurrentTransactionSignalR:function(e,t){null==this.signalRConnection&&this.StartSignalR(),this.secondaryHubProxy.invoke("logCurrentTransaction",e.toJSON(),this.signalRConnectionID,r.POSWorkstationID).done(function(e){}.bind(this)).fail(function(e){})},LeavePOSView:function(){this.performAction=!0,this.VoidTransactionWithValidation()},PerformAction:function(){this.performAction&&(this.performAction=!1,this.actionsView.SetHasOpenTransaction(this.HasOpenTransaction()),this.actionsView.CheckTransaction())},ProcessPublicNoteForm:function(e){var t="",i="",o="";(void 0!=this.transactionCollection||null!=this.transactionCollection)&&this.transactionCollection.length>0?(i=new P(this.transactionCollection.at(0).get("SalesOrders")),t=i.at(0),o=r.MaintenanceType.UPDATE):o=r.MaintenanceType.CREATE,this.ShowOrderNotesForm(e,t,o)},ShowOrderNotesForm:function(t,i,o){e("#main-transaction-blockoverlay").show(),e("#orderNotesContainer").append("<div id='orderNotes'></div>");var n=new ve({el:e("#orderNotes"),type:t,note:r.PublicNote,model:i,maintenanceType:o});n.on("orderNotesSaved",this.ProcessSavedNotes,this),n.on("customerNotesSaved",this.ProcessCustomerSavedNotes,this)},ProcessSavedNotes:function(e,t,i,o){switch(t){case r.NoteType.LineItem:r.HasChanges=!0,i&&i.set({ItemDescription:e}),this.cartView&&this.cartView.ReloadModel();break;case r.NoteType.OrderNotes:r.HasChanges=!0,r.PublicNote.PublicNotes=e,console.log("Retrieved: "+r.PublicNote.PublicNotes)}this.OnRequestCompleted("SaveNotes"),o.CloseOrderNotes()},ProcessCustomerSavedNotes:function(e,t,i,o){var n="";switch(t){case r.MaintenanceType.CREATE:n=r.ServiceUrl+c.CUSTOMER+l.ADDCUSTOMERNOTE;break;case r.MaintenanceType.UPDATE:n=r.ServiceUrl+c.CUSTOMER+l.UPDATECUSTOMERNOTE;break;case r.MaintenanceType.DELETE:n=r.ServiceUrl+c.CUSTOMER+l.DELETECUSTOMERNOTE}this.ProcessAddCustomerNote(e.EntityCode,e.ContactCode,e.Title,e.NoteText,e.NoteCode,n,t),o.CloseOrderNotes()},ProcessAddCustomerNote:function(e,t,i,o,n,a,s){var c=new f,l=this;c.set({EntityCode:e,NoteText:o,Title:i,NoteCode:n,ContactCode:t,UserCreated:r.Username,UserModified:r.Username}),c.url=a,c.save(c,{success:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),l.headerinfo&&l.headerinfo.ReloadNote()},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()}})},ProcessNoteRemoval:function(e,t,i){if(i==r.MaintenanceType.DELETE){var o=new f,n=this;o.set({EntityCode:t.get("EntityCode"),NoteText:t.get("NoteText"),Title:t.get("Title"),NoteCode:t.get("NoteCode"),ContactCode:t.get("ContactCode")}),o.url=r.ServiceUrl+c.CUSTOMER+l.DELETECUSTOMERNOTE,o.save(o,{success:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),n.headerinfo&&n.headerinfo.ReloadNote()},error:function(e,t,i){r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()}})}},GetItemDisplayName:function(e){var t="";return t=r.Preference.IsUseItemDescription?e.get("ItemDescription"):e.get("ItemName")},ShowGiftCardRecharge:function(t){t.stopPropagation(),e("#main-transaction-blockoverlay").show(),u.BlurItemScan(),this.giftCardView||this.InitializeGiftCardView(),this.cartCollection.length>0?this.giftCardView.hasItemOnCart=!0:this.giftCardView.hasItemOnCart=!1,this.giftCardView.viewType="POS",this.giftCardView.IsActivated=!1,this.giftCardView.InitializeGiftCardModel(),this.giftCardView.ShowGCardRechargeForm()},InitializeGiftCardView:function(){this.giftCardView=new we({el:e("#giftCardContainer")}),this.giftCardView.validateLocationBankAccount=function(){return this.ValidateLocationBankAccount()}.bind(this),this.giftCardView.on("proceedToRecharge",this.FindGiftCardDetail,this),this.giftCardView.on("askToEnterPIN",this.FetchGiftDetails,this),this.giftCardView.on("stopAskingPIN",this.StopPINRetrieval,this)},FindGiftCardDetail:function(e){r.OnRechargeProcess=!0,r.GCardAttributes=e.attributes,this.ProcessChangeCustomer()},ProcessChangeCustomer:function(){this.headerinfo||this.InitializeMainTransactionHeader();var e=r.GCardAttributes.CustomerCode;this.headerinfo.InitializeCustomer(1,e,"",!0)},ProcessItemLookup:function(){var e=r.GCardAttributes.ItemCode,t=r.GCardAttributes.UnitMeasureCode;this.GetLookupItems(1,t,e)},ConitinueRechargeGiftCard:function(e){this.tmpModel=new f,this.tmpModel.set(e[0]),this.tmpModel.set({Price:r.GCardAttributes.SalesPriceRate}),this.AddToCart(this.tmpModel)},AssignExistingSerial:function(e,t,i,o,n,a){this.InitializeSerializeLotCollection();var s=r.GCardAttributes,c={SerialLotNumber:s.SerialLotNumber,ItemCode:s.ItemCode,LineNum:o,ItemType:s.ItemType,SerialLotCode:1,SerialLotType:e,UnitMeasureCode:a,IsIncluded:!0,IsRecharged:!0};this.serializeLotCollection.reset(),this.serializeLotCollection.add(c),this.giftCardView.Hide()},CompleteRechargeAction:function(){r.OnRechargeProcess&&this.AddSuspend()},FetchGiftDetails:function(e,t){t.viewType="POS",r.PINType=e,this.OnRequestCompleted("AskForPIN")},StopPINRetrieval:function(){this.OnRequestCompleted("PINRetrieved"),this.StopFetchingPIN()},BeginFetchingPIN:function(){var e=this;this.giftPINTimeInterval&&this.StopFetchingPIN(),this.giftPINTimeInterval=window.setInterval(function(){e.FetchPINDetail()},250)},StopFetchingPIN:function(){window.clearInterval(this.giftPINTimeInterval),r.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()},FetchPINDetail:function(){var e=new f;e.url=r.ServiceUrl+c.POS+l.CURRENTPIN,e.set({WorkstationID:r.POSWorkstationID});var t=this;e.save(null,{success:function(e,i,o){i&&(i.ErrorMessage?(t.NotifyMsg(i.ErrorMessage,null,"Error Fetching PIN"),t.StopFetchingPIN()):i.PINDetail&&(r.AskPIN=!1,t.StopFetchingPIN(),t.ValidatePINFetched(i.PINDetail),t.OnRequestCompleted("PINRetrieved")))},error:function(e,i,o){t.StopFetchingPIN(),t.OnRequestCompleted("PINRetrieved")}})},DecryptPIN:function(e){return e?Base64.decode(e):e},ValidatePINFetched:function(e){var t=this.DecryptPIN(e);r.PIN=t;var i=null;switch(r.ViewRecipient){case"Recharge":i=this.giftCardView;break;case"Payment":i=this.paymentView;break;default:console.log("no view recepient")}i&&i.PopulatePINFields(t)},FocusToItemScan:function(e){if(r.isBrowserMode){if(!e)return void(r.IsOnItemDetail||u.FocusToItemScan());e.preventDefault(),this.DoFocusItemScan(e)&&u.FocusToItemScan()}},DoFocusItemScan:function(t){for(var i=t.target.id,o=["select","input","textarea"],n=!1,a=0;a<o.length;a++){var s=e("#"+i).is(o[a]);s&&(n=s)}if(r.IsOnItemDetail);else if(n);else if("quantityDisplay"!=i&&"itemPriceDisplay"!=i&&"discountDisplay"!=i)return!0;return!1},UpdateLoggedReasons:function(e){if(e&&r.LoggedReasons&&0!=r.LoggedReasons.length){var t,i=!1,o=!1;switch(r.TransactionType){case s.TransactionType.Sale:case s.TransactionType.Suspend:if(!e.Invoices)return;if(0==e.Invoices.length)return;t=e.Invoices[0].InvoiceCode;break;case s.TransactionType.Order:case s.TransactionType.Quote:if(!e.SalesOrders)return;if(0==e.SalesOrders.length)return;t=e.SalesOrders[0].SalesOrderCode;break;case s.TransactionType.SalesRefund:var n=!0;if(e.TransactionCode||(n=!1),i=!0,n)t=e.TransactionCode;else{if(e.ErrorMessage&&""!=e.ErrorMessage){n=!0,o=!0,t=r.TransactionCode;break}if(e.Invoices&&e.Invoices.length>0&&e.Invoices[0].InvoiceCode&&(n=!0,t=e.Invoices[0].InvoiceCode),!n)return}}if(t){var a=!1;if(r.LoggedReasons.each(function(e){i&&e.set({TransactionCode:t,TransactionType:r.TransactionType+(o?" (Failed)":"")}),a||i||e.get("TransactionCode")&&""!=e.get("TransactionCode")||(a=!0)}),a||i){var l=r.TransactionType,u=new f;u.url=r.ServiceUrl+c.POS+"updatereason/"+t+"/"+l,u.set({POSReasonLogs:r.LoggedReasons.toJSON()}),u.save(u,{success:function(){console.log("Logged Reasons Updated: Success!")},error:function(){console.log("Logged Reasons: Failed!")}})}}}},RemoveTermDiscountPayment:function(){if(this.paymentCollection&&0!=this.paymentCollection.length&&r.TransactionType!=s.TransactionType.SalesRefund){var e=this.paymentCollection.find(function(e){return"Term Discount"==e.get("PaymentType")});e&&this.paymentCollection.remove(e)}},RemoveScreenOverLay:function(){u.POS.Overlay.Hide()},IsItemGiftCredit:function(e){var t=e.attributes.ItemType;return t==s.ItemType.GiftCard||t==s.ItemType.GiftCertificate},IsItemQuantityAllowed:function(e){return e>=0||(1==this.CartHasGiftCredit()?(this.NotifyMsg("Item exchange is not allowed for transactions with Gift Cards. Please create a separate transaction."),!1):void 0)},AllowToAddGiftCredit:function(e){return 1!=this.CartHasNegativaQty()},CartHasGiftCredit:function(){var e=this.cartCollection.find(function(e){return e.get("ItemType")==s.ItemType.GiftCard||e.get("ItemType")==s.ItemType.GiftCertificate});return!!e},CartHasNegativaQty:function(){var e=this.cartCollection.find(function(e){return e.get("QuantityOrdered")<0});return!!e},GetFullTime:function(){var e=new Date;return e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+"."+e.getMilliseconds();
},LogWithTime:function(e){console.log("@"+this.GetFullTime()+" : "+e)},GetInProgressOverlayHtml:function(){return'<div id="inprogress-blockoverlay" class="blockOverlay" style="display: block;"></div>'},GetInProgressSpinHtml:function(){return'<div class="spin-container" id="inprogress-spinner"style="padding:30px 15px;border-radius: 8px; background-color: #000; opacity: 0.6; margin:0 auto; position:absolute; top:45%; left:45%;"><h5 style="color:#fff; text-align: center; position:relative; top:25px; text-shadow:none !important;">Finishing...</h5></div>'},ToggleInprogressOverlay:function(){var t=this.GetInProgressOverlayHtml(),i="block"==e("#main-transaction-blockoverlay").css("display");e("#spin").length>0;if(0==e("#inprogress-blockoverlay").length&&e("#main-transaction-blockoverlay").after(t),this.IsSavingTransactionOngoing){if(e("#inprogress-blockoverlay").show(),!i){e("#inprogress-spinner").show();var o=document.getElementById("inprogress-spinner");this.transactionSpinner||(this.transactionSpinner=Ue.newInstance()),this.transactionSpinner.opts.color="#fff",this.transactionSpinner.opts.lines=13,this.transactionSpinner.opts.length=7,this.transactionSpinner.opts.width=4,this.transactionSpinner.opts.radius=10,this.transactionSpinner.opts.top="auto",this.transactionSpinner.opts.left="auto",this.transactionSpinner.spin(o),e("#inprogress-spinner > div").length>0&&e("#inprogress-spinner > div").css("position","relative").css("left","50%").css("top","40%")}}else e("#inprogress-blockoverlay").hide(),e("#inprogress-spinner").hide(),this.transactionSpinner&&this.transactionSpinner.stop();e("#inprogress-blockoverlay").css("opacity",i?0:.6)},ShowTaxList:function(){var e=new te;e.on("changeTaxCode",function(e){this.cartCollection.each(function(t){t.set("TaxCode",e),t.set("IsModified",!0)}),this.ResetTermDiscount(),this.ChangeItemGroupTax(this.cartCollection)}.bind(this)),this.$el.find("#tax-override-list").html(e.render().el),this.$("#tax-override-list").find("#taxListContainer").listview().listview("refresh")},LoadLocationTaxCode:function(){var e=new f;e.url=r.ServiceUrl+c.SOP+l.GETLOCATIONTAXCODE+r.LocationCode+"/"+r.CustomerCode,e.fetch({success:function(e,t,i){window.sessionStorage.setItem("selected_taxcode",t.Value)}.bind(this),error:function(e,t,i){console.log(t)}.bind(this)})},ShowBundleConfigurator:function(e){var t=new ke({model:e});t.on("getitems",function(e){this.itemPriceCollection.reset(e),this.OnRequestCompleted(l.SALEBUNDLEGROUPTAX)}.bind(this)),this.$el.find("#bundle-configurator-container").html(t.render().el),this.$("#bundle-configurator-container").find("ul").listview().listview("refresh")},ShowKitConfigurator:function(e,t){var i=new Le({model:e,isEditMode:t,lineNum:t?e.get("LineNum"):this.GetLineNum(),coupon:this.couponModel});i.on("getItems",this.processKitConfigurator,this),i.on("editItems",this.editKitConfigurator,this),this.$el.find("#kit-configurator-container").html(i.render().el),this.$("#kit-configurator-container").find("ul").listview().listview("refresh")},isShowConfigurator:!0,processKitConfigurator:function(e,t){this.isShowConfigurator=!1;var i=o.first(e.SaleItems),n=i.ItemCode,a=i.UnitMeasureCode,r=this.IsReturn(),c=this.cartCollection.find(function(e){return r?e.get("ItemCode")==n&&e.get("UnitMeasureCode")==a&&e.get("IsNewLine")&&e.get("ItemType")==s.ItemType.Kit:e.get("ItemCode")==n&&e.get("unitMeasureCode")==a&&e.get("ItemType")==s.ItemType.Kit}),u=c?c.get("LineNum"):this.GetLineNum();o.each(e.KitDetailSaleItems,function(e){e.LineNum=u}),window.sessionStorage.setItem("kitItems-"+u,JSON.stringify(e.KitDetailSaleItems)),window.sessionStorage.setItem("kitBundleItems-"+u,JSON.stringify(e.KitBundleDetails)),this.itemPriceCollection.reset(e.SaleItems),this.isShowConfigurator=!0,this.OnRequestCompleted(l.SALEKITITEMTAX)},editKitConfigurator:function(e){this.isShowConfigurator=!1;var t=o.first(e.SaleItems),i=t.ItemCode,n=t.UnitMeasureCode,a=this.cartCollection.find(function(e){return e.get("ItemCode")==i&&e.get("UnitMeasureCode")==n&&e.get("ItemType")==s.ItemType.Kit});if(a){var c=a.get("LineNum"),l=c>0?c-1:c;this.cartCollection.trigger("itemRemoved",a),o.each(e.KitDetailSaleItems,function(e){e.LineNum=c}),window.sessionStorage.removeItem("kitItems-"+c),window.sessionStorage.setItem("kitItems-"+c,JSON.stringify(e.KitDetailSaleItems)),this.cartCollection.add(this.processItem(t,c),{at:l}),this.OnRequestCompleted("EditKitDetails")}r.HasChanges=!0,this.isShowConfigurator=!0},processItem:function(e,t){var i=0,o=this.CalculateExtPrice(0===e.Quantity?1:e.Quantity,e.Price,e.Discount,e.CouponDiscountType,e.CouponDiscountAmount,e.CouponComputation);e.OriginalQuantityAllocated&&(i=e.OriginalQuantityAllocated);var n={ItemCode:e.ItemCode,ItemName:e.ItemName,ItemDescription:e.ItemDescription,QuantityOrdered:0===e.Quantity?1:e.Quantity,QuantityShipped:1,SalesPriceRate:e.Price,SalesPrice:e.Price,SalesTaxAmountRate:e.Tax,UPCCode:e.UPCCode,ItemType:e.ItemType,Discount:u.ApplyAllowedDecimalFormat(e.Discount),LineNum:t,WarehouseCode:e.WarehouseCode,CouponDiscountType:e.CouponDiscountType,CouponCode:e.CouponCode,CouponDiscountAmount:e.CouponDiscountAmount,CouponComputation:e.CouponComputation,IsIncludedInCoupon:e.IsIncludedInCoupon,ExtPriceRate:o,UnitMeasureCode:e.UnitMeasureCode,UnitMeasureQty:e.UnitMeasureQty,SourceLineNum:0,IsOutOfStock:e.IsOutOfStock,Filename:e.Filename,SerializeLot:e.SerializeLot,IsModified:!0,InvoiceCode:"[To be generated]",OriginalQuantityAllocated:i,Status:e.Status,FreeStock:e.FreeStock,IsNewLine:!e.IsNewLine||e.IsNewLine,AutoGenerate:e.AutoGenerate};e.IsLoadedByUpc;return r.TransactionType===s.TransactionType.Return&&(n.Good=n.QuantityOrdered,n.QuantityAllocated=n.QuantityOrdered),n},StartSignalR:function(){var t=r.ServiceUrl+"signalr";this.signalRConnection=e.hubConnection(t,{useDefaultPath:!1}),this.secondaryHubProxy=this.signalRConnection.createHubProxy("secondaryDisplayHub"),this.transactionHubProxy=this.signalRConnection.createHubProxy("transactionHub"),this.secondaryHubProxy.on("logCurrentSignature",function(e){e&&e.SOP&&(e.ErrorMessage?this.NotifyMsg(e.ErrorMessage,null,"Error Fetching Signature"):e.SOP.SignatureDetail&&(r.AskSignature=!1,this.CheckSignatureFetched(e.SOP.SignatureDetail),this.OnRequestCompleted("SignatureRetrieved")))}.bind(this)),this.secondaryHubProxy.on("logCurrentPIN",function(e){e&&e.SOP&&(e.ErrorMessage?this.NotifyMsg(e.ErrorMessage,null,"Error Fetching PIN"):e.SOP.PINDetail&&(r.AskPIN=!1,this.ValidatePINFetched(e.SOP.PINDetail),this.OnRequestCompleted("PINRetrieved")))}.bind(this)),this.transactionHubProxy.on("transactionSaved",function(e){if(console.log(e),this.signalRConnectionStarted){if(r.OnRechargeProcess)return;this.LockTransactionScreen(!1),this.PrintAndEmailTransaction(e)}}.bind(this)),this.signalRConnection.logging=!0,this.signalRConnection.start().done(function(e){console.log(e.message),this.signalRConnectionStarted=!0,this.signalRConnectionID=e.id,this.secondaryHubProxy.invoke("joinGroup",r.POSWorkstationID)}.bind(this)).fail(function(e){console.log(e.message),this.logCurrentHubStarted=!1})},StopSignalR:function(){null!=this.signalRConnection&&(this.signalRConnection.stop(),this.signalRConnection=null,this.transactionHubProxy=null,this.secondaryHubProxy=null,this.signalRConnectionStarted=null,this.signalRConnectionID=null,r.HubConnectionID=null)}}),_e=function(e){console.log(e),1===e&&We.VoidTransactionWithValidation()},Je=function(e){1===e?Be.CreateTransaction():Be.RemoveScreenOverLay()};return qe});