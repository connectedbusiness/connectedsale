define(["jquery","mobile","underscore","backbone","model/base","collection/base","shared/enum","shared/global","shared/method","shared/service","shared/shared","model/postal","model/country","collection/postal","collection/countries","view/20.1.0/pos/keypad/keypad","view/20.1.0/pos/payment/gift","view/20.1.0/pos/payment/loyaltypoints","view/20.1.0/pos/postal/addpostal","text!template/20.1.0/pos/payment/payment.tpl.html","text!template/20.1.0/pos/payment/cash.tpl.html","text!template/20.1.0/pos/payment/check.tpl.html","text!template/20.1.0/pos/payment/creditcard.tpl.html","view/spinner","js/libs/jSignature.min.js","js/libs/moment.min.js","js/libs/format.min.js"],function(e,t,n,i,a,o,r,s,l,c,u,d,y,h,m,p,g,C,f,P,v,w,S,b){var k,T,N,x=function(e){1==e?N.AddNewPostal():N.ClearPostalDetails()},I=i.View.extend({_template:n.template(P),_cashTemplate:n.template(v),_checkTemplate:n.template(w),_creditCardTemplate:n.template(S),events:{"tap #keypad-done-btn":"btnSave_tap","tap #cmdDone":"btnSave_tap","tap #btn-cancelPayment":"btnClose_tap","tap .btn-clear-signature":"btnClearSignature_tap","tap #cc-swipe":"btnUni","change #cc-msg":"processMsg","change #isUnimag":"checkUnimag","tap #btn-more":"btnLoadMoreInfo_tap","change #ccCountry":"CountryChanged","change #ccCity":"CityChanged","keyup #ccPostal":"keyupPostal","blur  #ccPostal":"blurPostal","blur #ccEmail":"blurEmail","keydown #ccPhone":"txtPhone_Keydown","keyup #cardNumber":"cardNumber_keyup","focus #cardNumber":"AssignNumericValidation","focus #cvNumber":"AssignNumericValidation","focus #ccPhoneExt":"AssignNumericValidation","focus #ccPhone":"AssignNumericValidation","tap #btn-ask-to-sign":"btn_AskToSign","tap #btn-stop-asking":"btnCancel_Retrieval","blur #expDate":"ExpDate_blur","keydown #ccPhone":"CCPhone_keydown","keydown #expDate":"ExpDate_keydown"},ExpDate_keydown:function(t){if(s.isBrowserMode)return 9==t.keyCode?(e("#cvNumber").focus(),t.preventDefault(),!1):void 0},CCPhone_keydown:function(t){if(s.isBrowserMode)return 9==t.keyCode?(e("#ccPhoneExt").focus(),t.preventDefault(),!1):void 0},ExpDate_blur:function(){e("#cvNumber").focus()},btn_AskToSign:function(e){e.preventDefault(),this.$(".btn-ask-to-sign").attr("id","btn-stop-asking"),A(),this.trigger("allowUserToAttachSign","Payment",this)},btnCancel_Retrieval:function(e){e.preventDefault(),console.log("btnCancel_Retrieval"),this.$(".btn-ask-to-sign").attr("id","btn-ask-to-sign"),O(),this.trigger("cancelSignRetrieval","Refund",this)},SketchSignature:function(e){O(),B=!0,this.sketchView=!0,this.ShowSignatureDisplay(),this.LoadSignature(e)},LoadSignature:function(t){if(null!=t){var n=new Image;n.src="data:image/svg+xml;base64,"+t,this.$(".signatureDisplay").html(e(n))}},ShowSignatureDisplay:function(){this.sketchView&&(this.$(".signature").jSignature("reset"),this.$(".signature").hide(),this.$(".signatureDisplay").show())},keyupPostal:function(t){if(13===t.keyCode){this.keyupIsTriggered=!0;var n=e("#ccPostal").val();this.LoadPostal(n)}},AssignNumericValidation:function(e){s.isBrowserMode||u.Input.NonNegativeInteger("#"+e.target.id)},blurPostal:function(t){if(u.IsNullOrWhiteSpace(this.keyupIsTriggered)){var n=e("#ccPostal").val();this.LoadPostal(n)}this.keyupIsTriggered=!1},blurEmail:function(t){var n=e("#ccEmail").val();if(u.ValidateEmailFormat(n))return void navigator.notification.alert("Email format is invalid.",null,"Invalid Email","OK")},txtPhone_Keydown:function(e){var t=e.keyCode;8==t||t>47&&t<58||t>95&&t<106||e.preventDefault()},cardNumber_keyup:function(t){if(13===t.keyCode){var n=e("#cardNumber").val();s.isBrowserMode&&n.length>16&&(this.isUnimag=!1,u.CreditCard.ParseCreditCardMagWithValidation(n,this.isUnimag))}},checkUnimag:function(t){t.preventDefault();var n=e("#isUnimag").text();console.log("IsUnimag :"+n),s.isBrowserMode?e("#cc-msg").text("Enter Credit card details."):"true"===n&&e("#cc-msg").text("Establishing connection...")},btnClearSignature_tap:function(e){e.preventDefault(),this.ClearSignature()},ClearSignature:function(){var e=s.Signature;this.sketchView?(this.$(".signature").show(),this.$(".signatureDisplay").hide(),e&&(e.indexOf("[SVGID]:")!==-1?this.trigger("deleteSavedSignature",s.Signature,this):s.Signature=null)):this.$(".signature").jSignature("reset"),this.sketchView=!1,B=!1},btnSave_tap:function(t){return t.preventDefault(),this.IsWaiting()?void navigator.notification.alert("Waiting for customer's signature",null,"Invalid Action","OK"):void(e("#keypad-done-btn").hasClass("keypad-btn-faded")||this.SavePayment())},btnClose_tap:function(t){if(t.preventDefault(),!this.giftView||!this.giftView.IsWaiting()){if(this.CheckIfShowSignature()&&this.IsWaiting())return void navigator.notification.alert("Waiting for customer's signature",null,"Invalid Action","OK");this.Close(),e("#main-transaction-blockoverlay").hide()}},CheckIfShowSignature:function(){var e=!1;return s.PaymentType==r.PaymentType.Check&&(e=s.Preference.RequireSignatureOnCheck),s.PaymentType==r.PaymentType.CreditCard&&(e=s.Preference.RequireSignatureOnCreditCard),e},IsWaiting:function(){return this.$("#signature").hasClass("ui-disabled")},btnLoadMoreInfo_tap:function(t){switch(t.preventDefault(),t.currentTarget.innerHTML){case"More":e("#paymentAdditionalFields").show(),e("#paymentPrimaryFields").hide(),e(".signature-container").css("visibility","hidden"),e("#cc-msgContainer").css("visibility","hidden"),e("#btn-more").text("Back"),this.InitializePostal(),this.InitializeCountry(),e("#ccPostal").focus();break;case"Back":e("#paymentAdditionalFields").hide(),e("#paymentPrimaryFields").show(),e(".signature-container").css("visibility","visible"),e("#cc-msgContainer").css("visibility","visible"),e("#btn-more").text("More"),e("#cardNumber").focus()}},btnUni:function(t){if(t.preventDefault(),s.isBrowserMode)e("#cardNumber").focus(),this.RequestSwipe("Please swipe card."),u.CreditCard.ClearCreditCardInfo(),e("#expDate").removeClass("ui-disabled");else{var n=e("#isUnimag").text();"true"===n?this.RequestSwipe("Please swipe card."):this.LoadUnimagPlugin()}},processCard:function(t){t.preventDefault(),console.log("CHANGED CARD"),this.HideActivityIndicator(),e(".keypad").removeClass("ui-disabled"),e(".left-popover-btn").removeClass("ui-disabled"),e(".right-popover-btn").removeClass("ui-disabled")},processMsg:function(t){t.preventDefault(),this.HideActivityIndicator();var n=e("#cc-msg").text(),i=e("#track1").text(),a=e("#track2").text(),o=e("#ksn").text();e("#magnePrint").text(),e("#magnePrintStatus").text();console.log("Payment: "+n),"Card unreadable. Try again."===n?this.RequestSwipe("Please swipe card again."):"Successfully retrieved credit card information."===n&&""===i&&""===a&&""===o&&(console.log("Unable to read card information."),e("#cardNumber").val(""),u.SetDefaultToday("#expDate","YYYY-MM"),e("#cardName").val(""),e("#track1").text(""),e("#track2").text(""),e("#ksn").text(""),e("#magnePrint").text(""),e("#magnePrintStatus").text(""),s.isBrowserMode||navigator.notification.alert("Unable to get credit card information. Please swipe again.",null,"Unable to Proceed","OK"))},CountryChanged:function(t){var n=t.target.id,i=e("#"+n).val(),a=e("#ccPostal").val();this.countrySelected!=i&&a.length>0&&this.ClearPostalInfo(),this.countrySelected=i,this.PreviousCountrySelected=i},CityChanged:function(e){e.preventDefault(),this.SetState()},initialize:function(){var e=this.options.showForm;this.transactionBalance=this.options.balance,N=this,e&&(this.render(),this.InitializeSignature(),this.SetFocusedField()),this.on("processPINCaptured",this.TiggerPopulateTextFields)},render:function(){T=this;var t=this.transactionBalance;t>=1e10?navigator.notification.alert("Total exceeded the allowed maximum amount of 10,000,000,000.00",null,"Error","OK"):(this.$el.html(this._template({PaymentType:s.PaymentType})),s.TermDiscount>0&&this.$("#term-discount").text("Term Discount "+s.CurrencySymbol+s.TermDiscount.toFixed(2)).show(),this.InitializePaymentDetail(),this.ToggleFields(),e("#main-transaction-blockoverlay").show()),this.countrySelected=null,s.isBrowserMode&&this.BindLastElement(),s.isBrowserMode||this.ActivateUnimagPlugin(),s.PaymentType==r.PaymentType.CreditCard&&(s.TransactionType==r.TransactionType.SalesRefund?(e("#cc-msgContainer").hide(),e("#authorizationNumber").addClass("ui-disabled"),e("#cardReferenceNumber").addClass("ui-disabled")):s.TransactionType==r.TransactionType.Return?(e("#cc-msgContainer").show(),e("#authorizationNumber").addClass("ui-disabled"),e("#cardReferenceNumber").addClass("ui-disabled")):(e("#cc-msgContainer").show(),e("#authorizationNumber").removeClass("ui-disabled"),e("#cardReferenceNumber").removeClass("ui-disabled")))},BindLastElement:function(){s.isBrowserMode&&e("#paymentBody input:visible:last").on("keydown",function(t){if(9==t.keyCode)return e("#paymentBody input:visible:first").focus(),t.preventDefault(),!1})},RemoveScreenOverLay:function(){e("#main-transaction-blockoverlay").hide()},LoadUnimagPlugin:function(){u.NMIPaymentGateway.ActivateUnimag(),u.NMIPaymentGateway.isConnected();var t=this;e("#cc-msg").off("failedToDetectDevice"),e("#cc-msg").on("failedToDetectDevice",function(){navigator.notification.confirm("The device was not detected, would you like to try again?",function(e){1==e&&(console.log("Attemping to detect device."),u.NMIPaymentGateway.DeactivateUnimag(),t.LoadUnimagPlugin())},"Unable to Detect Device",["Yes","No"])})},InitializePaymentDetail:function(){switch(s.PaymentType){case r.PaymentType.Cash:this.InitializeCashPayment();break;case r.PaymentType.Check:this.InitializeCheckPayment();break;case r.PaymentType.CreditCard:this.InitializeCreditCardPayment();break;case r.PaymentType.Gift:this.InitializeGiftPayment();break;case r.PaymentType.Loyalty:this.InitializeLoyaltyPayment()}this.$(".paymentDetails").trigger("create"),s.PaymentType!=r.PaymentType.Loyalty?(this.InitializeKeypadView(),e(".complete-btn-container").removeClass("loyaltyBtn"),e("#keypad-done-btn").show(),e("#btn-donePayment").hide()):(e(".complete-btn-container").addClass("loyaltyBtn"),e("#keypad-done-btn").hide(),e("#btn-donePayment").show()),this.ToggleSize()},InitializePostal:function(){this.postalmodel||(this.postalmodel=new d),this.postalCollection||(this.postalCollection=new h)},LoadPostal:function(t){if(""==t)this.ClearCity();else{var n=this;u.LoadPostalByCode(t,function(e){n.postalCollection.reset(e),n.DisplayResultOnPostal(t)},function(t){n.postalCollection.reset(),n.postalCollection.RequestError(t,"Error Loading Postal Code"),e("#ccPostal").val("")})}},AddNewPostal:function(){var t=e("#addPostalCodeContainer"),n=e("#ccPostal").val(),i=e("#ccCountry option:selected").val();e(t).html("<div id='addPostalContainer' style='display: none'></div>");var a=e("#addPostalContainer");u.IsNullOrWhiteSpace(this.newPostalView)?this.newPostalView=new f({el:a}):(this.newPostalView.remove(),this.newPostalView=new f({el:a})),this.newPostalView.on("AcceptPostal",this.AcceptPostal,this),this.newPostalView.on("ClearPostal",this.ClearPostalDetails,this),this.newPostalView.Show(n,i,this.countryCollection)},AcceptPostal:function(t){this.disableEnter=!1,this.countrySelected=t.CountryCode,this.SetSelectedCountry(this.countrySelected),e("#ccPostal").val(t.PostalCode),e("#ccCity").val(t.StateCode),this.postal=t.PostalCode,this.city=t.City,this.LoadPostal(this.postal,this.city)},ClearPostalDetails:function(){this.disableEnter=!1,e("#ccPostal").val(""),this.postal="",this.ClearCity()},DisplayResultOnPostal:function(t){this.newCollection=new h,this.postalCollection.each(this.RemoveInvalidPostals,this),this.postalCollection=this.newCollection,0===this.postalCollection.length?(this.disableEnter=!0,navigator.notification.confirm("The Postal Code '"+t+"' does not exist in the Country selected. Do you want to add '"+t+"' ?",x,"Postal Not Found",["Yes","No"])):(e('#ccCity > option[val !=""]').remove(),this.LoadRetrievedPostal(),e("#ccCity").prop("selectedIndex",0),e("#ccCity").trigger("change"))},LoadRetrievedPostal:function(){this.postalCollection.each(this.SetFields,this)},RemoveInvalidPostals:function(e){var t=e.get("CountryCode");t===this.countrySelected&&this.newCollection.add(e)},ClearPostalInfo:function(){e("#ccPostal").val(""),e("#ccState").val(""),this.ClearCity()},ClearCity:function(){e('#ccCity > option[val !=""]').remove(),e("#ccCity").append(new Option("City...","")),e("#ccCity").prop("selectedIndex",0),e("#ccCity").trigger("change"),e("#ccState").val("")},SetState:function(){var t=e("#ccCity option:selected").val();if(""!=t){var n=this.postalCollection.find(function(e){return t=e.get("City")}),i=n.get("StateCode");e("#ccState").val(i)}else e("#ccState").val("")},SetFields:function(t){var n=t.get("City");e("#ccCity").append(new Option(n,n)),e("#ccCity").selectmenu("refresh",!0),this.SetState()},InitializeCountry:function(){this.countryModel||(this.countryModel=new y,this.countryModel.on("sync",this.SuccessCountryLookupResult,this),this.countryModel.on("error",this.ErrorCountryLookupResult,this)),this.countryCollection?0===this.countryCollection.length?this.LoadCountry():this.ReloadCountry(this.countryCollection):(this.countryCollection=new m,this.countryCollection.on("reset",this.DisplayCountries,this),this.LoadCountry())},LoadCountry:function(){_rows=1e4,this.index=0,this.countryModel.set({Criteria:""}),this.countryModel.url=s.ServiceUrl+c.CUSTOMER+l.COUNTRYCODELOOKUP+_rows,this.countryModel.save()},SuccessCountryLookupResult:function(e,t,n){s.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.countryCollection.reset(t.Countries)},ErrorCountryLookupResult:function(e,t,n){s.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Loading Country List")},DisplayCountries:function(e){0===e.length?(console.log("no countries available."),navigator.notification.alert("No country available.",null,"No Country Found","OK")):this.ReloadCountry(e)},LoadRetrievedCountry:function(t){t.each(this.SetCountryOptions,this),e("#ccCountry").selectmenu("refresh",!0)},SetCountryOptions:function(t){var n=t.get("CountryCode");e("#ccCountry").append(new Option(n,n))},ReloadCountry:function(t){e('#ccCountry > option[val !=""]').remove(),this.LoadRetrievedCountry(t),null!==this.countrySelected&&void 0!==this.countrySelected||(this.countrySelected=s.CurrentCustomer.Country?s.CurrentCustomer.Country:s.ShipTo.Country),this.SetSelectedCountry(this.countrySelected)},SetSelectedCountry:function(t){e("#ccCountry > option[value='"+t+"']").attr("selected","selected"),e("#ccCountry").selectmenu("refresh",!0)},InitializeCashPayment:function(){},InitializeCheckPayment:function(){e(".paymentDetails").html(this._checkTemplate({Balance:this.transactionBalance}))},InitializeCreditCardPayment:function(){s.OfflineCharge||(e(".paymentDetails").html(this._creditCardTemplate({NameOnCard:s.CurrentCustomer.CustomerName,Balance:this.transactionBalance})),u.BrowserModeDatePicker("#expDate","datepicker","yy-mm"),s.isBrowserMode&&e("#cardNumber").focus(),e("#cc-msg").text("Enter Credit card details."))},InitializeGiftPayment:function(){this.giftView&&(this.giftView.unbind(),this.giftView.remove()),e(".paymentDetails").html("<div></div>"),this.giftView=new g({el:".paymentDetails div"}),this.giftView.on("askToEnterPIN",this.TriggerAskToEnterPIN,this),this.giftView.on("stopAskingPIN",this.TriggerStopPINRetrieval,this),this.giftView.on("changeKeypadAmount",this.GiftChangeKeypadAmount,this)},GiftChangeKeypadAmount:function(e){var t=this.transactionBalance;e>t?this.keypadView.SetAmount(t.toString()):this.keypadView.SetAmount(e.toString())},PopulatePINFields:function(e){this.giftView&&this.giftView.PopulatePINFields(e)},TriggerAskToEnterPIN:function(e){this.trigger("askToEnterPIN",e,this)},TriggerStopPINRetrieval:function(){this.trigger("stopAskingPIN","payment",this)},InitializeLoyaltyPayment:function(){u.IsNullOrWhiteSpace(this.loyaltyView)||this.loyaltyView.unbind();console.log("Balance : "+this.transactionBalance),this.loyaltyView=new C({el:".paymentDetails"}),this.loyaltyView.paymentCollection=this.collection,this.loyaltyView.render(this.transactionBalance)},ToggleSize:function(){var e=!1;switch(s.PaymentType){case r.PaymentType.Cash:this.$("#paymentBody").addClass("cashPayment"),this.$(".paymentDetails").hide();break;case r.PaymentType.Check:e=s.Preference.RequireSignatureOnCheck,e?this.$("#paymentBody").addClass("checkPaymentWithSignature"):this.$("#paymentBody").addClass("checkPayment"),this.$(".keypad").addClass("keypadWithLeftPadding");break;case r.PaymentType.CreditCard:e=s.Preference.RequireSignatureOnCreditCard,s.OfflineCharge||s.DejavooEnabled?(this.$("#paymentBody").addClass("cashPayment"),this.$(".paymentDetails").hide()):(e?this.$("#paymentBody").addClass("creditCardPaymentWithSignature"):this.$("#paymentBody").addClass("creditCardPayment"),this.$(".keypad").addClass("keypadWithLeftPadding"));break;case r.PaymentType.Gift:this.$("#paymentBody").addClass("giftPayment"),this.$(".keypad").addClass("keypadWithLeftPadding");break;case r.PaymentType.Loyalty:this.$("#paymentBody").addClass("loyaltyPayment")}s.PaymentType!=r.PaymentType.Cash&&(s.PaymentType==r.PaymentType.Loyalty?this.AdjustPaymentBodyHeight(!0):this.AdjustPaymentBodyHeight())},DestroyCountryAndPostal:function(){this.postalModel&&this.postalModel.clear(),this.countryModel&&this.countryModel.clear(),this.countryCollection&&this.countryCollection.reset(void 0,{silent:!0}),this.postalCollection&&this.postalCollection.reset(void 0,{silent:!0})},Close:function(){s.PaymentType!=r.PaymentType.CreditCard&&s.PaymentType!=r.PaymentType.Check||s.OfflineCharge||this.CheckIfShowSignature()&&this.ClearSignature(),s.Signature=null,this.DestroyCountryAndPostal(),this.Hide(),e("#paymentContainer").removeClass("paymentFormLarge"),this.trigger("formClosed",this)},GetExistingNewLoyaltyPayment:function(){if(s.PaymentType!=r.PaymentType.Loyalty)return 0;if(!this.collection)return 0;if(0==this.collection.length)return 0;var e=this.collection.find(function(e){return e.get("PaymentType")==r.PaymentType.Loyalty&&1==e.get("IsNew")});return e?parseFloat(e.get("AmountPaid")):0},Show:function(e){this.sketchView=!1,this.cancelledPayment=!1,this.transactionBalance=parseFloat(e)+this.GetExistingNewLoyaltyPayment(),this.render(),this.$el.show(),this.InitializeSignature(),this.SetFocusedField()},Hide:function(){e(document).unbind("keydown"),this.isFullPayment||this.RemoveScreenOverLay(),console.log("Payment Type: "+s.PaymentType),this.DeactiveUnimag(),this.$el.html(""),this.$el.hide()},ActivateUnimagPlugin:function(){void 0!=window.plugins&&"Credit Card"===s.PaymentType&&(s.isBrowserMode||this.LoadUnimagPlugin());var t=e("#isUnimag").text();"false"===t&&e("#cc-msg").text("Device is not connected.")},DeactiveUnimag:function(){void 0!=window.plugins&&"Credit Card"===s.PaymentType&&(s.isBrowserMode||u.NMIPaymentGateway.DeactivateUnimag())},InitializeSignature:function(){var t=!1;switch(B=!1,s.PaymentType){case r.PaymentType.Check:t=s.Preference.RequireSignatureOnCheck;break;case r.PaymentType.CreditCard:t=s.Preference.RequireSignatureOnCreditCard}t&&(this.$(".signature-container").show(),this.$(".signature").jSignature({height:"100px"}),this.$(".signature").bind("change",this.SignatureChanged),e("#paymentContainer").addClass("paymentFormLarge"))},SignatureChanged:function(e){B=!0},MustOverwriteExistingGift:function(){return s.TransactionType==r.TransactionType.Order||s.TransactionType==r.TransactionType.UpdateOrder||s.TransactionType==r.TransactionType.ConvertQuote||s.TransactionType==r.TransactionType.ConvertOrder},IsGiftAlreadyExist:function(){var e=!1;if(s.PaymentType==r.PaymentType.Gift&&this.giftView){var t=this;this.collection&&this.collection.length>0&&this.collection.each(function(n){var i=n.get("IsNew")||!1,a=n.get("PaymentType")||"",o=n.get("SerialLotNumber")||"";!e&&i&&a==r.PaymentType.Gift&&o.toUpperCase()==t.giftView.gift.get("SerialLotNumber").toUpperCase()&&(u.IsNullOrWhiteSpace(i)||(e=!0))}),e&&navigator.notification.confirm("This Gift Card/Certificate is already added as payment.\nWould you like to use this amount instead?",E,"Gift Exists",["Yes","No"])}return e},ChangeGiftAmountToUse:function(){this.keypadView.GetAmount();if(this.collection&&this.collection.length>0){var e,t=this;this.collection.each(function(n){var i=n.get("IsNew")||!1,a=n.get("PaymentType")||"",o=n.get("SerialLotNumber")||"";e||!i&&!t.MustOverwriteExistingGift()||a!=r.PaymentType.Gift||o.toUpperCase()!=t.giftView.gift.get("SerialLotNumber").toUpperCase()||u.IsNullOrWhiteSpace(i)||(e=n)}),e&&(this.collection.remove(e),this.transactionBalance=this.options.GetTransactionBalance()||0,this.SavePayment())}},createForcePaymentGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})},ValidateGift:function(e,t,n,i){return s.PaymentType!=r.PaymentType.Gift||!!this.giftView&&this.giftView.ValidateGift(e,t,n,i)},SavePayment:function(){var t,n;s.PaymentType==r.PaymentType.Loyalty?(t=this.loyaltyView.monetaryPoints,n=this.loyaltyView.monetaryPoints,console.log("Amount Paid : "+t)):(t=this.keypadView.GetAmount(),n=this.keypadView.GetAmount());var i=e("#ccEmail").val();this.ValidateGift(t,this,"SavePayment",arguments)&&(this.IsGiftAlreadyExist()||this.IsNumeric(t)&&(t=this.GetTransactionPayment(),this.ValidatePayment(s.PaymentType,t,n)&&this.ValidateSignature(s.PaymentType)&&this.ValidateEmail(s.PaymentType,i)&&this.AddPayment(s.PaymentType,t)))},ValidateEmail:function(e,t){return!!s.OfflineCharge||(e!==r.PaymentType.CreditCard||""==t||(!u.ValidateEmailFormat(t)||(navigator.notification.alert("Email format is invalid.",null,"Invalid Email","OK"),!1)))},ValidatePayment:function(t,n,i){if(!n||0===n)return console.log("Please specify an amount."),navigator.notification.alert("Please specify an amount.",null,"Amount is Required","OK"),!1;switch(t){case r.PaymentType.Check:var a=e("#checkNumber").val();if(""===a.trim())return console.log("Please enter the Check Number."),navigator.notification.alert("Please enter the Check Number.",null,"Check Number is Required","OK"),!1;if(isNaN(a))return console.log("Please enter a valid Check Number"),navigator.notification.alert("Please enter valid Check Number",null,"Check Number invalid","OK"),!1;if(i>n)return console.log("Non-cash over payment is not allowed."),navigator.notification.alert("Non-cash over payment is not allowed.",null,"Invalid Payment","OK"),this.keypadView.SetAmount(this.transactionBalance.toFixed(2)),!1;break;case r.PaymentType.CreditCard:var o=e("#cardNumber").val(),l=e("#expDate").val(),c=e("#cardName").val(),u=(e("#track1").text(),e("#track2").text(),e("#ksn").text(),e("#magnePrint").text(),e("#magnePrintStatus").text(),e("#isSwiped").html()),d=e("#authorizationNumber").val();if(_cv=e("#cvNumber").val(),s.OfflineCharge)return!(i>n)||(console.log("Non-cash over payment is not allowed."),navigator.notification.alert("Non-cash over payment is not allowed.",null,"Invalid Payment","OK"),this.keypadView.SetAmount(this.transactionBalance.toFixed(2)),!1);if(d.length>0)return!(i>n)||(console.log("Non-cash over payment is not allowed."),navigator.notification.alert("Non-cash over payment is not allowed.",null,"Invalid Payment","OK"),this.keypadView.SetAmount(this.transactionBalance.toFixed(2)),!1);if(""===o.trim())return console.log("Please enter the Card Number."),navigator.notification.alert("Please enter the Card Number.",null,"Card Number is Required","OK"),!1;if(""===l.trim())return console.log("Please enter the Expiration Date."),navigator.notification.alert("Please enter the Expiration Date.",null,"Expiration Date is Required","OK"),!1;if(""===c.trim())return console.log("Please enter the Name on Card."),navigator.notification.alert("Please enter the Name on Card.",null,"Name on Card is Required","OK"),!1;var y=this.GetDateError(l);if(y)return console.log(y),navigator.notification.alert(y,null,"Invalid Date","OK"),!1;if(i>n)return console.log("Non-cash over payment is not allowed."),navigator.notification.alert("Non-cash over payment is not allowed.",null,"Invalid Payment","OK"),this.keypadView.SetAmount(this.transactionBalance.toFixed(2)),!1;if(0==d.length&&"false"==u&&null==o.match(/^\d+$/))return navigator.notification.alert("Card Number is not valid.",null,"Invalid Payment","OK"),!1;if(isNaN(o))return navigator.notification.alert("Please enter valid Card Number",null,"Card Number Invalid","OK"),!1;if(isNaN(_cv))return console.log("Invalid CV Number"),navigator.notification.alert("Please enter valid CV Number",null,"CV Number Invalid","OK"),!1;break;case r.PaymentType.Gift:if(i>n)return console.log("Non-cash over payment is not allowed."),navigator.notification.alert("Non-cash over payment is not allowed.",null,"Invalid Payment","OK"),this.keypadView.SetAmount(this.transactionBalance.toFixed(2)),!1}return!0},GetDateError:function(e){var t=0,n=0,i=new Date,a=i.getMonth()+1,o=i.getFullYear(),r=!1,s=!1;return e=e.split("-"),2===e.length?(t=e[0],n=e[1],isNaN(n)||isNaN(t)?r=!0:(t=parseFloat(t),n=parseFloat(n),n>12||0==n?r=!0:t<o?s=!0:t==o&&n<a&&(s=!0))):r=!0,r?"Invalid Expiration Date format. Use YYYY-MM.":s?"Card is already expired.":null},ValidateSignature:function(e){switch(e){case r.PaymentType.Check:if(s.Preference.RequireSignatureOnCheck&&B===!1)return console.log("A signature from the customer is required."),navigator.notification.alert("A signature from the customer is required.",null,"Signature is Required","OK"),!1;break;case r.PaymentType.CreditCard:if(!s.OfflineCharge&&s.Preference.RequireSignatureOnCreditCard&&B===!1)return console.log("A signature from the customer is required."),navigator.notification.alert("A signature from the customer is required.",null,"Signature is Required","OK"),!1}return!0},AddPayment:function(e,t){return 0===t?(console.log("Please enter the Amount Paid."),navigator.notification.alert("Please enter the Amount Paid.",null,"Amount is Required","OK"),!1):(payment=this.CreatePayment(e,t),void(e!=r.PaymentType.Cash&&this.Close()))},CreatePayment:function(e,t){switch(e){case r.PaymentType.Cash:k=t,this.CheckCashPaymentChangeDue();break;case r.PaymentType.Check:this.AddCheckPayment(t);break;case r.PaymentType.CreditCard:this.AddCreditCardPayment(t);break;case r.PaymentType.Gift:this.AddGiftPayment(t);break;case r.PaymentType.Loyalty:var n=this.collection.find(function(e){return e.get("PaymentType")==r.PaymentType.Loyalty&&1==e.get("IsNew")}),i=this;if(n)return void navigator.notification.confirm("There's an existing Loyalty Payment in this transaction.\nWould you like to use this new amount instead?",function(e){1==e?i.DoAddLoyaltyPayment(n,t):(i.isFullPayment=!1,i.Close())},"Loyalty Payment Exists",["Yes","No"]);this.AddLoyaltyPayment(t)}},DoAddLoyaltyPayment:function(e,t){e&&(this.transactionBalance=parseFloat(parseFloat((this.transactionBalance||0)+parseFloat(e.get("AmountPaid")||0)).toFixed(2)),this.isFullPayment=parseFloat(t)>=this.transactionBalance,this.collection.remove(e)),this.AddLoyaltyPayment(t)},AddLoyaltyPayment:function(e){this.collection.add({AmountPaid:e,PaymentType:r.PaymentType.Loyalty,Account:this.GetPaymentAccountInfo(),IsNew:!0,POSWorkstationID:s.POSWorkstationID,POSClerkID:s.Username}),this.Close()},formatAmount:function(e){var t=e.replace(",",""),n=t.replace(",",""),i=format("#,##0.00",n.replace(",",""));return i},AddCashPayment:function(){var e=this;this.collection.add({AmountPaid:k,PaymentType:r.PaymentType.Cash,Account:this.GetPaymentAccountInfo(),IsNew:!0,POSWorkstationID:s.POSWorkstationID,POSClerkID:s.Username,ChangeAmount:isNaN(e.lastChangeAmount)?0:e.lastChangeAmount}),this.Close()},AddCheckPayment:function(t){var n=e("#checkNumber").val(),i="",a="";B&&(i=this.GetSignature(),i.indexOf("[SVGID]:")!==-1&&(a=s.SignatureContent)),s.Signature=null,this.collection.add({CheckNumber:n,PaymentType:r.PaymentType.Check,AmountPaid:t,Account:this.GetPaymentAccountInfo(),IsNew:!0,SignatureSVG:i,SignatureSVGContent:a,POSWorkstationID:s.POSWorkstationID,POSClerkID:s.Username})},AddGiftPayment:function(e){var t="Gift Certificate";this.giftView.IsCard&&(t="Gift Card"),this.collection.add({AmountPaid:e,PaymentType:r.PaymentType.Gift,Account:this.GetPaymentAccountInfo(),IsNew:!0,CreditCode:this.giftView.gift.get("CreditCode"),SerialLotNumber:this.giftView.gift.get("SerialLotNumber"),GiftType:t,POSWorkstationID:s.POSWorkstationID,POSClerkID:s.Username}),this.Close()},AddCreditCardPayment:function(t){var n=this;if(s.DejavooEnabled){n.trigger("showDejavooProgress",!0);var i=s.Preference.DejavooConnectionProtocol+"://";i+=s.Preference.DejavooConnectionTerminal+":",i+=s.Preference.DejavooConnectionCGIPort+"/cgi.html?TerminalTransaction=",i+="<request>",i+="<PaymentType>Credit</PaymentType>",i+="<TransType>Sale</TransType>",i+="<Amount>"+parseFloat(t).toFixed(2)+"</Amount>",i+="<Tip>0</Tip>",i+="<Frequency>"+s.Preference.DejavooTransactionFrequency+"</Frequency>",i+="<InvNum></InvNum>",i+="<RefId>"+this.GenerateForceAuthorizationCode()+"</RefId>",i+="<RegisterId>"+s.Preference.DejavooTransactionRegisterID+"</RegisterId>",i+="<AuthKey>"+s.Preference.DejavooConnectionAuthKey+"</AuthKey>",i+="<PrintReceipt>"+(0==s.Preference.DejavooTransactionPrintReceipt?"No":"Both")+"</PrintReceipt>",i+="<SigCapture>"+(0==s.Preference.DejavooTransactionSignature?"No":"Yes")+"</SigCapture>",i+="</request>";var a=new o;a.url=i,a.fetch({error:function(i,a,o){var r=e.parseXML(a.responseText.replace(/[\n\r�]/g,"")),o=e(r);if("0"==o.find("ResultCode").text()){var s,l=o.find("ExtData").text().split(",");l.forEach(function(e){e.includes("Name=")&&(s=e.replace(/%20/g," "),s=s.replace("Name=",""),s=s.trim())});var c=o.find("AuthCode").text().trim();n.SaveCreditCardPayment(t,c,s),n.trigger("showDejavooProgress",!1)}else e("#main-transaction-blockoverlay").hide(),n.trigger("showDejavooProgress",!1),navigator.notification.alert(o.find("Message").text(),null,"Error","OK")}})}else n.SaveCreditCardPayment(t,null)},SaveCreditCardPayment:function(t,n,i){var a=["January","February","March","April","May","June","July","August","September","October","November","December"],o=e("#cardNumber").val(),l=e("#expDate").val(),c=e("#track1").text(),u=e("#track2").text(),d=e("#ksn").text(),y=e("#magnePrint").text(),h=e("#magnePrintStatus").text(),m=e("#cvNumber").val(),p=e("#ccCountry option:selected").val(),g=e("#ccPostal").val(),C=e.trim(e("#cardName").val())||s.CurrentCustomer.CustomerName,f=e("#ccAddress").val(),P=e("#ccCity option:selected").val(),v=e("#ccState").val(),w=e("#ccPhone").val(),S=e("#ccPhoneExt").val(),b=e("#ccEmail").val(),k=e("#isSwiped").html(),T="",N="",x="",I="",A="",D=!1,O=""!=d&&null!=d,V="";V=s.OfflineCharge?this.GenerateForceAuthorizationCode():e("#authorizationNumber").val(),null==o&&(o=""),null==l&&(l=""),null==c&&(c=""),null==u&&(u=""),null==d&&(d=""),null==y&&(y=""),null==h&&(h=""),null==m&&(m=""),null==p&&(p=""),null==g&&(g=""),null==C&&(C=""),null==f&&(f=""),null==P&&(P=""),null==v&&(v=""),null==w&&(w=""),null==S&&(S=""),null==b&&(b=""),null==k&&(k=!1),l=l.split("-"),2===l.length&&(T=l[0],N=a[parseInt(l[1])-1]),k="false"!==k,x="Authorize",""!=V&&(D=!0),s.OfflineCharge||B&&(I=this.GetSignature(),I.indexOf("[SVGID]:")!==-1&&(A=s.SignatureContent)),this.sketchView=!1,s.Signature=null;var E=this.EncryptCardNumber(o);x=this.GetCreditCardTransactionType(x,D,r.PaymentType.CreditCard,o),s.DejavooEnabled&&(V=n,C=i),this.collection.add({AmountPaid:t,PaymentType:r.PaymentType.CreditCard,CreditCardNumber:o,ExpDateYear:T,ExpDateMonth:N,NameOnCard:C,CardTransactionType:x,IsNew:!0,SignatureSVG:I,SignatureSVGContent:A,Track1:c,Track2:u,Ksn:d,MagnePrint:y,MagnePrintStatus:h,IsCreditCardEncrypted:O,IsUnimag:this.isUnimag,EncryptedCreditCardNumber:E,CreditCardIsAuthorizedVerbally:D,CreditCardAuthorizationCode:V,Email:b,Address:f,Country:p,PostalCode:g,City:P,State:v,Telephone:w,TelephoneExtension:S,CardVerification:m,POSWorkstationID:s.POSWorkstationID,POSClerkID:s.Username}),this.isUnimag=!1;
},GenerateForceAuthorizationCode:function(){var e=s.DejavooEnabled?"DJV":"FP",t=new Date,n=t.getFullYear().toString(),i=("0"+(t.getMonth()+1)).slice(-2),a=("0"+t.getDate()).slice(-2),o=("0"+t.getHours()).slice(-2),r=("0"+t.getMinutes()).slice(-2),l=("0"+t.getSeconds()).slice(-2),c=e.concat(n,i.toString(),a.toString(),o.toString(),r.toString(),l.toString());return c},GetCreditCardTransactionType:function(e,t,n,i){if("Credit Card"==n)switch(s.TransactionType){case"Convert Quote":case"Order":case"Update Order":return"Authorize";case"Convert Order":return 1!=t||"Auth"!=e&&"Authorize"!=e?1==s.AllowSaleCreditPreference?"Sale":"Auth/Capture":"Force";case"Suspended":case"Resume Sale":return t&&s.IsPosted&&("Auth"==e||"Authorize"==e)?"Force":s.IsPosted&&!t?1==s.AllowSaleCreditPreference?"Sale":"Auth/Capture":"Authorize";default:return s.IsPosted?t&&s.IsPosted?"Force":1==s.AllowSaleCreditPreference?"Sale":"Auth/Capture":"Authorize"}return null},EncryptCardNumber:function(e){for(var t=e.length,n=e.substr(t-4,4),i=t-4,a="",o=0;o<i;o++)a+="X";return a+n},CheckCashPaymentChangeDue:function(){var e=this.transactionBalance;e=parseFloat(e.toFixed(2));var t;s.PaymentType==r.PaymentType.Loyalty?this.loyaltyView.monetaryPoints:t=this.keypadView.GetAmount();var n;t>e?(n=t-e,n=n.toFixed(2),this.lastChangeAmount=isNaN(n)?0:n,this.Hide(),console.log("Your change is "+s.CurrencySymbol+" "+this.formatAmount(n)+"."),navigator.notification.confirm("Your change is "+s.CurrencySymbol+" "+this.formatAmount(n)+".",V,"Change Due",["Yes","No"])):(this.lastChangeAmount=0,this.AddCashPayment())},GetTransactionPayment:function(){var e;return s.PaymentType==r.PaymentType.Loyalty?(e=this.loyaltyView.monetaryPoints,console.log("Amount Paid : "+e)):e=this.keypadView.GetAmount(),e>=this.transactionBalance?(this.isFullPayment=!0,this.transactionBalance):(this.isFullPayment=!1,e)},GetPaymentAccountInfo:function(){return s.Preference.IsDepositPayment?"Deposit":"Undeposited"},IsNumeric:function(e){return!isNaN(e)||(console.log("The value you entered is not valid."),navigator.notification.alert("The value you entered is not valid.",null,"Invalid Format","OK"),!1)},SetFocusedField:function(){switch(s.PaymentType){case r.PaymentType.Cash:e("#amountPaid:visible").focus();break;case r.PaymentType.Check:e("#checkNumber:visible").focus();break;case r.PaymentType.CreditCard:}},RequestSwipe:function(t){e("#cardNumber").val(""),u.SetDefaultToday("#expDate","YYYY-MM"),e("#expDate").removeAttr("readonly"),e("#cardName").val(""),e("#track1").text(""),e("#track2").text(""),e("#ksn").text(""),e("#magnePrint").text(""),e("#magnePrintStatus").text(""),s.isBrowserMode||u.NMIPaymentGateway.RequestSwipe(),e("#cc-msg").text(t)},GetCardNumber:function(e){return e.substring(1,17)},UpdateChangeDue:function(e){var t=0;e>this.transactionBalance&&(t=e-this.transactionBalance),this.$("#changeDue").html(t.toFixed(2)+"&nbsp;&nbsp;")},ToggleFields:function(){switch(s.TransactionType){case r.TransactionType.SalesRefund:e("#amountPaid").attr("readonly","readonly"),e("#label-balance").html("Paid"),e("#label-amountPaid").html("Refund"),e("#cardRefNumber").show();break;default:e("#amountPaid").removeAttr("readonly"),e("#label-balance").html("Balance"),e("#label-amountPaid").html("Amount"),e("#cardRefNumber").hide()}},GetSignature:function(){if(this.sketchView)return s.Signature;var e=this.$(".signature").jSignature("getData","svgbase64");return e?e[1]:null},InitializeKeypadView:function(){this.keypadView&&this.keypadView.remove();var t=this;this.keypadView=new p({el:e(".keypad")}),this.keypadView.on("enterTriggered",function(){u.IsNullOrWhiteSpace(t.disableEnter)&&e("#keypad-done-btn").tap()},this),this.keypadView.Show(),this.keypadView.SetAmount(this.transactionBalance.toFixed(2))},closePluginDevice:function(){window.plugins.cbCCSwipe.CloseDevice("close")},ShowSpinner:function(){var e=document.getElementById("lblCard");this.ShowActivityIndicator(e)},ShowActivityIndicator:function(t){t||(t=document.getElementById("lblCard")),e("<div id='lblSpinner'></div>").appendTo(t);var n=document.getElementById("lblSpinner");_spinner=b,_spinner.opts.color="#000",_spinner.opts.lines=11,_spinner.opts.length=4,_spinner.opts.width=2,_spinner.opts.radius=5,_spinner.opts.top=-21,_spinner.opts.left=139,_spinner.spin(n)},HideActivityIndicator:function(){_spinner=b,_spinner.stop(),e("#lblSpinner").remove()},ResetField:function(){e("#track1").text(""),e("#track2").text(""),e("#ksn").text(""),e("#magnePrint").text(""),e("#magnePrintStatus").text("")},AdjustPaymentBodyHeight:function(t){this.$("input#checkNumber").attr("style","width: 71% !important;"),!s.TermDiscount>0||(t?(s.TermDiscount>0?this.$("#paymentBody").css("height","335px"):this.$("#paymentBody").css("height","276px"),this.$(".term-discount").css("margin-top","20px")):s.PaymentType==r.PaymentType.Check&&e("#paymentBody").hasClass("checkPayment")?this.$("#paymentBody").css("height","459px"):this.$("#paymentBody").css("height","400px"))}}),A=function(){var t=document.getElementById("btn-stop-asking");_spinner=b,_spinner.opts.left=10,_spinner.opts.radius=3,_spinner.opts.lines=9,_spinner.opts.length=4,_spinner.opts.width=3,_spinner.opts.color="#000",_spinner.spin(t,"Cancel"),e("#btn-stop-asking .ui-btn-text").text("Cancel"),e(".btn-ask-to-sign").css("text-align","center"),e("#signature").addClass("ui-disabled")},D=function(){_spinner=b,_spinner.stop()},O=function(){this.$(".btn-ask-to-sign").attr("id","btn-ask-to-sign"),e(".btn-ask-to-sign .ui-btn-text").text("Allow User To Sign"),e(".btn-ask-to-sign").css("text-align","center"),D(),e("#signature").removeClass("ui-disabled")},V=function(e){return 1!==e?void T.RemoveScreenOverLay():void T.AddCashPayment()},E=function(e){1===e&&T.ChangeGiftAmountToUse()},B=!1;return I});