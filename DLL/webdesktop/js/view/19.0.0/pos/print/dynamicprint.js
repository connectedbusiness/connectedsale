define(["jquery","mobile","underscore","backbone","shared/global","shared/service","shared/method","shared/shared","model/base","collection/base","model/reportsetting","view/19.0.0/pos/print/printer","view/19.0.0/pos/print/printpreview","text!template/19.0.0/pos/print/dynamicprint.tpl.html","text!template/19.0.0/pos/print/print.tpl.html","js/libs/iscroll.js"],function(e,t,i,r,n,s,o,p,a,l,c,h,P,d,u){var m,w=r.View.extend({_template:i.template(d),_browserPrintTemplate:i.template(u),events:{"tap #btn-print":"btnPrint","tap #btn-cancel":"btnCancel"},btnCancel:function(e){e.preventDefault(),n.PrintPluginLoaded=!1,this.Close()},btnPrint:function(e){if(e.preventDefault(),n.isBrowserMode)this.ProcessPrintReceipt();else{if(this.IsReceiptPrinter)return void this.ProcessPrintReceipt();this.top=87,"Reports"==n.ApplicationType?this.top=64:"Reports"==!n.ApplicationType&&this.on("closed",this.Close),n.PrintPluginLoaded||(n.PrintPluginLoaded=!0,p.Printer.PrintAirPrintReceipt(this.pdfUrl,this))}},initialize:function(){this.IsReceiptPrinter=this.options.IsReceiptPrinter,this.IsWorkstation=this.options.IsWorkstation},render:function(){if(this.transactionCode=this.model,"Reports"==n.ApplicationType==0&&(n.isBrowserMode?this.InitializeBrowserPrintPreview():(this.$el.html(this._template),n.isOkToOpenCashDrawer&&n.Preference.UseCashDrawer)),e("#main-transaction-blockoverlay").show(),this.reportType=this.options.reportType,!n.isBrowserMode){this.collection=this.LoadImages(this.pageSettings,this.transactionCode);var t=this;e("#print-area").css("overflow","hidden");var i=0,r=0,s=this.collection.models.length,o=function(){r==s?t.RenderFinalize():p()},p=function(){i++;var e=t.collection.at(i-1);if(e){var n="printImg"+i,s=new Image;s.onload=function(){console.log("IMAGE LOADED: "+n),t.$("#print-preview-container > tbody").append(s),t.$("#print-preview-container > tbody").append("<br/>"),r++,o()},s.id=n,s.src=e.get("ImageURL")}};p()}},CheckReportType:function(e){switch(e){case n.ReportCode.Invoice:case n.ReportCode.Order:case n.ReportCode.Quote:case n.ReportCode.Payment:this.imgWidth="290";break;default:this.imgWidth="740"}},Close:function(){n.PrintOptions.Reprint=!1,n.PrintPluginLoaded=!1,p.Printer.DeleteReport(this.pageSettings.Pages,this.transactionCode),this.IsReceiptPrinter&&(n.isBrowserMode||this.ClosePrinter()),this.$el.hide(),n.isBrowserMode||e("#main-transaction-blockoverlay").hide(),"Kiosk"===n.ApplicationType&&(n.Kiosk.Cart=null,n.Kiosk.Total=null,n.Kiosk.Customer=null,n.Kiosk.SerialLot=null,window.location.hash="kiosk"),!this.IsWorkstation&&n.Preference.AutoSignOutUser?n.PreviousReprintValue?n.PreviousReprintValue=!1:this.trigger("AutoSignOut",this):this.trigger("formclosed",this),this.printsetup&&(this.printsetup.unbind(),this.printsetup.remove()),p.FocusToItemScan(),this.Dispose()},ClosePrinter:function(){p.Printer.ReleasePrinterObjects()},Dispose:function(){"Reports"!=n.ApplicationType?(n.isBrowserMode||e("#main-transaction-blockoverlay").hide(),this.unbind(),this.remove()):n.isBrowserMode&&(e("#previewContainer").attr("style","display: block"),e(".arrow").remove())},InitializeBrowserPrintPreview:function(){n.isBrowserMode&&"Reports"!=n.ApplicationType&&(this.transactionCode=this.model,e("#main-transaction-blockoverlay").show(),this.$el.html(this._browserPrintTemplate({transactionCode:this.transactionCode,ServiceUrl:n.ServiceUrl})),p.PrintBrowserMode.DrawerKick())},Show:function(t,i,r){if(this.pageSettings=t,"Reports"==n.ApplicationType&&(this.model=i,this.options.reportType=r,n.isBrowserMode&&e("#print-area").removeAttr("style")),n.isBrowserMode){var s=n.Preference.AutoPrintReceipt&&n.PrintOptions.SilentPrint||n.PrintOptions.SilentPrint;if(t.IsPrintPickNote&&(s=!0),s){var i=this.model,o=parseInt(this.pageSettings.Pages);t.IsPrintPickNote||this.IsWorkstation||!n.Preference.AutoSignOutUser||n.PrintOptions.Reprint||this.trigger("AutoSignOut",this),p.PrintBrowserMode.Print(i,o,this.options.printer,this.options.copies),n.PrintOptions.Reprint=!1}else this.InitializeBrowserPrintPreview()}else this.IsReceiptPrinter?this.InitializeReceiptPrinter(t.IsPrintPickNote):(this.render(),n.isBrowserMode||p.Printer.LoadAirPrintPlugin())},RenderFinalize:function(){this.$el.show(),this.RetrieveImageWidth()},LoadImages:function(e,t){var i=new l,r=n.ServiceUrl+o.REPORTS+t;this.pdfUrl=r+".pdf?"+Math.random();for(var s=1;s<=e.Pages;s++)retinaReport=r+s+".png?"+Math.random(),this.IsReceiptPrinter?smallResReport=r+s+"@small.png?"+Math.random():smallResReport=retinaReport,i.add({ImageURL:smallResReport,ImageRetinaURL:retinaReport});return i},RetrieveImageWidth:function(){for(var t=this.$("#print-preview-container").find("> tbody > img"),i=0;i<t.length;i++)t[i].clientWidth>=740?e(t[i]).addClass("previewSizeToFit"):e(t[i]).removeClass("previewSizeToFit");this.RefreshMyScroll()},RefreshMyScroll:function(){n.isBrowserMode?e("#print-area").removeAttr("style"):this.myScroll?(this.myScroll.destroy(),this.myScroll=null,e("#print-preview-container").removeAttr("style"),this.myScroll=new iScroll("print-area",{vScrollbar:!0,vScroll:!0,snap:!1,momentum:!0,zoom:!0}),this.myScroll.refresh()):this.myScroll=new iScroll("print-area",{vScrollbar:!0,vScroll:!0,snap:!1,momentum:!0,zoom:!0})},InitializeReceiptPrinter:function(e){"Settings"==n.ApplicationType?p.Printer.DrawerKick():this.IsWorkstation&&!n.PreventDrawerKick&&n.Preference.UseCashDrawer&&p.Printer.DrawerKick(),this.receiptPrint||(this.receiptPrint=new h({el:this.$el}),this.receiptPrint.NoPreview=!0,this.receiptPrint.on("SignOut",this.ProcessSignOut,this),this.receiptPrint.on("ShowPreview",this.render,this),this.receiptPrint.on("PrintFinish",this.Dispose,this),this.receiptPrint.on("kioskPrint",this.ProcessReloadKiosk,this)),this.receiptPrint.ProcessPrinting(this.pageSettings,this.model,this.IsWorkstation,e)},ProcessReloadKiosk:function(){this.trigger("kioskPrint",this)},ProcessSignOut:function(){this.trigger("AutoSignOut",this)},ProcessPrintFromBrowser:function(){var e=this.model;p.LockTransactionScreen(!0,"Printing"),p.PrintBrowserMode.PrintReceiptFromBrowser(this.pageSettings,e),this.Close()},ProcessPrintReceipt:function(){var t=this;e("#modalBg").show(),e("#printSetupContainer").html('<div id="printSetupContainer-Wrapper"></div>'),this.printsetup=new P({el:"#printSetupContainer-Wrapper"}),n.isBrowserMode?this.printsetup.on("print",function(){t.ProcessPrintFromBrowser()}):this.printsetup.on("print",function(){t.printerIP=t.printsetup.printerIP,t.printerModel=t.printsetup.printerModel,console.log("ISOPEN: "+n.Printer.isPrinterOpen),t.ValidatePrinter()&&(t.OpenPrinter(),t.PrintReceipt())}),this.printsetup.Show(),"Reports"==n.ApplicationType&&e("#printSetup-Pointer").hide()},OpenPrinter:function(){p.Printer.OpenPrinter(this.printerIP)},PrintReceipt:function(){p.Printer.PrintReceipt(),n.isOkToOpenCashDrawer=!1,"Reports"==n.ApplicationType&&e("#printerSetup-div").hide()},SearchPrinter:function(){console.log("Searching"),this.printsetup.ReSearchPrinter()},ValidatePrinter:function(){return m=this,!!p.Printer.Validate(this.printerIP,this.printerModel)}});return w});