define(["jquery","mobile","underscore","backbone","shared/global","shared/enum","shared/method","shared/shared","collection/base","collection/printers","view/19.1.0/pos/print/printpreview"],function(e,i,r,t,n,s,o,P,a,c,p){var l=t.View.extend({InitializePrintPlugin:function(){P.Printer.InitializePrintPlugin(),P.Printer.InitializePrintPluginArray()},InitializePrintPreview:function(e,i,r,t){this.printPreview?this.printPreview.ProcessPreview(e,i,r,t):(this.printPreview=new p({el:this.$("#printPreviewContainer")}),this.printPreview.on("printFinish",this.ProcessSignOut,this),this.printPreview.on("AutoSignOut",this.ProcessSignOut,this),this.printPreview.on("kioskPrint",this.ProcessReloadKiosk,this),this.printPreview.ProcessPreview(e,i,r,t))},ProcessReloadKiosk:function(){this.trigger("kioskPrint",this.ReloadKiosk,this)},ProcessSignOut:function(){this.trigger("SignOut",this)},ProcessPrinting:function(i,r,t,o){var c=new a;e("#main-transaction-blockoverlay").hide(),n.isBrowserMode||(this.InitializePrintPlugin(),window.plugins.cbNetworkActivity.HideIndicator()),console.log("Global.isOkToOpenCashDrawer : "+n.isOkToOpenCashDrawer),n.isOkToOpenCashDrawer||(n.isOkToOpenCashDrawer=!1),n.isBrowserMode||(c=this.LoadImages(i.Pages,r,c),this.ProcessPrintingImages(c)),t&&(n.PrintOptions.SilentPrint=n.Preference.AutoPrintReceipt);var p=n.Preference.PromptToPrintReceipt||n.Preference.PromptEmailAddress,l=!n.PrintOptions.Reprint&&n.Preference.AutoPrintReceipt&&!t&&p&&n.PrintOptions.SilentPrint,h=!n.PrintOptions.Reprint&&n.Preference.AutoPrintReceipt&&(t||!p),g=n.PrintOptions.SilentPrint;if((o||l||h||g)&&"Reports"!=n.ApplicationType)n.isBrowserMode?this.ProcessPrintReceiptFromBrowser(i,r):P.Printer.Validate(n.Printer.IpAddress,n.Printer.PrinterModel)?(P.LockTransactionScreen(!0,"Printing"),this.ProcessPrintReceipt()):n.isBrowserMode||navigator.notification.alert("Please Specify the IP Address of the Printer and Try again...",null,"Unable to print Receipt","OK"),n.ClosingWorkStation&&this.trigger("SignOut",this),!t&&n.Preference.AutoSignOutUser&&(n.PreviousReprintValue?n.PreviousReprintValue=!1:this.trigger("SignOut",this)),"Kiosk"===n.ApplicationType&&this.trigger("kioskPrint",this),n.TransactionType===s.TransactionType.Suspend&&(n.TransactionType=s.TransactionType.Sale),n.PrintOptions.Reprint&&(n.PrintOptions.Reprint=!1),this.DeleteReport(i.Pages,r),this.trigger("PrintFinish",this);else{if(this.trigger("ShowPreview",this),this.NoPreview)return;this.InitializePrintPreview(i.Pages,r,t,c)}},DeleteReport:function(e,i){P.Printer.DeleteReport(e,i)},LoadImages:function(e,i,r){for(var t=n.ServiceUrl+o.REPORTS+i,s=1;s<=e;s++)retinaReport=t+s+".png?"+Math.random(),r.add({ImageURL:retinaReport,ImageRetinaURL:retinaReport});return r},ProcessPrintingImages:function(e){for(var i=0;i<e.length;i++)P.Printer.SetReceiptPrintImage(e.at(i).get("ImageRetinaURL"))},InitializePrinterCollection:function(){this.printerCollection||(this.printerCollection=new c,this.printerCollection.on("reset",this.SetValues,this)),this.printerCollection.fetch()},SetValues:function(e){var i=e.find(function(e){return e.get("PrinterModel")}),r=e.find(function(e){return e.get("IpAddress")});i&&(n.Printer.PrinterModel=i.get("PrinterModel")),r&&(n.Printer.IpAddress=r.get("IpAddress"))},ProcessPrintReceipt:function(){n.isBrowserMode||(this.OpenPrinter(),this.PrintReceipt()),P.LockTransactionScreen(!1)},ProcessPrintReceiptFromBrowser:function(e,i){n.Preference.UseCashDrawer&&P.PrintBrowserMode.PrintReceiptFromBrowser(e,i)},OpenPrinter:function(){P.Printer.OpenPrinter(n.Printer.IpAddress)},PrintReceipt:function(){P.Printer.PrintReceipt(),n.isOkToOpenCashDrawer=!1}});return l});