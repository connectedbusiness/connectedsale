define(["jquery","mobile","underscore","backbone","shared/global","shared/shared","shared/service","shared/method","model/base","model/lookupcriteria","collection/base","view/19.1.0/products/controls/generic-list","view/19.1.0/customers/customers/customer-detail","text!template/19.1.0/customers/customers/customer-form.tpl.html","text!template/19.1.0/customers/controls/generic-layout.tpl.html"],function(e,t,i,s,o,r,n,c,a,l,u,h,m,d,C){var w,f={SearchInput:"#txt-search",CustomerForm:"#customers-form"},V="General",L=s.View.extend({_customersFormTemplate:i.template(d),_genericLayoutTemplate:i.template(C),initialize:function(){w=this,this.UnloadConfirmationMessage=null,this.IsNew=!1},render:function(){return this.$el.html(this._customersFormTemplate),this.$(f.CustomerForm).html(this._genericLayoutTemplate),this},Show:function(){V="General",this.LoadItems(),this.render()},HasChanges:function(){if(this.IsNew)return this.UnloadConfirmationMessage="Do you want to cancel this new record?",!0},InitializeChildViews:function(){},InitializeCustomerModel:function(){this.customerModel=new l,this.customerModel.on("sync",this.CustomerLookUpLoadSuccess,this),this.customerModel.on("error",this.CustomerLookUpLoadError,this)},CustomerLookUpLoadSuccess:function(e,t,i){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.customerCollection||(this.customerCollection=new u),this.customerCollection.reset(t.Customers),this.DisplayItemList()},CustomerLookUpLoadError:function(e,t,i){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),console.log(e)},LoadItems:function(e){switch(V){case"General":this.LoadCustomers(e);break;case"Contact":this.LoadCustomerContacts(e);break;case"Note":this.LoadCustomerNotes(this.customerDetailView.CustomerCode,e)}},LoadCustomers:function(e){this.SetCurrentTab(),console.log("Load customers"),""!==e&&void 0!==e||(e=null),this.InitializeCustomerModel(),this.customerModel.set({StringValue:e}),this.customerModel.url=o.ServiceUrl+n.CUSTOMER+c.CUSTOMERLOOKUP+"100",this.customerModel.save()},DisplayItemList:function(){this.currentCollection||(this.currentCollection=new u),this.currentCollection=this.GetCurrentCollection(),this.genericListView?(this.GenericListViewSettings(),this.genericListView.RefreshList(this.currentCollection)):this.InitializeGenericListView(),this.SelectedItem()},GenericListViewSettings:function(){var e=null,t=null;switch(V){case"Contact":e="Search Contacts",t="ContactFullName";break;case"General":e="Search Customers",t="CustomerName";break;case"Note":e="Search Notes",t="Title";break;default:console.log("no GenericListViewSettings set.")}this.genericListView.SetPlaceHolder(e),this.genericListView.SetDisplayField(t)},SetCurrentTab:function(){this.customerDetailView&&(V=this.customerDetailView.CurrentTab)},GetCurrentCollection:function(){if(!this.customerDetailView)return this.customerCollection;switch(this.SetCurrentTab(),V){case"Contact":return this.contactCollection;case"General":return this.customerCollection;case"Note":return this.noteCollection;default:console.log("no collection got.")}},GetCurrentModel:function(){switch(V){case"General":return this.customerDetailView.customerModel;case"Contact":return this.customerDetailView.contactModel;case"Note":return this.customerDetailView.noteModel;default:console.log("no model got.")}},GetCurrentCode:function(){switch(V){case"General":return this.customerDetailView.CustomerCode;case"Contact":return this.customerDetailView.ContactCode;case"Note":return this.customerDetailView.NoteCode;default:console.log("no code got.")}},GetTabName:function(){var e="";switch(V){case"General":e="Customer";break;case"Contact":e="Contact";break;case"Note":e="Note";break;default:console.log("No tabName got.")}return e},SearchItem:function(){this.genericListView&&this.LoadItems(this.genericListView.GetItemToSearch())},SelectedItem:function(e){if(!this.IsNew&&(o.ListJustTapped=!0,this.genericListView)){if(this.customerDetailView||this.InitializeCustomerDetailsView(),this.genericListView.GetSelectedModel()||this.genericListView.GetFirstModel()){this.customerDetailView.model=new a;var t=this.genericListView.GetSelectedModel()||this.genericListView.GetFirstModel();this.customerDetailView.model=t}else this.CurrentCollection&&this.CurrentCollection.models.length>0?this.customerDetailView.model=this.CurrentCollection.at(0):this.customerDetailView.model=null;if(o.justRefreshCollection){var i=this.GetCurrentModel();this.customerDetailView.model=i,this.SetSelectedAttribute(),o.justRefreshCollection=!1}else o.fromContactsToGeneralTab&&(this.genericListView.SelectByAttribute("CustomerCode",this.customerDetailView.CustomerCode||this.customerDetailView.ContactEntityCode,!1,!0),this.genericListView.GetSelectedModel()?this.customerDetailView.model=this.genericListView.GetSelectedModel():this.customerDetailView.model=this.customerDetailView.customerModel,o.fromContactsToGeneralTab=!1);this.customerDetailView.toBeSearched=this.genericListView.GetItemToSearch(),this.customerDetailView.IsNew=!1,this.customerDetailView.Show(e)}},SetSelectedAttribute:function(e){switch(V){case"General":this.genericListView.SelectByAttribute("CustomerCode",this.customerDetailView.CustomerCode);break;case"Contact":this.genericListView.SelectByAttribute("ContactCode",this.customerDetailView.ContactCode);break;case"Note":this.genericListView.SelectByAttribute("NoteCode",this.customerDetailView.NoteCode);break;default:console.log("no collection got.")}},InitializeGenericListView:function(){this.genericListView=new h({el:"#left-panel",collection:this.customerCollection}),this.genericListView.on("search",this.SearchItem,this),this.genericListView.on("selected",this.SelectedItem,this),this.genericListView.on("add",this.AddMode,this),this.genericListView.collection=this.customerCollection,this.genericListView.SetPlaceHolder("Search Customers"),this.genericListView.SetDisplayField("CustomerName"),this.genericListView.Show()},InitializeCustomerDetailsView:function(){this.customerDetailView=new m({el:"#right-panel"}),this.customerDetailView.on("loadCustomers",this.ReloadCustomers,this),this.customerDetailView.on("schemaFetched",this.SchemaFetched,this),this.customerDetailView.on("newCustomerSaved",this.NewCustomerSaved,this),this.customerDetailView.on("deleted",this.DeleteSuccess,this),this.customerDetailView.on("cannotDelete",this.DeleteFailed,this),this.customerDetailView.on("updated",this.UpdateSuccess,this),this.customerDetailView.on("cancel",this.CancelNew,this),this.customerDetailView.on("loadCustomerContacts",this.LoadContacts,this),this.customerDetailView.on("newContactSaved",this.NewContactSaved,this),this.customerDetailView.on("loadCustomerNotes",this.LoadNotes,this),this.customerDetailView.on("newNoteSaved",this.NewNoteSaved,this),this.customerDetailView.on("failed",this.LoadPreviousModel,this)},LoadPreviousModel:function(e){o.justRefreshCollection=!1,this.IsNew=!1,this.customerDetailView.IsNew=!1,r.Customers.Overlay.Hide()},ReloadCustomers:function(){this.SetCurrentTab(),this.trigger("tabChanged","Customers"),this.DisplayItemList()},SchemaFetched:function(e){if(this.customerDetailView){var t=new a;switch(V){case"General":t.set(e.customerschema.attributes);break;case"Contact":t.set(e.contactschema.attributes);break;default:console.log("no schema fetched at "+V+".")}this.customerDetailView.IsNew=!0,this.customerDetailView.model=t,this.customerDetailView.Show(t),r.Customers.Overlay.Hide()}},NewCustomerSaved:function(e){var t=this.customerDetailView.CustomerCode;r.Customers.ShowNotification("Customer '"+t+"' was successfully saved!"),o.justRefreshCollection=!0,this.IsNew=!1,this.customerDetailView.IsNew=!1,this.genericListView&&this.LoadItems(),r.Customers.Overlay.Hide()},DeleteSuccess:function(e){var t=this.GetCurrentCode(),i=this.GetTabName();r.Customers.ShowNotification(i+" '"+t+"' was successfully deleted!"),this.IsNew=!1,this.customerDetailView.IsNew=!1,this.genericListView&&this.LoadItems(""),r.Customers.Overlay.Hide()},DeleteFailed:function(e){var t=this.customerDetailView.errorDeleteMsg;r.Customers.Overlay.Hide(),r.Customers.ShowNotification(t,!0)},UpdateSuccess:function(e){var t=this.GetTabName(),i=this.GetCurrentCode();null!==this.customerDetailView.model.get("ErrorMessage")?r.Customers.ShowNotification(this.customerDetailView.model.get("ErrorMessage"),!0):(o.justRefreshCollection=!0,r.Customers.ShowNotification("Changes on "+t+" '"+i+"' was successfully saved!"),this.genericListView&&this.LoadItems("")),r.Customers.Overlay.Hide()},ProceedToGeneralView:function(){o.fromContactsToGeneralTab=!0,this.customerDetailView.CurrentTab="General",V="General",this.IsNew=!1,this.customerDetailView.IsNew=!1,this.ReloadCustomers()},CancelNew:function(){this.ConfirmCancelChanges("DoCancelNew")},DoCancelNew:function(){this.IsNew=!1,this.customerDetailView.IsNew=!1,this.SelectedItem()},AddMode:function(){return o.Preference.AllowAddCustomer||"Contact"===V?void(this.customerDetailView&&(this.customerDetailView.AddMode(),this.IsNew=!0)):void navigator.notification.alert("Adding new customer is not allowed.",null,"Action Not Allowed","OK")},LoadContacts:function(e){this.SetCurrentTab();var t=this.customerDetailView.CustomerName;this.trigger("tabChanged",'Contacts of <a id="customer-name-a">'+r.Escapedhtml(t)+"</a>"),this.LoadCustomerContacts(e)},NewContactSaved:function(e){var t=this.customerDetailView.ContactCode;r.Customers.ShowNotification("Contact '"+t+"' was successfully saved!"),o.justRefreshCollection=!0,this.IsNew=!1,this.customerDetailView.IsNew=!1,this.genericListView&&this.LoadItems(),r.Customers.Overlay.Hide()},LoadCustomerContacts:function(e){""!==e&&void 0!==e||(e=null);var t=new l;t.on("sync",this.ContactLookUpLoadSuccess,this),t.on("error",this.ContactLookUpLoadError,this);var i=this.customerDetailView.CustomerCode;t.set({StringValue:e,EntityCode:i,Type:"CustomerContact"}),t.url=o.ServiceUrl+n.CUSTOMER+c.CONTACTSLOOKUP+"100",t.save()},ContactLookUpLoadSuccess:function(e,t,i){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.contactCollection||(this.contactCollection=new u),this.contactCollection.reset(t.CRMContacts),this.DisplayItemList()},ContactLookUpLoadError:function(e,t,i){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(error,"Error Loading Contacts","An error was encountered when trying to load contacts.")},LoadNotes:function(e){this.SetCurrentTab();var t=this.customerDetailView.CustomerName;this.trigger("tabChanged",'Notes of <a id="customer-name-a">'+r.Escapedhtml(t)+"</a>"),this.LoadCustomerNotes(e)},LoadCustomerNotes:function(e,t){""!=e&&void 0!=e||(e=null);var i=new l;i.on("sync",this.NoteLookupLoadSuccess,this),i.on("error",this.NoteLookupLoadError,this);this.customerDetailView.CustomerCode;i.set({CustomerCode:e,CriteriaString:t}),i.url=o.ServiceUrl+n.CUSTOMER+c.LOADCUSTOMERNOTELOOKUP,i.save()},NoteLookupLoadSuccess:function(e,t,i){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.noteCollection||(this.noteCollection=new u),this.noteCollection.reset(t.OrderNotes),this.DisplayItemList()},NoteLookupLoadError:function(e,t,i){},NewNoteSaved:function(e){var t=this.customerDetailView.NoteCode;r.Customers.ShowNotification("Note '"+t+"' was successfully saved!"),o.justRefreshCollection=!0,this.IsNew=!1,this.customerDetailView.IsNew=!1,this.genericListView&&this.LoadItems(),r.Customers.Overlay.Hide()},ConfirmCancelChanges:function(e,t){this.DoOnCancel=t,this.DoOnConfirm=e,this.HasChanges()?navigator.notification.confirm(this.UnloadConfirmationMessage,g,"Confirmation",["Yes","No"]):this.ConfirmExecute()},ConfirmExecute:function(){this.DoOnConfirm&&this[this.DoOnConfirm]()},CancelExecute:function(){this.DoOnCancel&&this[this.DoOnCancel]()}}),g=function(e){1==e?w.ConfirmExecute():w.CancelExecute()};return L});