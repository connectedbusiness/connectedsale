define(["jquery","mobile","underscore","backbone","shared/global","shared/service","shared/method","shared/shared","model/base","view/19.1.0/products/products/detail/general/photo-editor","text!template/19.1.0/products/products/detail/general.tpl.html"],function(e,t,o,i,a,n,r,s,d,l,c){var h,m={ItemName:".table-data #data-ItemName",ItemDescription:".table-data #data-ItemDescription",ItemType:".table-data #data-ItemType",SerializeLot:".table-data #data-SerializeLot",AutoGenerate:".table-data #data-AutoGenerate",DontEarnPoints:".table-data #data-DontEarnPoints"},u=i.View.extend({_generalTemplate:o.template(c),events:{"keypress  .table-data #data-ItemName":"inputChange_ItemName","change .table-data #data-ItemName":"inputChange_ItemName","keypress  .table-data #data-ItemDescription":"inputChange_Description","change .table-data #data-ItemDescription":"inputChange_Description","change .table-data #data-ItemType":"selectChange_ItemType","change .table-data #data-SerializeLot":"selectChange_SerializeLot","change .table-data #data-AutoGenerate":"checkChange_AutoGenerate","change .table-data #data-DontEarnPoints":"checkChange_DontEarnPoints","tap #item-image":"btnClick_Image","tap .photo-menu .camera":"btnClick_Camera","tap .photo-menu .gallery":"btnClick_Gallery","tap .photo-menu .edit":"btnClick_Edit","tap .photo-menu-upper .remove":"btnClick_Remove","change #browse-image":"browseImage_Changed","tap .copyname":"btnClick_CopyName"},inputChange_ItemName:function(){var t=e(m.ItemName).val();this.model.set({ItemName:t,ItemCode:t}),this.model.HasChanges=!0},inputChange_Description:function(){var t=e(m.ItemDescription).val();this.model.set({ItemDescription:t}),this.model.HasChanges=!0},selectChange_ItemType:function(){var t=e(m.ItemType).val();this.model.set({ItemType:t}),this.model.HasChanges=!0,this.CheckItemType(),this.ResetUM()},selectChange_SerializeLot:function(){var t=e(m.SerializeLot).val();this.model.set({SerializeLot:t}),this.model.HasChanges=!0},checkChange_AutoGenerate:function(){var t=e(m.AutoGenerate).is(":checked");this.model.set({AutoGenerate:t}),this.model.HasChanges=!0},checkChange_DontEarnPoints:function(){var t=e(m.DontEarnPoints).is(":checked");this.model.set({DontEarnPoints:t}),this.model.HasChanges=!0},btnClick_Image:function(e){e.preventDefault(),this.ShowPhotoMenu()},btnClick_Camera:function(e){e.preventDefault(),this.ShowPhotoMenu(),this.GetImage()},btnClick_Gallery:function(e){e.preventDefault(),this.ShowPhotoMenu(),this.GetImage(!0)},btnClick_Edit:function(e){e.preventDefault(),this.ShowPhotoMenu(),this.EditPhoto()},btnClick_Remove:function(e){e.preventDefault(),this.ShowPhotoMenu(),this.RemovePhoto()},btnClick_CopyName:function(t){t.preventDefault();var o=e(m.ItemName).val();return o&&""!=o?(e(m.ItemDescription).val(o),void this.inputChange_Description()):void s.Products.ShowNotification("Item Name is empty!",!0)},browseImage_Changed:function(t){var o=this,i=function(t){if(t.files&&t.files[0]){if(console.log("File Size: "+t.files[0].size),t.files[0].size>15e6)return navigator.notification.alert("Maximum image file size allowed is 15MB.",null,"Image Size","OK"),void e("#browse-image").val("");var i=new FileReader;i.onerror=function(e){navigator.notification.alert("An error was encountered when trying to load file.",null,"Loading Error","OK"),i=null},i.onload=function(e){o.LoadFromFileURI(e.target.result),i=null},i.readAsDataURL(t.files[0]),e("#browse-image").val("")}};i(document.getElementById("browse-image"))},initialize:function(){this.$el.show(),this.IsNew=!1,h=this},render:function(){var e=this,t=s.Escapedhtml(this.model.get("ItemName"));return this.model.set({CurrencySymbol:a.CurrencySymbol,IsNew:e.IsNew,FormattedItemName:t}),this.$el.html(this._generalTemplate(this.model.toJSON())),this.LoadImage(),this.LoadDrapDowns(),this.CheckReadOnlyMode(),this},CheckReadOnlyMode:function(){this.options.IsReadOnly&&(e(m.AutoGenerate).addClass("ui-readonly"),e(m.ItemName).addClass("ui-readonly"),e(m.ItemDescription).addClass("ui-readonly"),e(m.ItemType).addClass("ui-readonly"),e(m.SerializeLot).addClass("ui-readonly"),e(m.DontEarnPoints).addClass("ui-readonly"))},Show:function(){this.render()},Close:function(){this.remove(),this.unbind()},RemovePhoto:function(){this.model.get("Photo")&&navigator.notification.confirm("Do you really want to delete the photo from this item?",p,"Delete Photo",["Yes","No"])},DoRemovePhoto:function(){var e=new d,t=this.model.get("ItemCode"),o=this;return e.set({StringValue:t}),this.IsNew?(o.model.set({Photo:null,PhotoB64:null}),o.render(),void s.Products.ShowNotification("Photo Deleted!")):(e.on("sync",function(e,t){return a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),s.Products.Overlay.Hide(),t.ErrorMessage?void s.Products.ShowNotification("Error Removing Photo!",!0):(o.model.set({Photo:null,PhotoB64:null}),o.render(),void s.Products.ShowNotification("Photo Deleted!"))},this),e.on("error",function(e,t,o){s.Products.Overlay.Hide(),a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),s.Products.ShowNotification("Error Removing Photo!",!0)},this),e.url=a.ServiceUrl+n.PRODUCT+r.DELETEITEMPHOTO,e.save({timeout:0}),void s.Products.Overlay.Show())},ShowPhotoMenu:function(){if(!this.options.IsReadOnly){var t=".photo-menu",o=".photo-menu-upper";if(a.isBrowserMode&&e(t).addClass("photo-menu-browser"),this.MenuVisible)return e(t).fadeOut(),e(o).fadeOut(),void(this.MenuVisible=!1);var i=e("#item-image").position();e(t).css("left",i.left+4),e(t).css("top",i.top+154),e(o).css("left",i.left+4),e(o).css("top",i.top+4),e(t).fadeIn(),e(o).fadeIn(),this.MenuVisible=!0}},LoadImage:function(t){this.model.get("Photo")&&(this.model.get("PhotoB64")&&!t&&(t=this.model.get("PhotoB64")),e("#item-image").html("<img />"),t?e("#item-image img").attr("src","data:image/png;base64,"+t).css("display","block"):e("#item-image img").attr("src",a.ServiceUrl+r.IMAGES+this.model.get("ItemCode")+".png?"+Math.random()).css("display","block"),e("#item-image img").css("height","100%"),e("#item-image img").css("width","100%"))},LoadPhotoEditor:function(e){var t=this;this.photoEditor||(this.photoEditor=new l);var o=this.model.get("PhotoB64");this.photoEditor.on("done",function(){t.model.set({Photo:[0],PhotoB64:t.photoEditor.ImageB64,OPhotoB64:o||"0"})},this),this.model.get("PhotoB64")&&(this.photoEditor.ImageB64=this.model.get("PhotoB64")),e&&(this.photoEditor.ImageB64=e),this.photoEditor.Show()},GetImage:function(e){if(a.isBrowserMode)return void document.getElementById("browse-image").click();var t=this,o=1;e&&(o=0);var i=new CameraPopoverOptions(600,130,200,200,8);e||s.SetFullScreen(!0),navigator.camera.getPicture(function(o){t.ValidateFileSize(o),e||s.ToggleDisplayAlignment()},function(t){console.log("Camera - getPicute Error Log."),e||s.ToggleDisplayAlignment()},{quality:40,destinationType:Camera.DestinationType.FILE_URI,sourceType:o,allowEdit:!1,mediaType:Camera.MediaType.PICTURE,encodingType:Camera.EncodingType.PNG,popoverOptions:i})},ValidateFileSize:function(e){var t=this;window.resolveLocalFileSystemURI(e,function(o){var i=0;o.file(function(e){i=e.size,console.log("Size = "+i)}),t.LoadFromFileURI(e,i)},function(){navigator.notification.alert("An error was encountered when trying to load image.",null,"Loading Error","OK")})},LoadFromFileURI:function(e,t){s.Products.Overlay.Show();var o=new Image,i=this;console.log("LoadFromFileURI: "+e),o.onerror=function(){navigator.notification.alert("An error was encountered when trying to load image.\nFile might be corrupted or format not supported.",null,"Loading Error","OK"),s.Products.Overlay.Hide(),o=null},o.onload=function(){var e,t=1024,a=document.createElement("canvas"),n=a.getContext("2d"),r=1;o.width>o.height?(o.width>t&&(e=o.width),e&&(r=t/o.width)):(o.height>t&&(e=o.height),e&&(r=t/o.height)),a.height=o.height*r,a.width=o.width*r,n.drawImage(o,0,0,a.width,a.height);var d=a.toDataURL();d=s.Products.Base64Only(d),i.LoadPhotoEditor(d),s.Products.Overlay.Hide(),a=null,n=null,d=null,o=null},o.src=e},EditPhoto:function(){return this.model.get("PhotoB64")?void this.LoadPhotoEditor():void this.GetItemImage()},GetItemImage:function(){var e=new d,t=this.model.get("ItemCode");e.set({StringValue:t}),e.on("sync",this.GetItemImageSuccess,this),e.on("error",this.GetItemImageError,this),e.url=a.ServiceUrl+n.PRODUCT+r.GETITEMIMAGE,e.save(),s.Products.Overlay.Show()},GetItemImageSuccess:function(e,t){if(a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),s.Products.Overlay.Hide(),e.get("ItemDetails")&&e.get("ItemDetails")[0]){var o=e.get("ItemDetails")[0].Photo;if(!o)return void s.Products.ShowNotification("No Photo Found!",!0);var i=s.Products.ByteToBase64(o);i=this.model.set({PhotoB64:i}),this.LoadPhotoEditor()}},GetItemImageError:function(e,t,o){a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),s.Products.Overlay.Hide(),console.log(e),navigator.notification.alert("An error was encountered when trying to load image!",null,"Loading Error","OK")},IsAllowService:function(){var e=a.UserInfo?a.UserInfo.ProductEdition:"",t=!("Connected Retail"==e||"Connected Sale"==e||"Woohaa"==e);return t||!t&&!this.IsNew},LoadDrapDowns:function(){var t={Stock:"",NonStock:"",Service:"",Matrix:"",GiftCard:"",GiftCertificate:"",Kit:"",Bundle:""},o={None:"",Serial:"",Lot:""};switch(this.model.get("ItemType")){case"Stock":t.Stock="Selected";break;case"Non-Stock":t.NonStock="Selected";break;case"Service":t.Service="Selected";break;case"Matrix Item":t.Matrix="Selected";break;case"Gift Card":t.GiftCard="Selected";break;case"Gift Certificate":t.GiftCertificate="Selected";break;case"Kit":t.Kit="Selected";break;case"Bundle":t.Bundle="Selected"}switch(this.model.get("SerializeLot")){case"None":o.None="Selected";break;case"Serial":o.Serial="Selected";break;case"Lot":o.Lot="Selected"}e("#data-ItemType").html(""),e("#data-ItemType").append("<option "+t.Stock+' value="Stock">Stock</option>'),e("#data-ItemType").append("<option "+t.NonStock+' value="Non-Stock">Non-Stock</option>'),this.IsAllowService()&&e("#data-ItemType").append("<option "+t.Service+' value="Service">Service</option>'),e("#data-ItemType").append("<option "+t.GiftCard+' value="Gift Card">Gift Card</option>'),e("#data-ItemType").append("<option "+t.GiftCertificate+' value="Gift Certificate">Gift Certificate</option>'),e("#data-ItemType").append("<option "+t.Kit+' value="Kit">Kit</option>'),e("#data-ItemType").append("<option "+t.Bundle+' value="Bundle">Bundle</option>'),e("#data-SerializeLot").html(""),e("#data-SerializeLot").append("<option "+o.None+' value="None">None</option>'),e("#data-SerializeLot").append("<option "+o.Serial+' value="Serial">Serial</option>'),e("#data-SerializeLot").append("<option "+o.Lot+' value="Lot">Lot</option>'),this.IsNew||(e("#data-ItemType").append("<option "+t.Matrix+' value="Matrix Item">Matrix Item</option>'),e("#data-ItemType").attr("disabled","disabled").addClass("disabled"),e(m.ItemName).addClass("ui-readonly")),e(m.AutoGenerate).prop("checked",this.model.get("AutoGenerate")),e(m.DontEarnPoints).prop("checked",this.model.get("DontEarnPoints")),this.CheckItemType()},ResetUM:function(){this.IsNew&&this.trigger("resetUM")},CheckItemType:function(){if(this.model){var t=this.model.get("ItemType");"Gift Card"==t||"Gift Certificate"==t?(e("#tr-SerializeLot").css("display","none"),e("#tr-AutoGenerate").css("display",""),e("#tr-DontEarnPoints").css("display","none"),this.model.set({DontEarnPoints:!1}),e(m.DontEarnPoints).prop("checked",this.model.get("DontEarnPoints")),e(m.SerializeLot).val("None"),this.model.set({SerializeLot:"None"})):(e("#tr-SerializeLot").css("display",""),e("#tr-AutoGenerate").css("display","none"),e("#tr-DontEarnPoints").css("display",""))}},InitializeChildViews:function(){},Validate:function(){return!!this.model&&(this.model.get("ItemName")?""==e.trim(this.model.get("ItemName"))?this.ShowWarning("ItemName"):this.model.get("ItemDescription")?""!=e.trim(this.model.get("ItemDescription"))||this.ShowWarning("ItemDescription"):this.ShowWarning("ItemDescription"):this.ShowWarning("ItemName"))},ValidateItemName:function(e,t,o){var i=this;if(i.IsNew){var r=new d;r.set({StringValue:i.model.get("ItemName")}),r.url=a.ServiceUrl+n.PRODUCT+"loaditembycriterianame/",r.save(r,{success:function(n,r){return a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),r.Items&&r.Items.length>0?(i.ShowWarning("ItemExists"),void(o&&e&&e[o]())):void(t&&e&&e[t]())},error:function(){a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),i.ShowWarning("ValidationError"),o&&e&&e[o]()}})}},ShowWarning:function(e){this.ValidationError=e,this.trigger("validationError")}}),p=function(e){1==e&&h.DoRemovePhoto()};return u});