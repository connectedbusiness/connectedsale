define(["jquery","mobile","underscore","backbone","shared/global","shared/method","shared/service","shared/shared","model/lookupcriteria","model/base","model/workstation","model/print","collection/preferences","collection/localpreferences","text!template/dashboard/dashboard.tpl.html","view/spinner","js/libs/swipe.min.js"],function(e,t,o,r,i,n,s,a,c,l,u,d,h,p,f,w){var C=r.View.extend({_template:o.template(f),events:{"tap #pos":"buttonPOS_tap","tap #setting":"buttonSettings_tap","tap #products":"buttonProducts_tap","tap #customers":"buttonCustomers_tap","tap #reports":"buttonReports_tap","tap #secondary":"buttonSecondary_tap","tap #dashboard-logout":"buttonLogout_tap"},buttonPOS_tap:function(e){e.preventDefault(),this.CheckWorkstation("POS")},buttonKiosk_tap:function(e){e.preventDefault(),i.Kiosk.Customer=null,this.CheckWorkstation("Kiosk")},buttonProducts_tap:function(e){e.preventDefault(),this.CheckWorkstation("Products")},buttonCustomers_tap:function(e){e.preventDefault(),this.CheckWorkstation("Customers")},buttonReports_tap:function(e){e.preventDefault(),this.CheckWorkstation("Reports")},buttonSettings_tap:function(e){e.preventDefault(),i.PreviousPage="dashboard",this.CheckWorkstation("Settings")},buttonSecondary_tap:function(e){e.preventDefault(),this.CheckWorkstation("Secondary")},buttonLogout_tap:function(e){e.preventDefault(),this.ProcessLogout()},buttonResearch_tap:function(e){e.preventDefault(),i.PreviousPage="dashboard",this.CheckWorkstation("Research")},CheckWorkstation:function(e){this.ShowActivityIndicator(),console.log("CheckWorkstation"),i.ApplicationType=e,0===this.localpreference.length?window.location.hash="settings":this.localpreference.find(function(e){return 0==e.get("IsUseCustomerShipToPaymentType")})&&this.localpreference.find(function(e){return""==e.get("PaymentType")})?window.location.hash="settings":this.InitializeWorkstation(100,this.localpreference.at(0).get("WorkstationID"),e)},BindDashBoardSwipe:function(){},CheckUserCredentials:function(){i._HasAdmins=!1,i._HasStations=!1,i._UserIsAdmin=!1,console.log("trouble");var e=this;this.preferenceCollection=new h,this.preferenceCollection.url=i.ServiceUrl+s.POS+"getuserroles/",console.log(this.preferenceCollection.url),this.preferenceCollection.fetch({timeout:0,success:function(t,o){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.ValidateUserRole(o.UserRoles)},error:function(e,t,o){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error")}})},ValidateUserRole:function(e){if(i.AdministratorRole=!1,i._HasAdmins=!1,i._UserIsAdmin=!1,!e||0==e.length)return void this.CheckWorkStations();if(i._HasAdmins=!0,e.length>0)for(var t=0;t<e.length;t++)e[t].RoleCode==i.UserInfo.RoleCode&&(i._UserIsAdmin=!0,i.AdministratorRole=!0);this.ShowHideControlsByCredentials()},CheckWorkStations:function(){var e=new c,t=100,o=this;e.set({StringValue:""}),e.url=i.ServiceUrl+s.POS+n.PREFERENCELOOKUP+t,e.save(null,{success:function(e,t){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),o.ValidateWorkstation(t)},error:function(e,t,o){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()}})},ValidateWorkstation:function(e){e.Preferences&&0!=e.Preferences.length?i._HasStations=!0:i._HasStations=!1,this.ShowHideControlsByCredentials()},ShowHideControlsByCredentials:function(){var e=i._UserIsAdmin||i._HasStations&&!i._HasAdmins||!i._HasStations&&!i._HasAdmins;e?(this.$("div#setting-wrapper").show(),parseInt(this.CheckMajorVersion())>=14&&this.$("div#reports-wrapper").show()):i.Preference.IsAllowViewZXTape?(this.$("div#setting-wrapper").show(),parseInt(this.CheckMajorVersion())>=14&&this.$("div#reports-wrapper").show(),this.$("div#setting-wrapper").hide()):(this.$("div#setting-wrapper").hide(),this.$("div#reports-wrapper").hide())},CheckMajorVersion:function(){for(var e="",t=i.ServerVersion,o=!1,r=0;r<=t.length-1;r++)"."==t[r]&&(o=!0),0==o&&(e+=t[r]);return e},CheckProductEdition:function(){i._UserIsCS=!0,this.ShowHideControlsByProductEdition()},ShowHideControlsByProductEdition:function(){i._UserIsCS||(this.$("div#customers").hide(),this.$("div#products").hide())},InitializeChildViews:function(){this.render(),this.CheckProductEdition(),this.InitializeSwipe(),this.InitializeLocalPreference(),this.InitializePreference(),navigator.notification.overrideAlert()},InitializePreference:function(){var e=this;console.log(i.POSWorkstationID),void 0!=typeof i.POSWorkStationID&&(this.preferenceCollection=new h,this.preferenceCollection.url=i.ServiceUrl+s.POS+n.GETPREFERENCEBYWORKSTATION+i.POSWorkstationID,this.preferenceCollection.fetch({success:function(t,o){return i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),null!=o.ErrorMessage&&""!=o.ErrorMessage?void e.NotifyMsg(o.ErrorMessage,"Error"):(e.AssignCompanyInfo(o.Preference),e.AssignCurrency(o.Currency),e.ResetPreferenceCollection(o.Preference),e.ResetStatusCollection(o.Status),e.ResetUserRoleCollection(o.UserRoles),e.ResetWarehouseCollection(o.Warehouses),void e.ResetInventoryPreference(o.InventoryPreference))},error:function(e,t,o){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error")}}))},ResetInventoryPreference:function(e){i.InventoryPreference=e},AssignCurrency:function(e){i.CurrencySymbol=e.Symbol,i.CurrencyDecimalSeparator=e.CurrencyDecimalSeparator,i.CurrencyGroupSeparator=e.CurrencyGroupSeparator,i.CurrencyDecimalDigits=e.CurrencyDecimalDigits,i.CurrencyGroupSizes=e.CurrencyGroupSizes},AssignCompanyInfo:function(e){i.CompanyName=e.CompanyName,i.CompanyCountry=e.CompanyCountry,i.CustomerName=e.CustomerName},render:function(){var e=this;i.Kiosk.Cart=null,i.Kiosk.Total=null;var t=a.GetVersionAttributes(i.ServerVersion),o=t.Major+"."+t.Minor;return null!==i.PreviousServiceUrl&&""!==i.PreviousServiceUrl||(i.PreviousServiceUrl=i.ServiceUrl),o>="18.2"?this.$el.html(this._template({Username:i.Username,Version:o,HideReporting:!(e.CheckMajorVersion()>=14)})):this.$el.html(this._template({Username:i.Username,Version:i.ServerVersion,HideReporting:!(e.CheckMajorVersion()>=14)})),this.InitializeSwipe(),a.StorePickup.StopChecker(),this},InitializeSwipe:function(){if(parseInt(this.CheckMajorVersion())>=14){if(1==i._UserIsCS){e("#dashboard-Bullet").show(),e("#dashboard-page2").show(),this.swipe=new Swipe(document.getElementById("dashboard-swipe"),{callback:function(){var t=this.index+1;e("#dashboard-Bullet em").css("color","#CCC"),e("#dashboard-0"+t).css("color","#fff")}});var t=this.swipe.index+1;e("#dashboard-0"+t).css("color","#fff")}else e("#dashboard-Bullet").hide(),e("#dashboard-page2").hide();e("#reports").show()}else e("#reports").hide(),e("#dashboard-Bullet").hide(),e("#dashboard-page2").hide()},InitializeLocalPreference:function(){var e=this;console.log("trouble - localpref"),this.localpreference=new p,this.localpreference.fetch({isLocalStorage:!0,success:function(t,o){0!=t.length&&(i.POSWorkstationID=t.at(0).get("WorkstationID"),i.PreviousServiceUrl!==i.ServiceUrl&&t.each(e.ClearLocalPreference,e))},error:function(e,t,o){e.RequestError(t,"Error Retrieving Local Preference")}})},ProcessLogout:function(){var e=new l;i.IsSignOut=!0;e.url=i.ServiceUrl+s.POS+n.SIGNOUT,e.save(null,{success:function(){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator();var e=window.location.href.split("#")[0];e+="#login",window.location.href=e},error:function(e,t){i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Logging out")}})},InitializeWorkstation:function(e,t,o){var r=new c,a=e,l=this;r.set({StringValue:t}),r.url=i.ServiceUrl+s.POS+n.PREFERENCELOOKUP+a,r.save(null,{success:function(e,r){l.CheckApplicationType(t,r,o),i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()},error:function(e,t,o){l.HideActivityIndicator(),e.RequestError(t,"Error"),i.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator()}})},CheckApplicationType:function(e,t,o){if(i.POSWorkstationID=e,t.Preferences)switch(o){case"POS":window.location.hash="pos";break;case"Kiosk":window.location.hash="kiosk";break;case"Settings":window.location.hash="settings";break;case"Products":window.location.hash="products";break;case"Customers":window.location.hash="customers";break;case"Reports":window.location.hash="reports";break;case"Secondary":window.location.hash="secondary";break;case"Research":window.location.hash="research"}else window.location.hash="settings"},ClearLocalPreference:function(e){e.destroy(),i.POSWorkstationID="NoWorkstationId"+Math.random(),i.PreviousServiceUrl=i.ServiceUrl},ResetPreferenceCollection:function(e){i.Preference={},i.Preference=e,i.TrackDrawerBalance=i.Preference.TrackDrawerBalance,i.PrintOptions.CustomizePrint=e.IsAirprint,i.ResetTransactionType=!0;var t={CustomerName:e.CustomerName,CustomerCode:e.CustomerCode,Email:e.CustomerEmail,DefaultPrice:e.CustomerDefaultPrice,LocationCode:e.DefaultLocation,PaymentTermCode:e.PaymentTermCode};this.SetCurrentCustomer(t)},SetCurrentCustomer:function(e){i.CurrentCustomer=e},ResetStatusCollection:function(e){i.Status=null,i.Status=e},ResetUserRoleCollection:function(e){i.UserRole=e,this.ValidateUserRole(e)},ResetWarehouseCollection:function(e){i.Warehouses={},i.Warehouses=e,this.isValidDefaultLocation(e)},isValidDefaultLocation:function(e){var t=i.Preference.DefaultLocation,r=o.pluck(e,"WarehouseCode"),n=o.contains(r,t);return n?void(this.inValidDefaultLocation=!1):(this.NotifyMsg("The Current Status of the Default Location is Inactive. Please change your Default Location.","Invalid Location"),void(this.inValidDefaultLocation=!0))},NotifyMsg:function(e,t){navigator.notification.alert(e,null,t,"OK")},ShowActivityIndicator:function(t){this.$("#dashboard-blockoverlay").show(),t||(t=document.getElementById("dashboard-page")),e("<div id='spin'></div>").appendTo(t);var o=document.getElementById("spin");_spinner=w,_spinner.opts.color="#fff",_spinner.opts.lines=13,_spinner.opts.length=7,_spinner.opts.width=4,_spinner.opts.radius=10,_spinner.opts.top="auto",_spinner.opts.left="auto",_spinner.spin(o),e("<h5>Loading...</h5>").appendTo(e("#spin"))},HideActivityIndicator:function(){this.$("#dashboard-blockoverlay").hide(),_spinner=w,_spinner.stop(),e("#spin").remove()}});return C});