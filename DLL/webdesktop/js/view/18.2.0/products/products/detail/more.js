define(["jquery","mobile","underscore","backbone","shared/global","shared/service","shared/method","shared/shared","model/base","model/lookupcriteria","collection/base","text!template/18.2.0/products/products/detail/more.tpl.html","text!template/18.2.0/products/products/detail/more/category.tpl.html","text!template/18.2.0/products/products/detail/more/department.tpl.html","js/libs/iscroll.js"],function(e,t,r,i,a,o,n,s,d,l,c,h,p,g){var C={CAT:" .category select ",DELCAT:" .del ",DEP:" .department select ",DELDEP:" .del "},u={Category:".tables .header .category .collapse i",Department:".tables .header .department .collapse i"},m={Category:"#category-table",Department:"#department-table"},D=i.View.extend({_moreTemplate:r.template(h),_categoryLine:r.template(p),_departmentLine:r.template(g),events:{"tap .category-add span":"btnClick_AddCategory","tap .department-add span":"btnClick_AddDepartment","tap .tables .header .category .collapse":"btnClick_CollapseCategory","tap .tables .header .department .collapse":"btnClick_CollapseDepartment"},btnClick_AddCategory:function(e){e.preventDefault(),this.AddNewCategory()},btnClick_AddDepartment:function(e){e.preventDefault(),this.AddNewDepartment()},btnClick_CollapseCategory:function(e){e.preventDefault(),this.ToggleCollapseButton(u.Category,m.Category)},btnClick_CollapseDepartment:function(e){e.preventDefault(),this.ToggleCollapseButton(u.Department,m.Department)},initialize:function(){this.$el.show(),this.categories=new c,this.categoryList=new c,this.departments=new c,this.departmentList=new c},render:function(){return this.$el.html(this._moreTemplate()),this.LoadCategoryCollection(),this.LoadDepartmentCollection(),this.CheckReadOnlyMode(),this},CheckReadOnlyMode:function(){this.options.IsReadOnly&&(e(".category-add span").addClass("ui-disabled"),e(".department-add span").addClass("ui-disabled"),e(C.CAT).addClass("ui-readonly"),e(C.DEP).addClass("ui-readonly"),e(C.DELCAT).addClass("ui-disabled"),e(C.DELDEP).addClass("ui-disabled"))},Show:function(){this.listCount=0,this.GetCategories(),this.GetDepartments()},Close:function(){this.remove(),this.unbind()},InitializeChildViews:function(){},GetCategories:function(){var e=new l;e.on("sync",this.GetCategoriesSuccess,this),e.on("error",this.GetCategoriesError,this);var t=1e3;e.set({StringValue:""}),e.url=a.ServiceUrl+o.PRODUCT+n.GETCATEGORYDETAILS+t,e.save()},GetCategoriesSuccess:function(e,t){a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.categoryList.reset(e.get("SystemCategories")),this.listCount++,2==this.listCount&&this.render()},GetCategoriesError:function(e,t){a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.listCount++,2==this.listCount&&this.render()},GetDepartments:function(){var e=new l;e.on("sync",this.GetDepartmentsSuccess,this),e.on("error",this.GetDepartmentsError,this);var t=1e3;e.set({StringValue:""}),e.url=a.ServiceUrl+o.PRODUCT+n.GETDEPARTMENTDETAILS+t,e.save()},GetDepartmentsSuccess:function(e,t){a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.departmentList.reset(e.get("Departments")),this.listCount++,2==this.listCount&&this.render()},GetDepartmentsError:function(e,t){a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.listCount++,2==this.listCount&&this.render()},LoadCategoryCollection:function(){var t=this,r=0;e(m.Category).html(""),this.categories.each(function(e){t.RenderCategory(e,r),r++})},LoadDepartmentCollection:function(){var t=this,r=0;e(m.Department).html(""),this.departments.each(function(e){t.RenderDepartment(e,r),r++})},RenderCategory:function(t,r){var i="categoryIndex"+r,a=m.Category;t.set({categoryIndex:i}),e(a).append(this._categoryLine(t.toJSON()));var o=a+" #"+i;this.LoadCategoryList(o+" select",t.get("CategoryCode")),this.BindEvents(t,o,a),this.RefreshiScroll()},RenderDepartment:function(t,r){var i="departmentIndex"+r,a=m.Department;t.set({departmentIndex:i}),e(a).append(this._departmentLine(t.toJSON()));var o=a+" #"+i;this.LoadDepartmentList(o+" select",t.get("DepartmentCode")),this.BindEvents(t,o,a),this.RefreshiScroll()},LoadCategoryList:function(t,r){var i="CategoryCode";this.categoryList.sortedField=i,this.categoryList.comparator=function(e){var t=this;return e.get(t.sortedField)};e(t).html(""),this.categoryList.sort(i).each(function(i){var a="";e.trim(i.get("CategoryCode"))==e.trim(r)&&(a="Selected"),e(t).append("<option "+a+' value="'+i.get("CategoryCode")+'" >'+s.Escapedhtml(i.get("CategoryDescription")||i.get("Description"))+"</option>")}),r||e(t).prop("selectedIndex",-1)},LoadDepartmentList:function(t,r){var i="DepartmentCode";this.departmentList.sortedField=i,this.departmentList.comparator=function(e){var t=this;return e.get(t.sortedField)};e(t).html(""),this.departmentList.sort(i).each(function(i){var a="";e.trim(i.get("DepartmentCode"))==e.trim(r)&&(a="Selected"),e(t).append("<option "+a+' value="'+i.get("DepartmentCode")+'">'+s.Escapedhtml(i.get("DepartmentDescription")||i.get("Description"))+"</option>")}),r||e(t).prop("selectedIndex",-1)},BindEvents:function(t,r,i){t.set({cid:r});var a=this;i==m.Category&&(e(r+C.CAT).on("change",function(){a.ChangeModelAttribute(r,C.CAT,i)}),e(r+C.DELCAT).on("tap",function(e){e.preventDefault(),a.ChangeModelAttribute(r,C.DELCAT,i)})),i==m.Department&&(e(r+C.DEP).on("change",function(){a.ChangeModelAttribute(r,C.DEP,i)}),e(r+C.DELDEP).on("tap",function(e){e.preventDefault(),a.ChangeModelAttribute(r,C.DELDEP,i)}))},ChangeModelAttribute:function(e,t,r){var i=this;r==m.Category&&this.categories.each(function(a){a.get("cid")==e&&i.DoChangeAttribute(a,e,t,r)}),r==m.Department&&this.departments.each(function(a){a.get("cid")==e&&i.DoChangeAttribute(a,e,t,r)})},DoChangeAttribute:function(t,r,i,a){var o=null;if(i!=C.DELCAT&&i!=C.DELDEP&&(o=e(r+i).val()),a==m.Category)switch(this.categories.HasChanges=!0,i){case C.DELCAT:if(!t)return;this.categories.remove(t),this.LoadCategoryCollection();break;case C.CAT:var n=t.get("CategoryCode");t.set({CategoryCode:o}),this.ValidateCategories(!0)||(t.set({CategoryCode:n}),this.LoadCategoryList(r+i,n)),this.categoryList&&this.categoryList.each(function(e){e.get("CategoryCode")==t.get("CategoryCode")&&t.set({Description:e.get("Description")})})}if(a==m.Department)switch(this.departments.HasChanges=!0,i){case C.DELDEP:if(!t)return;this.departments.remove(t),this.LoadDepartmentCollection();break;case C.DEP:var n=t.get("DepartmentCode");t.set({DepartmentCode:o}),this.ValidateDepartments(!0)||(t.set({DepartmentCode:n}),this.LoadDepartmentList(r+i,n)),this.departmentList&&this.departmentList.each(function(e){e.get("DepartmentCode")==t.get("DepartmentCode")&&t.set({Description:e.get("Description")})})}},AddNewCategory:function(){if(this.categoryList.model.length=0)return void navigator.notification.alert("There are no available Categories!",null,"Error","OK");if(this.Validate()){var e=new d;this.categories.add(e),this.categories.HasChanges=!0,this.RenderCategory(e,this.categories.models.length-1),this.ToggleCollapseButton(u.Category,m.Category,!0)}},AddNewDepartment:function(){if(this.categoryList.model.length=0)return void navigator.notification.alert("There are no available Departments!",null,"Error","OK");if(this.Validate()){var e=new d;this.departments.add(e),this.departments.HasChanges=!0,this.RenderDepartment(e,this.departments.models.length-1),this.ToggleCollapseButton(u.Department,m.Department,!0)}},ToggleCollapseButton:function(t,r,i){if(e(t).hasClass("icon-chevron-up")&&!i)e(t).removeClass("icon-chevron-up"),e(t).addClass("icon-chevron-down"),e(r).hide();else{if(i&&e(t).hasClass("icon-chevron-up"))return;e(t).removeClass("icon-chevron-down"),e(t).addClass("icon-chevron-up"),e(r).show()}},Validate:function(){return!!this.ValidateCategories()&&!!this.ValidateDepartments()},ValidateCategories:function(t){if(!this.categories)return!1;var r="",i=!1,a="";return this.categories.each(function(o){if(!i){if(!t){if(!o.get("CategoryCode"))return i=!0,void(r="CategoryCode");if(""==e.trim(o.get("CategoryCode")))return i=!0,void(r="CategoryCode")}return a.indexOf("["+o.get("CategoryCode")+"]")>-1?(i=!0,void(r="Category_Duplicate")):void(a=a+"["+o.get("CategoryCode")+"]")}}),a=null,!i||(this.ValidationError=r,this.trigger("validationError"),!1)},ValidateDepartments:function(t){if(!this.departments)return!1;var r="",i=!1,a="";return this.departments.each(function(o){if(!i){if(!t){if(!o.get("DepartmentCode"))return i=!0,void(r="DepartmentCode");if(""==e.trim(o.get("DepartmentCode")))return i=!0,void(r="DepartmentCode")}return a.indexOf("["+o.get("DepartmentCode")+"]")>-1?(i=!0,void(r="DepartmentCode_Duplicate")):void(a=a+"["+o.get("DepartmentCode")+"]")}}),a=null,!i||(this.ValidationError=r,this.trigger("validationError"),!1)},RefreshiScroll:function(){a.isBrowserMode||(this.myScroll?(this.myScroll.refresh(),e("#detail-body").height()<e("#more-details").height()&&this.myScroll.scrollToElement("li:first-child",100)):this.myScroll=new iScroll("detail-body",{vScrollbar:!0,vScroll:!0,snap:!0,momentum:!0,useTransform:!1,onBeforeScrollStart:function(e){for(var t=e.target;1!=t.nodeType;)t=t.parentNode;"SELECT"!=t.tagName&&"INPUT"!=t.tagName&&"TEXTAREA"!=t.tagName&&e.preventDefault()}}),e("#detail-body div:first-child").css("width","100%"),e(".tables").css("width","80%"))}});return D});