define(["jquery","mobile","underscore","backbone","shared/enum","shared/global","shared/method","shared/service","shared/shared","model/postal","model/country","collection/base","collection/postal","collection/countries","view/18.2.0/pos/postal/addpostal","text!template/18.2.0/pos/payment/refund.tpl.html","text!template/18.2.0/pos/payment/check.tpl.html","text!template/18.2.0/pos/payment/creditcard.tpl.html","view/spinner","js/libs/jSignature.min.js"],function(e,t,n,a,r,o,s,c,l,u,d,h,y,C,m,p,g,f,v){var P,S,b,k=function(e){1==e?b.AddNewPostal():b.ClearPostalDetails()},w=a.View.extend({_template:n.template(p),_checkTemplate:n.template(g),_creditCardTemplate:n.template(f),events:{"tap #btn-savePayment":"btnSave_tap","tap #btn-cancelPayment":"btnClose_tap","tap .btn-clear-signature":"btnClearSignature_tap","keypress #checkNumber":"checkNumber_keypress","change #cc-msg":"processMsg","tap #cc-swipe":"btnSwipe_tap","change #isUnimag":"checkUnimag","tap #btn-more":"btnLoadMoreInfo_tap","change #ccCountry":"CountryChanged","change #ccCity":"CityChanged","keyup #ccPostal":"keyupPostal","blur  #ccPostal":"blurPostal","blur #ccEmail":"blurEmail","keyup #cardNumber":"cardNumber_keyup","focus #cvNumber":"AssignNumericValidation","focus #ccPhoneExt":"AssignNumericValidation","focus #ccPhone":"AssignNumericValidation","tap #btn-ask-to-sign":"btn_AskToSign","tap #btn-stop-asking":"btnCancel_Retrieval"},btn_AskToSign:function(e){e.preventDefault(),console.log("btn_AskToSign"),this.$(".btn-ask-to-sign").attr("id","btn-stop-asking"),T(),this.trigger("allowUserToAttachSign","Refund",this)},btnCancel_Retrieval:function(e){e.preventDefault(),I(),this.trigger("cancelSignRetrieval","Refund",this)},SketchSignature:function(e){I(),N=!0,this.sketchView=!0,this.ShowSignatureDisplay(),this.LoadSignature(e)},ShowSignatureDisplay:function(){this.sketchView&&(this.$(".signature").jSignature("reset"),this.$(".signature").hide(),this.$(".signatureDisplay").show())},LoadSignature:function(t){if(null!=t){var i=new Image;i.src="data:image/svg+xml;base64,"+t,this.$(".signatureDisplay").html(e(i))}},keyupPostal:function(t){if(13===t.keyCode){this.keyupIsTriggered=!0;var i=e("#ccPostal").val();this.LoadPostal(i)}},AssignNumericValidation:function(e){l.Input.NonNegativeInteger("#"+e.target.id)},blurPostal:function(t){if(l.IsNullOrWhiteSpace(this.keyupIsTriggered)){var i=e("#ccPostal").val();this.LoadPostal(i)}this.keyupIsTriggered=!1},blurEmail:function(t){var i=e("#ccEmail").val();if(l.ValidateEmailFormat(i))return void navigator.notification.alert("Email format is invalid.",null,"Invalid Email","OK")},cardNumber_keyup:function(t){if(13===t.keyCode){var i=e("#cardNumber").val();o.isBrowserMode&&i.length>16&&(this.isUnimag=!1,l.CreditCard.ParseCreditCardMagWithValidation(i,this.isUnimag))}},checkUnimag:function(t){t.preventDefault();var i=e("#isUnimag").text();"true"===i&&e("#cc-msg").text("Establishing connection...")},btnSwipe_tap:function(t){t.preventDefault(),o.isBrowserMode?(e("#cardNumber").focus(),this.RequestSwipe("Please swipe card."),l.CreditCard.ClearCreditCardInfo(),e("#expDate").removeClass("ui-disabled")):(this.RequestSwipe("Please swipe card."),e("#expDate").removeAttr("readonly"))},btnSave_tap:function(e){e.preventDefault(),this.SavePayment()},btnClose_tap:function(e){return e.preventDefault(),this.IsWaiting()?void navigator.notification.alert("Waiting the for customer's signature.",null,"Invalid Action","OK"):(this.sketchView=!1,void this.Close(!0))},IsWaiting:function(){return this.$("#signature").hasClass("ui-disabled")},btnClearSignature_tap:function(e){e.preventDefault(),this.ClearSignature()},ClearSignature:function(){var e=o.Signature;this.sketchView?(this.$(".signature").show(),this.$(".signatureDisplay").hide(),e.indexOf("[SVGID]:")!==-1?this.trigger("deleteSavedSignature",o.Signature,this):o.Signature=null):this.$(".signature").jSignature("reset"),this.sketchView=!1,N=!1},btnLoadMoreInfo_tap:function(t){switch(t.preventDefault(),t.currentTarget.innerHTML){case"More":e("#paymentAdditionalFields").show(),e("#paymentPrimaryFields").hide(),e(".signature-container").css("visibility","hidden"),e(".refundDetails").css("height","320px"),e("#cc-msgContainer").css("visibility","hidden"),e("#btn-more").text("Back"),this.InitializePostal(),this.InitializeCountry();break;case"Back":e("#paymentAdditionalFields").hide(),e("#paymentPrimaryFields").show(),e(".signature-container").css("visibility","visible"),e(".refundDetails").css("height",""),e("#cc-msgContainer").css("visibility","visible"),e("#btn-more").text("More")}},processMsg:function(t){t.preventDefault();var i=e("#cc-msg").text(),n=e("#track1").text(),a=e("#track2").text(),r=e("#ksn").text();console.log("Refund: "+i),"Card unreadable. Try again."===i?this.RequestSwipe("Please swipe card again."):"Successfully retrieved credit card information."===i&&""===n&&""===a&&""===r&&(e("#cardNumber").val(""),e("#expDate").val(""),e("#cardName").val(""),e("#track1").text(""),e("#track2").text(""),e("#ksn").text(""),console.log("Unable to read card information."),o.isBrowserMode||navigator.notification.alert("Unable to get credit card information. Please swipe again.",null,"Unable to Proceed","OK"))},checkNumber_keypress:function(t){e("#amountPaid").val();13===t.keyCode&&(this.$("#checkNumber").blur(),this.SavePayment())},CountryChanged:function(t){var i=t.target.id,n=e("#"+i).val(),a=e("#ccPostal").val();this.countrySelected!=n&&a.length>0&&this.ClearPostalInfo(),this.countrySelected=n,this.PreviousCountrySelected=n},CityChanged:function(e){e.preventDefault(),this.SetState()},initialize:function(){this.payment=this.options.payment,b=this},render:function(){this.$el.html(this._template({PaymentType:o.PaymentType})),this.InitializePaymentDetail(),this.countrySelected=null,o.isBrowserMode||this.ActivateUnimagPlugin()},LoadUnimagPlugin:function(){l.NMIPaymentGateway.ActivateUnimag(),l.NMIPaymentGateway.isConnected();var t=this;e("#cc-msg").off("failedToDetectDevice"),e("#cc-msg").on("failedToDetectDevice",function(){navigator.notification.confirm("The device was not detected, would you like to try again?",function(e){1==e&&(console.log("Attemping to detect device."),l.NMIPaymentGateway.DeactivateUnimag(),t.LoadUnimagPlugin())},"Unable to Detect Device",["Yes","No"])})},InitializePaymentDetail:function(){switch(o.PaymentType){case r.PaymentType.Check:this.InitializeCheckPayment();break;case r.PaymentType.CreditCard:this.InitializeCreditCardPayment()}this.$(".refundDetails").trigger("create")},InitializePostal:function(){this.postalmodel||(this.postalmodel=new u),this.postalCollection||(this.postalCollection=new h)},LoadPostal:function(t){if(""==t)this.ClearCity();else{var i=this;l.LoadPostalByCode(t,function(e){i.postalCollection.reset(e),i.DisplayResultOnPostal(t)},function(t){i.postalCollection.reset(),i.postalCollection.RequestError(t,"Error Loading Postal Code"),e("#ccPostal").val("")})}},AddNewPostal:function(){var t=e("#addPostalCodeContainer"),i=e("#ccPostal").val(),n=e("#ccCountry option:selected").val();e(t).html("<div id='addPostalContainer' style='display: none'></div>");var a=e("#addPostalContainer");l.IsNullOrWhiteSpace(this.newPostalView)?this.newPostalView=new m({el:a}):(this.newPostalView.remove(),this.newPostalView=new m({el:a})),this.newPostalView.on("AcceptPostal",this.AcceptPostal,this),this.newPostalView.on("ClearPostal",this.ClearPostalDetails,this),this.newPostalView.Show(i,n,this.countryCollection)},AcceptPostal:function(t){this.countrySelected=t.CountryCode,this.SetSelectedCountry(this.countrySelected),e("#ccPostal").val(t.PostalCode),e("#ccCity").val(t.StateCode),this.postal=t.PostalCode,this.city=t.City,this.LoadPostal(this.postal,this.city)},ClearPostalDetails:function(){e("#ccPostal").val(""),this.postal="",this.ClearCity()},DisplayResultOnPostal:function(t){this.newCollection=new h,this.postalCollection.each(this.RemoveInvalidPostals,this),this.postalCollection=this.newCollection,0===this.postalCollection.length?navigator.notification.confirm("The Postal Code '"+t+"' does not exist in the Country selected. Do you want to add '"+t+"' ?",k,"Postal Not Found",["Yes","No"]):(e('#ccCity > option[val !=""]').remove(),this.LoadRetrievedPostal(),e("#ccCity").prop("selectedIndex",0),e("#ccCity").trigger("change"))},LoadRetrievedPostal:function(){this.postalCollection.each(this.SetFields,this)},RemoveInvalidPostals:function(e){var t=e.get("CountryCode");t===this.countrySelected&&this.newCollection.add(e)},ClearPostalInfo:function(){e("#ccPostal").val(""),e("#ccState").val(""),this.ClearCity()},ClearCity:function(){e('#ccCity > option[val !=""]').remove(),e("#ccCity").append(new Option("City...","")),e("#ccCity").prop("selectedIndex",0),e("#ccCity").trigger("change"),e("#ccState").val("")},SetState:function(){var t=e("#ccCity option:selected").val();if(""!=t){var i=this.postalCollection.find(function(e){return t=e.get("City")}),n=i.get("StateCode");e("#ccState").val(n)}else e("#ccState").val("")},SetFields:function(t){var i=t.get("City");e("#ccCity").append(new Option(i,i)),e("#ccCity").selectmenu("refresh",!0),this.SetState()},InitializeCountry:function(){this.countryModel||(this.countryModel=new d,this.countryModel.on("sync",this.SuccessCountryLookupResult,this),this.countryModel.on("error",this.ErrorCountryLookupResult,this)),this.countryCollection?0===this.countryCollection.length?this.LoadCountry():this.ReloadCountry(this.countryCollection):(this.countryCollection=new y,this.countryCollection.on("reset",this.DisplayCountries,this),this.LoadCountry())},LoadCountry:function(){_rows=1e4,this.index=0,this.countryModel.set({Criteria:""}),this.countryModel.url=o.ServiceUrl+c.CUSTOMER+s.COUNTRYCODELOOKUP+_rows,this.countryModel.save()},SuccessCountryLookupResult:function(e,t,i){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),this.countryCollection.reset(t.Countries)},ErrorCountryLookupResult:function(e,t,i){o.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.RequestError(t,"Error Loading Country List")},DisplayCountries:function(e){0===e.length?(console.log("no countries available."),navigator.notification.alert("No country available.",null,"No Country Found","OK")):this.ReloadCountry(e)},LoadRetrievedCountry:function(t){t.each(this.SetCountryOptions,this),e("#ccCountry").selectmenu("refresh",!0)},SetCountryOptions:function(t){var i=t.get("CountryCode");e("#ccCountry").append(new Option(i,i))},SetSelectedCountry:function(t){e("#ccCountry > option[value='"+t+"']").attr("selected","selected"),e("#ccCountry").selectmenu("refresh",!0)},ReloadCountry:function(t){e('#ccCountry > option[val !=""]').remove(),this.LoadRetrievedCountry(t),null!==this.countrySelected&&void 0!==this.countrySelected||(this.countrySelected=o.CurrentCustomer.Country?o.CurrentCustomer.Country:o.ShipTo.Country),this.SetSelectedCountry(this.countrySelected)},InitializeCheckPayment:function(){e(".refundDetails").html(this._checkTemplate({Balance:this.transactionBalance}))},InitializeCreditCardPayment:function(){e(".refundDetails").html(this._creditCardTemplate({NameOnCard:o.CurrentCustomer.CustomerName,Balance:this.transactionBalance})),l.BrowserModeDatePicker("#expDate","datepicker","yy-mm"),o.isBrowserMode&&(e("#cardNumber").focus(),e("#cc-msg").text("Enter Credit card details."))},DestroyCountryAndPostal:function(){this.postalModel&&this.postalModel.clear(),this.countryModel&&this.countryModel.clear(),this.countryCollection&&this.countryCollection.reset(void 0,{silent:!0}),this.postalCollection&&this.postalCollection.reset(void 0,{silent:!0})},Close:function(e){o.Signature=null,this.DestroyCountryAndPostal(),this.Hide(e)},Show:function(t){this.sketchView=!1,this.transactionBalance=t,this.render(),this.$el.show(),e("#creditCardAutorizaiton").hide(),this.InitializeSignature()},Hide:function(e){o.isBrowserMode||this.DeactiveUnimag(),this.$el.html(""),this.$el.hide(),e&&this.RemoveScreenOverLay()},ActivateUnimagPlugin:function(){void 0!=window.plugins&&"Credit Card"===o.PaymentType&&(o.isBrowserMode||this.LoadUnimagPlugin());var t=e("#isUnimag").text();"false"===t&&e("#cc-msg").text("Device is not connected.")},DeactiveUnimag:function(){void 0!=window.plugins&&"Credit Card"===o.PaymentType&&(o.isBrowserMode||l.NMIPaymentGateway.DeactivateUnimag())},RequestSwipe:function(t){e("#cardNumber").val(""),l.SetDefaultToday("#expDate","YYYY-MM"),e("#cardName").val(""),e("#track1").text(""),e("#track2").text(""),e("#ksn").text(""),o.isBrowserMode||l.NMIPaymentGateway.RequestSwipe(),e("#cc-msg").text(t)},RemoveScreenOverLay:function(){e("#main-transaction-blockoverlay").hide()},InitializeSignature:function(){var t=!1;switch(N=!1,o.PaymentType){case r.PaymentType.Check:t=o.Preference.RequireSignatureOnCheck;break;case r.PaymentType.CreditCard:t=o.Preference.RequireSignatureOnCreditCard}this.$(".signatureDisplay").hide(),this.$(".signature-container").show(),this.$(".signature").jSignature({height:"100px"}),e("#paymentContainer").addClass("paymentFormLarge"),t?this.$(".signature").bind("change",this.SignatureChanged):(this.$(".signature-container").css("overflow","hidden"),this.$(".signature-container").css("height","0px"),this.$(".signature-container").css("visibility","hidden"))},SignatureChanged:function(e){N=!0},SavePayment:function(){if(this.IsWaiting())return void navigator.notification.alert("Waiting the for customer's signature.",null,"Invalid Action","OK");var t=this.transactionBalance,i=e("#ccEmail").val(),n=e("#cardReferenceNumber").val();this.ValidatePayment(o.PaymentType,t)&&this.ValidateSignature(o.PaymentType)&&this.ValidateEmail(o.PaymentType,i)&&this.ValidateCardReference(o.PaymentType,n)&&this.AddPayment(o.PaymentType,t)},ValidateEmail:function(e,t){return e!==r.PaymentType.CreditCard||""==t||(!l.ValidateEmailFormat(t)||(navigator.notification.alert("Email format is invalid.",null,"Invalid Email","OK"),!1))},ValidateCardReference:function(e,t){return e!==r.PaymentType.CreditCard||(""===t?(navigator.notification.alert("Reference number is required. Reference number is found on the receipt.",null,"Card reference required","OK"),!1):this.CheckCardReference(t))},ValidatePayment:function(t,i){if(!i||0===i)return console.log("Please specify an amount."),navigator.notification.alert("Please specify an amount.",null,"Amount is Required","OK"),!1;switch(t){case r.PaymentType.Check:var n=e("#checkNumber").val();if(""===n.trim())return console.log("Please enter the Check Number."),navigator.notification.alert("Please enter the Check Number.",null,"Check Number is Required","OK"),!1;break;case r.PaymentType.CreditCard:var a=e("#cardNumber").val(),o=e("#expDate").val(),s=e("#cardName").val();if(""===a.trim())return console.log("Please enter the Card Number."),navigator.notification.alert("Please enter the Card Number.",null,"Card Number is Required","OK"),!1;if(""===o.trim())return console.log("Please enter the Expiration Date."),navigator.notification.alert("Please enter the Expiration Date.",null,"Expiration Date is Required","OK"),!1;if(""===s.trim())return console.log("Please enter the Name on Card."),navigator.notification.alert("Please enter the Name on Card.",null,"Name on Card is Required","OK"),!1;var c=this.GetDateError(o);if(c)return console.log(c),navigator.notification.alert(c,null,"Invalid Date","OK"),!1}return!0},GetDateError:function(e){var t=0,i=0,n=new Date,a=n.getMonth()+1,r=n.getFullYear(),o=!1,s=!1;return e=e.split("-"),2===e.length?(t=e[0],i=e[1],isNaN(i)||isNaN(t)?o=!0:(t=parseFloat(t),i=parseFloat(i),i>12||0==i?o=!0:t<r?s=!0:t==r&&i<a&&(s=!0))):o=!0,o?"Invalid Expiration Date format. Use YYYY-MM.":s?"Card is already expired.":null},ValidateSignature:function(e){switch(e){case r.PaymentType.Check:if(o.Preference.RequireSignatureOnCheck&&N===!1)return console.log("A signature from the customer is required."),navigator.notification.alert("A signature from the customer is required.",null,"Signature is Required","OK"),!1;break;case r.PaymentType.CreditCard:if(o.Preference.RequireSignatureOnCreditCard&&N===!1)return console.log("A signature from the customer is required."),navigator.notification.alert("A signature from the customer is required.",null,"Signature is Required","OK"),!1}return!0},AddPayment:function(e,t){return 0===t?(console.log("Please enter the Amount Paid."),navigator.notification.alert("Please enter the Amount Paid.",null,"Amount is Required","OK"),!1):(payment=this.CreatePayment(e,t),void this.Close())},CreatePayment:function(e,t){switch(e){case r.PaymentType.Cash:this.AddCashPayment(t);break;case r.PaymentType.Check:this.AddCheckPayment(t);break;case r.PaymentType.CreditCard:this.AddCreditCardPayment(t)}},AddCashPayment:function(e){this.collection.add({AmountPaid:e,PaymentType:r.PaymentType.Cash,Account:this.GetPaymentAccountInfo(),IsNew:!0,POSWorkstationID:o.POSWorkstationID,POSClerkID:o.Username})},AddCheckPayment:function(t){var i=e("#checkNumber").val(),n="";N&&(n=this.GetSignature()),this.collection.add({CheckNumber:i,PaymentType:r.PaymentType.Check,AmountPaid:t,Account:this.GetPaymentAccountInfo(),IsNew:!0,SignatureSVG:n,POSWorkstationID:o.POSWorkstationID,POSClerkID:o.Username})},AddCreditCardPayment:function(t){var i=["January","February","March","April","May","June","July","August","September","October","November","December"],n=e("#cardNumber").val(),a=e("#expDate").val(),s=e("#cardName").val(),c=e("#track1").text(),l=e("#track2").text(),u=e("#ksn").text(),d=e("#cvNumber").val(),h=e("#ccCountry option:selected").val(),y=e("#ccPostal").val(),C=e("#ccAddress").val(),m=e("#ccCity option:selected").val(),p=e("#ccState").val(),g=e("#ccPhone").val(),f=e("#ccPhoneExt").val(),v=e("#ccEmail").val(),b=(e("#cardReferenceNumber").val(),e("#authorizationNumber").val()),k=(e("#isSwiped").html(),""),w="",T="",D="",I=!1,A=""!=u&&null!=u;console.log("TRACK1 "+c+"TRACK2 "+l+"KSN "+u),a=a.split("-"),2===a.length&&(k=a[0],w=i[parseInt(a[1])-1]),o.TransactionType===r.TransactionType.Order||o.TransactionType===r.TransactionType.UpdateOrder||o.TransactionType===r.TransactionType.ConvertQuote?(T="Authorize",""!=b&&(I=!0)):(T="Auth/Capture",""!=b&&(I=!0)),N&&(D=this.GetSignature()),T=this.GetCreditCardTransactionType(T,I,r.PaymentType.CreditCard,n),this.collection.add({AmountPaid:t,PaymentType:r.PaymentType.CreditCard,CreditCardNumber:n,ExpDateYear:k,ExpDateMonth:w,NameOnCard:s,CardTransactionType:T,IsNew:!0,SignatureSVG:D,Track1:c,Track2:l,Ksn:u,MagnePrint:P,MagnePrintStatus:S,IsCreditCardEncrypted:A,CreditCardIsAuthorizedVerbally:I,CreditCardAuthorizationCode:b,AuthorizationCode:b,IsUnimag:!0,Email:v,Address:C,Country:h,PostalCode:y,City:m,State:p,Telephone:g,TelephoneExtension:f,CardVerification:d,POSWorkstationID:o.POSWorkstationID,POSClerkID:o.Username}),console.log("This was sent: "+JSON.stringify(this.collection)),this.isUnimag=!1},GetCreditCardTransactionType:function(e,t,i,n){if("Credit Card"==i)switch(o.TransactionType){case"Convert Quote":return"Authorize";case"Suspended":case"Resume Sale":return t&&o.IsPosted&&("Auth"==e||"Authorize"==e)?"Force":o.IsPosted&&!t?"Auth/Capture":"Authorize";default:return o.IsPosted?t&&o.IsPosted&&""==!n?"Force":"Auth/Capture":"Authorize"}return null},CheckCardReference:function(e){var t=this.payment.pluck("CreditCardReference");console.log(t);for(i in t)if(e==t[i])return!0;return navigator.notification.alert("Please enter the correct Reference number found in the receipt.",null,"Incorrect Input","OK"),!1},GetPaymentAccountInfo:function(){return o.Preference.IsDepositPayment?"Deposit":"Undeposited"},SetFocusedField:function(){switch(o.PaymentType){case r.PaymentType.Check:this.$("#checkNumber").focus();break;case r.PaymentType.CreditCard:this.$("#cardNumber").focus()}},GetSignature:function(){if(this.sketchView)return o.Signature;var e=this.$(".signature").jSignature("getData","svgbase64");return e?e[1]:null},HideActivityIndicator:function(){_spinner=v,_spinner.stop(),e("#lblSpinner").remove()},ResetField:function(){e("#track1").val(""),e("#track2").val(""),e("#ksn").val("")}}),T=function(){var t=document.getElementById("btn-stop-asking");_spinner=v,_spinner.opts.left=10,_spinner.opts.radius=3,_spinner.opts.lines=9,_spinner.opts.length=4,_spinner.opts.width=3,_spinner.opts.color="#000",_spinner.spin(t,"Cancel"),e("#btn-stop-asking .ui-btn-text").text("Cancel"),e(".btn-ask-to-sign").css("text-align","center"),e("#signature").addClass("ui-disabled")},D=function(){_spinner=v,_spinner.stop()},I=function(){this.$(".btn-ask-to-sign").attr("id","btn-ask-to-sign"),e(".btn-ask-to-sign .ui-btn-text").text("Allow User To Sign"),e(".btn-ask-to-sign").css("text-align","center"),D(),e("#signature").removeClass("ui-disabled")},N=!1;return w});