define(["jquery","mobile","underscore","backbone","shared/global","shared/enum","shared/service","shared/method","shared/shared","model/base","model/serialnumber","collection/base","view/18.2.0/pos/seriallot/serial/serials","view/18.2.0/pos/seriallot/list/lists","text!template/18.2.0/pos/seriallot/seriallot.tpl.html"],function(e,t,i,r,a,o,n,s,l,c,d,u,h,m,g){var p=r.View.extend({_template:i.template(g),events:{"tap #done-serialLot":"buttonDone_tap","keypress #input-serialLot":"addSerial_keypress","change #input-serialLot":"addSerial_change","tap #add-serialLot":"buttonAdd_tap","tap #cancel-serialLot":"buttonCancel_tap","tap #view-serialList":"buttonView_tap"},addSerial_keypress:function(e){e=e||event;var t=String.fromCharCode(e.keyCode||e.which),i=this.validateString(t);return i.valid||13==e.keyCode?void(13===e.keyCode&&this.ProcessAddSerialLotNumber()):void e.preventDefault()},addSerial_change:function(t,i){var r=e("#input-serialLot").val(),a=this.validateString(r);a.valid||e("#input-serialLot").val(a.val)},validateString:function(e){var t=!0;e=e||"",/\s/g.test(e)&&(e=e.replace(/\s/g,""),t=!1);var i=new RegExp(/[^-\w\s]/gi);return i.test(e)&&(e=e.replace(/[^-\w\s]/gi,""),t=!1),{val:e,valid:t}},buttonDone_tap:function(e){e.preventDefault(),this.validateClosingForm()},buttonAdd_tap:function(e){e.preventDefault(),this.ProcessAddSerialLotNumber()},buttonCancel_tap:function(t){t.preventDefault(),this.Hide(),this.autoGenerate?e("#gclookup").is(":visible")&&this.trigger("SerialGenerated"):a.TransactionType===o.TransactionType.SalesRefund?this.validateIsIncluded():e("#gclookup").is(":visible")&&this.validateClosingForm(!0)},buttonView_tap:function(t){t.preventDefault(),e("#serialLot-content").hide()},validateClosingForm:function(t){try{var i="SerialLotNumber is Required. The following items do not have the same number of serial numbers with the shipped quantity.",r=this.ValidateClosingSerial(this.collection,this.cartCollection,i);if(this.model.get("ItemType")===o.ItemType.GiftCard||this.model.get("ItemType")===o.ItemType.GiftCertificate){if(void 0===r||""===r)this.Hide();else if(!t)throw r}else this.Hide();e("#gclookup").is(":visible")&&!r&&(a.TransactionType===o.TransactionType.SalesRefund?this.validateIsIncluded():this.trigger("SerialGenerated"))}catch(n){navigator.notification.alert(n,null,"Action not allowed","OK"),console.log(n)}},validateIsIncluded:function(){var e=0,t=this;this.collection.each(function(i){i.get("ItemCode")===t.model.get("ItemCode")&&i.get("LineNum")===t.model.get("LineNum")&&i.get("IsIncluded")&&t.model.get("Good")!=e&&e++});var i=this.collection.filter(function(e){return e.get("ItemCode")===t.model.get("ItemCode")&&e.get("LineNum")===t.model.get("LineNum")});e===i.length&&this.trigger("SerialGenerated")},IsSerialListEmpty:!1,initialize:function(){this.type=this.options.type,this.itemCode=this.options.itemCode,this.itemName=this.options.itemName,this.lineNum=this.options.lineNum,this.itemType=this.options.itemType,this.uom=this.options.unitMeasure,this.eventname=this.options.serialEvent,this.model=new c(this.options.itemModel),this.cartCollection=this.options.cartCollection,this.serialList=this.options.serialList,this.collection.comparator=function(e){return e.get("SerialLotCode")},this.InitializeEvents(),this.isProcessing=!1},render:function(){this.$el.html(this._template({SerialLotType:this.type,ItemName:this.itemName,UnitMeasureCode:this.uom})),this.$el.trigger("create"),this.HideElements()},AddSerialLotNumber:function(e,t,i,r,o,n,s,l,c,u,h,m,g){var p={SerialLotNumber:e,ItemCode:t,LineNum:i,ItemType:r,SerialLotCode:o,SerialLotType:n,SerializeLot:n,UnitMeasureCode:s,IsIncluded:m,SerialRecipient:h,IsReturned:l,IsActivated:c,IsSerialGenerated:u,OriginalSerialRecipient:h};if(this.ValidateAddSerialLot(p,r))switch(a.Preference.PreventDuplicateSerialNumber){case!0:this.ProcessValidateSerial(p,r);break;case!1:this.collection.add(p),this.collection.trigger("startRendering",new d(p)),this.isProcessing=!1}},AddSerialLotNumberByBatch:function(e){var t=[],i=this,r=[];if(e.each(function(e){var a=new d,o=i.CompareCurrentData("ItemType","ItemCode",e.get("ItemCode")),n=i.PopulateSerialRecipient(e.get("OriginalSerialRecipient"),e.get("SerialRecipient")),s={SerialLotNumber:e.get("SerialLotNumber"),ItemCode:e.get("ItemCode"),LineNum:e.get("LineNum"),ItemType:o,SerialLotCode:e.get("SerialLotCode"),SerialLotType:"None",SerializeLot:"None",UnitMeasureCode:i.RetrieveUnitMeasureCode(e.get("LineNum"),e.get("ItemCode")),IsIncluded:!1,SerialRecipient:n,IsReturned:e.get("IsReturned"),IsActivated:e.get("IsActivated"),IsSerialGenerated:e.get("IsSerialGenerated"),OriginalSerialRecipient:n};i.isItemAlreadyRemoved(e.get("ItemCode"),e.get("LineNum"))?r[r.length]=e:t.push(a.set(s))}),r.length>0)for(var a in r)e.remove(r[a]);t.length>0&&e.length===t.length&&(this.collection.add(t),this.collection.trigger("startRendering"))},isItemOnCart:function(){if(!this.cartCollection)return!0},AllowedToAddSerial:function(e){return a.TransactionType!=o.TransactionType.Recharge||(navigator.notification.alert("Action not allowed in "+a.TransactionType+" transaction. ",null,"Action not allowed"),!1)},ChangeEmailAddress:function(){"ItemDetail"!==this.eventname&&"QuantityOrderedUpdated"!==this.eventname||this.itemType!==o.ItemType.GiftCard&&this.itemType!==o.ItemType.GiftCertificate||this.collection.each(function(e){var t=e.get("SerialRecipient"),i=(e.get("OriginalSerialRecipient"),!!e.get("IsEmailModified"));t!=a.DefaultContactEmail&&(i||e.set({SerialRecipient:a.DefaultContactEmail,OriginalSerialRecipient:t}))})},CheckUnitMeasureCode:function(){var e=this,t=[];if(this.collection&&this.collection.length>0){var r=this.collection.toJSON().filter(function(t){return t.UnitMeasureCode===e.uom&&t.LineNum===e.model.LineNum});if(l.IsNullOrWhiteSpace(r)&&0===r.length){this.collection.comparator=function(e){return e.get("LineNum")},this.collection.sort({silent:!0});var a=e.model.get("QuantityOrdered")*e.model.get("UnitMeasureQty"),n=this.collection.filter(function(t){return t.get("ItemCode")===e.model.get("ItemCode")&&t.get("LineNum")===e.model.get("LineNum")});n&&n.length>0&&i.each(n,function(i,r){i.get("ItemType")===o.ItemType.GiftCard||i.get("ItemType")===o.ItemType.GiftCertificate?r<a?i.set({UnitMeasureCode:e.uom}):t.push(i):i.set({UnitMeasureCode:e.uom})}),t.length>0&&this.collection.remove(t)}}},CompareCurrentData:function(e,t,i,r){var a=this.cartCollection.find(function(e){return e.get(t)===i&&e.get(t)===r});return!a||null==a.get(e)&&""==a.get(e)&&void 0==a.get(e)?this.model.get(e):a.get(e)},isItemAlreadyRemoved:function(e,t){var i=this.cartCollection.find(function(i){return i.get("ItemCode")===e&&i.get("LineNum")===t});return!i},EmptySerialList:function(e){this.$("#serialListNumber").html("")},ErrorHandler:function(e,t,i){return""!=t.ErrorMessage||null!=t.ErrorMessage||void 0!=t.ErrorMessage?!t.Value||(navigator.notification.alert(this.type+" number ("+i.serialLotNumber+") you entered has duplicate(s) on other transaction(s).",null,"Duplicate "+this.type+" number(s)","OK"),this.isProcessing=!1,!1):(navigator.notification.alert(t.ErrorMessage,null,"Error Occured","OK"),!1)},FindSerialLotNumberDuplicate:function(e,t){switch(t){case!0:var i=this.collection.find(function(t){return t.get("SerialLotNumber").toUpperCase()===e.SerialLotNumber.toUpperCase()});break;default:var i=this.collection.find(function(t){return t.get("SerialLotNumber").toUpperCase()===e.SerialLotNumber.toUpperCase()&&t.get("ItemCode")===e.ItemCode})}return!i},GenerateGiftSerialNumber:function(){var t=this,i=function(i,r,o){l.HideActivityIndicator(),e("#spin").removeClass("z3000"),e("#itemDetail").is(":visible")||e("#main-transaction-blockoverlay").removeClass("z2990"),a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),t.ProcessGiftSerialNumber(new u(r.SerialLotNumbers))},r=function(t,i,r){l.HideActivityIndicator(),e("#spin").removeClass("z3000"),e("#main-transaction-blockoverlay").removeClass("z2990"),a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),navigator.notification.alert(i,null,"Error","OK")};if(!e("#spin").is(":visible")){var o="Generating serial number(s)...",n=document.getElementById("main-transaction-page");l.ShowActivityIndicator(n),e("<h5>"+o+"</h5>").appendTo(e("#spin")),e("#spin").addClass("z3000"),e("#main-transaction-blockoverlay").addClass("z2990").show()}l.SerialNumbers.GenerateGiftSerialNumber(t.model,t.collection,i,r,!1)},Hide:function(){this.$("#serialLot").remove();var t=!1;e("#gclookup").is(":visible")?this.ToggleOverlay(e("#gclookup").is(":visible")):(this.ToggleOverlay(e("#itemDetail").is(":visible")),e("#itemDetail").is(":visible")||(t=!0),this.trigger("Close",t)),l.FocusToItemScan()},HideElements:function(){a.TransactionType===o.TransactionType.SalesRefund||this.model.get("AutoGenerate")?(e("#input-serialLot").addClass("ui-disabled"),e("#add-serialLot").addClass("ui-disabled")):(e("#input-serialLot").removeClass("ui-disabled"),e("#add-serialLot").removeClass("ui-disabled"))},HideSerialList:function(){e("#serialLot").removeAttr("style","top: 10%"),e("#serialLot-content").removeAttr("style","height:200px; overflow:auto;"),e("#serialLot-list").hide()},InitializeEvents:function(){this.collection._callbacks&&this.collection.unbind(),this.collection.on("doneAdding",this.ProcessAddedData,this),this.collection.on("removeSerial",this.ProcessDeletedData,this),this.collection.on("removeLot",this.ProcessDeletedData,this),this.collection.on("reset",this.EmptySerialList,this),this.collection.on("change:SerialRecipient",this.ProcessAddedData,this)},InitializeGC:function(){if(this.itemType==o.ItemType.GiftCard||this.itemType==o.ItemType.GiftCertificate)switch(this.eventname){case"QuantityOrderedUpdated":this.model.get("AutoGenerate")?this.GenerateGiftSerialNumber():this.serialListView.Show();break;case"UnitMeasureUpdated":this.model.get("AutoGenerate")?this.GenerateGiftSerialNumber():(this.CheckUnitMeasureCode(),this.serialListView.Show());break;default:this.IsItemCodeExist(this.model.get("ItemCode"),this.model.get("UnitMeasureCode"))&&this.model.get("AutoGenerate")?this.GenerateGiftSerialNumber():this.serialListView.Show()}else switch(this.eventname){case"UnitMeasureUpdated":this.model.get("AutoGenerate")?this.GenerateGiftSerialNumber():(this.CheckUnitMeasureCode(),this.serialListView.Show());break;default:this.serialListView.Show()}},InitializeSerialList:function(t,i){var r=null;this.itemType!=o.ItemType.GiftCard&&this.itemType!=o.ItemType.GiftCertificate&&(t.sort({silent:!0}),r=this.type),this.serialListView&&(this.serialListView.unbind(),this.serialListView.remove(),this.serialListView=null),e("#serialLot-scroll").append("<div id='mainserialLot-scroll'></div>"),this.serialListView=new h({el:e("#mainserialLot-scroll"),collection:t,type:r,lineNum:this.lineNum,itemCode:i,uom:this.uom,itemType:this.itemType,autoGenerate:this.autoGenerate?this.autoGenerate:this.model.get("AutoGenerate")})},IsItemCodeExist:function(e,t){if(0===this.collection.length)return!0;var i=this.collection.filter(function(i){return i.get("ItemCode")===e&&i.get("UnitMeasureCode")===t});return!(i.length>0)},LoadData:function(){this.InitializeSerialList(this.ProcessItemType(this.collection),this.itemCode)},LoadItem:function(){var e=this,t=new c;t.url=a.ServiceUrl+n.PRODUCT+s.LOADITEMDETAILBYCODE+this.model.get("ItemCode"),t.fetch({success:function(t,i,r){a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),e.autoGenerate=i.ItemDetails[0].AutoGenerate,e.autoGenerate&&e.GenerateGiftSerialNumber(),e.InitializeSerialList(e.collection,e.itemCode)}})},PopulateSerialRecipient:function(e,t){var i="";return i=l.IsNullOrWhiteSpace(e)&&l.IsNullOrWhiteSpace(t)?a.DefaultContactEmail||"":!l.IsNullOrWhiteSpace(e)&&l.IsNullOrWhiteSpace(t)?t:t||a.DefaultContactEmail},ProcessAddedData:function(e){this.serialListView.ProcessAddedData(e)},ProcessDeletedData:function(e){this.collection.remove(e),this.collection.each(function(e,t){e.get("SerialLotCode")!=t+1&&e.set({SerialLotCode:t+1})})},ProcessAddSerialLotNumber:function(t){if(this.AllowedToAddSerial()){if(l.IsNullOrWhiteSpace(t)&&(t=e("#input-serialLot").val()),t.length<6)return void navigator.notification.alert("Please enter at least 6 characters.",null,"Incorrect Input","OK");if(this.model.get("QuantityOrdered")>0)this.isProcessing||(this.isProcessing=!0,this.AddSerialLotNumber(t,this.itemCode,this.lineNum,this.itemType,this.collection.length+1,this.type,this.uom,!1,!1,!1,this.PopulateSerialRecipient("",""),!1,this.model));else if("Gift Card"===this.model.get("ItemType")||"Gift Certificate"===this.model.get("ItemType"))return void navigator.notification.alert("Adding Serial for GiftCard / Certificate\nwhen Quantity Ordered is negative is not allowed",null,"Negative Quantity not Allowed","OK")}},ProcessGiftSerialNumber:function(e){e.length>0&&(this.collection.reset(),this.AddSerialLotNumberByBatch(e))},ProcessItemType:function(e){var t=this;return e.each(function(e){var i=t.CompareCurrentData("ItemType","ItemCode",e.get("ItemCode"));e.set({ItemType:i})}),e},ProcessSelectedSerial:function(e){this.AddSerialLotNumber(e.get("SerialLotNumber"),e.get("ItemCode"),this.model.get("LineNum"),this.itemType,this.collection.length+1,this.type,this.uom,e.get("IsReturned"),e.get("IsActivated"),e.get("IsGenerated"),e.get("SerialRecipient"),e.get("IsIncluded"),e)},ProcessValidateSerial:function(e,t){var i=this,r=function(t,r,o){a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),i.ErrorHandler(t,r,o)&&(i.collection.add(e),i.collection.trigger("startRendering"),i.isProcessing=!1)},n=function(e,t,r){a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),i.ErrorHandler(e,t,r)};if(this.FindSerialLotNumberDuplicate(e,t===o.ItemType.GiftCard||t===o.ItemType.GiftCertificate))switch(t){case o.ItemType.GiftCertificate:case o.ItemType.GiftCard:if(a.TransactionType==o.TransactionType.UpdateInvoice&&this.AllowSerialToBeAdded(e,r))return;this.ValidateGiftCardCertificateSerial(e,r);break;default:e.SerialLotType!=o.SerialLotType.Lot&&a.TransactionType!=o.TransactionType.SalesRefund?l.SerialNumbers.GetSerialLotNumberDuplicate(e.ItemCode,e.SerialLotNumber,a.TransactionCode?a.TransactionCode:"To be generated",r,n):(this.collection.add(e),this.collection.trigger("startRendering"),this.isProcessing=!1)}else navigator.notification.alert(this.type+" number you entered already exist. Try adding different "+this.type+" number.",null,"Duplicate "+this.type+" Number","OK"),this.isProcessing=!1},AllowSerialToBeAdded:function(e,t){if(!a.invDetailSerialCollection)return!1;var i=a.invDetailSerialCollection.find(function(t){return t.get("ItemCode")==e.ItemCode&&t.get("SerialLotNumber").toLowerCase()==e.SerialLotNumber.toLowerCase()});if(!i)return!1;var r=this.collection.find(function(t){return t.get("ItemCode")==e.ItemCode&&t.get("SerialLotNumber").toLowerCase()==e.SerialLotNumber.toLowerCase()});return!r&&(i.set({ItemType:e.ItemType}),this.collection.add(i.attributes),this.collection.trigger("startRendering"),this.isProcessing=!1,!0)},RemoveGCSerial:function(){var e=this.collection.filter(function(e){return e.get("ItemType")!=o.ItemType.GiftCard&&e.get("ItemType")!=o.ItemType.GiftCertificate});e&&this.collection.reset(e)},RenderSerialForReturn:function(){var e=this;this.collection.each(function(t){t.set({ItemType:e.CompareCurrentData("ItemType","ItemCode",t.get("ItemCode"),t.get("UnitMeasureCode"))})}),this.InitializeSerialList(this.collection,this.itemCode),this.serialListView.Show()},RetrieveSerialNumberList:function(e,t,i,r,o){var s=this,d=new c,h=new u,m={CustomerCode:e,ItemCode:t,LineNum:i,DocumentCode:r};l.IsNullOrWhiteSpace(o)&&(o=null),d.url=a.ServiceUrl+n.SOP+"getseriallotnumberlist/"+o,d.set(m),d.save(d,{success:function(e,t,i){if(a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),l.IsNullOrWhiteSpace(t.SerialLotNumbers))s.Hide();else{if(!l.IsNullOrWhiteSpace(t.ErrorMessage))return void navigator.notification.alert(t.ErrorMessage,null,"Error","OK");h.reset(t.SerialLotNumbers),s.ShowSerialNumberList(h)}},error:function(e,t,i){a.isBrowserMode||window.plugins.cbNetworkActivity.HideIndicator(),navigator.notification.alert("Error retrieving SerialLotNumber List.",null,"Error","OK")}})},RetrieveUnitMeasureCode:function(e,t){var i=this.cartCollection.find(function(i){return i.get("LineNum")===e&&i.get("ItemCode")===t});return i?i.get("UnitMeasureCode"):""},Show:function(){this.ValidateQuantity()?(this.render(),e("#main-transaction-blockoverlay").show(),this.InitializeSerialList(this.ProcessItemType(this.collection),this.itemCode),this.InitializeGC(),a.TransactionType!==o.TransactionType.SalesRefund&&a.TransactionType!==o.TransactionType.Recharge||(this.RenderSerialForReturn(),this.itemType!=o.ItemType.GiftCard&&this.itemType!=o.ItemType.GiftCertificate&&a.TransactionType!=o.TransactionType.UpdateInvoice&&this.ShowSerialNumberList(this.serialList)),l.BlurItemScan(),this.IsSerialListEmpty||this.ToggleOverlay(),this.IsSerialListEmpty=!1):navigator.notification.alert("Adding Serial for GiftCard / Certificate\nwhen Quantity Ordered is negative is not allowed",null,"Negative Quantity not Allowed","OK")},ShowSerialNumberList:function(t){e("#serialLot").attr("style","top: 10%"),e("#serialLot-content").attr("style","height:200px; overflow:auto;");var i=new m({el:e("#serialLot-inner"),collection:t,serial:this.collection,view:this});i.on("selected",this.ProcessSelectedSerial,this),i.on("hideSerialList",this.HideSerialList,this)},ToggleOverlay:function(t){var i={SerialLot:"#serialLot",ItemDetail:"#itemDetail",GCList:"#gclookup",ProductLookup:"#lookup",MainOverlay:"#main-transaction-blockoverlay"},r=e(i.ItemDetail).is(":visible"),a=e(i.GCList).is(":visible"),o=e(i.MainOverlay).is(":visible");e(i.ProductLookup).is(":visible");r||a?t?(e(i.SerialLot).removeClass("z3000"),e(i.MainOverlay).removeClass("z2990"),e(i.MainOverlay).show()):(e(i.SerialLot).addClass("z3000"),e(i.MainOverlay).addClass("z2990"),e(i.MainOverlay).show()):l.IsNullOrWhiteSpace(t)?o||e(i.MainOverlay).show():e(i.MainOverlay).hide()},UpdateEmail:function(){this.collection.each(function(e){var t=e.get("SerialRecipient");e.get("OriginalSerialRecipient"),!!e.get("IsEmailModified");e.set({SerialRecipient:a.DefaultContactEmail,OriginalSerialRecipient:t})})},ValidateClosingSerial:function(e,t,r){var n=r,s=0,l=this,c=this.model.get("ItemType")===o.ItemType.GiftCard||this.model.get("ItemType")===o.ItemType.GiftCertificate;if(e&&c){var d=!1,u=e.filter(function(e){return e.get("ItemCode")===l.model.get("ItemCode")&&e.get("UnitMeasureCode")===l.model.get("UnitMeasureCode")&&e.get("LineNum")===l.model.get("LineNum")});if(a.TransactionType===o.TransactionType.SalesRefund){var h=i.filter(u,function(e){return!!e.get("IsIncluded")});d=h.length===this.model.get("Good")*this.model.get("UnitMeasureQty")}else d=u.length===this.model.get("QuantityOrdered")*this.model.get("UnitMeasureQty");return d||s++,s>0?n:void 0}},ValidateSerialLot:function(e,t,i){var r=i,a=0,n=this.model.get("ItemType")===o.ItemType.GiftCard||this.model.get("ItemType")===o.ItemType.GiftCertificate;if(e&&n){var s=this.model,l=!1,c=e.filter(function(e){return e.get("ItemCode")===s.get("ItemCode")&&e.get("UnitMeasureCode")===s.get("UnitMeasureCode")&&e.get("IsSerialGenerated")===!1&&s.get("ItemType")===e.get("ItemType")&&e.get("LineNum")===s.get("LineNum")});return l=c.length!=s.get("QuantityOrdered")*s.get("UnitMeasureQty"),l||a++,a>0?r:void 0}},ValidateAddSerialLot:function(e,t){if(!e.IsSerialGenerated&&(t==o.ItemType.GiftCard||t==o.ItemType.GiftCertificate))try{var i="The following items do not have the same number of serial numbers with the shipped quantity.",r=this.ValidateSerialLot(this.collection,this.cartCollection,i);if(void 0==r||""==r)return!0;throw this.isProcessing=!1,r}catch(a){return navigator.notification.alert(a,null,"Action not Allowed","OK"),this.isProcessing=!1,!1}return!0},ValidateGiftCardCertificateSerial:function(e,t,i){var r=this,o=new c;o.url=a.ServiceUrl+n.SOP+"validategiftcardcertificateserial/"+e.SerialLotNumber,o.fetch({success:function(i,r,a){a={serialLotNumber:e.SerialLotNumber},t(i,r,a)},error:function(e,t,i){r.ErrorHandler(e,t,i)}})},ValidateQuantity:function(){return!(this.model.get("QuantityOrdered")<0)||this.model.get("ItemType")!==o.ItemType.GiftCertificate&&this.model.get("ItemType")!==o.ItemType.GiftCard}});return p});