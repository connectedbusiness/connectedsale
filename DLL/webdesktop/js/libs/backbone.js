!function(t,e){"undefined"!=typeof exports?e(t,exports,require("underscore")):"function"==typeof define&&define.amd?define(["underscore","jquery","exports"],function(i,n,s){t.Backbone=e(t,s,i,n)}):t.Backbone=e(t,{},t._,t.jQuery||t.Zepto||t.ender)}(this,function(t,e,i,n){var s=t.Backbone,r=Array.prototype.slice,o=Array.prototype.splice;e.VERSION="0.9.2",e.setDomLibrary=function(t){n=t},e.noConflict=function(){return t.Backbone=s,e},e.emulateHTTP=!1,e.emulateJSON=!1;var a=/\s+/,h=e.Events={on:function(t,e,i){var n,s,r,o,h;if(!e)return this;for(t=t.split(a),n=this._callbacks||(this._callbacks={});s=t.shift();)h=n[s],r=h?h.tail:{},r.next=o={},r.context=i,r.callback=e,n[s]={tail:o,next:h?h.next:r};return this},off:function(t,e,n){var s,r,o,h,c,u;if(r=this._callbacks){if(!(t||e||n))return delete this._callbacks,this;for(t=t?t.split(a):i.keys(r);s=t.shift();)if(o=r[s],delete r[s],o&&(e||n))for(h=o.tail;(o=o.next)!==h;)c=o.callback,u=o.context,(e&&c!==e||n&&u!==n)&&this.on(s,c,u);return this}},trigger:function(t){var e,i,n,s,o,h,c;if(!(n=this._callbacks))return this;for(h=n.all,t=t.split(a),c=r.call(arguments,1);e=t.shift();){if(i=n[e])for(s=i.tail;(i=i.next)!==s;)i.callback.apply(i.context||this,c);if(i=h)for(s=i.tail,o=[e].concat(c);(i=i.next)!==s;)i.callback.apply(i.context||this,o)}return this}};h.bind=h.on,h.unbind=h.off;var c=e.Model=function(t,e){var n;t||(t={}),e&&e.parse&&(t=this.parse(t)),(n=A(this,"defaults"))&&(t=i.extend({},n,t)),e&&e.collection&&(this.collection=e.collection),this.attributes={},this._escapedAttributes={},this.cid=i.uniqueId("c"),this.changed={},this._silent={},this._pending={},this.set(t,{silent:!0}),this.changed={},this._silent={},this._pending={},this._previousAttributes=i.clone(this.attributes),this.initialize.apply(this,arguments)};i.extend(c.prototype,h,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(t){return i.clone(this.attributes)},get:function(t){return this.attributes[t]},escape:function(t){var e;if(e=this._escapedAttributes[t])return e;var n=this.get(t);return this._escapedAttributes[t]=i.escape(null==n?"":""+n)},has:function(t){return null!=this.get(t)},set:function(t,e,n){var s,r,o;if(i.isObject(t)||null==t?(s=t,n=e):(s={},s[t]=e),n||(n={}),!s)return this;if(s instanceof c&&(s=s.attributes),n.unset)for(r in s)s[r]=void 0;if(!this._validate(s,n))return!1;this.idAttribute in s&&(this.id=s[this.idAttribute]);var a=n.changes={},h=this.attributes,u=this._escapedAttributes,l=this._previousAttributes||{};for(r in s)o=s[r],(!i.isEqual(h[r],o)||n.unset&&i.has(h,r))&&(delete u[r],(n.silent?this._silent:a)[r]=!0),n.unset?delete h[r]:h[r]=o,i.isEqual(l[r],o)&&i.has(h,r)==i.has(l,r)?(delete this.changed[r],delete this._pending[r]):(this.changed[r]=o,n.silent||(this._pending[r]=!0));return n.silent||this.change(n),this},unset:function(t,e){return(e||(e={})).unset=!0,this.set(t,null,e)},clear:function(t){return(t||(t={})).unset=!0,this.set(i.clone(this.attributes),t)},fetch:function(t){t=t?i.clone(t):{};var n=this,s=t.success;return t.success=function(e,i,r){return!!n.set(n.parse(e,r),t)&&void(s&&s(n,e))},t.error=e.wrapError(t.error,n,t),(this.sync||e.sync).call(this,"read",this,t)},save:function(t,n,s){var r,o;if(i.isObject(t)||null==t?(r=t,s=n):(r={},r[t]=n),s=s?i.clone(s):{},s.wait){if(!this._validate(r,s))return!1;o=i.clone(this.attributes)}var a=i.extend({},s,{silent:!0});if(r&&!this.set(r,s.wait?a:s))return!1;var h=this,c=s.success;s.success=function(t,e,n){var o=h.parse(t,n);return s.wait&&(delete s.wait,o=i.extend(r||{},o)),!!h.set(o,s)&&void(c?c(h,t):h.trigger("sync",h,t,s))},s.error=e.wrapError(s.error,h,s);var u=this.isNew()?"create":"update",l=(this.sync||e.sync).call(this,u,this,s);return s.wait&&this.set(o,a),l},destroy:function(t){t=t?i.clone(t):{};var n=this,s=t.success,r=function(){n.trigger("destroy",n,n.collection,t)};if(this.isNew())return r(),!1;t.success=function(e){t.wait&&r(),s?s(n,e):n.trigger("sync",n,e,t)},t.error=e.wrapError(t.error,n,t);var o=(this.sync||e.sync).call(this,"delete",this,t);return t.wait||r(),o},url:function(){var t=A(this,"urlRoot")||A(this.collection,"url")||C();return this.isNew()?t:t+("/"==t.charAt(t.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(t,e){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},change:function(t){t||(t={});var e=this._changing;this._changing=!0;for(var n in this._silent)this._pending[n]=!0;var s=i.extend({},t.changes,this._silent);this._silent={};for(var n in s)this.trigger("change:"+n,this,this.get(n),t);if(e)return this;for(;!i.isEmpty(this._pending);){this._pending={},this.trigger("change",this,t);for(var n in this.changed)this._pending[n]||this._silent[n]||delete this.changed[n];this._previousAttributes=i.clone(this.attributes)}return this._changing=!1,this},hasChanged:function(t){return arguments.length?i.has(this.changed,t):!i.isEmpty(this.changed)},changedAttributes:function(t){if(!t)return!!this.hasChanged()&&i.clone(this.changed);var e,n=!1,s=this._previousAttributes;for(var r in t)i.isEqual(s[r],e=t[r])||((n||(n={}))[r]=e);return n},previous:function(t){return arguments.length&&this._previousAttributes?this._previousAttributes[t]:null},previousAttributes:function(){return i.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(t,e){if(e.silent||!this.validate)return!0;t=i.extend({},this.attributes,t);var n=this.validate(t,e);return!n||(e&&e.error?e.error(this,n,e):this.trigger("error",this,n,e),!1)}});var u=e.Collection=function(t,e){e||(e={}),e.model&&(this.model=e.model),e.comparator&&(this.comparator=e.comparator),this._reset(),this.initialize.apply(this,arguments),t&&this.reset(t,{silent:!0,parse:e.parse})};i.extend(u.prototype,h,{model:c,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},add:function(t,e){var n,s,r,a,h,c,u={},l={},d=[];for(e||(e={}),t=i.isArray(t)?t.slice():[t],n=0,r=t.length;n<r;n++){if(!(a=t[n]=this._prepareModel(t[n],e)))throw new Error("Can't add an invalid model to a collection");h=a.cid,c=a.id,u[h]||this._byCid[h]||null!=c&&(l[c]||this._byId[c])?d.push(n):u[h]=l[c]=a}for(n=d.length;n--;)t.splice(d[n],1);for(n=0,r=t.length;n<r;n++)(a=t[n]).on("all",this._onModelEvent,this),this._byCid[a.cid]=a,null!=a.id&&(this._byId[a.id]=a);if(this.length+=r,s=null!=e.at?e.at:this.models.length,o.apply(this.models,[s,0].concat(t)),this.comparator&&this.sort({silent:!0}),e.silent)return this;for(n=0,r=this.models.length;n<r;n++)u[(a=this.models[n]).cid]&&(e.index=n,a.trigger("add",a,this,e));return this},remove:function(t,e){var n,s,r,o;for(e||(e={}),t=i.isArray(t)?t.slice():[t],n=0,s=t.length;n<s;n++)o=this.getByCid(t[n])||this.get(t[n]),o&&(delete this._byId[o.id],delete this._byCid[o.cid],r=this.indexOf(o),this.models.splice(r,1),this.length--,e.silent||(e.index=r,o.trigger("remove",o,this,e)),this._removeReference(o));return this},push:function(t,e){return t=this._prepareModel(t,e),this.add(t,e),t},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t),e},unshift:function(t,e){return t=this._prepareModel(t,e),this.add(t,i.extend({at:0},e)),t},shift:function(t){var e=this.at(0);return this.remove(e,t),e},get:function(t){if(null!=t)return this._byId[null!=t.id?t.id:t]},getByCid:function(t){return t&&this._byCid[t.cid||t]},at:function(t){return this.models[t]},where:function(t){return i.isEmpty(t)?[]:this.filter(function(e){for(var i in t)if(t[i]!==e.get(i))return!1;return!0})},sort:function(t){if(t||(t={}),!this.comparator)throw new Error("Cannot sort a set without a comparator");var e=i.bind(this.comparator,this);return 1==this.comparator.length?this.models=this.sortBy(e):this.models.sort(e),t.silent||this.trigger("reset",this,t),this},pluck:function(t){return i.map(this.models,function(e){return e.get(t)})},reset:function(t,e){t||(t=[]),e||(e={});for(var n=0,s=this.models.length;n<s;n++)this._removeReference(this.models[n]);return this._reset(),this.add(t,i.extend({silent:!0},e)),e.silent||this.trigger("reset",this,e),this},fetch:function(t){t=t?i.clone(t):{},void 0===t.parse&&(t.parse=!0);var n=this,s=t.success;return t.success=function(e,i,r){n[t.add?"add":"reset"](n.parse(e,r),t),s&&s(n,e)},t.error=e.wrapError(t.error,n,t),(this.sync||e.sync).call(this,"read",this,t)},create:function(t,e){var n=this;if(e=e?i.clone(e):{},t=this._prepareModel(t,e),!t)return!1;e.wait||n.add(t,e);var s=e.success;return e.success=function(i,r,o){e.wait&&n.add(i,e),s?s(i,r):i.trigger("sync",t,r,e)},t.save(null,e),t},parse:function(t,e){return t},chain:function(){return i(this.models).chain()},_reset:function(t){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(t,e){if(e||(e={}),t instanceof c)t.collection||(t.collection=this);else{var i=t;e.collection=this,t=new this.model(i,e),t._validate(t.attributes,e)||(t=!1)}return t},_removeReference:function(t){this==t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,n){("add"!=t&&"remove"!=t||i==this)&&("destroy"==t&&this.remove(e,n),e&&t==="change:"+e.idAttribute&&(delete this._byId[e.previous(e.idAttribute)],this._byId[e.id]=e),this.trigger.apply(this,arguments))}});var l=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];i.each(l,function(t){u.prototype[t]=function(){return i[t].apply(i,[this.models].concat(i.toArray(arguments)))}});var d=e.Router=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},f=/:\w+/g,p=/\*\w+/g,g=/[-[\]{}()+?.,\\^$|#\s]/g;i.extend(d.prototype,h,{initialize:function(){},route:function(t,n,s){return e.history||(e.history=new v),i.isRegExp(t)||(t=this._routeToRegExp(t)),s||(s=this[n]),e.history.route(t,i.bind(function(i){var r=this._extractParameters(t,i);s&&s.apply(this,r),this.trigger.apply(this,["route:"+n].concat(r)),e.history.trigger("route",this,n,r)},this)),this},navigate:function(t,i){e.history.navigate(t,i)},_bindRoutes:function(){if(this.routes){var t=[];for(var e in this.routes)t.unshift([e,this.routes[e]]);for(var i=0,n=t.length;i<n;i++)this.route(t[i][0],t[i][1],this[t[i][1]])}},_routeToRegExp:function(t){return t=t.replace(g,"\\$&").replace(f,"([^/]+)").replace(p,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,e){return t.exec(e).slice(1)}});var v=e.History=function(){this.handlers=[],i.bindAll(this,"checkUrl")},m=/^[#\/]/,_=/msie [\w.]+/;v.started=!1,i.extend(v.prototype,h,{interval:50,getHash:function(t){var e=t?t.location:window.location,i=e.href.match(/#(.*)$/);return i?i[1]:""},getFragment:function(t,e){if(null==t)if(this._hasPushState||e){t=window.location.pathname;var i=window.location.search;i&&(t+=i)}else t=this.getHash();return t.indexOf(this.options.root)||(t=t.substr(this.options.root.length)),t.replace(m,"")},start:function(t){if(v.started)throw new Error("Backbone.history has already been started");v.started=!0,this.options=i.extend({},{root:"/"},this.options,t),this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var e=this.getFragment(),s=document.documentMode,r=_.exec(navigator.userAgent.toLowerCase())&&(!s||s<=7);r&&(this.iframe=n('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e)),this._hasPushState?n(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!r?n(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=e;var o=window.location,a=o.pathname==this.options.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!a?(this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&a&&o.hash&&(this.fragment=this.getHash().replace(m,""),window.history.replaceState({},document.title,o.protocol+"//"+o.host+this.options.root+this.fragment)),this.options.silent?void 0:this.loadUrl())},stop:function(){n(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),v.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(t){var e=this.getFragment();return e==this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe))),e!=this.fragment&&(this.iframe&&this.navigate(e),void(this.loadUrl()||this.loadUrl(this.getHash())))},loadUrl:function(t){var e=this.fragment=this.getFragment(t),n=i.any(this.handlers,function(t){if(t.route.test(e))return t.callback(e),!0});return n},navigate:function(t,e){if(!v.started)return!1;e&&e!==!0||(e={trigger:e});var i=(t||"").replace(m,"");this.fragment!=i&&(this._hasPushState?(0!=i.indexOf(this.options.root)&&(i=this.options.root+i),this.fragment=i,window.history[e.replace?"replaceState":"pushState"]({},document.title,i)):this._wantsHashChange?(this.fragment=i,this._updateHash(window.location,i,e.replace),this.iframe&&i!=this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,i,e.replace))):window.location.assign(this.options.root+t),e.trigger&&this.loadUrl(t))},_updateHash:function(t,e,i){i?t.replace(t.toString().replace(/(javascript:|#).*$/,"")+"#"+e):t.hash=e}});var y=e.View=function(t){this.cid=i.uniqueId("view"),this._configure(t||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},w=/^(\S+)\s*(.*)$/,b=["model","collection","el","id","attributes","className","tagName"];i.extend(y.prototype,h,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this},make:function(t,e,i){var s=document.createElement(t);return e&&n(s).attr(e),null!=i&&n(s).html(i),s},setElement:function(t,e){return this.$el&&this.undelegateEvents(),this.$el=t instanceof n?t:n(t),this.el=this.$el[0],e!==!1&&this.delegateEvents(),this},delegateEvents:function(t){if(t||(t=A(this,"events"))){this.undelegateEvents();for(var e in t){var n=t[e];if(i.isFunction(n)||(n=this[t[e]]),!n)throw new Error('Method "'+t[e]+'" does not exist');var s=e.match(w),r=s[1],o=s[2];n=i.bind(n,this),r+=".delegateEvents"+this.cid,""===o?this.$el.bind(r,n):this.$el.delegate(o,r,n)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(t){this.options&&(t=i.extend({},this.options,t));for(var e=0,n=b.length;e<n;e++){var s=b[e];t[s]&&(this[s]=t[s])}this.options=t},_ensureElement:function(){if(this.el)this.setElement(this.el,!1);else{var t=A(this,"attributes")||{};this.id&&(t.id=this.id),this.className&&(t["class"]=this.className),this.setElement(this.make(this.tagName,t),!1)}}});var x=function(t,e){var i=S(this,t,e);return i.extend=this.extend,i};c.extend=u.extend=d.extend=y.extend=x;var E={create:"PUT",update:"PUT","delete":"DELETE",read:"GET"};e.sync=function(t,s,r){var o=E[t];r||(r={});var a={type:o,dataType:"json"};return r.url||(a.url=A(s,"url")||C()),r.data||!s||"create"!=t&&"update"!=t||(a.contentType="application/json",a.data=JSON.stringify(s.toJSON())),e.emulateJSON&&(a.contentType="application/x-www-form-urlencoded",a.data=a.data?{model:a.data}:{}),e.emulateHTTP&&("PUT"!==o&&"DELETE"!==o||(e.emulateJSON&&(a.data._method=o),a.type="POST",a.beforeSend=function(t){t.setRequestHeader("X-HTTP-Method-Override",o)})),"GET"===a.type||e.emulateJSON||(a.processData=!1),n.ajax(i.extend(a,r))},e.wrapError=function(t,e,i){return function(n,s){s=n===e?s:n,t?t(e,s,i):e.trigger("error",e,s,i)}};var k=function(){},S=function(t,e,n){var s;return s=e&&e.hasOwnProperty("constructor")?e.constructor:function(){t.apply(this,arguments)},i.extend(s,t),k.prototype=t.prototype,s.prototype=new k,e&&i.extend(s.prototype,e),n&&i.extend(s,n),s.prototype.constructor=s,s.__super__=t.prototype,s},A=function(t,e){return t&&t[e]?i.isFunction(t[e])?t[e]():t[e]:null},C=function(){throw new Error('A "url" property or function must be specified')};return e});